{% extends "baseall.html" %}

{% block title %}Chat Room{% endblock %}

{% block extra_head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans:wght@400;500;700&display=swap" rel="stylesheet">
{% endblock %}

{% block extra_styles %}
/* Chat-specific styles */
body {
    font-family: 'Inter', 'Noto Sans JP', 'Noto Sans', sans-serif;
    overflow: hidden;
    height: 100vh;
    margin: 0;
}

.chat-container {
    height: calc(100vh - 100px); /* ho·∫∑c ƒë√∫ng v·ªõi chi·ªÅu cao navbar th·ª±c t·∫ø */
    display: flex;
    flex-direction: column;
    min-height: 0;
    padding: 0; /* gi·∫£m padding n·∫øu c·∫ßn */
}

.chat-sidebar {
    background: var(--card-bg);
    border-radius: 15px;
    padding: 1.5rem;
    height: 100%;
    display: flex;
    flex-direction: column;
}

.chat-main {
    background: var(--card-bg);
    border-radius: 15px;
    height: 100%;
    min-height: 0;
    display: flex;
    flex-direction: column;
    max-height: calc(100vh - 3rem);
}

.chat-header {
    padding: 0.5rem;
    border-bottom: 1px solid var(--navbar-border);
    border-radius: 15px 15px 0 0;
    background: rgba(var(--primary-color-rgb, 52, 152, 219), 0.1);
    flex-shrink: 0;
}

.chat-messages {
    flex: 1 1 0%;
    min-height: 0;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.chat-input-area {
    flex-shrink: 0;
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--navbar-border);
    border-radius: 0 0 15px 15px;
    background: var(--card-bg);
}

.message {
    max-width: 70%;
    padding-top: 0.75rem;
    padding-right: 1rem;
    padding-bottom: 0.75rem;
    padding-left: 1rem;
    border-radius: 18px;
    margin-bottom: 0.5rem;
    word-wrap: break-word;
    position: relative;
}

.message.own {
    background: var(--primary-color);
    color: white;
    align-self: flex-end;
    margin-left: auto;
}

.message.other {
    background: var(--card-bg);
    border: 1px solid var(--navbar-border);
    color: var(--text-color);
    align-self: flex-start;
}

.message-header {
    font-size: 0.75rem;
    opacity: 0.8;
    margin-bottom: 0.25rem;
    font-weight: 500;
}

.message-content {
    line-height: 1.4;
    margin: 0;
}

.message-time {
    font-size: 0.7rem;
    opacity: 0.7;
    margin-top: 0.25rem;
}

.message-image {
    max-width: 100%;
    max-height: 300px;
    border-radius: 8px;
    cursor: pointer;
}

.message-actions {
    position: absolute;
    top: -30px;
    right: 0;
    background: var(--card-bg);
    border-radius: 15px;
    padding: 0.25rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: none;
}

.message:hover .message-actions {
    display: flex;
}

.message-reply {
    background: rgba(var(--primary-color-rgb, 52, 152, 219), 0.1);
    border-left: 3px solid var(--primary-color);
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    border-radius: 0 8px 8px 0;
    font-size: 0.85rem;
}

.message-edited {
    font-style: italic;
    opacity: 0.8;
}

.users-list {
    flex: 1;
    overflow-y: auto;
}

.user-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem;
    margin-bottom: 0.25rem;
    background: rgba(var(--primary-color-rgb, 52, 152, 219), 0.05);
    border-radius: 8px;
    font-weight: 500;
}

.user-item.owner {
    background: rgba(var(--primary-color-rgb, 52, 152, 219), 0.15);
}

.user-item.owner::after {
    content: "üëë";
    font-size: 0.8rem;
}

.search-box {
    margin-bottom: 1rem;
}

.search-results {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid var(--navbar-border);
    border-radius: 8px;
    padding: 0.5rem;
    background: var(--card-bg);
    display: none;
}

.search-result-item {
    padding: 0.5rem;
    border-bottom: 1px solid var(--navbar-border);
    cursor: pointer;
    border-radius: 4px;
}

.search-result-item:hover {
    background: rgba(var(--primary-color-rgb, 52, 152, 219), 0.1);
}

.search-result-item:last-child {
    border-bottom: none;
}

.typing-indicator {
    font-style: italic;
    opacity: 0.7;
    padding: 0.5rem;
    font-size: 0.85rem;
}

.file-drop-zone {
    border: 2px dashed var(--navbar-border);
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
    color: var(--secondary-color);
    margin-bottom: 1rem;
    display: none;
}

.file-drop-zone.active {
    border-color: var(--primary-color);
    background: rgba(var(--primary-color-rgb, 52, 152, 219), 0.1);
    display: block;
}

.image-preview {
    max-width: 200px;
    max-height: 200px;
    border-radius: 8px;
    margin: 0.5rem 0;
}

.room-controls {
    margin-top: auto;
    padding-top: 1rem;
    border-top: 1px solid var(--navbar-border);
}

.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--primary-color);
    color: white;
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    z-index: 9999;
    display: none;
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Japanese font support */
.message-content, .user-item, .search-result-item {
    font-family: 'Inter', 'Noto Sans JP', 'Noto Sans', sans-serif;
}

/* Responsive design */
@media (max-width: 768px) {
    .chat-container {
        height: calc(100vh - 80px);
    }
    
    .chat-sidebar {
        display: none;
    }
    
    .message {
        max-width: 85%;
    }
    
    .chat-header {
        padding: 1rem;
    }
    
    .chat-input-area {
        padding: 1rem;
    }
}

/* Sidebar toggle */
.chat-sidebar.collapsed {
    display: none;
}

.chat-main.expanded {
    width: 100%;
}

/* Message input textarea */
#messageInput {
    min-height: 38px;
    max-height: 120px;
    resize: none;
    overflow-y: auto;
    line-height: 1.4;
    padding-top: 8px;
    padding-bottom: 8px;
    border: 3px solid rgba(255,255,255,.3);
    background: var(--bg-color);
}
.input-group {
    align-items: flex-end;
}
/* Loading spinner */
.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.btn-close {
    background: #bd2130  !important;
    color: inherit !important;
    opacity: 1 !important;
}

/* Rooms List Styles */
.rooms-list {
    max-height: 300px;
    overflow-y: auto;
}

.room-item {
    border: 1px solid var(--navbar-border);
    border-radius: 8px;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    background: var(--card-bg);
}

.room-item:hover {
    background: var(--hover-bg);
}

.room-name {
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.room-info {
    font-size: 0.8rem;
    color: var(--secondary-color);
    margin-bottom: 0.25rem;
}

.room-info .font-monospace {
    background: rgba(var(--primary-color-rgb, 52, 152, 219), 0.1);
    padding: 0.1rem 0.3rem;
    border-radius: 3px;
    font-size: 0.75rem;
}

.room-stats {
    display: flex;
    gap: 1rem;
    font-size: 0.75rem;
    color: var(--secondary-color);
    margin-top: 0.25rem;
}

/* File Message Styles */
.message-file-container {
    background: rgba(var(--primary-color-rgb, 52, 152, 219), 0.1);
    border: 1px solid var(--primary-color);
    border-radius: 8px;
    padding: 0.75rem;
    min-width: 200px;
}

.file-preview {
    border: 2px dashed var(--primary-color);
    background: rgba(var(--primary-color-rgb, 52, 152, 219), 0.1);
}

/* Custom scrollbar for messages container */
#messagesContainer::-webkit-scrollbar {
    width: 6px;
}

#messagesContainer::-webkit-scrollbar-track {
    background: var(--navbar-border);
    border-radius: 3px;
}

#messagesContainer::-webkit-scrollbar-thumb {
    background: var(--secondary-color);
    border-radius: 3px;
}

#messagesContainer::-webkit-scrollbar-thumb:hover {
    background: var(--primary-color);
}

/* Ensure proper height for chat interface */
.row.h-100 {
    height: 100%;
    min-height: 0;
    display: flex;
}

.mt-4 {
    margin-top: 0.2rem !important;
}

.col-md-9, .col-12 {
    height: 100%;
    min-height: 0;
    display: flex;
    flex-direction: column;
}
{% endblock %}

{% block navbar_content %}
<a class="navbar-brand" id="navbarBrand" href="{{ url_for('home') }}" style="cursor: pointer;">
    <i class="bi bi-chat-dots me-2"></i>
    Chat Room
</a>
{% endblock %}

{% block content %}
<!-- Join/Create Room Modal -->
<div class="modal fade" id="roomModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-door-open me-2"></i>
                    Join or Create Room
                </h5>
                <button type="button" class="btn-close" onclick="window.location.href='{{ url_for('home') }}'"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs mb-3" id="roomTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="join-tab" data-bs-toggle="tab" data-bs-target="#join-pane" type="button">
                            <i class="bi bi-box-arrow-in-right me-1"></i>
                            Join Room
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="create-tab" data-bs-toggle="tab" data-bs-target="#create-pane" type="button">
                            <i class="bi bi-plus-circle me-1"></i>
                            Create Room
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="rooms-tab" data-bs-toggle="tab" data-bs-target="#rooms-pane" type="button">
                            <i class="bi bi-list me-1"></i>
                            Existing Rooms
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content">
                    <!-- Join Room Tab -->
                    <div class="tab-pane fade show active" id="join-pane">
                        <form id="joinForm">
                            <div class="mb-3">
                                <label for="joinRoomName" class="form-label">Room Name</label>
                                <input type="text" class="form-control" id="joinRoomName" value="{{ room_name }}" required>
                            </div>
                            <div class="mb-3">
                                <label for="joinPassword" class="form-label">Password (if required)</label>
                                <input type="password" class="form-control" id="joinPassword">
                            </div>
                            <div class="mb-3">
                                <label for="joinUserName" class="form-label">Your Name</label>
                                <input type="text" class="form-control" id="joinUserName" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-box-arrow-in-right me-1"></i>
                                Join Room
                            </button>
                        </form>
                    </div>
                    
                    <!-- Create Room Tab -->
                    <div class="tab-pane fade" id="create-pane">
                        <form id="createForm">
                            <div class="mb-3">
                                <label for="createRoomName" class="form-label">Room Name</label>
                                <input type="text" class="form-control" id="createRoomName" required>
                                <div class="form-text">Max 3 rooms allowed</div>
                            </div>
                            <div class="mb-3">
                                <label for="createPassword" class="form-label">Password (optional)</label>
                                <input type="password" class="form-control" id="createPassword">
                                <div class="form-text">Leave empty for public room</div>
                            </div>
                            <div class="mb-3">
                                <label for="createOwnerName" class="form-label">Your Name (Room Owner)</label>
                                <input type="text" class="form-control" id="createOwnerName" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-plus-circle me-1"></i>
                                Create Room
                            </button>
                        </form>
                    </div>
                    
                    <!-- Existing Rooms Tab -->
                    <div class="tab-pane fade" id="rooms-pane">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Active Rooms</h6>
                            <button class="btn btn-sm btn-outline-secondary" onclick="chatApp.loadRoomsList()" title="Refresh">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                        
                        <div id="roomsList" class="rooms-list">
                            <div class="text-center">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <div class="small mt-1">Loading rooms...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="roomError" class="alert alert-danger mt-3" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Main Chat Interface (Hidden initially) -->
<div id="chatInterface" class="chat-container" style="display: none;">
    <div class="row h-100">
        <!-- Sidebar -->
        <div class="col-md-3">
            <div class="chat-sidebar">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">
                        <i class="bi bi-people me-2"></i>
                        Users
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" id="copyRoomLink" title="Copy room link">
                        <i class="bi bi-link-45deg"></i>
                    </button>
                </div>
                
                <div class="users-list" id="usersList"></div>
                
                <!-- Search Box -->
                <div class="search-box">
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchInput" placeholder="Search messages...">
                        <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                    <div id="searchResults" class="search-results mt-2"></div>
                </div>
                
                <!-- Room Controls -->
                <div class="room-controls">
                    <button class="btn btn-sm btn-outline-secondary w-100 mb-2" id="leaveRoomBtn">
                        <i class="bi bi-box-arrow-right me-1"></i>
                        Leave Room
                    </button>
                    <button class="btn btn-sm btn-outline-danger w-100" id="deleteRoomBtn" style="display: none;">
                        <i class="bi bi-trash me-1"></i>
                        Delete Room
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Main Chat Area -->
        <div class="col-md-9">
            <div class="chat-main">
                <!-- Chat Header -->
                <div class="chat-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0" id="roomTitle">Room Name</h4>
                        </div>
                        <div>
                            <button class="btn btn-outline-secondary me-2" id="toggleSidebarBtn" title="Toggle users list">
                                <i class="bi bi-people"></i>
                            </button>
                            <button class="btn btn-outline-secondary d-md-none" id="toggleSidebar">
                                <i class="bi bi-list"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Messages Area -->
                <div class="chat-messages" id="messagesContainer">
                    <!-- Messages will be inserted here -->
                </div>
                
                <!-- File Drop Zone -->
                <div class="file-drop-zone" id="fileDropZone">
                    <i class="bi bi-cloud-upload display-4"></i>
                    <p>Drop images here to upload</p>
                </div>
                
                <!-- Chat Input -->
                <div class="chat-input-area">
                    <!-- Reply Preview -->
                    <div id="replyPreview" class="reply-preview mb-2" style="display: none;">
                        <div class="d-flex justify-content-between align-items-start p-2 bg-light rounded">
                            <div class="flex-grow-1">
                                <small class="text-muted">Replying to <strong id="replyToUser"></strong>:</small>
                                <div id="replyToContent" class="small"></div>
                            </div>
                            <button type="button" class="btn-close btn-sm" id="cancelReply"></button>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <input type="file" class="d-none" id="imageInput" accept="image/*">
                        <input type="file" class="d-none" id="fileInput" accept=".txt,.zip,.rar,.7z,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx">
                        <button class="btn btn-outline-secondary" type="button" id="imageBtn" title="Upload image">
                            <i class="bi bi-image"></i>
                        </button>
                        <button class="btn btn-outline-secondary" type="button" id="fileBtn" title="Upload file">
                            <i class="bi bi-paperclip"></i>
                        </button>
                        <textarea class="form-control" id="messageInput" placeholder="Type a message... (ÊîØÊåÅÊó•Êú¨Ë™û„Å®Vietnamese)" maxlength="1000" rows="1" style="resize: none; overflow-y: hidden;"></textarea>
                        <button class="btn btn-primary" type="button" id="sendBtn">
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                    
                    <div class="small text-muted mt-1">
                        Press Enter to send, Shift+Enter for new line. Use @username to mention someone.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Message Modal -->
<div class="modal fade" id="editMessageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Message</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <textarea class="form-control" id="editMessageContent" rows="3" maxlength="1000"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveEditBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Image Preview Modal -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalTitle">Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="imageModalImg" class="img-fluid" alt="Image">
            </div>
        </div>
    </div>
</div>

<!-- Notification -->
<div id="notification" class="notification">
    <div id="notificationContent"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
class ChatApp {
    constructor() {
        this.socket = null;
        this.currentRoom = null;
        this.currentUser = null;
        this.isOwner = false;
        this.replyToMessage = null;
        this.editingMessage = null;
        this.originalTitle = document.title;
        this.isTabActive = true;
        this.unreadCount = 0;
        
        this.init();
    }
    
    init() {
        // Initialize socket connection
        this.socket = io();
        
        // Setup event listeners
        this.setupEventListeners();
        this.setupSocketListeners();
        
        // Check if we have saved room data (for refresh handling)
        this.checkSavedRoomData();
        
        // Check URL parameters for room link
        const urlParams = new URLSearchParams(window.location.search);
        const roomFromUrl = urlParams.get('room');
        
        if (roomFromUrl) {
            // Mark that we accessed via room link for history management
            this.accessedViaRoomLink = true;
            
            // Setup history management to prevent going back to login/modal
            this.setupHistoryManagement();
            
            // If accessed via room link, show only join tab and pre-fill room name
            document.getElementById('joinRoomName').value = roomFromUrl;
            this.showJoinOnlyModal();
        } else if (!this.currentRoom) {
            // Show normal modal if no room data exists
            const roomModal = new bootstrap.Modal(document.getElementById('roomModal'));
            roomModal.show();
        }

        document.getElementById('create-tab').addEventListener('click', async () => {
            try {
                const res = await fetch('/api/ui_settings');
                const data = await res.json();
                if (data && data.user_name) {
                    document.getElementById('createOwnerName').value = data.user_name;
                }
            } catch (e) {
                // fallback: leave blank if error
                document.getElementById('createOwnerName').value = '';
            }
        });
    }
    
    setupEventListeners() {
        // Form submissions
        document.getElementById('joinForm').addEventListener('submit', (e) => this.handleJoinRoom(e));
        document.getElementById('createForm').addEventListener('submit', (e) => this.handleCreateRoom(e));
        
        // Message sending
        document.getElementById('sendBtn').addEventListener('click', () => this.sendMessage());
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                if (e.shiftKey) {
                    // Allow new line with Shift+Enter
                    return;
                } else {
                    // Send message with Enter
                    e.preventDefault();
                    this.sendMessage();
                }
            }
        });
        
        // Auto-resize textarea
        document.getElementById('messageInput').addEventListener('input', (e) => {
            this.autoResizeTextarea(e.target);
        });
        
        // Image upload
        document.getElementById('imageBtn').addEventListener('click', () => {
            document.getElementById('imageInput').click();
        });
        document.getElementById('imageInput').addEventListener('change', (e) => this.handleImageUpload(e));
        
        // File upload
        document.getElementById('fileBtn').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });
        document.getElementById('fileInput').addEventListener('change', (e) => this.handleFileUpload(e));
        
        // Search
        document.getElementById('searchBtn').addEventListener('click', () => this.searchMessages());
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                this.searchMessages();
            }
        });
        
        // Room controls
        document.getElementById('leaveRoomBtn').addEventListener('click', () => this.leaveRoom());
        document.getElementById('deleteRoomBtn').addEventListener('click', () => this.deleteRoom());
        document.getElementById('copyRoomLink').addEventListener('click', () => this.copyRoomLink());
        
        // Sidebar toggle
        document.getElementById('toggleSidebarBtn').addEventListener('click', () => this.toggleSidebar());
        
        // Edit message
        document.getElementById('saveEditBtn').addEventListener('click', () => this.saveEditMessage());
        document.getElementById('cancelReply').addEventListener('click', () => this.cancelReply());
        
        // Drag and drop
        this.setupDragAndDrop();
        
        // Paste handling
        document.addEventListener('paste', (e) => this.handlePaste(e));
        
        // Tab visibility handling
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                this.isTabActive = false;
            } else {
                this.isTabActive = true;
                this.unreadCount = 0;
                document.title = this.originalTitle;
            }
        });
        
        // Window focus handling
        window.addEventListener('focus', () => {
            this.isTabActive = true;
            this.unreadCount = 0;
            document.title = this.originalTitle;
        });
        
        window.addEventListener('blur', () => {
            this.isTabActive = false;
        });
        
        // Handle browser close/tab close
        window.addEventListener('beforeunload', () => {
            // Only leave room on actual browser/tab close, not on refresh
            if (this.currentRoom && this.currentUser) {
                // Send leave room message but don't clear localStorage
                // This allows rejoin on refresh but leaves on actual close
                this.socket.emit('leave_room', {
                    room_name: this.currentRoom,
                    user_name: this.currentUser
                });
            }
        });
        
        // Rooms tab event listener
        document.getElementById('rooms-tab').addEventListener('click', () => {
            this.loadRoomsList();
        });
    }
    
    setupSocketListeners() {
        this.socket.on('room_joined', (data) => this.handleRoomJoined(data));
        this.socket.on('user_joined', (data) => this.handleUserJoined(data));
        this.socket.on('user_left', (data) => this.handleUserLeft(data));
        this.socket.on('user_kicked', (data) => this.handleUserKicked(data));
        this.socket.on('message_received', (data) => this.handleMessageReceived(data));
        this.socket.on('message_edited', (data) => this.handleMessageEdited(data));
        this.socket.on('message_deleted', (data) => this.handleMessageDeleted(data));
        this.socket.on('room_deleted', (data) => this.handleRoomDeleted(data));
        this.socket.on('kicked', (data) => this.handleKicked(data));
        this.socket.on('error', (data) => this.handleError(data));
    }
    
    checkSavedRoomData() {
        // Check localStorage for saved room data
        const savedRoom = localStorage.getItem('chatRoom');
        const savedUser = localStorage.getItem('chatUser');
        const savedIsOwner = localStorage.getItem('chatIsOwner') === 'true';
        
        if (savedRoom && savedUser) {
            this.currentRoom = savedRoom;
            this.currentUser = savedUser;
            this.isOwner = savedIsOwner;
            
            // Try to rejoin the room automatically
            this.rejoinRoom();
        }
    }
    
    async rejoinRoom() {
        try {
            // Wait for socket connection first
            if (!this.socket.connected) {
                await new Promise(resolve => {
                    this.socket.on('connect', resolve);
                });
            }
            
            const response = await fetch('/api/chat/join_room', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    room_name: this.currentRoom, 
                    password: '', // No password for rejoin
                    user_name: this.currentUser 
                })
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                // Join socket room
                this.socket.emit('join_room', { 
                    room_name: this.currentRoom, 
                    user_name: this.currentUser 
                });
                
                // Don't show modal since we're rejoining
                return;
            } else {
                // If rejoin fails, clear saved data and show modal
                this.clearSavedRoomData();
                const roomModal = new bootstrap.Modal(document.getElementById('roomModal'));
                roomModal.show();
            }
        } catch (error) {
            console.error('Rejoin error:', error);
            // If rejoin fails, clear saved data and show modal
            this.clearSavedRoomData();
            const roomModal = new bootstrap.Modal(document.getElementById('roomModal'));
            roomModal.show();
        }
    }
    
    showJoinOnlyModal() {
        // Hide create tab and rooms tab - only show join tab
        document.getElementById('create-tab').style.display = 'none';
        document.getElementById('create-pane').style.display = 'none';
        document.getElementById('rooms-tab').style.display = 'none';
        document.getElementById('rooms-pane').style.display = 'none';
        
        // Disable room name input since it's pre-filled from URL
        const roomNameInput = document.getElementById('joinRoomName');
        roomNameInput.setAttribute('readonly', true);
        roomNameInput.style.backgroundColor = '#f8f9fa';
        
        // Update modal title
        document.querySelector('.modal-title').innerHTML = `
            <i class="bi bi-box-arrow-in-right me-2"></i>
            Join Room
        `;
        
        // Show the modal
        const roomModal = new bootstrap.Modal(document.getElementById('roomModal'));
        roomModal.show();
    }
    
    saveRoomData() {
        // Save room data to localStorage
        if (this.currentRoom && this.currentUser) {
            localStorage.setItem('chatRoom', this.currentRoom);
            localStorage.setItem('chatUser', this.currentUser);
            localStorage.setItem('chatIsOwner', this.isOwner.toString());
        }
    }
    
    clearSavedRoomData() {
        // Clear saved room data
        localStorage.removeItem('chatRoom');
        localStorage.removeItem('chatUser');
        localStorage.removeItem('chatIsOwner');
    }
    
    setupHistoryManagement() {
        // Add a history entry to prevent going back to login/modal
        history.pushState({ chatApp: true }, document.title, window.location.href);
        
        // Handle back button - redirect to join modal instead of login
        window.addEventListener('popstate', (event) => {
            if (this.accessedViaRoomLink) {
                // Prevent going back to login, show join modal instead
                history.forward();
                
                // If user tries to leave chat room via back, show join modal
                if (this.currentRoom) {
                    this.leaveRoom();
                    this.showJoinOnlyModal();
                }
            }
        });
    }
    
    async handleJoinRoom(e) {
        e.preventDefault();
        
        const roomName = document.getElementById('joinRoomName').value.trim();
        const password = document.getElementById('joinPassword').value.trim();
        const userName = document.getElementById('joinUserName').value.trim();
        
        if (!roomName || !userName) {
            this.showError('Room name and user name are required');
            return;
        }
        
        try {
            const response = await fetch('/api/chat/join_room', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ room_name: roomName, password: password, user_name: userName })
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                this.currentRoom = roomName;
                this.currentUser = userName;
                this.isOwner = data.is_owner;
                
                // Save room data for refresh handling
                this.saveRoomData();
                
                // Join socket room
                this.socket.emit('join_room', { room_name: roomName, user_name: userName });
                
                // Hide modal
                bootstrap.Modal.getInstance(document.getElementById('roomModal')).hide();
                
            } else {
                this.showError(data.message);
            }
        } catch (error) {
            this.showError('Failed to join room: ' + error.message);
        }
    }
    
    async handleCreateRoom(e) {
        e.preventDefault();
        
        const roomName = document.getElementById('createRoomName').value.trim();
        const password = document.getElementById('createPassword').value.trim();
        const ownerName = document.getElementById('createOwnerName').value.trim();
        
        if (!roomName || !ownerName) {
            this.showError('Room name and owner name are required');
            return;
        }
        
        try {
            const response = await fetch('/api/chat/create_room', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ room_name: roomName, password: password, owner_name: ownerName })
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                this.currentRoom = roomName;
                this.currentUser = ownerName;
                this.isOwner = true;
                
                // Save room data for refresh handling
                this.saveRoomData();
                
                // Join socket room
                this.socket.emit('join_room', { room_name: roomName, user_name: ownerName });
                
                // Hide modal
                bootstrap.Modal.getInstance(document.getElementById('roomModal')).hide();
                
                this.showNotification('Room created successfully!');
                
            } else {
                this.showError(data.message);
            }
        } catch (error) {
            this.showError('Failed to create room: ' + error.message);
        }
    }
    
    handleRoomJoined(data) {
        // Show chat interface
        document.getElementById('chatInterface').style.display = 'block';
        
        // Update room info
        document.getElementById('roomTitle').textContent = data.room_name;
        
        // Show delete button for owner
        if (data.is_owner) {
            document.getElementById('deleteRoomBtn').style.display = 'block';
        }
        
        // Load messages
        this.loadMessages(data.messages);
        
        // Update users list
        this.updateUsersList(data.users);
        
        // Clean up URL parameters after successful join
        if (window.location.search) {
            const url = new URL(window.location);
            url.search = '';
            window.history.replaceState({}, document.title, url.toString());
        }
        
        // If accessed via room link, add another history state to prevent back navigation
        if (this.accessedViaRoomLink) {
            history.pushState({ chatRoom: this.currentRoom }, document.title, window.location.href);
        }
        
        this.showNotification('Joined room successfully!');
    }
    
    handleUserJoined(data) {
        this.updateUsersList(data.users);
        this.showNotification(`${data.user_name} joined the room`);
    }
    
    handleUserLeft(data) {
        this.updateUsersList(data.users);
        this.showNotification(`${data.user_name} left the room`);
    }
    
    handleUserKicked(data) {
        this.updateUsersList(data.users);
        this.showNotification(`${data.user_name} was kicked from the room`);
    }
    
    handleMessageReceived(data) {
        this.addMessage(data);
        
        // Show notification if not own message
        if (data.sender_name !== this.currentUser) {
            // Flash tab title if not active
            if (!this.isTabActive) {
                this.unreadCount++;
                this.flashTabTitle();
            }
            
            this.showNotification(`New message from ${data.sender_name}`);
        }
    }
    
    handleMessageEdited(data) {
        const messageElement = document.querySelector(`[data-message-id="${data.message_id}"]`);
        if (messageElement) {
            const contentElement = messageElement.querySelector('.message-content');
            if (contentElement) {
                contentElement.textContent = data.content;
                
                // Add edited indicator
                if (!messageElement.querySelector('.message-edited')) {
                    const editedSpan = document.createElement('span');
                    editedSpan.className = 'message-edited';
                    editedSpan.textContent = ' (edited)';
                    contentElement.appendChild(editedSpan);
                }
            }
        }
    }
    
    handleMessageDeleted(data) {
        const messageElement = document.querySelector(`[data-message-id="${data.message_id}"]`);
        if (messageElement) {
            messageElement.remove();
        }
    }
    
    handleRoomDeleted(data) {
        this.showNotification(data.message);
        this.clearSavedRoomData(); // Clear saved data when room is deleted
        this.leaveRoom();
    }
    
    handleKicked(data) {
        this.showNotification(data.message);
        this.clearSavedRoomData(); // Clear saved data when kicked
        this.leaveRoom();
    }
    
    handleError(data) {
        this.showError(data.message);
    }
    
    sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const content = messageInput.value.trim();
        if (!content) return;
        
        this.socket.emit('send_message', {
            room_name: this.currentRoom,
            user_name: this.currentUser,
            content: content,
            reply_to_id: this.replyToMessage ? this.replyToMessage.id : null
        });
        
        messageInput.value = '';
        messageInput.style.height = 'auto'; // Reset textarea height
        this.cancelReply();
    }
    
    async handleImageUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // Show image preview immediately
        this.showImagePreview(file);
        
        const formData = new FormData();
        formData.append('image', file);
        formData.append('room_name', this.currentRoom);
        formData.append('sender_name', this.currentUser);
        
        try {
            const response = await fetch('/api/chat/upload_image', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                // Don't remove preview immediately - wait for socket message
                // The real message will replace the preview
                this.showNotification('Image uploaded successfully!');
                
                // Set a timeout to remove preview if socket message doesn't arrive
                setTimeout(() => {
                    this.removeImagePreview();
                }, 3000);
            } else {
                this.removeImagePreview();
                this.showError(data.message);
            }
        } catch (error) {
            this.removeImagePreview();
            this.showError('Failed to upload image: ' + error.message);
        }
        
        // Reset input
        e.target.value = '';
    }
    
    async handleFileUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        this.uploadFileFile(file);
        
        // Reset input
        e.target.value = '';
    }
    
    async uploadFileFile(file) {
        // Check file size (max 10MB)
        if (file.size > 10 * 1024 * 1024) {
            this.showError('File too large. Maximum size is 10MB');
            return;
        }
        
        // Check file type
        const allowedExtensions = ['txt', 'zip', 'rar', '7z', 'pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'];
        const fileExt = file.name.split('.').pop().toLowerCase();
        if (!allowedExtensions.includes(fileExt)) {
            this.showError('File type not allowed. Allowed: txt, zip, rar, 7z, pdf, doc, docx, xls, xlsx, ppt, pptx');
            return;
        }
        
        // Show file preview
        this.showFilePreview(file);
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('room_name', this.currentRoom);
        formData.append('sender_name', this.currentUser);
        
        try {
            const response = await fetch('/api/chat/upload_file', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                this.showNotification('File uploaded successfully!');
                
                // Set a timeout to remove preview if socket message doesn't arrive
                setTimeout(() => {
                    this.removeFilePreview();
                }, 3000);
            } else {
                this.removeFilePreview();
                this.showError(data.message);
            }
        } catch (error) {
            this.removeFilePreview();
            this.showError('Failed to upload file: ' + error.message);
        }
    }
    
    showFilePreview(file) {
        const container = document.getElementById('messagesContainer');
        
        const previewDiv = document.createElement('div');
        previewDiv.className = 'message own file-preview';
        previewDiv.id = 'file-preview';
        previewDiv.innerHTML = `
            <div class="message-file-container">
                <div class="d-flex align-items-center">
                    <i class="bi bi-file-earmark me-2"></i>
                    <div>
                        <div class="fw-bold">${file.name}</div>
                        <div class="small text-muted">${this.formatFileSize(file.size)}</div>
                    </div>
                </div>
                <div class="text-center mt-2">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Uploading...</span>
                    </div>
                    <div class="small mt-1">Uploading...</div>
                </div>
            </div>
        `;
        
        container.appendChild(previewDiv);
        container.scrollTop = container.scrollHeight;
    }
    
    removeFilePreview() {
        const preview = document.getElementById('file-preview');
        if (preview) {
            preview.remove();
        }
    }
    
    formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    async searchMessages() {
        const query = document.getElementById('searchInput').value.trim();
        if (!query) {
            document.getElementById('searchResults').style.display = 'none';
            return;
        }
        
        try {
            const response = await fetch(`/api/chat/search_messages?room_name=${encodeURIComponent(this.currentRoom)}&query=${encodeURIComponent(query)}`);
            const data = await response.json();
            
            if (data.status === 'success') {
                this.displaySearchResults(data.results);
            } else {
                this.showError(data.message);
            }
        } catch (error) {
            this.showError('Search failed: ' + error.message);
        }
    }
    
    displaySearchResults(results) {
        const container = document.getElementById('searchResults');
        container.innerHTML = '';
        
        if (results.length === 0) {
            container.innerHTML = '<div class="text-muted">No results found</div>';
        } else {
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.innerHTML = `
                    <div class="fw-bold">${this.escapeHtml(result.sender_name)}</div>
                    <div class="small">${this.escapeHtml(result.content)}</div>
                    <div class="text-muted small">${result.created_at}</div>
                `;
                container.appendChild(item);
            });
        }
        
        container.style.display = 'block';
    }
    
    loadMessages(messages) {
        const container = document.getElementById('messagesContainer');
        container.innerHTML = '';
        
        messages.forEach(message => this.addMessage(message));
        
        // Scroll to bottom
        container.scrollTop = container.scrollHeight;
    }
    
    addMessage(messageData) {
        const container = document.getElementById('messagesContainer');
        
        // If this is an image or file message from the current user, remove any existing preview
        if ((messageData.message_type === 'image' || messageData.message_type === 'file') && messageData.sender_name === this.currentUser) {
            this.removeImagePreview();
            this.removeFilePreview();
        }
        
        const messageDiv = document.createElement('div');
        
        const isOwn = messageData.sender_name === this.currentUser;
        messageDiv.className = `message ${isOwn ? 'own' : 'other'}`;
        messageDiv.setAttribute('data-message-id', messageData.id);
        
        let content = '';
        
        // Reply preview
        if (messageData.reply_to) {
            let replyContent = '[Image]';
            if (messageData.reply_to.message_type === 'text') {
                replyContent = this.escapeHtml(messageData.reply_to.content);
            } else if (messageData.reply_to.message_type === 'file') {
                replyContent = '[File]';
            }
            
            content += `
                <div class="message-reply" onclick="chatApp.scrollToMessage(${messageData.reply_to.id})" style="cursor: pointer;" title="Click to go to original message">
                    <strong>${this.escapeHtml(messageData.reply_to.sender_name)}:</strong>
                    ${replyContent}
                </div>
            `;
        }
        
        // Message header (for other users)
        if (!isOwn) {
            content += `<div class="message-header">${this.escapeHtml(messageData.sender_name)}</div>`;
        }
        
        // Message content
        if (messageData.message_type === 'text') {
            const processedContent = this.processMessageContent(messageData.content);
            content += `<div class="message-content">${processedContent}</div>`;
        } else if (messageData.message_type === 'image') {
            const imageContainer = `
                <div class="message-image-container position-relative d-inline-block">
                    <img src="${messageData.image_url}" class="message-image" alt="Image" onclick="chatApp.showImageModal('${messageData.image_url}', '${messageData.sender_name}')">
                    ${isOwn ? `<button class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1 rounded-circle" onclick="chatApp.deleteMessage(${messageData.id})" title="Delete image" style="width: 25px; height: 25px; padding: 0; line-height: 1;"><i class="bi bi-x"></i></button>` : ''}
                </div>
            `;
            content += imageContainer;
        } else if (messageData.message_type === 'file') {
            const fileContainer = `
                <div class="message-file-container position-relative">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-file-earmark me-2 fs-4"></i>
                        <div class="flex-grow-1">
                            <div class="fw-bold">${this.escapeHtml(messageData.file_name)}</div>
                            <div class="small text-muted">${this.formatFileSize(messageData.file_size)}</div>
                        </div>
                        <a href="${messageData.file_url}" class="btn btn-sm btn-outline-primary ms-2" title="Download">
                            <i class="bi bi-download"></i>
                        </a>
                        ${isOwn ? `<button class="btn btn-sm btn-outline-danger ms-1" onclick="chatApp.deleteMessage(${messageData.id})" title="Delete file"><i class="bi bi-trash"></i></button>` : ''}
                    </div>
                </div>
            `;
            content += fileContainer;
        }
        
        // Message time and edited indicator
        let timeHtml = `<div class="message-time">${messageData.created_at}</div>`;
        if (messageData.is_edited) {
            timeHtml = `<div class="message-time">${messageData.created_at} <span class="message-edited">(edited)</span></div>`;
        }
        content += timeHtml;
        
        // Message actions (for own messages)
        if (isOwn) {
            let actions = '<div class="message-actions">';
            if (messageData.message_type === 'text') {
                actions += `<button class="btn btn-sm btn-outline-secondary me-1" onclick="chatApp.editMessage(${messageData.id}, '${this.escapeHtml(messageData.content)}')" title="Edit"><i class="bi bi-pencil"></i></button>`;
                actions += `<button class="btn btn-sm btn-outline-danger me-1" onclick="chatApp.deleteMessage(${messageData.id})" title="Delete"><i class="bi bi-trash"></i></button>`;
            } else if (messageData.message_type === 'image' || messageData.message_type === 'file') {
                actions += `<button class="btn btn-sm btn-outline-danger me-1" onclick="chatApp.deleteMessage(${messageData.id})" title="Delete"><i class="bi bi-trash"></i></button>`;
            }
            
            let replyContent = messageData.content || (messageData.message_type === 'image' ? '[Image]' : '[File]');
            actions += `<button class="btn btn-sm btn-outline-primary" onclick="chatApp.setReplyToMessage(${messageData.id}, '${messageData.sender_name}', '${this.escapeHtml(replyContent)}')" title="Reply"><i class="bi bi-reply"></i></button>`;
            actions += '</div>';
            content += actions;
        } else {
            // Reply button for other users' messages
            let replyContent = messageData.content || (messageData.message_type === 'image' ? '[Image]' : '[File]');
            const actions = `
                <div class="message-actions">
                    <button class="btn btn-sm btn-outline-primary" onclick="chatApp.setReplyToMessage(${messageData.id}, '${messageData.sender_name}', '${this.escapeHtml(replyContent)}')" title="Reply"><i class="bi bi-reply"></i></button>
                </div>
            `;
            content += actions;
        }
        
        messageDiv.innerHTML = content;
        container.appendChild(messageDiv);
        
        // Scroll to bottom
        container.scrollTop = container.scrollHeight;
    }
    
    processMessageContent(content) {
        // Process @mentions
        const mentionRegex = /@(\w+)/g;
        return this.escapeHtml(content).replace(mentionRegex, '<span class="fw-bold text-primary">@$1</span>');
    }
    
    updateUsersList(users) {
        const container = document.getElementById('usersList');
        container.innerHTML = '';
        
        users.forEach(user => {
            const userDiv = document.createElement('div');
            userDiv.className = `user-item ${this.isOwner && user === this.currentUser ? 'owner' : ''}`;
            
            const userContent = `
                <span>${this.escapeHtml(user)}</span>
                ${this.isOwner && user !== this.currentUser ? 
                    `<button class="btn btn-sm btn-outline-danger" onclick="chatApp.kickUser('${user}')" title="Kick user">
                        <i class="bi bi-person-x"></i>
                    </button>` : ''}
            `;
            
            userDiv.innerHTML = userContent;
            container.appendChild(userDiv);
        });
    }
    
    editMessage(messageId, content) {
        this.editingMessage = { id: messageId, content: content };
        
        document.getElementById('editMessageContent').value = content;
        const modal = new bootstrap.Modal(document.getElementById('editMessageModal'));
        modal.show();
    }
    
    saveEditMessage() {
        if (!this.editingMessage) return;
        
        const newContent = document.getElementById('editMessageContent').value.trim();
        if (!newContent) return;
        
        this.socket.emit('edit_message', {
            message_id: this.editingMessage.id,
            content: newContent,
            user_name: this.currentUser
        });
        
        this.editingMessage = null;
        bootstrap.Modal.getInstance(document.getElementById('editMessageModal')).hide();
    }
    
    deleteImage(messageId) {
        if (confirm('Are you sure you want to delete this image?')) {
            this.socket.emit('delete_image', {
                message_id: messageId,
                user_name: this.currentUser
            });
        }
    }
    
    deleteMessage(messageId) {
        if (confirm('Are you sure you want to delete this message?')) {
            this.socket.emit('delete_message', {
                message_id: messageId,
                user_name: this.currentUser
            });
        }
    }
    
    setReplyToMessage(messageId, senderName, content) {
        this.replyToMessage = { id: messageId, sender: senderName, content: content };
        
        document.getElementById('replyToUser').textContent = senderName;
        document.getElementById('replyToContent').textContent = content.length > 50 ? content.substring(0, 50) + '...' : content;
        document.getElementById('replyPreview').style.display = 'block';
        
        document.getElementById('messageInput').focus();
    }
    
    cancelReply() {
        this.replyToMessage = null;
        document.getElementById('replyPreview').style.display = 'none';
    }
    
    kickUser(userName) {
        if (confirm(`Are you sure you want to kick ${userName}?`)) {
            this.socket.emit('kick_user', {
                room_name: this.currentRoom,
                owner_name: this.currentUser,
                target_user: userName
            });
        }
    }
    
    deleteRoom() {
        if (confirm('Are you sure you want to delete this room? All messages and images will be lost.')) {
            this.socket.emit('delete_room', {
                room_name: this.currentRoom,
                owner_name: this.currentUser
            });
        }
    }
    
    leaveRoom() {
        if (this.currentRoom && this.currentUser) {
            this.socket.emit('leave_room', {
                room_name: this.currentRoom,
                user_name: this.currentUser
            });
        }
        
        // Clear saved room data
        this.clearSavedRoomData();
        
        // Reset state
        this.currentRoom = null;
        this.currentUser = null;
        this.isOwner = false;
        
        // Reset create tab visibility in case it was hidden
        document.getElementById('create-tab').style.display = 'block';
        document.getElementById('create-pane').style.display = 'block';
        
        // Reset modal title
        document.querySelector('.modal-title').innerHTML = `
            <i class="bi bi-door-open me-2"></i>
            Join or Create Room
        `;
        
        // Hide chat interface and show room modal
        document.getElementById('chatInterface').style.display = 'none';
        const roomModal = new bootstrap.Modal(document.getElementById('roomModal'));
        roomModal.show();
    }
    
    copyRoomLink() {
        const roomLink = `${window.location.origin}/chat?room=${encodeURIComponent(this.currentRoom)}`;
        
        if (navigator.clipboard) {
            navigator.clipboard.writeText(roomLink).then(() => {
                this.showNotification('Room link copied to clipboard!');
            });
        } else {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = roomLink;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            this.showNotification('Room link copied to clipboard!');
        }
    }
    
    toggleSidebar() {
        const sidebar = document.querySelector('.chat-sidebar').parentElement;
        const mainChat = document.querySelector('.chat-main').parentElement;
        
        if (sidebar.style.display === 'none') {
            sidebar.style.display = 'block';
            sidebar.className = 'col-md-3';
            mainChat.className = 'col-md-9';
        } else {
            sidebar.style.display = 'none';
            mainChat.className = 'col-12';
        }
    }
    
    async loadRoomsList() {
        const container = document.getElementById('roomsList');
        
        // Show loading
        container.innerHTML = `
            <div class="text-center">
                <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="small mt-1">Loading rooms...</div>
            </div>
        `;
        
        try {
            const response = await fetch('/api/chat/rooms');
            const data = await response.json();
            
            if (data.status === 'success') {
                this.displayRoomsList(data.rooms);
            } else {
                container.innerHTML = `<div class="text-danger">Error: ${data.message}</div>`;
            }
        } catch (error) {
            container.innerHTML = `<div class="text-danger">Failed to load rooms</div>`;
        }
    }
    
    displayRoomsList(rooms) {
        const container = document.getElementById('roomsList');
        
        if (rooms.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted">
                    <i class="bi bi-door-closed fs-3"></i>
                    <div class="mt-2">No active rooms</div>
                </div>
            `;
            return;
        }
        
        container.innerHTML = '';
        
        rooms.forEach(room => {
            const roomDiv = document.createElement('div');
            roomDiv.className = 'room-item';
            
            const hasPassword = room.has_password;
            const passwordDisplay = room.password_display || '';
            const userCount = room.user_count || 0;
            
            roomDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="room-name">
                            ${this.escapeHtml(room.name)}
                            ${hasPassword ? '<i class="bi bi-lock-fill text-warning ms-1" title="Password protected"></i>' : ''}
                        </div>
                        <div class="room-info">
                            <div>Owner: ${this.escapeHtml(room.owner_name)}</div>
                            ${hasPassword ? `<div class="small text-warning"><i class="bi bi-lock-fill me-1"></i>Password required to join</div>` : '<div class="small text-success"><i class="bi bi-unlock-fill me-1"></i>No password required</div>'}
                        </div>
                        <div class="room-stats">
                            <span><i class="bi bi-people me-1"></i>${userCount} users</span>
                            <span><i class="bi bi-clock me-1"></i>${room.last_activity}</span>
                        </div>
                    </div>
                    <div class="d-flex flex-column gap-1">
                        <button class="btn btn-sm btn-primary" onclick="chatApp.joinRoomFromList('${room.name}', ${hasPassword})" title="Join room">
                            <i class="bi bi-box-arrow-in-right"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="chatApp.deleteRoomFromList('${room.name}')" title="Delete room">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            container.appendChild(roomDiv);
        });
    }
    
    joinRoomFromList(roomName, hasPassword) {
        // Switch to join tab and pre-fill room name
        document.getElementById('join-tab').click();
        document.getElementById('joinRoomName').value = roomName;
        
        if (hasPassword) {
            document.getElementById('joinPassword').focus();
        } else {
            document.getElementById('joinUserName').focus();
        }
    }
    
    async deleteRoomFromList(roomName) {
        if (!confirm(`Are you sure you want to delete room "${roomName}"? All messages and files will be lost.`)) {
            return;
        }
        
        try {
            const response = await fetch('/api/chat/delete_room', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ room_name: roomName })
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                this.showNotification('Room deleted successfully');
                this.loadRoomsList(); // Refresh list
            } else {
                this.showError(data.message);
            }
        } catch (error) {
            this.showError('Failed to delete room: ' + error.message);
        }
    }
    
    showImageModal(imageUrl, senderName) {
        document.getElementById('imageModalImg').src = imageUrl;
        document.getElementById('imageModalTitle').textContent = `Image from ${senderName}`;
        const modal = new bootstrap.Modal(document.getElementById('imageModal'));
        modal.show();
    }
    
    scrollToMessage(messageId) {
        const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
        if (messageElement) {
            // Scroll within the messages container
            const messagesContainer = document.getElementById('messagesContainer');
            
            // Calculate position relative to container
            const containerRect = messagesContainer.getBoundingClientRect();
            const messageRect = messageElement.getBoundingClientRect();
            
            // Scroll to show the message in the center of the container if possible
            const scrollTop = messageElement.offsetTop - messagesContainer.offsetHeight / 2 + messageElement.offsetHeight / 2;
            messagesContainer.scrollTo({
                top: scrollTop,
                behavior: 'smooth'
            });
            
            // Highlight the message briefly
            messageElement.style.backgroundColor = 'rgba(255, 255, 0, 0.3)';
            setTimeout(() => {
                messageElement.style.backgroundColor = '';
            }, 2000);
        }
    }
    
    setupDragAndDrop() {
        const dropZone = document.getElementById('fileDropZone');
        const chatMain = document.querySelector('.chat-main');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            chatMain.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
        });
        
        ['dragenter', 'dragover'].forEach(eventName => {
            chatMain.addEventListener(eventName, () => {
                dropZone.classList.add('active');
            });
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            chatMain.addEventListener(eventName, () => {
                dropZone.classList.remove('active');
            });
        });
        
        chatMain.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('image/')) {
                    this.uploadImageFile(file);
                } else {
                    // Check if it's an allowed file type
                    const allowedExtensions = ['txt', 'zip', 'rar', '7z', 'pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'];
                    const fileExt = file.name.split('.').pop().toLowerCase();
                    if (allowedExtensions.includes(fileExt)) {
                        this.uploadFileFile(file);
                    } else {
                        this.showError('File type not allowed. Allowed: txt, zip, rar, 7z, pdf, doc, docx, xls, xlsx, ppt, pptx');
                    }
                }
            }
        });
    }
    
    handlePaste(e) {
        if (!this.currentRoom) return;
        
        const items = e.clipboardData.items;
        for (let item of items) {
            if (item.type.startsWith('image/')) {
                const file = item.getAsFile();
                this.uploadImageFile(file);
                break;
            }
        }
    }
    
    async uploadImageFile(file) {
        // Show image preview immediately
        this.showImagePreview(file);
        
        const formData = new FormData();
        formData.append('image', file);
        formData.append('room_name', this.currentRoom);
        formData.append('sender_name', this.currentUser);
        
        try {
            const response = await fetch('/api/chat/upload_image', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                // Don't remove preview immediately - wait for socket message
                // The real message will replace the preview
                this.showNotification('Image uploaded successfully!');
                
                // Set a timeout to remove preview if socket message doesn't arrive
                setTimeout(() => {
                    this.removeImagePreview();
                }, 3000);
            } else {
                this.removeImagePreview();
                this.showError(data.message);
            }
        } catch (error) {
            this.removeImagePreview();
            this.showError('Failed to upload image: ' + error.message);
        }
    }
    
    showError(message) {
        const errorDiv = document.getElementById('roomError');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        
        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 5000);
    }
    
    showNotification(message) {
        const notification = document.getElementById('notification');
        const content = document.getElementById('notificationContent');
        
        content.textContent = message;
        notification.style.display = 'block';
        
        setTimeout(() => {
            notification.style.display = 'none';
        }, 3000);
    }
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    flashTabTitle() {
        if (this.isTabActive) return;
        
        const flashTitle = `(${this.unreadCount}) New Messages - ${this.originalTitle}`;
        document.title = flashTitle;
        
        // Create blinking effect
        let isVisible = true;
        const blinkInterval = setInterval(() => {
            if (this.isTabActive || this.unreadCount === 0) {
                clearInterval(blinkInterval);
                document.title = this.originalTitle;
                return;
            }
            
            document.title = isVisible ? this.originalTitle : flashTitle;
            isVisible = !isVisible;
        }, 1000);
    }
    
    showImagePreview(file) {
        const container = document.getElementById('messagesContainer');
        const previewDiv = document.createElement('div');
        previewDiv.id = 'imagePreviewMessage';
        previewDiv.className = 'message own';
        
        const reader = new FileReader();
        reader.onload = (e) => {
            previewDiv.innerHTML = `
                <div class="message-header">Uploading...</div>
                <div class="message-image-container position-relative d-inline-block">
                    <img src="${e.target.result}" class="message-image" alt="Uploading image" style="opacity: 0.7;">
                    <div class="position-absolute top-50 start-50 translate-middle">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Uploading...</span>
                        </div>
                    </div>
                </div>
                <div class="message-time">Uploading...</div>
            `;
            
            container.appendChild(previewDiv);
            container.scrollTop = container.scrollHeight;
        };
        reader.readAsDataURL(file);
    }
    
    removeImagePreview() {
        const preview = document.getElementById('imagePreviewMessage');
        if (preview) {
            preview.remove();
        }
    }
    
    autoResizeTextarea(textarea) {
        textarea.style.height = 'auto';
        const maxHeight = 120; // Max 5 lines approximately
        textarea.style.height = Math.min(textarea.scrollHeight, maxHeight) + 'px';
        
        // Reset to single line when empty
        if (!textarea.value.trim()) {
            textarea.style.height = 'auto';
        }
    }
}

// Initialize chat app when DOM is loaded
let chatApp;
document.addEventListener('DOMContentLoaded', function() {
    chatApp = new ChatApp();
});
</script>
{% endblock %}
