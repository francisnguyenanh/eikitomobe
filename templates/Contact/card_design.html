{% extends "Contact/base.html" %}
{% block content %}

<div class="container py-3">
  <h2 class="mb-4 text-center"><i class="bi bi-card-image me-2"></i>Thiết kế Thiệp Kỷ Niệm</h2>
  <div class="row justify-content-center align-items-start g-4">
    <div class="col-lg-5 order-lg-2 mb-4 mb-lg-0">
      <div class="card shadow-sm p-3 h-100">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <label class="form-label mb-1">Mẫu thiệp</label>
            <select class="form-select form-select-sm" id="templateSelect" name="template">
              <option value="classic">Cổ điển</option>
              <option value="modern">Hiện đại</option>
              <option value="minimal">Tối giản</option>
              <option value="cosmic">Vũ trụ</option>
              <option value="vintage">Cổ điển Retro</option>
              <option value="bohemian">Bohemian</option>
            </select>
          </div>
          <div>
            <label class="form-label mb-1">Màu nền</label>
            <input type="color" class="form-control form-control-color ms-2" id="bgColor" name="bgColor" value="#fff8e1" style="width:2.5rem;">
          </div>
        </div>
        <div class="d-flex justify-content-end align-items-center mb-2 gap-2">
          <button type="button" class="btn btn-primary" id="previewCardBtn"><i class="bi bi-eye me-2"></i>Xem trước thiệp</button>
          <button type="button" class="btn btn-success" id="downloadCardBtn"><i class="bi bi-download me-2"></i>Tải thiệp về</button>
          <button type="button" class="btn btn-warning" id="genLinkBtn"><i class="bi bi-link-45deg me-2"></i>Gen link chia sẻ</button>
        </div>
        <div id="cardPreview" class="my-4" style="min-height:320px;"></div>
      </div>
    </div>
  </div>
</div>

<style>
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes flicker {
  0%, 100% { opacity: 0.9; }
  50% { opacity: 0.6; }
}
@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.02); }
}
.card-container {
  animation: fadeIn 0.5s ease-in-out;
}
.flicker {
  animation: flicker 1.5s infinite;
}
.pulse {
  animation: pulse 2s infinite;
}
.container {
  max-width: 1100px;
}
.card {
  border-radius: 1rem;
  border: none;
}
.form-label {
  font-weight: 500;
  font-size: 0.98rem;
}
.form-control-color {
  padding: 0.2rem;
}
.list-group-item {
  font-size: 1rem;
  padding: 0.65rem 1rem;
}
</style>

<script>
// Updated card templates with enhanced vintage and new themes
const CARD_TEMPLATES = {
  classic: ({name, eventLabel, message, bgColor, specialWish}) => `
    <div class="card-container" style="background:linear-gradient(145deg,${bgColor},#f5f5f5);border-radius:16px;padding:2.5rem;box-shadow:0 6px 20px rgba(0,0,0,0.1);max-width:500px;margin:auto;text-align:center;border:2px solid #d4af37;">
      <div style="font-size:2.2rem;color:#8b4513;font-family:'Merriweather',serif;font-weight:700;letter-spacing:1px;">${eventLabel}</div>
      <div style="font-size:1.3rem;margin:1.5rem 0;color:#333;font-family:'Merriweather',serif;">${name ? ' ' + name : ''}</div>
      <div style="font-size:1.1rem;margin:1.5rem 0;color:#444;font-family:'Inter',sans-serif;">${message.replace(/\n/g,'<br>')}</div>
      <div style="font-size:1rem;color:#b8860b;margin-top:2rem;font-style:italic;" id="specialWishText">${specialWish || 'Chúc mừng ngày đặc biệt!'}</div>
    </div>
  `,
  modern: ({name, eventLabel, message, bgColor, specialWish}) => `
    <div class="card-container" style="background:linear-gradient(135deg,${bgColor},#dbeafe);border-radius:20px;padding:2.5rem;box-shadow:0 8px 24px rgba(59,130,246,0.15);max-width:520px;margin:auto;text-align:center;position:relative;overflow:hidden;">
      <div style="position:absolute;top:-40px;right:-40px;font-size:6rem;opacity:0.1;">🎉</div>
      <div style="font-size:2.2rem;color:#2563eb;font-family:'Inter',sans-serif;font-weight:700;letter-spacing:1.5px;">${eventLabel}</div>
      <div style="font-size:1.3rem;margin:1.5rem 0;color:#1e3a8a;font-family:'Inter',sans-serif;">${name ? name : ''}</div>
      <div style="font-size:1.1rem;margin:1.5rem 0;color:#444;font-family:'Inter',sans-serif;">${message.replace(/\n/g,'<br>')}</div>
      <div style="font-size:1rem;color:#2563eb;margin-top:2rem;font-family:'Inter',sans-serif;" id="specialWishText">${specialWish || 'Chúc mừng ngày đặc biệt!'}</div>
    </div>
  `,
  minimal: ({name, eventLabel, message, bgColor, specialWish}) => `
    <div class="card-container" style="background:${bgColor};border-radius:14px;padding:2rem;box-shadow:0 4px 16px rgba(0,0,0,0.08);max-width:400px;margin:auto;text-align:center;border:1px solid #d1d5db;">
      <div style="font-size:1.8rem;color:#1f2937;font-family:'Inter',sans-serif;font-weight:600;">${eventLabel}</div>
      <div style="font-size:1.2rem;margin:1.2rem 0;color:#4b5563;font-family:'Inter',sans-serif;">${name ? name : ''}</div>
      <div style="font-size:1rem;margin:1.2rem 0;color:#6b7280;font-family:'Inter',sans-serif;">${message.replace(/\n/g,'<br>')}</div>
      <div style="font-size:1rem;color:#9ca3af;margin-top:1.5rem;font-family:'Inter',sans-serif;" id="specialWishText">${specialWish || 'Chúc mừng ngày đặc biệt!'}</div>
    </div>
  `,
  cosmic: ({name, eventLabel, message, bgColor, specialWish}) => `
    <div class="card-container" style="background:linear-gradient(145deg,${bgColor},#1e3a8a);border-radius:20px;padding:2.5rem;box-shadow:0 8px 24px rgba(59,130,246,0.2);max-width:520px;margin:auto;text-align:center;position:relative;overflow:hidden;border:2px solid #93c5fd;">
      <div style="position:absolute;top:10px;left:10px;font-size:3rem;opacity:0.5;" class="flicker">✨</div>
      <div style="position:absolute;bottom:10px;right:10px;font-size:3rem;opacity:0.5;" class="flicker">🌟</div>
      <div style="font-size:2.2rem;color:#93c5fd;font-family:'Inter',sans-serif;font-weight:700;letter-spacing:2px;text-shadow:0 0 8px rgba(147,197,253,0.5);">${eventLabel}</div>
      <div style="font-size:1.3rem;margin:1.5rem 0;color:#bfdbfe;font-family:'Inter',sans-serif;">${name ? name : ''}</div>
      <div style="font-size:1.1rem;margin:1.5rem 0;color:#e0f2fe;font-family:'Inter',sans-serif;">${message.replace(/\n/g,'<br>')}</div>
      <div style="font-size:1rem;color:#93c5fd;margin-top:2rem;font-family:'Inter',sans-serif;" id="specialWishText">${specialWish || 'Chúc mừng ngày đặc biệt!'}</div>
    </div>
  `,
  vintage: ({name, eventLabel, message, bgColor, specialWish}) => `
    <div class="card-container" style="background:linear-gradient(135deg,${bgColor},#4c2c2a);border-radius:16px;padding:2.5rem;box-shadow:0 8px 24px rgba(139,69,19,0.2);max-width:520px;margin:auto;text-align:center;border:3px double #d4a373;position:relative;overflow:hidden;">
      <div style="position:absolute;top:15px;left:15px;font-size:2.5rem;opacity:0.6;" class="flicker">✉️</div>
      <div style="position:absolute;bottom:15px;right:15px;font-size:2.5rem;opacity:0.6;" class="flicker">📜</div>
      <div style="font-size:2.2rem;color:#d4a373;font-family:'Playfair Display',serif;font-weight:700;letter-spacing:1.5px;text-shadow:0 2px 4px rgba(0,0,0,0.3);">${eventLabel}</div>
      <div style="font-size:1.3rem;margin:1.5rem 0;color:#f5e6cc;font-family:'Playfair Display',serif;">${name ? name : ''}</div>
      <div style="font-size:1.1rem;margin:1.5rem 0;color:#f5e6cc;font-family:'Courier New',monospace;background:rgba(0,0,0,0.1);padding:10px;border-radius:8px;">${message.replace(/\n/g,'<br>')}</div>
      <div style="font-size:1rem;color:#d4a373;margin-top:2rem;font-style:italic;font-family:'Playfair Display',serif;" id="specialWishText">${specialWish || 'Chúc mừng ngày đặc biệt!'}</div>
    </div>
  `,
  bohemian: ({name, eventLabel, message, bgColor, specialWish}) => `
    <div class="card-container" style="background:linear-gradient(135deg,${bgColor},#4a2c2a);border-radius:18px;padding:2.5rem;box-shadow:0 6px 20px rgba(154,72,72,0.2);max-width:500px;margin:auto;text-align:center;border:2px dashed #e76f51;position:relative;overflow:hidden;">
      <div style="position:absolute;top:15px;left:15px;font-size:2.5rem;opacity:0.7;" class="pulse">🌙</div>
      <div style="position:absolute;bottom:15px;right:15px;font-size:2.5rem;opacity:0.7;" class="pulse">🪶</div>
      <div style="font-size:2.2rem;color:#e76f51;font-family:'Amatic SC',cursive;font-weight:700;letter-spacing:2px;">${eventLabel}</div>
      <div style="font-size:1.3rem;margin:1.5rem 0;color:#f4a261;font-family:'Amatic SC',cursive;">${name ? name : ''}</div>
      <div style="font-size:1.1rem;margin:1.5rem 0;color:#f4a261;font-family:'Lora',serif;background:rgba(0,0,0,0.1);padding:10px;border-radius:8px;">${message.replace(/\n/g,'<br>')}</div>
      <div style="font-size:1rem;color:#e76f51;margin-top:2rem;font-style:italic;font-family:'Amatic SC',cursive;" id="specialWishText">${specialWish || 'Chúc mừng ngày đặc biệt!'}</div>
    </div>
  `
};

// Updated age styles prioritizing vintage, art_deco, and bohemian for adults
const CARD_AGE_STYLES = {
  child: {
    template: 'cosmic',
    icon: '🪐🚀',
    bg: '#e0f2fe',
    font: 'Comic Neue, Inter, sans-serif',
    color: '#3b82f6'
  },
  teen_male: {
    template: 'cosmic',
    icon: '🌌⚽',
    bg: '#dbeafe',
    font: 'Inter, sans-serif',
    color: '#2563eb'
  },
  teen_female: {
    template: 'sakura',
    icon: '🎀🌸',
    bg: '#ffe4e6',
    font: 'Merriweather, Inter, sans-serif',
    color: '#ec4899'
  },
  youth_male: {
    template: 'modern',
    icon: '🏆🚀',
    bg: '#e0f7fa',
    font: 'Inter, sans-serif',
    color: '#0288d1'
  },
  youth_female: {
    template: 'flower',
    icon: '🌸💖',
    bg: '#fce7f3',
    font: 'Merriweather, Inter, sans-serif',
    color: '#db2777'
  },
  adult: {
    template: 'vintage',
    icon: '✉️📜',
    bg: '#f5e6cc',
    font: 'Playfair Display, serif',
    color: '#8b4513'
  },
  elder: {
    template: 'bohemian',
    icon: '🌙🪶',
    bg: '#fef3e7',
    font: 'Amatic SC, cursive',
    color: '#e76f51'
  }
};

// Wish templates (unchanged)
const WISH_TEMPLATES = {
  child: {
    vi: "Chúc con luôn vui vẻ, học giỏi và lớn nhanh như thổi!",
    en: "Wishing you lots of fun, joy, and big dreams!",
    ja: "いつも元気で、たくさん遊んで大きくなってね！"
  },
  teen_male: {
    vi: "Chúc em luôn mạnh mẽ, tự tin và thành công trên con đường phía trước!",
    en: "Wishing you strength, confidence, and success ahead!",
    ja: "これからも自信を持って、夢に向かって頑張ってね！"
  },
  teen_female: {
    vi: "Chúc em gái luôn xinh đẹp, hạnh phúc và đạt nhiều thành tích tốt!",
    en: "Wishing you beauty, happiness, and great achievements!",
    ja: "いつも笑顔で、素敵な毎日を過ごしてね！"
  },
  youth_male: {
    vi: "Chúc bạn luôn nhiệt huyết, thành công và hạnh phúc trong cuộc sống!",
    en: "Wishing you passion, success, and happiness in life!",
    ja: "情熱を持って、素晴らしい人生を歩んでください！"
  },
  youth_female: {
    vi: "Chúc bạn gái luôn rạng rỡ, tự tin và gặt hái nhiều thành công!",
    en: "Wishing you confidence, radiance, and many successes!",
    ja: "自信を持って、輝く未来を切り開いてください！"
  },
  adult: {
    vi: "Chúc anh/chị luôn mạnh khỏe, hạnh phúc và viên mãn bên gia đình!",
    en: "Wishing you health, happiness, and fulfillment with your family!",
    ja: "ご家族と共に、健康で幸せな日々をお過ごしください。"
  },
  elder: {
    vi: "Kính chúc bác luôn an khang, trường thọ và vui vầy bên con cháu!",
    en: "Wishing you longevity, peace, and joy with your family!",
    ja: "いつまでもお元気で、ご家族と幸せな時間をお過ごしください。"
  }
};

// Loại bỏ chọn loại kỷ niệm, dùng text tự do
function getEventLabel(eventLabel) {
  return eventLabel || 'Kỷ niệm';
}

function getWishText() {
  // Không còn lứa tuổi, chỉ lấy mặc định tiếng Việt
  return "Chúc mừng ngày đặc biệt! Chúc bạn luôn hạnh phúc và thành công!";
}


function renderCardPreview() {
  window.cardState = window.cardState || {
    name: '',
    eventLabel: '',
    eventDate: '',
    message: '',
    specialWish: 'Chúc mừng ngày đặc biệt!'
  };
  let { name, eventLabel, eventDate, message, specialWish } = window.cardState;
  let template = document.getElementById('templateSelect').value;
  let bgColor = document.getElementById('bgColor').value;
  if (!message.trim()) message = getWishText();
  if (!specialWish) specialWish = 'Chúc mừng ngày đặc biệt!';
  let html = CARD_TEMPLATES[template]({
    name,
    eventLabel,
    message: `<div class="card-message">${message.replace(/\n/g,'<br>')}</div>`,
    bgColor,
    eventDate
  });
  setTimeout(() => {
    const wishEls = document.querySelectorAll('#specialWishText');
    wishEls.forEach(el => el.textContent = specialWish);
  }, 0);
  document.getElementById('cardPreview').innerHTML = html;
}

function renderCardEdit() {
  window.cardState = window.cardState || {
    name: '',
    eventLabel: '',
    eventDate: '',
    message: '',
    specialWish: 'Chúc mừng ngày đặc biệt!'
  };
  let { name, eventLabel, eventDate, message, specialWish } = window.cardState;
  let template = document.getElementById('templateSelect').value;
  let bgColor = document.getElementById('bgColor').value;
  if (!message.trim()) message = getWishText();
  if (!specialWish) specialWish = 'Chúc mừng ngày đặc biệt!';
  let html = CARD_TEMPLATES[template]({
    name: `<input id="editNameOnCard" class="form-control form-control-sm d-inline-block" style="width:90%;display:inline-block;" value="${name}" placeholder="Tên người nhận">`,
    eventLabel: `<input id="editEventLabelOnCard" class="form-control form-control-sm d-inline-block" style="width:90%;display:inline-block;" value="${eventLabel || ''}" placeholder="Loại kỷ niệm (ví dụ: Sinh nhật, Kỷ niệm cưới...)">`,
    message: `<div class="card-message"><textarea id="editMessageOnCard" class="form-control" style="min-height:80px;resize:vertical;">${message.replace(/<br\s*\/>/g, '\n')}</textarea></div>`,
    bgColor,
    eventDate: `<input type="date" id="editEventDateOnCard" class="form-control form-control-sm d-inline-block" style="width:auto;display:inline-block;" value="${eventDate}">`
  });
  document.getElementById('cardPreview').innerHTML = html;
  // Sự kiện sửa trực tiếp trên card
  const nameInput = document.getElementById('editNameOnCard');
  if (nameInput) nameInput.addEventListener('input', function() {
    window.cardState.name = this.value;
  });
  const eventLabelInput = document.getElementById('editEventLabelOnCard');
  if (eventLabelInput) eventLabelInput.addEventListener('input', function() {
    window.cardState.eventLabel = this.value;
  });
  const eventDateInput = document.getElementById('editEventDateOnCard');
  if (eventDateInput) eventDateInput.addEventListener('input', function() {
    window.cardState.eventDate = this.value;
  });
  const editMsg = document.getElementById('editMessageOnCard');
  if (editMsg) {
    editMsg.addEventListener('input', function() {
      window.cardState.message = this.value;
    });
  }
  // Thêm input chỉnh sửa special wish
  const wishEls = document.querySelectorAll('#specialWishText');
  wishEls.forEach(el => {
    el.innerHTML = `<input id="editSpecialWishOnCard" class="form-control form-control-sm d-inline-block" style="width:90%;display:inline-block;" value="${specialWish || ''}" placeholder="Chúc mừng ngày đặc biệt!">`;
  });
  const editWish = document.getElementById('editSpecialWishOnCard');
  if (editWish) {
    editWish.addEventListener('input', function() {
      window.cardState.specialWish = this.value;
    });
  }
}


window.addEventListener('DOMContentLoaded', function() {
  const previewBtn = document.getElementById('previewCardBtn');
  let isPreview = false;
  if (previewBtn) previewBtn.onclick = function() {
    isPreview = !isPreview;
    if (isPreview) {
      renderCardPreview();
      previewBtn.innerHTML = '<i class="bi bi-pencil me-2"></i>Chỉnh sửa thiệp';
    } else {
      renderCardEdit();
      previewBtn.innerHTML = '<i class="bi bi-eye me-2"></i>Xem trước thiệp';
    }
  };
  ['templateSelect','bgColor'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('input', function() {
        if (isPreview) renderCardPreview();
        else renderCardEdit();
      });
    }
  });
  renderCardEdit();
});

// Đã loại bỏ các template không còn sử dụng khỏi dropdown và logic thêm động.
// --- Tải card về file ảnh PNG ---
// Yêu cầu: html2canvas
function downloadCardAsImage() {
  const card = document.querySelector('#cardPreview .card-container');
  if (!card) return;
  // Tạm thời ẩn input khi export (nếu đang ở chế độ edit)
  const inputs = card.querySelectorAll('input, textarea, select');
  const prevValues = [];
  inputs.forEach(el => {
    prevValues.push({el, value: el.value, type: el.type, parent: el.parentNode, outer: el.outerHTML});
    // Thay input bằng span text để xuất đẹp
    const span = document.createElement('span');
    span.textContent = el.value;
    span.style.cssText = el.style.cssText;
    el.parentNode.replaceChild(span, el);
  });
  window.html2canvas(card, {backgroundColor: null, scale: 2}).then(canvas => {
    // Khôi phục lại input sau khi export
    prevValues.forEach(({el, parent, outer}, i) => {
      const span = parent.querySelector('span');
      if (span) parent.replaceChild(el, span);
    });
    const link = document.createElement('a');
    link.download = 'thiep-ky-niem.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
  });
}

// Tải html2canvas nếu chưa có
if (typeof window.html2canvas === 'undefined') {
  const script = document.createElement('script');
  script.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
  script.onload = function() {
    // nothing
  };
  document.head.appendChild(script);
}

document.addEventListener('DOMContentLoaded', function() {
  const downloadBtn = document.getElementById('downloadCardBtn');
  if (downloadBtn) {
    downloadBtn.addEventListener('click', function() {
      downloadCardAsImage();
    });
  }
});

// --- Gen link chia sẻ card ---
function generateShareLink() {
  // Lấy state hiện tại
  const state = window.cardState || {};
  // Chỉ lấy các trường cần thiết
  const data = {
    name: state.name || '',
    eventLabel: state.eventLabel || '',
    eventDate: state.eventDate || '',
    message: state.message || '',
    specialWish: state.specialWish || '',
    template: document.getElementById('templateSelect').value,
    bgColor: document.getElementById('bgColor').value
  };
  // Encode thành base64 để nhúng vào URL
  const json = JSON.stringify(data);
  const b64 = btoa(unescape(encodeURIComponent(json)));
  // Tạo link (giả sử có route /card/view?data=...)
  const url = `${window.location.origin}/card/view?data=${b64}`;
  // Hiển thị modal hoặc copy link
  showShareLinkModal(url);
}

function showShareLinkModal(url) {
  let modal = document.getElementById('shareLinkModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'shareLinkModal';
    modal.innerHTML = `
      <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.3);z-index:9999;display:flex;align-items:center;justify-content:center;">
        <div style="background:#fff;padding:2rem 2.5rem;border-radius:1rem;box-shadow:0 4px 32px rgba(0,0,0,0.15);max-width:90vw;min-width:320px;">
          <h5 class="mb-3">Link chia sẻ thiệp</h5>
          <input class="form-control mb-2" value="${url}" readonly id="shareLinkInput" style="font-size:1rem;">
          <button class="btn btn-outline-primary btn-sm" onclick="navigator.clipboard.writeText(document.getElementById('shareLinkInput').value)">Copy link</button>
          <button class="btn btn-outline-secondary btn-sm ms-2" onclick="document.getElementById('shareLinkModal').remove()">Đóng</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }
}

document.addEventListener('DOMContentLoaded', function() {
  // ...existing code...
  const genLinkBtn = document.getElementById('genLinkBtn');
  if (genLinkBtn) {
    genLinkBtn.addEventListener('click', function() {
      generateShareLink();
    });
  }
  // ...existing code...
});
</script>
{% endblock %}