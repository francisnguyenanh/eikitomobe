{% extends "Contact/base.html" %}
{% block content %}

<div class="container py-3">
  <h2 class="mb-4 text-center"><i class="bi bi-card-image me-2"></i>Thiáº¿t káº¿ Thiá»‡p Ká»· Niá»‡m</h2>
  <div class="row justify-content-center align-items-start g-4">
    <div class="col-lg-5 order-lg-2 mb-4 mb-lg-0">
      <div class="card shadow-sm p-3 h-100">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <label class="form-label mb-1">Máº«u thiá»‡p</label>
            <select class="form-select form-select-sm" id="templateSelect" name="template">
              <option value="classic">Cá»• Ä‘iá»ƒn</option>
              <option value="modern">Hiá»‡n Ä‘áº¡i</option>
              <option value="minimal">Tá»‘i giáº£n</option>
              <option value="cosmic">VÅ© trá»¥</option>
              <option value="vintage">Cá»• Ä‘iá»ƒn Retro</option>
              <option value="bohemian">Bohemian</option>
            </select>
          </div>
          <div>
            <label class="form-label mb-1">MÃ u ná»n</label>
            <input type="color" class="form-control form-control-color ms-2" id="bgColor" name="bgColor" value="#fff8e1" style="width:2.5rem;">
          </div>
        </div>
        <div class="d-flex justify-content-end align-items-center mb-2 gap-2">
          <button type="button" class="btn btn-primary" id="previewCardBtn"><i class="bi bi-eye me-2"></i>Xem trÆ°á»›c thiá»‡p</button>
          <button type="button" class="btn btn-success" id="downloadCardBtn"><i class="bi bi-download me-2"></i>Táº£i thiá»‡p vá»</button>
          <button type="button" class="btn btn-warning" id="genLinkBtn"><i class="bi bi-link-45deg me-2"></i>Gen link chia sáº»</button>
        </div>
        <div id="cardPreview" class="my-4" style="min-height:320px;"></div>
      </div>
    </div>
  </div>
</div>

<style>
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes flicker {
  0%, 100% { opacity: 0.9; }
  50% { opacity: 0.6; }
}
@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.02); }
}
.card-container {
  animation: fadeIn 0.5s ease-in-out;
}
.flicker {
  animation: flicker 1.5s infinite;
}
.pulse {
  animation: pulse 2s infinite;
}
.container {
  max-width: 1100px;
}
.card {
  border-radius: 1rem;
  border: none;
}
.form-label {
  font-weight: 500;
  font-size: 0.98rem;
}
.form-control-color {
  padding: 0.2rem;
}
.list-group-item {
  font-size: 1rem;
  padding: 0.65rem 1rem;
}
</style>

<script>
// Updated card templates with enhanced vintage and new themes
const CARD_TEMPLATES = {
  classic: ({name, eventLabel, message, bgColor, specialWish}) => `
    <div class="card-container" style="background:linear-gradient(145deg,${bgColor},#f5f5f5);border-radius:16px;padding:2.5rem;box-shadow:0 6px 20px rgba(0,0,0,0.1);max-width:500px;margin:auto;text-align:center;border:2px solid #d4af37;">
      <div style="font-size:2.2rem;color:#8b4513;font-family:'Merriweather',serif;font-weight:700;letter-spacing:1px;">${eventLabel}</div>
      <div style="font-size:1.3rem;margin:1.5rem 0;color:#333;font-family:'Merriweather',serif;">${name ? ' ' + name : ''}</div>
      <div style="font-size:1.1rem;margin:1.5rem 0;color:#444;font-family:'Inter',sans-serif;">${message.replace(/\n/g,'<br>')}</div>
      <div style="font-size:1rem;color:#b8860b;margin-top:2rem;font-style:italic;" id="specialWishText">${specialWish || 'ChÃºc má»«ng ngÃ y Ä‘áº·c biá»‡t!'}</div>
    </div>
  `,
  modern: ({name, eventLabel, message, bgColor, specialWish}) => `
    <div class="card-container" style="background:linear-gradient(135deg,${bgColor},#dbeafe);border-radius:20px;padding:2.5rem;box-shadow:0 8px 24px rgba(59,130,246,0.15);max-width:520px;margin:auto;text-align:center;position:relative;overflow:hidden;">
      <div style="position:absolute;top:-40px;right:-40px;font-size:6rem;opacity:0.1;">ğŸ‰</div>
      <div style="font-size:2.2rem;color:#2563eb;font-family:'Inter',sans-serif;font-weight:700;letter-spacing:1.5px;">${eventLabel}</div>
      <div style="font-size:1.3rem;margin:1.5rem 0;color:#1e3a8a;font-family:'Inter',sans-serif;">${name ? name : ''}</div>
      <div style="font-size:1.1rem;margin:1.5rem 0;color:#444;font-family:'Inter',sans-serif;">${message.replace(/\n/g,'<br>')}</div>
      <div style="font-size:1rem;color:#2563eb;margin-top:2rem;font-family:'Inter',sans-serif;" id="specialWishText">${specialWish || 'ChÃºc má»«ng ngÃ y Ä‘áº·c biá»‡t!'}</div>
    </div>
  `,
  minimal: ({name, eventLabel, message, bgColor, specialWish}) => `
    <div class="card-container" style="background:${bgColor};border-radius:14px;padding:2rem;box-shadow:0 4px 16px rgba(0,0,0,0.08);max-width:400px;margin:auto;text-align:center;border:1px solid #d1d5db;">
      <div style="font-size:1.8rem;color:#1f2937;font-family:'Inter',sans-serif;font-weight:600;">${eventLabel}</div>
      <div style="font-size:1.2rem;margin:1.2rem 0;color:#4b5563;font-family:'Inter',sans-serif;">${name ? name : ''}</div>
      <div style="font-size:1rem;margin:1.2rem 0;color:#6b7280;font-family:'Inter',sans-serif;">${message.replace(/\n/g,'<br>')}</div>
      <div style="font-size:1rem;color:#9ca3af;margin-top:1.5rem;font-family:'Inter',sans-serif;" id="specialWishText">${specialWish || 'ChÃºc má»«ng ngÃ y Ä‘áº·c biá»‡t!'}</div>
    </div>
  `,
  cosmic: ({name, eventLabel, message, bgColor, specialWish}) => `
    <div class="card-container" style="background:linear-gradient(145deg,${bgColor},#1e3a8a);border-radius:20px;padding:2.5rem;box-shadow:0 8px 24px rgba(59,130,246,0.2);max-width:520px;margin:auto;text-align:center;position:relative;overflow:hidden;border:2px solid #93c5fd;">
      <div style="position:absolute;top:10px;left:10px;font-size:3rem;opacity:0.5;" class="flicker">âœ¨</div>
      <div style="position:absolute;bottom:10px;right:10px;font-size:3rem;opacity:0.5;" class="flicker">ğŸŒŸ</div>
      <div style="font-size:2.2rem;color:#93c5fd;font-family:'Inter',sans-serif;font-weight:700;letter-spacing:2px;text-shadow:0 0 8px rgba(147,197,253,0.5);">${eventLabel}</div>
      <div style="font-size:1.3rem;margin:1.5rem 0;color:#bfdbfe;font-family:'Inter',sans-serif;">${name ? name : ''}</div>
      <div style="font-size:1.1rem;margin:1.5rem 0;color:#e0f2fe;font-family:'Inter',sans-serif;">${message.replace(/\n/g,'<br>')}</div>
      <div style="font-size:1rem;color:#93c5fd;margin-top:2rem;font-family:'Inter',sans-serif;" id="specialWishText">${specialWish || 'ChÃºc má»«ng ngÃ y Ä‘áº·c biá»‡t!'}</div>
    </div>
  `,
  vintage: ({name, eventLabel, message, bgColor, specialWish}) => `
    <div class="card-container" style="background:linear-gradient(135deg,${bgColor},#4c2c2a);border-radius:16px;padding:2.5rem;box-shadow:0 8px 24px rgba(139,69,19,0.2);max-width:520px;margin:auto;text-align:center;border:3px double #d4a373;position:relative;overflow:hidden;">
      <div style="position:absolute;top:15px;left:15px;font-size:2.5rem;opacity:0.6;" class="flicker">âœ‰ï¸</div>
      <div style="position:absolute;bottom:15px;right:15px;font-size:2.5rem;opacity:0.6;" class="flicker">ğŸ“œ</div>
      <div style="font-size:2.2rem;color:#d4a373;font-family:'Playfair Display',serif;font-weight:700;letter-spacing:1.5px;text-shadow:0 2px 4px rgba(0,0,0,0.3);">${eventLabel}</div>
      <div style="font-size:1.3rem;margin:1.5rem 0;color:#f5e6cc;font-family:'Playfair Display',serif;">${name ? name : ''}</div>
      <div style="font-size:1.1rem;margin:1.5rem 0;color:#f5e6cc;font-family:'Courier New',monospace;background:rgba(0,0,0,0.1);padding:10px;border-radius:8px;">${message.replace(/\n/g,'<br>')}</div>
      <div style="font-size:1rem;color:#d4a373;margin-top:2rem;font-style:italic;font-family:'Playfair Display',serif;" id="specialWishText">${specialWish || 'ChÃºc má»«ng ngÃ y Ä‘áº·c biá»‡t!'}</div>
    </div>
  `,
  bohemian: ({name, eventLabel, message, bgColor, specialWish}) => `
    <div class="card-container" style="background:linear-gradient(135deg,${bgColor},#4a2c2a);border-radius:18px;padding:2.5rem;box-shadow:0 6px 20px rgba(154,72,72,0.2);max-width:500px;margin:auto;text-align:center;border:2px dashed #e76f51;position:relative;overflow:hidden;">
      <div style="position:absolute;top:15px;left:15px;font-size:2.5rem;opacity:0.7;" class="pulse">ğŸŒ™</div>
      <div style="position:absolute;bottom:15px;right:15px;font-size:2.5rem;opacity:0.7;" class="pulse">ğŸª¶</div>
      <div style="font-size:2.2rem;color:#e76f51;font-family:'Amatic SC',cursive;font-weight:700;letter-spacing:2px;">${eventLabel}</div>
      <div style="font-size:1.3rem;margin:1.5rem 0;color:#f4a261;font-family:'Amatic SC',cursive;">${name ? name : ''}</div>
      <div style="font-size:1.1rem;margin:1.5rem 0;color:#f4a261;font-family:'Lora',serif;background:rgba(0,0,0,0.1);padding:10px;border-radius:8px;">${message.replace(/\n/g,'<br>')}</div>
      <div style="font-size:1rem;color:#e76f51;margin-top:2rem;font-style:italic;font-family:'Amatic SC',cursive;" id="specialWishText">${specialWish || 'ChÃºc má»«ng ngÃ y Ä‘áº·c biá»‡t!'}</div>
    </div>
  `
};

// Updated age styles prioritizing vintage, art_deco, and bohemian for adults
const CARD_AGE_STYLES = {
  child: {
    template: 'cosmic',
    icon: 'ğŸªğŸš€',
    bg: '#e0f2fe',
    font: 'Comic Neue, Inter, sans-serif',
    color: '#3b82f6'
  },
  teen_male: {
    template: 'cosmic',
    icon: 'ğŸŒŒâš½',
    bg: '#dbeafe',
    font: 'Inter, sans-serif',
    color: '#2563eb'
  },
  teen_female: {
    template: 'sakura',
    icon: 'ğŸ€ğŸŒ¸',
    bg: '#ffe4e6',
    font: 'Merriweather, Inter, sans-serif',
    color: '#ec4899'
  },
  youth_male: {
    template: 'modern',
    icon: 'ğŸ†ğŸš€',
    bg: '#e0f7fa',
    font: 'Inter, sans-serif',
    color: '#0288d1'
  },
  youth_female: {
    template: 'flower',
    icon: 'ğŸŒ¸ğŸ’–',
    bg: '#fce7f3',
    font: 'Merriweather, Inter, sans-serif',
    color: '#db2777'
  },
  adult: {
    template: 'vintage',
    icon: 'âœ‰ï¸ğŸ“œ',
    bg: '#f5e6cc',
    font: 'Playfair Display, serif',
    color: '#8b4513'
  },
  elder: {
    template: 'bohemian',
    icon: 'ğŸŒ™ğŸª¶',
    bg: '#fef3e7',
    font: 'Amatic SC, cursive',
    color: '#e76f51'
  }
};

// Wish templates (unchanged)
const WISH_TEMPLATES = {
  child: {
    vi: "ChÃºc con luÃ´n vui váº», há»c giá»i vÃ  lá»›n nhanh nhÆ° thá»•i!",
    en: "Wishing you lots of fun, joy, and big dreams!",
    ja: "ã„ã¤ã‚‚å…ƒæ°—ã§ã€ãŸãã•ã‚“éŠã‚“ã§å¤§ãããªã£ã¦ã­ï¼"
  },
  teen_male: {
    vi: "ChÃºc em luÃ´n máº¡nh máº½, tá»± tin vÃ  thÃ nh cÃ´ng trÃªn con Ä‘Æ°á»ng phÃ­a trÆ°á»›c!",
    en: "Wishing you strength, confidence, and success ahead!",
    ja: "ã“ã‚Œã‹ã‚‰ã‚‚è‡ªä¿¡ã‚’æŒã£ã¦ã€å¤¢ã«å‘ã‹ã£ã¦é ‘å¼µã£ã¦ã­ï¼"
  },
  teen_female: {
    vi: "ChÃºc em gÃ¡i luÃ´n xinh Ä‘áº¹p, háº¡nh phÃºc vÃ  Ä‘áº¡t nhiá»u thÃ nh tÃ­ch tá»‘t!",
    en: "Wishing you beauty, happiness, and great achievements!",
    ja: "ã„ã¤ã‚‚ç¬‘é¡”ã§ã€ç´ æ•µãªæ¯æ—¥ã‚’éã”ã—ã¦ã­ï¼"
  },
  youth_male: {
    vi: "ChÃºc báº¡n luÃ´n nhiá»‡t huyáº¿t, thÃ nh cÃ´ng vÃ  háº¡nh phÃºc trong cuá»™c sá»‘ng!",
    en: "Wishing you passion, success, and happiness in life!",
    ja: "æƒ…ç†±ã‚’æŒã£ã¦ã€ç´ æ™´ã‚‰ã—ã„äººç”Ÿã‚’æ­©ã‚“ã§ãã ã•ã„ï¼"
  },
  youth_female: {
    vi: "ChÃºc báº¡n gÃ¡i luÃ´n ráº¡ng rá»¡, tá»± tin vÃ  gáº·t hÃ¡i nhiá»u thÃ nh cÃ´ng!",
    en: "Wishing you confidence, radiance, and many successes!",
    ja: "è‡ªä¿¡ã‚’æŒã£ã¦ã€è¼ãæœªæ¥ã‚’åˆ‡ã‚Šé–‹ã„ã¦ãã ã•ã„ï¼"
  },
  adult: {
    vi: "ChÃºc anh/chá»‹ luÃ´n máº¡nh khá»e, háº¡nh phÃºc vÃ  viÃªn mÃ£n bÃªn gia Ä‘Ã¬nh!",
    en: "Wishing you health, happiness, and fulfillment with your family!",
    ja: "ã”å®¶æ—ã¨å…±ã«ã€å¥åº·ã§å¹¸ã›ãªæ—¥ã€…ã‚’ãŠéã”ã—ãã ã•ã„ã€‚"
  },
  elder: {
    vi: "KÃ­nh chÃºc bÃ¡c luÃ´n an khang, trÆ°á»ng thá» vÃ  vui váº§y bÃªn con chÃ¡u!",
    en: "Wishing you longevity, peace, and joy with your family!",
    ja: "ã„ã¤ã¾ã§ã‚‚ãŠå…ƒæ°—ã§ã€ã”å®¶æ—ã¨å¹¸ã›ãªæ™‚é–“ã‚’ãŠéã”ã—ãã ã•ã„ã€‚"
  }
};

// Loáº¡i bá» chá»n loáº¡i ká»· niá»‡m, dÃ¹ng text tá»± do
function getEventLabel(eventLabel) {
  return eventLabel || 'Ká»· niá»‡m';
}

function getWishText() {
  // KhÃ´ng cÃ²n lá»©a tuá»•i, chá»‰ láº¥y máº·c Ä‘á»‹nh tiáº¿ng Viá»‡t
  return "ChÃºc má»«ng ngÃ y Ä‘áº·c biá»‡t! ChÃºc báº¡n luÃ´n háº¡nh phÃºc vÃ  thÃ nh cÃ´ng!";
}


function renderCardPreview() {
  window.cardState = window.cardState || {
    name: '',
    eventLabel: '',
    eventDate: '',
    message: '',
    specialWish: 'ChÃºc má»«ng ngÃ y Ä‘áº·c biá»‡t!'
  };
  let { name, eventLabel, eventDate, message, specialWish } = window.cardState;
  let template = document.getElementById('templateSelect').value;
  let bgColor = document.getElementById('bgColor').value;
  if (!message.trim()) message = getWishText();
  if (!specialWish) specialWish = 'ChÃºc má»«ng ngÃ y Ä‘áº·c biá»‡t!';
  let html = CARD_TEMPLATES[template]({
    name,
    eventLabel,
    message: `<div class="card-message">${message.replace(/\n/g,'<br>')}</div>`,
    bgColor,
    eventDate
  });
  setTimeout(() => {
    const wishEls = document.querySelectorAll('#specialWishText');
    wishEls.forEach(el => el.textContent = specialWish);
  }, 0);
  document.getElementById('cardPreview').innerHTML = html;
}

function renderCardEdit() {
  window.cardState = window.cardState || {
    name: '',
    eventLabel: '',
    eventDate: '',
    message: '',
    specialWish: 'ChÃºc má»«ng ngÃ y Ä‘áº·c biá»‡t!'
  };
  let { name, eventLabel, eventDate, message, specialWish } = window.cardState;
  let template = document.getElementById('templateSelect').value;
  let bgColor = document.getElementById('bgColor').value;
  if (!message.trim()) message = getWishText();
  if (!specialWish) specialWish = 'ChÃºc má»«ng ngÃ y Ä‘áº·c biá»‡t!';
  let html = CARD_TEMPLATES[template]({
    name: `<input id="editNameOnCard" class="form-control form-control-sm d-inline-block" style="width:90%;display:inline-block;" value="${name}" placeholder="TÃªn ngÆ°á»i nháº­n">`,
    eventLabel: `<input id="editEventLabelOnCard" class="form-control form-control-sm d-inline-block" style="width:90%;display:inline-block;" value="${eventLabel || ''}" placeholder="Loáº¡i ká»· niá»‡m (vÃ­ dá»¥: Sinh nháº­t, Ká»· niá»‡m cÆ°á»›i...)">`,
    message: `<div class="card-message"><textarea id="editMessageOnCard" class="form-control" style="min-height:80px;resize:vertical;">${message.replace(/<br\s*\/>/g, '\n')}</textarea></div>`,
    bgColor,
    eventDate: `<input type="date" id="editEventDateOnCard" class="form-control form-control-sm d-inline-block" style="width:auto;display:inline-block;" value="${eventDate}">`
  });
  document.getElementById('cardPreview').innerHTML = html;
  // Sá»± kiá»‡n sá»­a trá»±c tiáº¿p trÃªn card
  const nameInput = document.getElementById('editNameOnCard');
  if (nameInput) nameInput.addEventListener('input', function() {
    window.cardState.name = this.value;
  });
  const eventLabelInput = document.getElementById('editEventLabelOnCard');
  if (eventLabelInput) eventLabelInput.addEventListener('input', function() {
    window.cardState.eventLabel = this.value;
  });
  const eventDateInput = document.getElementById('editEventDateOnCard');
  if (eventDateInput) eventDateInput.addEventListener('input', function() {
    window.cardState.eventDate = this.value;
  });
  const editMsg = document.getElementById('editMessageOnCard');
  if (editMsg) {
    editMsg.addEventListener('input', function() {
      window.cardState.message = this.value;
    });
  }
  // ThÃªm input chá»‰nh sá»­a special wish
  const wishEls = document.querySelectorAll('#specialWishText');
  wishEls.forEach(el => {
    el.innerHTML = `<input id="editSpecialWishOnCard" class="form-control form-control-sm d-inline-block" style="width:90%;display:inline-block;" value="${specialWish || ''}" placeholder="ChÃºc má»«ng ngÃ y Ä‘áº·c biá»‡t!">`;
  });
  const editWish = document.getElementById('editSpecialWishOnCard');
  if (editWish) {
    editWish.addEventListener('input', function() {
      window.cardState.specialWish = this.value;
    });
  }
}


window.addEventListener('DOMContentLoaded', function() {
  const previewBtn = document.getElementById('previewCardBtn');
  let isPreview = false;
  if (previewBtn) previewBtn.onclick = function() {
    isPreview = !isPreview;
    if (isPreview) {
      renderCardPreview();
      previewBtn.innerHTML = '<i class="bi bi-pencil me-2"></i>Chá»‰nh sá»­a thiá»‡p';
    } else {
      renderCardEdit();
      previewBtn.innerHTML = '<i class="bi bi-eye me-2"></i>Xem trÆ°á»›c thiá»‡p';
    }
  };
  ['templateSelect','bgColor'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('input', function() {
        if (isPreview) renderCardPreview();
        else renderCardEdit();
      });
    }
  });
  renderCardEdit();
});

// ÄÃ£ loáº¡i bá» cÃ¡c template khÃ´ng cÃ²n sá»­ dá»¥ng khá»i dropdown vÃ  logic thÃªm Ä‘á»™ng.
// --- Táº£i card vá» file áº£nh PNG ---
// YÃªu cáº§u: html2canvas
function downloadCardAsImage() {
  const card = document.querySelector('#cardPreview .card-container');
  if (!card) return;
  // Táº¡m thá»i áº©n input khi export (náº¿u Ä‘ang á»Ÿ cháº¿ Ä‘á»™ edit)
  const inputs = card.querySelectorAll('input, textarea, select');
  const prevValues = [];
  inputs.forEach(el => {
    prevValues.push({el, value: el.value, type: el.type, parent: el.parentNode, outer: el.outerHTML});
    // Thay input báº±ng span text Ä‘á»ƒ xuáº¥t Ä‘áº¹p
    const span = document.createElement('span');
    span.textContent = el.value;
    span.style.cssText = el.style.cssText;
    el.parentNode.replaceChild(span, el);
  });
  window.html2canvas(card, {backgroundColor: null, scale: 2}).then(canvas => {
    // KhÃ´i phá»¥c láº¡i input sau khi export
    prevValues.forEach(({el, parent, outer}, i) => {
      const span = parent.querySelector('span');
      if (span) parent.replaceChild(el, span);
    });
    const link = document.createElement('a');
    link.download = 'thiep-ky-niem.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
  });
}

// Táº£i html2canvas náº¿u chÆ°a cÃ³
if (typeof window.html2canvas === 'undefined') {
  const script = document.createElement('script');
  script.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
  script.onload = function() {
    // nothing
  };
  document.head.appendChild(script);
}

document.addEventListener('DOMContentLoaded', function() {
  const downloadBtn = document.getElementById('downloadCardBtn');
  if (downloadBtn) {
    downloadBtn.addEventListener('click', function() {
      downloadCardAsImage();
    });
  }
});

// --- Gen link chia sáº» card ---
function generateShareLink() {
  // Láº¥y state hiá»‡n táº¡i
  const state = window.cardState || {};
  // Chá»‰ láº¥y cÃ¡c trÆ°á»ng cáº§n thiáº¿t
  const data = {
    name: state.name || '',
    eventLabel: state.eventLabel || '',
    eventDate: state.eventDate || '',
    message: state.message || '',
    specialWish: state.specialWish || '',
    template: document.getElementById('templateSelect').value,
    bgColor: document.getElementById('bgColor').value
  };
  // Encode thÃ nh base64 Ä‘á»ƒ nhÃºng vÃ o URL
  const json = JSON.stringify(data);
  const b64 = btoa(unescape(encodeURIComponent(json)));
  // Táº¡o link (giáº£ sá»­ cÃ³ route /card/view?data=...)
  const url = `${window.location.origin}/card/view?data=${b64}`;
  // Hiá»ƒn thá»‹ modal hoáº·c copy link
  showShareLinkModal(url);
}

function showShareLinkModal(url) {
  let modal = document.getElementById('shareLinkModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'shareLinkModal';
    modal.innerHTML = `
      <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.3);z-index:9999;display:flex;align-items:center;justify-content:center;">
        <div style="background:#fff;padding:2rem 2.5rem;border-radius:1rem;box-shadow:0 4px 32px rgba(0,0,0,0.15);max-width:90vw;min-width:320px;">
          <h5 class="mb-3">Link chia sáº» thiá»‡p</h5>
          <input class="form-control mb-2" value="${url}" readonly id="shareLinkInput" style="font-size:1rem;">
          <button class="btn btn-outline-primary btn-sm" onclick="navigator.clipboard.writeText(document.getElementById('shareLinkInput').value)">Copy link</button>
          <button class="btn btn-outline-secondary btn-sm ms-2" onclick="document.getElementById('shareLinkModal').remove()">ÄÃ³ng</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }
}

document.addEventListener('DOMContentLoaded', function() {
  // ...existing code...
  const genLinkBtn = document.getElementById('genLinkBtn');
  if (genLinkBtn) {
    genLinkBtn.addEventListener('click', function() {
      generateShareLink();
    });
  }
  // ...existing code...
});
</script>
{% endblock %}