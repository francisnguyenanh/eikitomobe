{% extends "Memo/base.html" %}
{% block title %}Evernote{% endblock %}
{% block content %}
<style>
/* ===== BASE STYLES ===== */
.evernote-layout,
.evernote-sidebar,
.evernote-main,
.evernote-editor,
.evernote-toolbar {
    font-family: "Segoe UI", "Helvetica Neue", Arial, "Noto Sans JP", "Noto Sans", "Meiryo", "Yu Gothic", "Tahoma", sans-serif;
}

.evernote-layout {
    display: flex;
    height: 100%;
}

/* ===== SIDEBAR STYLES ===== */
.evernote-sidebar {
    background: var(--card-bg, #f8f9fa);
    min-width: 220px;
    max-width: 260px;
    height: 70vh;
    overflow-y: auto;
    padding: 0;
    transition: all 0.2s ease;
}

.evernote-sidebar .list-group-item {
    background: transparent;
    border: none;
    color: var(--text-color, #222);
    cursor: pointer;
}

.evernote-sidebar .list-group-item.active {
    background: var(--bg-color, #e3f2fd);
    color: #1976d2;
    font-weight: bold;
}

.evernote-sidebar.collapsed {
    min-width: 45px !important;
    max-width: 45px !important;
    width: 45px !important;
    overflow-x: hidden;
}

.evernote-sidebar.collapsed .fw-bold,
.evernote-sidebar.collapsed .list-group,
.evernote-sidebar.collapsed .btn:not(#toggle-sidebar-btn) {
    display: none !important;
}

/* ===== MAIN CONTENT STYLES ===== */
.evernote-main {
    flex: 1 1 0;
    padding: 0 1.5rem;
    min-width: 0;
    display: flex;
    flex-direction: column;
    height: 70vh;
}

.evernote-main.expanded {
    padding-left: 0 !important;
}

/* ===== TOOLBAR STYLES ===== */
.evernote-toolbar {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.evernote-toolbar .btn,
.evernote-toolbar .form-select {
    min-width: 36px;
    padding: 0.25rem 0.5rem;
}

.evernote-toolbar .btn.effect-click {
    box-shadow: 0 0 0 0.2rem #90caf9;
    background-color: #e3f2fd !important;
    transition: box-shadow 0.2s, background-color 0.2s;
}

/* ===== EDITOR STYLES ===== */
.evernote-editor {
    flex: 1 1 0;
    background: var(--bg-color, #fff);
    padding: 1rem;
    margin-top: 1rem;
    overflow-y: auto;
    min-height: 250px;
    outline: none;
    font-size: 1rem;
    color: var(--text-color, #222);
}

.evernote-editor a {
    cursor: pointer;
    text-decoration: underline;
}

.evernote-editor input[type="checkbox"] {
    cursor: pointer;
}

/* ===== SEARCH STYLES ===== */
.search-highlight {
    background: yellow;
    color: #222;
    border-radius: 2px;
}

#searchModal .modal-dialog {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    margin: 0;
    z-index: 1060;
    width: 320px;
    max-width: 90vw;
}

#searchModal .modal-content {
    box-shadow: 0 2px 16px rgba(0,0,0,0.15);
}

/* ===== DESKTOP STYLES ===== */
@media (min-width: 992px) {
    .container.mt-4 {
        height: calc(100vh - 90px) !important;
        min-height: calc(100vh - 90px) !important;
        max-width: 100vw !important;
        width: 100vw !important;
        padding-left: 0 !important;
        padding-right: 0 !important;
    }
    
    .evernote-layout {
        height: 100%;
    }
    
    .evernote-main {
        height: 100%;
    }
    
    .evernote-editor {
        height: 100%;
        max-height: 100%;
        min-height: 0;
    }
    
    .evernote-sidebar {
        height: 100%;
        min-height: 0;
    }
}

/* ===== MOBILE STYLES ===== */
@media (max-width: 991.98px) {
    html, body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
        overflow-x: hidden;
    }
    
    .container.mt-4 {
        height: 100vh !important;
        min-height: 100vh !important;
        max-width: 100vw !important;
        width: 100vw !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    
    .evernote-layout {
        flex-direction: column !important;
        height: 100%;
        min-height: 100%;
        width: 100vw;
        max-width: 100vw;
    }
    
    .evernote-sidebar {
        max-width: 100vw;
        min-width: 0;
        width: 100vw;
        height: auto;
        border-right: none;
        border-bottom: 1px solid #e0e0e0;
        flex-shrink: 0;
    }
    
    .evernote-main {
        padding: 0.5rem;
        height: 100%;
        min-height: 0;
        flex: 1 1 0;
        width: 100vw;
        max-width: 100vw;
    }
    
    .evernote-editor {
        flex: 1 1 0;
        min-height: 0;
        height: 100%;
        max-height: 100%;
        margin-top: 0.5rem;
        padding: 0.5rem;
        width: 100%;
        box-sizing: border-box;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .evernote-toolbar {
        position: sticky;
        top: 0;
        z-index: 10;
        background: var(--card-bg, #fff);
        padding: 0.5rem 0;
        border-bottom: 1px solid #e0e0e0;
        transition: all 0.2s ease;
        flex-wrap: wrap;
        gap: 0.25rem;
        row-gap: 0.25rem;
    }
    
    .evernote-toolbar > * {
        margin-bottom: 0.25rem;
        flex: 0 0 auto;
    }
    
    .evernote-toolbar input,
    .evernote-toolbar select,
    .evernote-toolbar button {
        font-size: 0.95rem;
        padding: 0.25rem 0.5rem;
        min-width: 32px;
        max-width: 100%;
    }
    
    .evernote-toolbar .form-control {
        min-width: 120px;
        max-width: 100%;
    }
    
    #note-list.collapsed {
        display: none !important;
    }
}

/* ===== TABLET STYLES ===== */
@media (max-width: 900px) and (min-width: 576px) {
    .evernote-layout {
        flex-direction: column;
    }
    
    .evernote-sidebar {
        max-width: 100vw;
        min-width: 0;
        height: auto;
        border-right: none;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .evernote-main {
        padding: 0.5rem;
        height: auto;
    }
}
/* ===== IMAGE STYLES ===== */
.image-container {
    margin: 10px 0;
    position: relative;
    display: inline-block;
    max-width: 100%;
}

.image-container img {
    max-width: 100%;
    height: auto;
    border-radius: 4px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}

.image-container:hover img {
    transform: scale(1.02);
}

.delete-image-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(255, 0, 0, 0.8);
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    cursor: pointer;
    font-size: 12px;
    line-height: 1;
    opacity: 0;
    transition: opacity 0.2s;
}

.image-container:hover .delete-image-btn {
    opacity: 1;
}

.images-section {
    border-top: 1px solid #e0e0e0;
    padding-top: 15px;
    margin-top: 15px;
}
</style>

<div class="evernote-layout d-flex">
    <!-- Sidebar -->
    <div class="evernote-sidebar">
        <div class="d-flex justify-content-between align-items-center px-3 py-2">
            <span class="fw-bold">Note</span>
            <span id="save-status" style="margin-left:8px; color:#43a047; font-size:1.2em; display:none;">
                <i class="bi bi-cloud-check-fill"></i>
            </span>
            <div>
                <button class="btn btn-success btn-sm" id="add-note-btn"><i class="bi bi-plus"></i></button>
                <button class="btn btn-outline-secondary btn-sm d-none d-lg-inline-block" id="toggle-sidebar-btn" title="Thu gọn/Mở rộng sidebar">
                    <span id="toggle-sidebar-icon">&lt;</span>
                </button>
                <button class="btn btn-secondary btn-sm d-inline-block d-lg-none" id="toggle-list-btn" title="Ẩn/Hiện danh sách">
                    <i class="bi bi-chevron-bar-up" id="toggle-list-icon"></i>
                </button>
            </div>
        </div>
        <ul class="list-group list-group-flush" id="note-list"></ul>
    </div>

    <!-- Main content -->
    <div class="evernote-main">
        <div class="evernote-toolbar">
            <div style="position: relative; display: inline-block; max-width:200px; width:100%;">
                <input type="text" class="form-control" id="note-title" placeholder="Tiêu đề ghi chú..." style="padding-right:28px;" tabindex="1">
                <button type="button" id="clear-title-btn" style="position:absolute; right:4px; top:50%; transform:translateY(-50%); border:none; background:transparent; padding:0; margin:0; font-size:1.1em; color:#888; cursor:pointer; z-index:2;" title="Xóa tiêu đề">&times;</button>
            </div>
            <button class="btn btn-danger btn-sm" id="delete-note-btn" title="Xóa"><i class="bi bi-trash"></i></button>
            <button type="button" id="search-btn" class="btn btn-light btn-sm" title="Tìm kiếm"><i class="bi bi-search"></i></button>
            <div class="vr mx-2"></div>
            
            <!-- Format toolbar -->
            <button class="btn btn-light btn-sm" type="button" id="bold-btn" title="In đậm" onmousedown="toggleFormat(event, 'bold', this)"><b>B</b></button>
            <button class="btn btn-light btn-sm" type="button" id="italic-btn" title="In nghiêng" onmousedown="toggleFormat(event, 'italic', this)"><i>I</i></button>
            <button class="btn btn-light btn-sm" type="button" id="underline-btn" title="Gạch chân" onmousedown="toggleFormat(event, 'underline', this)"><u>U</u></button>
            <button class="btn btn-light btn-sm" type="button" id="strike-btn" title="Gạch bỏ" onmousedown="toggleFormat(event, 'strikeThrough', this)"><s>S</s></button>
            
            <select class="form-select form-select-sm" style="width:90px;display:inline-block;" onchange="format('formatBlock', this.value)">
                <option value="p">Body</option>
                <option value="h1">H1</option>
                <option value="h2">H2</option>
                <option value="h3">H3</option>
            </select>
            
            <select class="form-select form-select-sm" style="width:80px;display:inline-block;" onchange="setFontSize(this.value)">
                <option value="">Size</option>
                <option value="9pt">9</option>
                <option value="10pt">10</option>
                <option value="11pt">11</option>
                <option value="12pt">12</option>
                <option value="14pt">14</option>
                <option value="16pt">16</option>
                <option value="18pt">18</option>
                <option value="20pt">20</option>
                <option value="24pt">24</option>
                <option value="28pt">28</option>
                <option value="32pt">32</option>
                <option value="36pt">36</option>
                <option value="40pt">40</option>
                <option value="44pt">44</option>
                <option value="48pt">48</option>
                <option value="50pt">50</option>
            </select>
            
            <input type="color" class="form-control form-control-color form-control-sm" title="Màu chữ" onchange="format('foreColor', this.value)" style="width:36px;">
            <div class="vr mx-2"></div>
            
            <!-- List and alignment -->
            <button class="btn btn-light btn-sm" type="button" id="ordered-btn" title="Danh sách số" onmousedown="toggleFormat(event, 'insertOrderedList', this)"><i class="bi bi-list-ol"></i></button>
            <button class="btn btn-light btn-sm" type="button" id="unordered-btn" title="Danh sách chấm" onmousedown="toggleFormat(event, 'insertUnorderedList', this)"><i class="bi bi-list-ul"></i></button>
            <button class="btn btn-light btn-sm" type="button" id="checklist-btn" title="Checklist" onmousedown="toggleChecklist(event, this)"><i class="bi bi-check2-square"></i></button>
            <button class="btn btn-light btn-sm" type="button" id="left-btn" title="Căn trái" onmousedown="toggleFormat(event, 'justifyLeft', this)"><i class="bi bi-text-left"></i></button>
            <button class="btn btn-light btn-sm" type="button" id="center-btn" title="Căn giữa" onmousedown="toggleFormat(event, 'justifyCenter', this)"><i class="bi bi-text-center"></i></button>
            <button class="btn btn-light btn-sm" type="button" id="right-btn" title="Căn phải" onmousedown="toggleFormat(event, 'justifyRight', this)"><i class="bi bi-text-right"></i></button>
        </div>
        
        <div id="evernote-editor" class="evernote-editor" contenteditable="true" tabindex="2"></div>
        <div id="note-meta" style="font-size:0.95em; color:#888; margin-top:8px;"></div>
    </div>
</div>

<!-- Modals -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmLabel">Xác nhận</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                Bạn có chắc muốn xóa ghi chú này không?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">Xóa</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-body py-2">
                <input type="text" id="search-textbox" class="form-control form-control-sm" placeholder="Nhập từ khóa...">
            </div>
        </div>
    </div>
</div>

<script>
// ===== APPLICATION STATE =====
const AppState = {
    notes: [],
    currentId: null,
    pendingDelete: false,
    checklistActive: false,
    searchActive: false,
    searchResults: [],
    currentSearchIndex: -1,
    lastSearchTerm: "",
    lastSavedTitle: "",
    lastSavedContent: "",
    searchModalInstance: null,
    originalEditorHeight: null,
    currentImages: []  // Thêm để track ảnh hiện tại
};

// ===== IMAGE FUNCTIONS =====
const ImageManager = {
    // Upload ảnh từ file input
    async uploadImages(files, noteId) {
        if (!files || files.length === 0) return;
        
        // Hiển thị loading
        this.showUploadStatus('Đang upload ảnh...');
        
        const formData = new FormData();
        Array.from(files).forEach(file => {
            formData.append('images', file);
        });
        
        try {
            const response = await fetch(`/api/evernote_notes/${noteId}/upload_images`, {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                const result = await response.json();
                this.showUploadStatus(`Upload thành công ${result.processed_count} ảnh!`, 'success');
                
                // Cập nhật state và reload note
                await NoteManager.loadNotes();
                NoteManager.selectNote(noteId);
                return result;
            } else {
                const error = await response.json();
                this.showUploadStatus(`Lỗi upload: ${error.message}`, 'error');
            }
        } catch (error) {
            console.error('Error uploading images:', error);
            this.showUploadStatus('Lỗi upload ảnh!', 'error');
        }
    },
    
    // Hiển thị trạng thái upload
    showUploadStatus(message, type = 'info') {
        // Tạo hoặc cập nhật status element
        let statusDiv = document.getElementById('upload-status');
        if (!statusDiv) {
            statusDiv = document.createElement('div');
            statusDiv.id = 'upload-status';
            statusDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 10px 15px;
                border-radius: 5px;
                z-index: 9999;
                font-size: 14px;
                max-width: 300px;
            `;
            document.body.appendChild(statusDiv);
        }
        
        // Set style based on type
        const styles = {
            info: 'background: #e3f2fd; color: #1976d2; border: 1px solid #90caf9;',
            success: 'background: #e8f5e8; color: #2e7d32; border: 1px solid #81c784;',
            error: 'background: #ffebee; color: #c62828; border: 1px solid #ef9a9a;'
        };
        
        statusDiv.style.cssText += styles[type] || styles.info;
        statusDiv.textContent = message;
        statusDiv.style.display = 'block';
        
        // Auto hide after 3 seconds
        setTimeout(() => {
            if (statusDiv) {
                statusDiv.style.display = 'none';
            }
        }, 3000);
    },
    
    // Xử lý paste ảnh từ clipboard
    async handlePaste(event, noteId) {
        const items = (event.clipboardData || event.originalEvent.clipboardData).items;
        
        for (let item of items) {
            if (item.type.indexOf('image') !== -1) {
                event.preventDefault();
                const file = item.getAsFile();
                if (file && noteId) {
                    this.showUploadStatus('Đang xử lý ảnh từ clipboard...');
                    await this.uploadImages([file], noteId);
                }
                break;
            }
        }
    },
    
    // Hiển thị ảnh trong editor
    displayImages(images) {
        if (!images || images.length === 0) return '';
        
        return images.map(img => {
            return `<div class="image-container" style="margin: 10px 0; position: relative; display: inline-block;">
                <img src="data:image/jpeg;base64,${img.data}" 
                     style="max-width: 100%; height: auto; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" 
                     alt="${img.filename}">
                <button type="button" class="delete-image-btn" 
                        onclick="ImageManager.deleteImage('${img.id}', ${AppState.currentId})"
                        style="position: absolute; top: 5px; right: 5px; background: rgba(255,0,0,0.8); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 12px; line-height: 1;"
                        title="Xóa ảnh">×</button>
            </div>`;
        }).join('');
    },
    
    // Xóa ảnh
    async deleteImage(imageId, noteId) {
        if (!confirm('Bạn có chắc muốn xóa ảnh này?')) return;
        
        try {
            const response = await fetch(`/api/evernote_notes/${noteId}/delete_image/${imageId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                this.showUploadStatus('Xóa ảnh thành công!', 'success');
                // Reload note để cập nhật
                await NoteManager.loadNotes();
                NoteManager.selectNote(noteId);
            } else {
                this.showUploadStatus('Lỗi xóa ảnh!', 'error');
            }
        } catch (error) {
            console.error('Error deleting image:', error);
            this.showUploadStatus('Lỗi xóa ảnh!', 'error');
        }
    },
    
    // Thêm input file cho upload ảnh
    createImageUpload() {
        const input = document.createElement('input');
        input.type = 'file';
        input.multiple = true;
        input.accept = 'image/*';
        input.style.display = 'none';
        
        input.addEventListener('change', async (e) => {
            if (AppState.currentId && e.target.files.length > 0) {
                await this.uploadImages(e.target.files, AppState.currentId);
            }
            // Reset input để có thể chọn lại cùng file
            e.target.value = '';
        });
        
        document.body.appendChild(input);
        return input;
    }
};

// ===== UTILITY FUNCTIONS =====
const Utils = {
    formatDate(dtStr) {
        if (!dtStr) return '';
        const date = new Date(dtStr);
        const options = {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            weekday: 'short',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false,
            timeZone: 'Asia/Tokyo'
        };
        const formatter = new Intl.DateTimeFormat('ja-JP', options);
        const parts = formatter.formatToParts(date);
        const year = parts.find(p => p.type === 'year')?.value || '';
        const month = parts.find(p => p.type === 'month')?.value || '';
        const day = parts.find(p => p.type === 'day')?.value || '';
        const weekday = parts.find(p => p.type === 'weekday')?.value || '';
        const hour = parts.find(p => p.type === 'hour')?.value || '';
        const minute = parts.find(p => p.type === 'minute')?.value || '';
        return `${year}/${month}/${day} (${weekday}) ${hour}:${minute}`;
    },

    generateNoteTitle() {
        const now = new Date();
        const pad = n => n.toString().padStart(2, '0');
        return `Note ${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}`;
    },

    debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    },

    autoLink(html) {
        const div = document.createElement('div');
        div.innerHTML = html;

        function linkifyNode(node) {
            if (node.nodeType === 3) {
                const urlRegex = /((https?:\/\/)[^\s<]+)/g;
                let text = node.nodeValue;
                let match, lastIndex = 0;
                const frag = document.createDocumentFragment();
                
                while ((match = urlRegex.exec(text)) !== null) {
                    if (match.index > lastIndex) {
                        frag.appendChild(document.createTextNode(text.slice(lastIndex, match.index)));
                    }
                    const a = document.createElement('a');
                    a.href = match[1];
                    a.target = "_blank";
                    a.rel = "noopener noreferrer";
                    a.textContent = match[1];
                    frag.appendChild(a);
                    lastIndex = urlRegex.lastIndex;
                }
                
                if (lastIndex < text.length) {
                    frag.appendChild(document.createTextNode(text.slice(lastIndex)));
                }
                return frag.childNodes.length ? frag : node;
            } else if (node.nodeType === 1 && node.tagName !== 'A') {
                for (let i = 0; i < node.childNodes.length; i++) {
                    const replaced = linkifyNode(node.childNodes[i]);
                    if (replaced !== node.childNodes[i]) {
                        node.replaceChild(replaced, node.childNodes[i]);
                    }
                }
            }
            return node;
        }

        linkifyNode(div);
        return div.innerHTML;
    }
};

// ===== API FUNCTIONS =====
const API = {
    async fetchNotes() {
        const res = await fetch('/api/evernote_notes');
        return await res.json();
    },

    async createNote(title, content) {
        const res = await fetch('/api/evernote_notes', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({title, content})
        });
        return await res.json();
    },

    async updateNote(id, title, content) {
        const requestData = {title, content};
        
        const res = await fetch(`/api/evernote_notes/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(requestData)
        });
        return await res.json();
    },

    async deleteNote(id) {
        await fetch(`/api/evernote_notes/${id}`, {method: 'DELETE'});
    }
};

// ===== NOTE MANAGEMENT =====
const NoteManager = {
    async loadNotes() {
        AppState.notes = await API.fetchNotes();
        this.renderNoteList();
        
        if (AppState.notes.length > 0) {
            const stillExists = AppState.notes.some(n => n.id === AppState.currentId);
            if (!stillExists) {
                AppState.currentId = AppState.notes[0].id;
            }
            this.selectNote(AppState.currentId);
        } else {
            AppState.currentId = null;
            document.getElementById('note-title').value = '';
            document.getElementById('evernote-editor').innerHTML = '';
            document.getElementById('note-meta').textContent = '';
            AppState.currentImages = [];
        }
    },

    renderNoteList() {
        const list = document.getElementById('note-list');
        list.innerHTML = '';
        AppState.notes.forEach(note => {
            const li = document.createElement('li');
            li.className = 'list-group-item' + (note.id === AppState.currentId ? ' active' : '');
            li.textContent = note.title || 'Không tiêu đề';
            li.onclick = () => this.selectNote(note.id);
            list.appendChild(li);
        });
    },

    selectNote(id) {
        AppState.currentId = id;
        const note = AppState.notes.find(n => n.id === id);
        if (!note) return;
        
        document.getElementById('note-title').value = note.title;
        
        // Hiển thị content và ảnh
        const editor = document.getElementById('evernote-editor');
        let content = Utils.autoLink(note.content);
        
        // Thêm ảnh vào cuối content
        if (note.images && note.images.length > 0) {
            AppState.currentImages = note.images;
            content += '<div class="images-section">' + ImageManager.displayImages(note.images) + '</div>';
        } else {
            AppState.currentImages = [];
        }
        
        editor.innerHTML = content;
        this.renderNoteList();

        const metaDiv = document.getElementById('note-meta');
        if (metaDiv && note.created_at && note.updated_at) {
            const createTime = Utils.formatDate(note.created_at);
            const updateTime = Utils.formatDate(note.updated_at);
            metaDiv.innerHTML = `Create: ${createTime}<br>Update: ${updateTime}`;
        } else if (metaDiv) {
            metaDiv.textContent = '';
        }
    },

    async addNote() {
        const title = Utils.generateNoteTitle();
        const data = await API.createNote(title, "");
        await this.loadNotes();
        this.selectNote(data.id);
    },

    async deleteNote() {
        if (!AppState.currentId) return;
        await API.deleteNote(AppState.currentId);
        await this.loadNotes();
        
        if (AppState.notes.length > 0) {
            this.selectNote(AppState.notes[0].id);
        } else {
            AppState.currentId = null;
            document.getElementById('note-title').value = '';
            document.getElementById('evernote-editor').innerHTML = '';
            document.getElementById('note-meta').textContent = '';
            AppState.currentImages = [];
        }
    }
};

// ===== EDITOR FUNCTIONS =====
const Editor = {
    syncCheckboxStates(editor) {
        const checkboxes = editor.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => {
            if (cb.checked) {
                cb.setAttribute('checked', 'checked');
            } else {
                cb.removeAttribute('checked');
            }
        });
    },

    toggleChecklist(event, btn) {
        event.preventDefault();
        AppState.checklistActive = !AppState.checklistActive;
        btn.classList.toggle('active', AppState.checklistActive);
        btn.classList.add('effect-click');
        setTimeout(() => btn.classList.remove('effect-click'), 200);

        if (AppState.checklistActive) {
            document.execCommand('insertHTML', false, '<input type="checkbox" style="transform:scale(1.2);margin-right:6px;">');
        }
        document.getElementById('evernote-editor').focus();
    },

    toggleFormat(event, cmd, btn) {
        event.preventDefault();
        document.getElementById('evernote-editor').focus();
        document.execCommand(cmd);
        this.updateFormatButtons();
        btn.classList.add('effect-click');
        setTimeout(() => btn.classList.remove('effect-click'), 200);
    },

    updateFormatButtons() {
        const buttons = {
            'bold': document.getElementById('bold-btn'),
            'italic': document.getElementById('italic-btn'),
            'underline': document.getElementById('underline-btn'),
            'strikeThrough': document.getElementById('strike-btn'),
            'insertOrderedList': document.getElementById('ordered-btn'),
            'insertUnorderedList': document.getElementById('unordered-btn'),
            'justifyLeft': document.getElementById('left-btn'),
            'justifyCenter': document.getElementById('center-btn'),
            'justifyRight': document.getElementById('right-btn')
        };

        Object.entries(buttons).forEach(([cmd, btn]) => {
            if (btn) {
                btn.classList.toggle('active', document.queryCommandState(cmd));
            }
        });
    }
};

// ===== SEARCH FUNCTIONS =====
const Search = {
    clearHighlight() {
        const editor = document.getElementById('evernote-editor');
        const spans = editor.querySelectorAll('.search-highlight');
        spans.forEach(span => {
            const text = document.createTextNode(span.textContent);
            span.parentNode.replaceChild(text, span);
        });
    },

    highlightTerm(term) {
        this.clearHighlight();
        if (!term) return [];
        
        const editor = document.getElementById('evernote-editor');
        const regex = new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
        let results = [];

        function walk(node) {
            if (node.nodeType === 3) {
                let match;
                let parent = node.parentNode;
                let text = node.nodeValue;
                let frag = document.createDocumentFragment();
                let lastIndex = 0;
                regex.lastIndex = 0;
                
                while ((match = regex.exec(text)) !== null) {
                    if (match.index > lastIndex) {
                        frag.appendChild(document.createTextNode(text.slice(lastIndex, match.index)));
                    }
                    const span = document.createElement('span');
                    span.className = 'search-highlight';
                    span.textContent = match[0];
                    frag.appendChild(span);
                    results.push(span);
                    lastIndex = regex.lastIndex;
                }
                
                if (lastIndex < text.length) {
                    frag.appendChild(document.createTextNode(text.slice(lastIndex)));
                }
                if (results.length > 0) {
                    parent.replaceChild(frag, node);
                }
            } else if (node.nodeType === 1 && node.childNodes && node.tagName !== 'SCRIPT' && node.tagName !== 'STYLE') {
                for (let i = node.childNodes.length - 1; i >= 0; i--) {
                    walk(node.childNodes[i]);
                }
            }
        }

        walk(editor);
        return results;
    },

    gotoNext() {
        if (!AppState.searchResults.length) return;
        AppState.searchResults.forEach(span => span.style.outline = '');
        AppState.currentSearchIndex = (AppState.currentSearchIndex + 1) % AppState.searchResults.length;
        const span = AppState.searchResults[AppState.currentSearchIndex];
        span.scrollIntoView({behavior: "smooth", block: "center"});
        span.style.outline = '2px solid orange';
    }
};

// ===== SAVE FUNCTIONS =====
const SaveManager = {
    showSaveStatus() {
        const icon = document.getElementById('save-status');
        icon.style.display = 'inline';
        icon.style.opacity = '1';
        icon.animate([{opacity: 0.2}, {opacity: 1}], {duration: 300, iterations: 1});
        
        clearTimeout(this.saveTimeout);
        this.saveTimeout = setTimeout(() => {
            icon.style.display = 'none';
        }, 1500);
    },

    async saveNote() {
        let title = document.getElementById('note-title').value.trim();
        const editor = document.getElementById('evernote-editor');
        Editor.syncCheckboxStates(editor);
        
        // Lấy content nhưng loại bỏ phần images-section để không lưu trong content
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = editor.innerHTML;
        const imagesSection = tempDiv.querySelector('.images-section');
        if (imagesSection) {
            imagesSection.remove();
        }
        const content = tempDiv.innerHTML;

        if (title === "") {
            title = `Note_${new Date().toLocaleString('sv-SE').replace(/[:\s]/g, '_').slice(0, -3)}`;
            document.getElementById('note-title').value = title;
        }

        if (!AppState.currentId) {
            if (title !== "" || content !== "") {
                const data = await API.createNote(title, content);
                await NoteManager.loadNotes();
                NoteManager.selectNote(data.id);
            }
        } else {
            const note = AppState.notes.find(n => n.id === AppState.currentId);
            if (note) {
                note.title = title;
                note.content = content;
                // Không cần truyền images vì đã được xử lý riêng trong upload
                await API.updateNote(AppState.currentId, title, content);
            }
        }

        AppState.lastSavedTitle = title;
        AppState.lastSavedContent = content;
        this.showSaveStatus();
    },

    autoSave: Utils.debounce(function() {
        const title = document.getElementById('note-title').value.trim();
        const editor = document.getElementById('evernote-editor');
        
        // Lấy content mà không có images-section
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = editor.innerHTML;
        const imagesSection = tempDiv.querySelector('.images-section');
        if (imagesSection) {
            imagesSection.remove();
        }
        const content = tempDiv.innerHTML;
        
        if (title !== AppState.lastSavedTitle || content !== AppState.lastSavedContent) {
            SaveManager.saveNote();
        }
    }, 5000)
};

// ===== UI HANDLERS =====
const UIHandlers = {
    setupSidebar() {
        const sidebar = document.querySelector('.evernote-sidebar');
        const main = document.querySelector('.evernote-main');
        const toggleBtn = document.getElementById('toggle-sidebar-btn');
        const toggleIcon = document.getElementById('toggle-sidebar-icon');
        let collapsed = false;

        toggleBtn.onclick = () => {
            collapsed = !collapsed;
            sidebar.classList.toggle('collapsed', collapsed);
            main.classList.toggle('expanded', collapsed);
            toggleIcon.textContent = collapsed ? '>' : '<';
        };
    },

    setupMobileList() {
        const noteList = document.getElementById('note-list');
        const toggleBtn = document.getElementById('toggle-list-btn');
        const toggleIcon = document.getElementById('toggle-list-icon');
        let collapsed = false;

        toggleBtn.onclick = () => {
            collapsed = !collapsed;
            noteList.classList.toggle('collapsed', collapsed);
            toggleIcon.classList.toggle('bi-chevron-bar-up', !collapsed);
            toggleIcon.classList.toggle('bi-chevron-bar-down', collapsed);
        };
    },

    setupSearch() {
        const searchBtn = document.getElementById('search-btn');
        const searchModal = document.getElementById('searchModal');
        const searchTextbox = document.getElementById('search-textbox');

        searchBtn.onclick = () => {
            searchBtn.classList.add('effect-click');
            setTimeout(() => searchBtn.classList.remove('effect-click'), 200);

            if (!AppState.searchActive) {
                searchBtn.classList.add('active');
                AppState.searchActive = true;
                AppState.searchModalInstance = new bootstrap.Modal(searchModal);
                searchTextbox.value = "";
                AppState.searchModalInstance.show();
                
                searchModal.addEventListener('shown.bs.modal', function handler() {
                    searchTextbox.focus();
                    searchModal.removeEventListener('shown.bs.modal', handler);
                });
            } else {
                searchBtn.classList.remove('active');
                AppState.searchActive = false;
                Search.clearHighlight();
                AppState.searchResults = [];
                AppState.currentSearchIndex = -1;
                AppState.lastSearchTerm = "";
                if (AppState.searchModalInstance) {
                    AppState.searchModalInstance.hide();
                }
            }
        };

        searchTextbox.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                this.hideSearchModal();
                
                const term = searchTextbox.value.trim();
                AppState.lastSearchTerm = term;
                if (!term) return;
                
                if (!AppState.searchResults.length) {
                    AppState.searchResults = Search.highlightTerm(term);
                    AppState.currentSearchIndex = -1;
                }
                if (AppState.searchResults.length) {
                    Search.gotoNext();
                }
            }
        });

        searchTextbox.addEventListener('input', () => {
            Search.clearHighlight();
            AppState.searchResults = [];
            AppState.currentSearchIndex = -1;
            this.showSearchModal();
            AppState.lastSearchTerm = searchTextbox.value.trim();
        });

        searchModal.addEventListener('hidden.bs.modal', () => {
            this.showSearchModal();
            if (AppState.searchResults.length > 0 && AppState.lastSearchTerm) {
                searchBtn.classList.add('active');
                AppState.searchActive = true;
            } else {
                searchBtn.classList.remove('active');
                AppState.searchActive = false;
                Search.clearHighlight();
                AppState.searchResults = [];
                AppState.currentSearchIndex = -1;
                AppState.lastSearchTerm = "";
            }
        });
    },

    hideSearchModal() {
        const modal = document.getElementById('searchModal');
        modal.querySelector('.modal-content').style.opacity = '0.2';
        const backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) backdrop.style.display = 'none';
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        modal.removeAttribute('tabindex');
    },

    showSearchModal() {
        const modal = document.getElementById('searchModal');
        modal.querySelector('.modal-content').style.opacity = '1';
        const backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) backdrop.style.display = '';
        document.body.classList.add('modal-open');
    },

    setupVisualViewport() {
        if (window.visualViewport) {
            AppState.originalEditorHeight = document.getElementById('evernote-editor').style.height;
            
            window.visualViewport.addEventListener('resize', () => {
                const editor = document.getElementById('evernote-editor');
                const toolbar = document.querySelector('.evernote-toolbar');
                
                if (window.visualViewport.height < window.innerHeight * 0.7) {
                    toolbar.style.position = 'sticky';
                    toolbar.style.top = '0';
                    toolbar.style.zIndex = '10';
                    
                    const availableHeight = window.visualViewport.height - toolbar.offsetHeight - 20;
                    editor.style.height = `${availableHeight}px`;
                    editor.style.maxHeight = `${availableHeight}px`;
                } else {
                    editor.style.height = AppState.originalEditorHeight || '100%';
                    editor.style.maxHeight = '100%';
                }
            });
        }
    }
};

// ===== GLOBAL FUNCTIONS (for inline handlers) =====
function format(cmd, value = null) {
    document.execCommand(cmd, false, value);
    document.getElementById('evernote-editor').focus();
}

function setFontSize(size) {
    if (!size) return;
    document.execCommand('fontSize', false, 7);
    const editor = document.getElementById('evernote-editor');
    const fonts = editor.querySelectorAll('font[size="7"]');
    fonts.forEach(font => {
        const span = document.createElement('span');
        span.style.fontSize = size;
        span.innerHTML = font.innerHTML;
        font.parentNode.replaceChild(span, font);
    });
    editor.focus();
}

function toggleFormat(event, cmd, btn) {
    Editor.toggleFormat(event, cmd, btn);
}

function toggleChecklist(event, btn) {
    Editor.toggleChecklist(event, btn);
}

// ===== EVENT LISTENERS =====
document.addEventListener('DOMContentLoaded', () => {
    // Setup UI handlers
    UIHandlers.setupSidebar();
    UIHandlers.setupMobileList();
    UIHandlers.setupSearch();
    UIHandlers.setupVisualViewport();

    // Setup button events
    document.getElementById('add-note-btn').onclick = () => NoteManager.addNote();
    document.getElementById('delete-note-btn').onclick = () => {
        AppState.pendingDelete = true;
        const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        modal.show();
    };
    document.getElementById('confirm-delete-btn').onclick = async () => {
        if (AppState.pendingDelete) {
            await NoteManager.deleteNote();
            AppState.pendingDelete = false;
            bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
        }
    };
    document.getElementById('clear-title-btn').onclick = () => {
        document.getElementById('note-title').value = "";
        document.getElementById('note-title').focus();
    };

    // Setup editor events
    const editor = document.getElementById('evernote-editor');
    editor.onblur = () => SaveManager.saveNote();
    editor.addEventListener('keyup', Editor.updateFormatButtons);
    editor.addEventListener('mouseup', Editor.updateFormatButtons);
    editor.addEventListener('focus', Editor.updateFormatButtons);
    editor.addEventListener('input', SaveManager.autoSave);
    
    // Thêm event listener cho paste ảnh
    editor.addEventListener('paste', (e) => {
        if (AppState.currentId) {
            ImageManager.handlePaste(e, AppState.currentId);
        }
    });

    editor.addEventListener('keydown', (e) => {
        if (AppState.checklistActive && e.key === 'Enter') {
            e.preventDefault();
            document.execCommand('insertHTML', false, '<br><input type="checkbox" style="transform:scale(1.2);margin-right:6px;">');
            const sel = window.getSelection();
            if (sel.rangeCount > 0) {
                const range = sel.getRangeAt(0);
                range.collapse(false);
            }
        }
    });

    // Tạo input file cho upload ảnh
    const imageUploadInput = ImageManager.createImageUpload();
    
    // Thêm button upload ảnh vào toolbar
    const toolbar = document.querySelector('.evernote-toolbar');
    const uploadBtn = document.createElement('button');
    uploadBtn.className = 'btn btn-light btn-sm';
    uploadBtn.type = 'button';
    uploadBtn.title = 'Upload ảnh';
    uploadBtn.innerHTML = '<i class="bi bi-image"></i>';
    uploadBtn.onclick = () => {
        if (AppState.currentId) {
            imageUploadInput.click();
        } else {
            alert('Vui lòng chọn hoặc tạo note trước');
        }
    };
    
    // Thêm vào toolbar sau button search
    const searchBtn = document.getElementById('search-btn');
    searchBtn.parentNode.insertBefore(uploadBtn, searchBtn.nextSibling);


    // Load initial data
    NoteManager.loadNotes();
});
// Expose ImageManager globally for onclick handlers
window.ImageManager = ImageManager;
</script>
{% endblock %}