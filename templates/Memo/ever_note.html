{% extends "Memo/base.html" %}
{% block title %}Evernote{% endblock %}
{% block content %}
<style>
/* ===== BASE STYLES ===== */
.evernote-layout,
.evernote-sidebar,
.evernote-main,
.evernote-editor,
.evernote-toolbar {
    font-family: "Segoe UI", "Helvetica Neue", Arial, "Noto Sans JP", "Noto Sans", "Meiryo", "Yu Gothic", "Tahoma", sans-serif;
}

.evernote-layout {
    display: flex;
    height: 100%;
}

/* ===== SIDEBAR STYLES ===== */
.evernote-sidebar {
    background: var(--card-bg, #f8f9fa);
    min-width: 220px;
    max-width: 260px;
    height: 70vh;
    overflow-y: auto;
    padding: 0;
    transition: all 0.2s ease;
}

.evernote-sidebar .list-group-item {
    background: transparent;
    border: none;
    color: var(--text-color, #222);
    cursor: pointer;
}

.evernote-sidebar .list-group-item.active {
    background: var(--bg-color, #e3f2fd);
    color: #1976d2;
    font-weight: bold;
}

.evernote-sidebar.collapsed {
    min-width: 55px !important;
    max-width: 55px !important;
    width: 55px !important;
    overflow-x: hidden;
}

.evernote-sidebar.collapsed .fw-bold,
.evernote-sidebar.collapsed .list-group,
.evernote-sidebar.collapsed .btn:not(#toggle-sidebar-btn) {
    display: none !important;
}

/* Desktop button spacing */
@media (min-width: 992px) {
    .evernote-sidebar .d-flex > div {
        display: flex !important;
        flex-wrap: nowrap !important;
        gap: 0.25rem !important;
        align-items: center !important;
    }
    
    .evernote-sidebar .btn-sm {
        min-width: 32px !important;
        height: 32px !important;
        padding: 0.25rem !important;
        margin: 0 !important;
        font-size: 0.875rem !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        flex-shrink: 0 !important;
    }
}

/* ===== MAIN CONTENT STYLES ===== */
.evernote-main {
    flex: 1 1 0;
    padding: 0 1.5rem;
    min-width: 0;
    display: flex;
    flex-direction: column;
    height: 70vh;
}

.evernote-main.expanded {
    padding-left: 0 !important;
}

/* ===== TOOLBAR STYLES ===== */
.evernote-toolbar {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.evernote-toolbar .btn,
.evernote-toolbar .form-select {
    min-width: 36px;
    padding: 0.25rem 0.5rem;
}

.evernote-toolbar .btn.effect-click {
    box-shadow: 0 0 0 0.2rem #90caf9;
    background-color: #e3f2fd !important;
    transition: box-shadow 0.2s, background-color 0.2s;
}

/* ===== EDITOR STYLES ===== */
.evernote-editor {
    flex: 1 1 0;
    background: var(--bg-color, #fff);
    padding: 1rem;
    margin-top: 1rem;
    overflow-y: auto;
    min-height: 250px;
    outline: none;
    font-size: 1rem;
    color: var(--text-color, #222);
    display: flex;
    flex-direction: column;
    line-height: 1.5; /* Thêm dòng này để kiểm soát khoảng cách dòng */
}

/* Kiểm soát margin của paragraphs */
.evernote-editor p {
    margin: 0; /* Khoảng cách trên/dưới paragraph */
}

/* Kiểm soát margin của line breaks */
.evernote-editor br {
    margin: 0; /* Khoảng cách cho line break */
}

/* Kiểm soát margin của divs */
.evernote-editor div {
    margin: 0;
}

.evernote-editor a {
    cursor: pointer;
    text-decoration: underline;
}

.evernote-editor input[type="checkbox"] {
    cursor: pointer;
}

.evernote-editor > *:not(.images-section) {
    order: 1; /* Text content có order thấp hơn */
}

/* ===== SEARCH STYLES ===== */
.search-highlight {
    background: yellow;
    color: #222;
    border-radius: 2px;
}

#searchModal .modal-dialog {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    margin: 0;
    z-index: 1060;
    width: 320px;
    max-width: 90vw;
}

#searchModal .modal-content {
    box-shadow: 0 2px 16px rgba(0,0,0,0.15);
}

/* ===== IMAGE STYLES ===== */
.image-container {
    margin: 10px 5px;
    position: relative;
    display: inline-block;
    max-width: 100%;
    vertical-align: top;
}

.image-container img {
    max-width: 100%;
    height: auto;
    border-radius: 4px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.2s, cursor 0.2s;
    cursor: pointer;
    display: block;
    margin: 0 auto;
}

.image-container:hover img {
    transform: scale(1.02);
}

.delete-image-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(255, 0, 0, 0.8);
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    cursor: pointer;
    font-size: 12px;
    line-height: 1;
    opacity: 0;
    transition: opacity 0.2s;
}

.image-container:hover .delete-image-btn {
    opacity: 1;
}

.images-section {
    border-top: 1px solid #e0e0e0;
    padding-top: 15px;
    margin-top: 15px;
    order: 999; /* Đảm bảo luôn ở cuối */
    background: var(--card-bg);
    text-align: center; /* Căn giữa các ảnh */
}

/* ===== IMAGE LIGHTBOX STYLES ===== */
.image-lightbox {
    display: none;
    position: fixed;
    z-index: 10000;
    padding-top: 50px;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.9);
}

.lightbox-content {
    margin: auto;
    display: block;
    width: 90%;
    max-width: 1200px;
    max-height: 80%;
    object-fit: contain;
    border-radius: 8px;
    animation: zoom 0.3s;
}

@keyframes zoom {
    from {transform: scale(0.1)}
    to {transform: scale(1)}
}

.lightbox-close {
    position: absolute;
    top: 15px;
    right: 35px;
    color: #f1f1f1;
    font-size: 40px;
    font-weight: bold;
    transition: 0.3s;
    cursor: pointer;
    z-index: 10001;
}

.lightbox-close:hover,
.lightbox-close:focus {
    color: #bbb;
    text-decoration: none;
}

.lightbox-caption {
    margin: auto;
    display: block;
    width: 80%;
    max-width: 700px;
    text-align: center;
    color: #ccc;
    padding: 10px 0;
    height: 150px;
}

/* ===== DESKTOP STYLES ===== */
@media (min-width: 992px) {
    .container.mt-4 {
        height: calc(100vh - 90px) !important;
        min-height: calc(100vh - 90px) !important;
        max-width: 100vw !important;
        width: 100vw !important;
        padding-left: 0 !important;
        padding-right: 0 !important;
    }
    
    .evernote-layout {
        height: 100%;
    }
    
    .evernote-main {
        height: 100%;
    }
    
    .evernote-editor {
        height: 100%;
        max-height: 100%;
        min-height: 0;
    }
    
    .evernote-sidebar {
        height: 100%;
        min-height: 0;
    }
}

/* ===== TABLET STYLES ===== */
@media (max-width: 900px) and (min-width: 576px) {
    .evernote-layout {
        flex-direction: column;
    }
    
    .evernote-sidebar {
        max-width: 100vw;
        min-width: 0;
        height: auto;
        border-right: none;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .evernote-main {
        padding: 0.5rem;
        height: auto;
    }
}

/* ===== MOBILE STYLES ===== */
@media (max-width: 991.98px) {
    html, body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
        overflow-x: hidden;
    }
    
    .container.mt-4 {
        height: 100vh !important;
        min-height: 100vh !important;
        max-width: 100vw !important;
        width: 100vw !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    
    .evernote-layout {
        flex-direction: column !important;
        height: 100%;
        min-height: 100%;
        width: 100vw;
        max-width: 100vw;
    }
    
    .evernote-sidebar {
        max-width: 100vw;
        min-width: 0;
        width: 100vw;
        height: auto;
        border-right: none;
        border-bottom: 1px solid #e0e0e0;
        flex-shrink: 0;
    }
    
    /* Hide desktop toggle button on mobile */
    #toggle-sidebar-btn {
        display: none !important;
    }
    
    /* Mobile button spacing improvements */
    .evernote-sidebar .d-flex > div {
        gap: 0.75rem !important;
        display: flex !important;
        flex-wrap: wrap;
        justify-content: space-between !important; /* Thêm dòng này */
        width: 100% !important; /* Đảm bảo chiếm full width */
    }
    
    .evernote-sidebar .btn-sm {
        min-width: 44px !important;
        min-height: 44px !important;
        padding: 0.5rem !important;
        margin: 0.25rem !important;
        font-size: 1.1rem !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }
    
    /* Specific spacing for action buttons */
    #add-note-btn,
    #share-link-btn, 
    #delete-note-btn,
    #toggle-list-btn {
        margin-right: 0.5rem !important;
        margin-left: 0.25rem !important;
    }
    
    .evernote-main {
        padding: 0.5rem;
        height: 100%;
        min-height: 0;
        flex: 1 1 0;
        width: 100vw;
        max-width: 100vw;
    }
    
    .evernote-editor {
        flex: 1 1 0;
        min-height: 0;
        height: 100%;
        max-height: 100%;
        margin-top: 0.5rem;
        padding: 0.5rem;
        width: 100%;
        box-sizing: border-box;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .evernote-toolbar {
        position: sticky;
        top: 0;
        z-index: 10;
        background: var(--card-bg, #fff);
        padding: 0.5rem 0;
        border-bottom: 1px solid #e0e0e0;
        transition: all 0.2s ease;
        flex-wrap: wrap;
        gap: 0.25rem;
        row-gap: 0.25rem;
    }
    
    .evernote-toolbar > * {
        margin-bottom: 0.25rem;
        flex: 0 0 auto;
    }
    
    .evernote-toolbar input,
    .evernote-toolbar select,
    .evernote-toolbar button {
        font-size: 0.95rem;
        padding: 0.25rem 0.5rem;
        min-width: 32px;
        max-width: 100%;
    }
    
    .evernote-toolbar .form-control {
        min-width: 120px;
        max-width: 100%;
    }
    
    #note-list.collapsed {
        display: none !important;
    }
    
    /* Mobile lightbox adjustments */
    .lightbox-content {
        width: 95%;
        max-height: 70%;
    }
    
    .lightbox-close {
        top: 10px;
        right: 20px;
        font-size: 30px;
    }
    
    .lightbox-caption {
        font-size: 14px;
        padding: 5px 0;
        height: 100px;
    }
}
/* Icon link styles */
.btn-link-share {
    background: linear-gradient(45deg, #007bff, #0056b3);
    color: white;
    border: none;
}

.btn-link-share:hover {
    background: linear-gradient(45deg, #0056b3, #004085);
    color: white;
    transform: scale(1.05);
}

.btn-link-share.effect-click {
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);
    background: linear-gradient(45deg, #0056b3, #004085);
}
@media (min-width: 992px) {
    .evernote-sidebar .d-flex > div {
        display: flex !important;
        flex-wrap: nowrap !important;
        gap: 0.25rem !important;
        align-items: center !important;
        justify-content: space-between !important; /* Thêm dòng này */
    }
    
    .evernote-sidebar .btn-sm {
        min-width: 32px !important;
        height: 32px !important;
        padding: 0.25rem !important;
        margin: 0 !important;
        font-size: 0.875rem !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        flex-shrink: 0 !important;
    }
    
    /* Hide mobile toggle button on desktop */
    #toggle-list-btn {
        display: none !important;
    }
    /* Đảm bảo các button action (add, share, delete) nhóm lại với nhau */
    .evernote-sidebar .d-flex > div > .btn:not(#toggle-list-btn) {
        margin-right: 0.25rem !important;
        margin-left: 0 !important;
    }
    #toggle-list-btn {
        margin-left: auto !important;
        margin-right: 0 !important;
    }
    
}
.evernote-sidebar .d-flex {
    display: block !important;
}
/* Thêm CSS cho bảng */
.evernote-editor table {
    border-collapse: collapse;
    width: 100%;
    margin: 10px 0;
}

.evernote-editor table, 
.evernote-editor th, 
.evernote-editor td {
    border: 1px solid #ddd;
}

.evernote-editor th, 
.evernote-editor td {
    padding: 8px;
    text-align: left;
}

.evernote-editor th {
    background-color: #f5f5f5;
    font-weight: bold;
}

.evernote-editor tbody tr:nth-child(even) {
    background-color: #f9f9f9;
}

</style>

<div class="evernote-layout d-flex">
    <!-- Sidebar -->
    <div class="evernote-sidebar">
        <div class="d-flex justify-content-between align-items-center px-3 py-2">
                <span id="save-status" style="margin-left:8px; color:#43a047; font-size:1.2em; display:none;">
                    <i class="bi bi-cloud-check-fill"></i>
                </span>
                <div>
                    <button class="btn btn-success btn-sm" id="add-note-btn"><i class="bi bi-plus"></i></button>
                    <button class="btn btn-link-share btn-sm" id="share-link-btn" title="Tạo link chia sẻ"><i class="bi bi-link-45deg"></i></button>
                    <button class="btn btn-danger btn-sm" id="delete-note-btn" title="Xóa"><i class="bi bi-trash"></i></button>
                    <button class="btn btn-outline-secondary btn-sm d-none d-lg-block" id="toggle-sidebar-btn" title="Thu gọn/Mở rộng sidebar">
                        <span id="toggle-sidebar-icon">&lt;</span>
                    </button>
                    <button class="btn btn-secondary btn-sm d-lg-none" id="toggle-list-btn" title="Ẩn/Hiện danh sách">
                        <i class="bi bi-chevron-bar-up" id="toggle-list-icon"></i>
                    </button>
                </div>
        </div>
        <ul class="list-group list-group-flush" id="note-list"></ul>
    </div>

    <!-- Main content -->
    <div class="evernote-main">
        <div class="evernote-toolbar">
            <div style="position: relative; display: inline-block; max-width:200px; width:100%;">
                <input type="text" class="form-control" id="note-title" placeholder="Tiêu đề ghi chú..." style="padding-right:28px;" tabindex="1">
                <button type="button" id="clear-title-btn" style="position:absolute; right:4px; top:50%; transform:translateY(-50%); border:none; background:transparent; padding:0; margin:0; font-size:1.1em; color:#888; cursor:pointer; z-index:2;" title="Xóa tiêu đề">&times;</button>
            </div>
            <button type="button" id="search-btn" class="btn btn-light btn-sm" title="Tìm kiếm"><i class="bi bi-search"></i></button>
            <div class="vr mx-2"></div>
            
            <!-- Format toolbar -->
            <button class="btn btn-light btn-sm" type="button" id="bold-btn" title="In đậm" onmousedown="toggleFormat(event, 'bold', this)"><b>B</b></button>
            <button class="btn btn-light btn-sm" type="button" id="italic-btn" title="In nghiêng" onmousedown="toggleFormat(event, 'italic', this)"><i>I</i></button>
            <button class="btn btn-light btn-sm" type="button" id="underline-btn" title="Gạch chân" onmousedown="toggleFormat(event, 'underline', this)"><u>U</u></button>
            <button class="btn btn-light btn-sm" type="button" id="strike-btn" title="Gạch bỏ" onmousedown="toggleFormat(event, 'strikeThrough', this)"><s>S</s></button>
            
            <select class="form-select form-select-sm" style="width:90px;display:inline-block;" onchange="format('formatBlock', this.value)">
                <option value="p">Body</option>
                <option value="h1">H1</option>
                <option value="h2">H2</option>
                <option value="h3">H3</option>
            </select>
            
            <select class="form-select form-select-sm" style="width:80px;display:inline-block;" onchange="setFontSize(this.value)">
                <option value="">Size</option>
                <option value="9pt">9</option>
                <option value="10pt">10</option>
                <option value="11pt">11</option>
                <option value="12pt">12</option>
                <option value="14pt">14</option>
                <option value="16pt">16</option>
                <option value="18pt">18</option>
                <option value="20pt">20</option>
                <option value="24pt">24</option>
                <option value="28pt">28</option>
                <option value="32pt">32</option>
                <option value="36pt">36</option>
                <option value="40pt">40</option>
                <option value="44pt">44</option>
                <option value="48pt">48</option>
                <option value="50pt">50</option>
            </select>
            
            <input type="color" class="form-control form-control-color form-control-sm" title="Màu chữ" onchange="format('foreColor', this.value)" style="width:36px;">
            <div class="vr mx-2"></div>
            
            <!-- List and alignment -->
            <button class="btn btn-light btn-sm" type="button" id="ordered-btn" title="Danh sách số" onmousedown="toggleFormat(event, 'insertOrderedList', this)"><i class="bi bi-list-ol"></i></button>
            <button class="btn btn-light btn-sm" type="button" id="unordered-btn" title="Danh sách chấm" onmousedown="toggleFormat(event, 'insertUnorderedList', this)"><i class="bi bi-list-ul"></i></button>
            <button class="btn btn-light btn-sm" type="button" id="checklist-btn" title="Checklist" onmousedown="toggleChecklist(event, this)"><i class="bi bi-check2-square"></i></button>
            <button class="btn btn-light btn-sm" type="button" id="left-btn" title="Căn trái" onmousedown="toggleFormat(event, 'justifyLeft', this)"><i class="bi bi-text-left"></i></button>
            <button class="btn btn-light btn-sm" type="button" id="center-btn" title="Căn giữa" onmousedown="toggleFormat(event, 'justifyCenter', this)"><i class="bi bi-text-center"></i></button>
            <button class="btn btn-light btn-sm" type="button" id="right-btn" title="Căn phải" onmousedown="toggleFormat(event, 'justifyRight', this)"><i class="bi bi-text-right"></i></button>
        </div>
        
        <div id="evernote-editor" class="evernote-editor" contenteditable="true" tabindex="2"></div>
        <div id="note-meta" style="font-size:0.95em; color:#888; margin-top:8px;"></div>
    </div>
</div>

<!-- Share Link Modal -->
<div class="modal fade" id="shareLinkModal" tabindex="-1" aria-labelledby="shareLinkLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <div id="share-link-content">
                    <p>Đang tạo link chia sẻ...</p>
                </div>
                <div id="share-link-result" style="display: none;">
                    <div class="mb-3">
                        <label for="share-link-input" class="form-label">Link chia sẻ:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="share-link-input" readonly>
                            <button class="btn btn-outline-secondary" type="button" id="copy-link-btn">
                                <i class="bi bi-clipboard"></i> Copy
                            </button>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        Link này cho phép mọi người xem nội dung ghi chú mà không cần đăng nhập.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Thêm Image Lightbox Modal -->
<div id="imageLightbox" class="image-lightbox">
    <span class="lightbox-close">&times;</span>
    <img class="lightbox-content" id="lightboxImg">
    <div class="lightbox-caption" id="lightboxCaption"></div>
</div>

<!-- Modals -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmLabel">Xác nhận</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                Bạn có chắc muốn xóa ghi chú này không?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">Xóa</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-body py-2">
                <input type="text" id="search-textbox" class="form-control form-control-sm" placeholder="Nhập từ khóa...">
            </div>
        </div>
    </div>
</div>

<script>
// ===== APPLICATION STATE =====
const AppState = {
    notes: [],
    currentId: null,
    pendingDelete: false,
    checklistActive: false,
    searchActive: false,
    searchResults: [],
    currentSearchIndex: -1,
    lastSearchTerm: "",
    lastSavedTitle: "",
    lastSavedContent: "",
    searchModalInstance: null,
    originalEditorHeight: null,
    currentImages: []  // Thêm để track ảnh hiện tại
};

// ===== SHARE LINK FUNCTIONS =====
const ShareLink = {
    async generateShareLink(noteId) {
        try {
            const response = await fetch(`/api/evernote_notes/${noteId}/share`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const result = await response.json();
                return result.share_url;
            } else {
                const error = await response.json();
                throw new Error(error.message || 'Không thể tạo link chia sẻ');
            }
        } catch (error) {
            console.error('Error generating share link:', error);
            throw error;
        }
    },

    showShareModal(shareUrl) {
        const modal = new bootstrap.Modal(document.getElementById('shareLinkModal'));
        const linkInput = document.getElementById('share-link-input');
        const resultDiv = document.getElementById('share-link-result');
        const contentDiv = document.getElementById('share-link-content');
        
        linkInput.value = shareUrl;
        contentDiv.style.display = 'none';
        resultDiv.style.display = 'block';
        
        modal.show();
    },

    copyToClipboard() {
        const linkInput = document.getElementById('share-link-input');
        linkInput.select();
        linkInput.setSelectionRange(0, 99999); // For mobile devices
        
        try {
            document.execCommand('copy');
            const copyBtn = document.getElementById('copy-link-btn');
            const originalText = copyBtn.innerHTML;
            copyBtn.innerHTML = '<i class="bi bi-check"></i> Đã copy!';
            copyBtn.classList.add('btn-success');
            copyBtn.classList.remove('btn-outline-secondary');
            
            setTimeout(() => {
                copyBtn.innerHTML = originalText;
                copyBtn.classList.remove('btn-success');
                copyBtn.classList.add('btn-outline-secondary');
            }, 2000);
        } catch (err) {
            console.error('Could not copy text: ', err);
            alert('Không thể copy link. Vui lòng copy thủ công.');
        }
    }
};

// ===== IMAGE FUNCTIONS =====
const ImageManager = {
    // Upload ảnh từ file input
    async uploadImages(files, noteId) {
        if (!files || files.length === 0) return;
        
        // LƯU VỊ TRÍ CURSOR TRƯỚC KHI UPLOAD
        const editor = document.getElementById('evernote-editor');
        const selection = window.getSelection();
        let savedRange = null;
        if (selection.rangeCount > 0) {
            savedRange = selection.getRangeAt(0).cloneRange();
        }
        
        // Hiển thị loading
        this.showUploadStatus('Đang upload ảnh...');
        
        const formData = new FormData();
        Array.from(files).forEach(file => {
            formData.append('images', file);
        });
        
        try {
            const response = await fetch(`/api/evernote_notes/${noteId}/upload_images`, {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                const result = await response.json();
                this.showUploadStatus(`Upload thành công ${result.processed_count} ảnh!`, 'success');
                
                // Cập nhật state local
                AppState.currentImages = result.images || [];
                
                // Cập nhật ảnh trong editor
                this.updateImagesInEditor(AppState.currentImages);
                
                // KHÔI PHỤC VỊ TRÍ CURSOR
                if (savedRange) {
                    try {
                        selection.removeAllRanges();
                        selection.addRange(savedRange);
                    } catch (e) {
                        // Nếu không thể khôi phục range cũ, đặt cursor ở cuối text content
                        const textNodes = this.getTextNodes(editor);
                        if (textNodes.length > 0) {
                            const lastTextNode = textNodes[textNodes.length - 1];
                            const range = document.createRange();
                            range.setStart(lastTextNode, lastTextNode.textContent.length);
                            range.collapse(true);
                            selection.removeAllRanges();
                            selection.addRange(range);
                        }
                    }
                    editor.focus();
                }
                
                // Reload notes để cập nhật sidebar (không reload selectNote)
                const oldCurrentId = AppState.currentId;
                AppState.notes = await API.fetchNotes();
                NoteManager.renderNoteList();
                AppState.currentId = oldCurrentId;
                
                return result;
            } else {
                const error = await response.json();
                this.showUploadStatus(`Lỗi upload: ${error.message}`, 'error');
            }
        } catch (error) {
            console.error('Error uploading images:', error);
            this.showUploadStatus('Lỗi upload ảnh!', 'error');
        }
    },

    // THÊM HÀM HỖ TRỢ: Lấy tất cả text nodes trong editor (trừ images-section)
    getTextNodes(element) {
        const textNodes = [];
        const walker = document.createTreeWalker(
            element,
            NodeFilter.SHOW_TEXT,
            {
                acceptNode: function(node) {
                    // Bỏ qua text nodes trong images-section
                    const parent = node.parentElement;
                    if (parent && (parent.closest('.images-section') || parent.classList.contains('images-section'))) {
                        return NodeFilter.FILTER_REJECT;
                    }
                    return NodeFilter.FILTER_ACCEPT;
                }
            }
        );
        
        let node;
        while (node = walker.nextNode()) {
            if (node.textContent.trim()) {
                textNodes.push(node);
            }
        }
        return textNodes;
    },
    
    // Hiển thị trạng thái upload
    showUploadStatus(message, type = 'info') {
        // Tạo hoặc cập nhật status element
        let statusDiv = document.getElementById('upload-status');
        if (!statusDiv) {
            statusDiv = document.createElement('div');
            statusDiv.id = 'upload-status';
            statusDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 10px 15px;
                border-radius: 5px;
                z-index: 9999;
                font-size: 14px;
                max-width: 300px;
            `;
            document.body.appendChild(statusDiv);
        }
        
        // Set style based on type
        const styles = {
            info: 'background: #e3f2fd; color: #1976d2; border: 1px solid #90caf9;',
            success: 'background: #e8f5e8; color: #2e7d32; border: 1px solid #81c784;',
            error: 'background: #ffebee; color: #c62828; border: 1px solid #ef9a9a;'
        };
        
        statusDiv.style.cssText += styles[type] || styles.info;
        statusDiv.textContent = message;
        statusDiv.style.display = 'block';
        
        // Auto hide after 3 seconds
        setTimeout(() => {
            if (statusDiv) {
                statusDiv.style.display = 'none';
            }
        }, 3000);
    },
    
    // Xử lý paste ảnh từ clipboard
    async handlePaste(event, noteId) {
        const items = (event.clipboardData || event.originalEvent.clipboardData).items;
        let hasImage = false;
        
        for (let item of items) {
            if (item.type.indexOf('image') !== -1) {
                // Có ảnh - xử lý upload ảnh
                event.preventDefault();
                hasImage = true;
                const file = item.getAsFile();
                if (file && noteId) {
                    this.showUploadStatus('Đang xử lý ảnh từ clipboard...');
                    await this.uploadImages([file], noteId);
                }
                break;
            }
        }
        
        // Nếu không có ảnh, để browser xử lý paste text bình thường
        if (!hasImage) {
            // Không preventDefault - để text được paste vào vị trí cursor hiện tại
            console.log('Pasting text content...');
        }
    },

    // THÊM HÀM displayImages - HÀM NÀY BỊ THIẾU
    displayImages(images) {
        if (!images || images.length === 0) return '';
        
        return images.map(img => {
            return `<div class="image-container" style="margin: 10px 0; position: relative; display: inline-block;">
                <img src="data:image/jpeg;base64,${img.data}" 
                     style="max-width: 100%; height: auto; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer;" 
                     alt="${img.filename}"
                     onclick="ImageManager.showLightbox('data:image/jpeg;base64,${img.data}', '${img.filename}')">
                <button type="button" class="delete-image-btn" 
                        onclick="ImageManager.deleteImage('${img.id}', ${AppState.currentId})"
                        style="position: absolute; top: 5px; right: 5px; background: rgba(255,0,0,0.8); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 12px; line-height: 1;"
                        title="Xóa ảnh">×</button>
            </div>`;
        }).join('');
    },
    
    // Hiển thị ảnh trong lightbox
    showLightbox(imageSrc, filename) {
        const lightbox = document.getElementById('imageLightbox');
        const lightboxImg = document.getElementById('lightboxImg');
        const lightboxCaption = document.getElementById('lightboxCaption');
        
        lightbox.style.display = 'block';
        lightboxImg.src = imageSrc;
        lightboxCaption.textContent = filename || 'Image';
        
        // Disable body scroll
        document.body.style.overflow = 'hidden';
    },
    
    // Đóng lightbox
    closeLightbox() {
        const lightbox = document.getElementById('imageLightbox');
        lightbox.style.display = 'none';
        
        // Re-enable body scroll
        document.body.style.overflow = '';
    },

    // Đảm bảo chỉ có 1 images-section
    ensureSingleImagesSection() {
        const editor = document.getElementById('evernote-editor');
        const imagesSections = editor.querySelectorAll('.images-section');
        
        // Nếu có nhiều hơn 1 images-section
        if (imagesSections.length > 1) {
            // Xóa tất cả trừ section cuối cùng
            for (let i = 0; i < imagesSections.length - 1; i++) {
                imagesSections[i].remove();
            }
        }
    },

    // Cập nhật ảnh trong editor hiện tại
    updateImagesInEditor(images) {
        const editor = document.getElementById('evernote-editor');
        
        // CHỈ XÓA images-section, KHÔNG XÓA text content
        const existingSections = editor.querySelectorAll('.images-section');
        existingSections.forEach(section => section.remove());
        
        // Nếu có ảnh, thêm vào cuối editor
        if (images && images.length > 0) {
            const imagesHTML = '<div class="images-section">' + this.displayImages(images) + '</div>';
            editor.insertAdjacentHTML('beforeend', imagesHTML);
            
            // NẾU EDITOR TRỐNG (chỉ có images-section), đặt cursor ở đầu để user có thể gõ text
            const textContent = editor.innerText.trim();
            if (!textContent || textContent === '') {
                // Tạo một đoạn văn trống ở đầu editor
                const p = document.createElement('p');
                p.innerHTML = '<br>'; // Placeholder để cursor có thể focus
                editor.insertBefore(p, editor.firstChild);
                
                // Đặt cursor vào đoạn văn trống
                const range = document.createRange();
                const sel = window.getSelection();
                range.setStart(p, 0);
                range.collapse(true);
                sel.removeAllRanges();
                sel.addRange(range);
                editor.focus();
            }
        }
        // Cập nhật state
        AppState.currentImages = images || [];
    },
    
    // Xóa ảnh
    async deleteImage(imageId, noteId) {
        if (!confirm('Bạn có chắc muốn xóa ảnh này?')) return;
        
        try {
            const response = await fetch(`/api/evernote_notes/${noteId}/delete_image/${imageId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                this.showUploadStatus('Xóa ảnh thành công!', 'success');
                
                // Cập nhật state local (xóa ảnh khỏi currentImages)
                AppState.currentImages = AppState.currentImages.filter(img => img.id !== imageId);
                
                // Cập nhật ảnh trong editor ngay lập tức
                this.updateImagesInEditor(AppState.currentImages);
                
                // Reload notes để cập nhật sidebar
                const oldCurrentId = AppState.currentId;
                AppState.notes = await API.fetchNotes();
                NoteManager.renderNoteList();
                AppState.currentId = oldCurrentId;
            } else {
                this.showUploadStatus('Lỗi xóa ảnh!', 'error');
            }
        } catch (error) {
            console.error('Error deleting image:', error);
            this.showUploadStatus('Lỗi xóa ảnh!', 'error');
        }
    },
    
    // Thêm input file cho upload ảnh
    createImageUpload() {
        const input = document.createElement('input');
        input.type = 'file';
        input.multiple = true;
        input.accept = 'image/*';
        input.style.display = 'none';
        
        input.addEventListener('change', async (e) => {
            if (AppState.currentId && e.target.files.length > 0) {
                await this.uploadImages(e.target.files, AppState.currentId);
            }
            // Reset input để có thể chọn lại cùng file
            e.target.value = '';
        });
        
        document.body.appendChild(input);
        return input;
    }
};

// ===== PASTE MANAGER (SEPARATE OBJECT) =====
const PasteManager = {
    handlePaste(event, noteId) {
        const clipboardData = event.clipboardData || window.clipboardData;
        
        // Kiểm tra xem có ảnh thực sự không (file ảnh binary)
        const items = Array.from(clipboardData.items);
        const hasImageFile = items.some(item => 
            item.type.indexOf('image') === 0 && item.kind === 'file'
        );
        
        if (hasImageFile) {
            // Có ảnh file thực sự - để ImageManager xử lý
            console.log('Found actual image file, delegating to ImageManager');
            return;
        }
        
        // Xử lý text/HTML
        event.preventDefault();
        
        const htmlData = clipboardData.getData('text/html');
        const plainText = clipboardData.getData('text/plain');
        
        console.log('HTML data length:', htmlData?.length || 0);
        console.log('Plain text length:', plainText?.length || 0);
        
        // Kiểm tra xem có phải data từ Excel không (có table structure)
        if (htmlData && this.isExcelData(htmlData)) {
            console.log('Detected Excel/table data, pasting as table');
            this.pasteAsTable(htmlData);
        } else if (plainText) {
            console.log('Pasting as plain text');
            this.pasteAsPlainText(plainText);
        }
    },
    
    // Cải thiện hàm kiểm tra Excel data
    isExcelData(htmlData) {
        // Chuyển về lowercase để kiểm tra dễ hơn
        const lowerHtml = htmlData.toLowerCase();
        
        // Kiểm tra các dấu hiệu của Excel/table data
        const hasTable = lowerHtml.includes('<table') || 
                         lowerHtml.includes('<tr') || 
                         (lowerHtml.includes('<td') && lowerHtml.includes('</td>'));
        
        const hasExcelIndicators = lowerHtml.includes('excel') || 
                                  lowerHtml.includes('xl') ||
                                  lowerHtml.includes('office') ||
                                  lowerHtml.includes('mso-') ||
                                  lowerHtml.includes('microsoft');
        
        // Kiểm tra tab-separated data trong plain text
        const clipboardData = window.clipboardData || (window.event && window.event.clipboardData);
        const plainText = clipboardData ? clipboardData.getData('text/plain') : '';
        const hasTabSeparatedData = plainText.includes('\t') && plainText.includes('\n');
        
        console.log('Table detection:', {
            hasTable,
            hasExcelIndicators, 
            hasTabSeparatedData,
            sampleHtml: htmlData.substring(0, 200),
            samplePlainText: plainText.substring(0, 100)
        });
        
        return hasTable || hasExcelIndicators || hasTabSeparatedData;
    },
    
    // Cải thiện hàm paste table
    pasteAsTable(htmlData) {
        console.log('Processing table data...');
        
        // Tạo temporary div để parse HTML
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = htmlData;
        
        // Tìm table hoặc tạo table từ structure
        let table = tempDiv.querySelector('table');
        
        if (!table) {
            // Nếu không có table tag, cố gắng tạo từ tr/td
            const rows = tempDiv.querySelectorAll('tr');
            if (rows.length > 0) {
                console.log('Creating table from TR elements, rows found:', rows.length);
                table = this.createTableFromRows(rows);
            } else {
                // Thử tạo table từ tab-separated data
                console.log('Trying to create table from tab-separated data');
                table = this.createTableFromTabData(htmlData);
            }
        }
        
        if (table) {
            console.log('Table created successfully, inserting into editor');
            // Clean table - chỉ giữ text content
            this.cleanTable(table);
            
            // Insert table vào editor
            this.insertTable(table);
        } else {
            console.log('Could not create table, falling back to plain text');
            // Fallback to plain text
            const plainText = tempDiv.textContent || htmlData.replace(/<[^>]*>/g, '');
            this.pasteAsPlainText(plainText);
        }
    },
    
    // Thêm hàm tạo table từ rows
    createTableFromRows(rows) {
        const table = document.createElement('table');
        const tbody = document.createElement('tbody');
        
        rows.forEach(row => {
            const newRow = document.createElement('tr');
            const cells = row.querySelectorAll('td, th');
            
            cells.forEach(cell => {
                const newCell = document.createElement('td');
                newCell.textContent = cell.textContent.trim();
                newRow.appendChild(newCell);
            });
            
            if (newRow.children.length > 0) {
                tbody.appendChild(newRow);
            }
        });
        
        if (tbody.children.length > 0) {
            table.appendChild(tbody);
            return table;
        }
        return null;
    },
    
    // Thêm hàm tạo table từ tab-separated data
    createTableFromTabData(htmlData) {
        // Lấy plain text và tách theo tab/newline
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = htmlData;
        const plainText = tempDiv.textContent || htmlData.replace(/<[^>]*>/g, '');
        
        const lines = plainText.split('\n').filter(line => line.trim());
        
        if (lines.length < 2) return null; // Cần ít nhất 2 dòng
        
        const table = document.createElement('table');
        const tbody = document.createElement('tbody');
        
        lines.forEach(line => {
            const cells = line.split('\t');
            if (cells.length > 1) { // Chỉ tạo row nếu có nhiều hơn 1 cell
                const row = document.createElement('tr');
                cells.forEach(cellText => {
                    const cell = document.createElement('td');
                    cell.textContent = cellText.trim();
                    row.appendChild(cell);
                });
                tbody.appendChild(row);
            }
        });
        
        if (tbody.children.length > 0) {
            table.appendChild(tbody);
            return table;
        }
        return null;
    },
    
    // Thêm hàm insert table
    insertTable(table) {
        const selection = window.getSelection();
        const editor = document.getElementById('evernote-editor');
        
        if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            range.deleteContents();
            range.insertNode(table);
            
            // Tạo một paragraph trống sau table để cursor có chỗ đứng
            const afterParagraph = document.createElement('p');
            afterParagraph.innerHTML = '<br>';
            
            // Đặt paragraph sau table
            range.setStartAfter(table);
            range.insertNode(afterParagraph);
            
            // Đặt cursor vào paragraph mới - QUAN TRỌNG: Đặt cursor vào text node
            range.setStart(afterParagraph.firstChild, 0);
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
            
            // Focus editor để đảm bảo cursor hiển thị
            editor.focus();
        } else {
            // Nếu không có selection, thêm vào cuối
            const imagesSection = editor.querySelector('.images-section');
            if (imagesSection) {
                editor.insertBefore(table, imagesSection);
                
                // Tạo paragraph sau table
                const afterParagraph = document.createElement('p');
                afterParagraph.innerHTML = '<br>';
                editor.insertBefore(afterParagraph, imagesSection);
                
                // Đặt cursor vào paragraph - QUAN TRỌNG: Vào text node
                const range = document.createRange();
                const sel = window.getSelection();
                range.setStart(afterParagraph.firstChild, 0);
                range.collapse(true);
                sel.removeAllRanges();
                sel.addRange(range);
            } else {
                editor.appendChild(table);
                
                // Tạo paragraph sau table
                const afterParagraph = document.createElement('p');
                afterParagraph.innerHTML = '<br>';
                editor.appendChild(afterParagraph);
                
                // Đặt cursor vào paragraph - QUAN TRỌNG: Vào text node
                const range = document.createRange();
                const sel = window.getSelection();
                range.setStart(afterParagraph.firstChild, 0);
                range.collapse(true);
                sel.removeAllRanges();
                sel.addRange(range);
            }
            
            // Focus editor
            editor.focus();
        }
    },
    
    // Clean table - loại bỏ formatting, chỉ giữ text
    cleanTable(table) {
        // Loại bỏ tất cả attributes trừ cấu trúc bảng
        table.removeAttribute('style');
        table.removeAttribute('class');
        table.removeAttribute('border');
        table.removeAttribute('cellpadding');
        table.removeAttribute('cellspacing');
        
        // Clean tất cả cells
        const cells = table.querySelectorAll('td, th');
        cells.forEach(cell => {
            // Loại bỏ tất cả attributes
            const attributes = Array.from(cell.attributes);
            attributes.forEach(attr => {
                if (attr.name !== 'colspan' && attr.name !== 'rowspan') {
                    cell.removeAttribute(attr.name);
                }
            });
            
            // Chỉ giữ text content
            const text = cell.textContent.trim();
            cell.innerHTML = text;
        });
        
        // Clean rows
        const rows = table.querySelectorAll('tr');
        rows.forEach(row => {
            const attributes = Array.from(row.attributes);
            attributes.forEach(attr => {
                row.removeAttribute(attr.name);
            });
        });
        
        // Clean thead, tbody, tfoot
        const sections = table.querySelectorAll('thead, tbody, tfoot');
        sections.forEach(section => {
            const attributes = Array.from(section.attributes);
            attributes.forEach(attr => {
                section.removeAttribute(attr.name);
            });
        });
    },
    
    // Paste plain text
    pasteAsPlainText(text) {
        if (!text) return;
        
        // Loại bỏ các ký tự đặc biệt, chỉ giữ text thuần
        const cleanText = text.replace(/[\r\n]+/g, '\n').trim();
        
        // Tách thành các dòng
        const lines = cleanText.split('\n');
        
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            range.deleteContents();
            
            lines.forEach((line, index) => {
                if (index > 0) {
                    // Thêm line break cho các dòng sau
                    range.insertNode(document.createElement('br'));
                    range.collapse(false);
                }
                
                // Thêm text
                const textNode = document.createTextNode(line);
                range.insertNode(textNode);
                range.setStartAfter(textNode);
                range.collapse(true);
            });
            
            selection.removeAllRanges();
            selection.addRange(range);
        }
    }
};



// ===== UTILITY FUNCTIONS =====
const Utils = {
    formatDate(dtStr) {
        if (!dtStr) return '';
        const date = new Date(dtStr);
        const options = {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            weekday: 'short',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false,
            timeZone: 'Asia/Tokyo'
        };
        const formatter = new Intl.DateTimeFormat('ja-JP', options);
        const parts = formatter.formatToParts(date);
        const year = parts.find(p => p.type === 'year')?.value || '';
        const month = parts.find(p => p.type === 'month')?.value || '';
        const day = parts.find(p => p.type === 'day')?.value || '';
        const weekday = parts.find(p => p.type === 'weekday')?.value || '';
        const hour = parts.find(p => p.type === 'hour')?.value || '';
        const minute = parts.find(p => p.type === 'minute')?.value || '';
        return `${year}/${month}/${day} (${weekday}) ${hour}:${minute}`;
    },

    generateNoteTitle() {
        const now = new Date();
        const pad = n => n.toString().padStart(2, '0');
        return `Note ${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}`;
    },

    debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    },

    autoLink(html) {
        const div = document.createElement('div');
        div.innerHTML = html;

        function linkifyNode(node) {
            if (node.nodeType === 3) {
                const urlRegex = /((https?:\/\/)[^\s<]+)/g;
                let text = node.nodeValue;
                let match, lastIndex = 0;
                const frag = document.createDocumentFragment();
                
                while ((match = urlRegex.exec(text)) !== null) {
                    if (match.index > lastIndex) {
                        frag.appendChild(document.createTextNode(text.slice(lastIndex, match.index)));
                    }
                    const a = document.createElement('a');
                    a.href = match[1];
                    a.target = "_blank";
                    a.rel = "noopener noreferrer";
                    a.textContent = match[1];
                    // Thêm event handler để click vào link
                    a.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        window.open(this.href, '_blank', 'noopener,noreferrer');
                    });
                    frag.appendChild(a);
                    lastIndex = urlRegex.lastIndex;
                }
                
                if (lastIndex < text.length) {
                    frag.appendChild(document.createTextNode(text.slice(lastIndex)));
                }
                return frag.childNodes.length ? frag : node;
            } else if (node.nodeType === 1 && node.tagName !== 'A') {
                for (let i = 0; i < node.childNodes.length; i++) {
                    const replaced = linkifyNode(node.childNodes[i]);
                    if (replaced !== node.childNodes[i]) {
                        node.replaceChild(replaced, node.childNodes[i]);
                    }
                }
            }
            return node;
        }

        linkifyNode(div);
        return div.innerHTML;
    }
};

// ===== API FUNCTIONS =====
const API = {
    async fetchNotes() {
        const res = await fetch('/api/evernote_notes');
        return await res.json();
    },

    async createNote(title, content) {
        const res = await fetch('/api/evernote_notes', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({title, content})
        });
        return await res.json();
    },

    async updateNote(id, title, content) {
        const requestData = {title, content};
        
        const res = await fetch(`/api/evernote_notes/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(requestData)
        });
        return await res.json();
    },

    async deleteNote(id) {
        await fetch(`/api/evernote_notes/${id}`, {method: 'DELETE'});
    }
};

const NoteManager = {
    async loadNotes() {
        AppState.notes = await API.fetchNotes();
        this.renderNoteList();
        
        if (AppState.notes.length > 0) {
            const stillExists = AppState.notes.some(n => n.id === AppState.currentId);
            if (!stillExists) {
                AppState.currentId = AppState.notes[0].id;
            }
            this.selectNote(AppState.currentId);
        } else {
            AppState.currentId = null;
            document.getElementById('note-title').value = '';
            document.getElementById('evernote-editor').innerHTML = '';
            document.getElementById('note-meta').textContent = '';
            AppState.currentImages = [];
        }
    },

    renderNoteList() {
        const list = document.getElementById('note-list');
        list.innerHTML = '';
        AppState.notes.forEach(note => {
            const li = document.createElement('li');
            li.className = 'list-group-item' + (note.id === AppState.currentId ? ' active' : '');
            li.textContent = note.title || 'Không tiêu đề';
            li.onclick = () => this.selectNote(note.id);
            list.appendChild(li);
        });
    },

    selectNote(id) {
        AppState.currentId = id;
        const note = AppState.notes.find(n => n.id === id);
        if (!note) return;
        
        document.getElementById('note-title').value = note.title;
        
        // Hiển thị content (KHÔNG bao gồm ảnh)
        const editor = document.getElementById('evernote-editor');
        const content = Utils.autoLink(note.content);
        editor.innerHTML = content;
        
        // Cập nhật ảnh riêng biệt
        if (note.images && note.images.length > 0) {
            AppState.currentImages = note.images;
            ImageManager.updateImagesInEditor(note.images);
        } else {
            AppState.currentImages = [];
            // Xóa các images-section cũ nếu có
            const existingSections = editor.querySelectorAll('.images-section');
            existingSections.forEach(section => section.remove());
        }
        
        // NẾU KHÔNG CÓ TEXT CONTENT, TẠO PLACEHOLDER ĐỂ USER CÓ THỂ GÕ
        if (!content.trim()) {
            const p = document.createElement('p');
            p.innerHTML = '<br>';
            if (editor.querySelector('.images-section')) {
                // Nếu có ảnh, đặt paragraph trước images-section
                editor.insertBefore(p, editor.querySelector('.images-section'));
            } else {
                // Nếu không có ảnh, đặt paragraph ở đầu
                editor.appendChild(p);
            }
        }
        
        this.renderNoteList();

        const metaDiv = document.getElementById('note-meta');
        if (metaDiv && note.created_at && note.updated_at) {
            const createTime = Utils.formatDate(note.created_at);
            const updateTime = Utils.formatDate(note.updated_at);
            metaDiv.innerHTML = `Create: ${createTime}<br>Update: ${updateTime}`;
        } else if (metaDiv) {
            metaDiv.textContent = '';
        }
    },

    async addNote() {
        const title = Utils.generateNoteTitle();
        const data = await API.createNote(title, "");
        await this.loadNotes();
        this.selectNote(data.id);
    },

    async deleteNote() {
        if (!AppState.currentId) return;
        await API.deleteNote(AppState.currentId);
        await this.loadNotes();
        
        if (AppState.notes.length > 0) {
            this.selectNote(AppState.notes[0].id);
        } else {
            AppState.currentId = null;
            document.getElementById('note-title').value = '';
            document.getElementById('evernote-editor').innerHTML = '';
            document.getElementById('note-meta').textContent = '';
            AppState.currentImages = [];
        }
    }
};

// ===== EDITOR FUNCTIONS =====
const Editor = {
    syncCheckboxStates(editor) {
        const checkboxes = editor.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => {
            if (cb.checked) {
                cb.setAttribute('checked', 'checked');
            } else {
                cb.removeAttribute('checked');
            }
        });
    },

    toggleChecklist(event, btn) {
        event.preventDefault();
        AppState.checklistActive = !AppState.checklistActive;
        btn.classList.toggle('active', AppState.checklistActive);
        btn.classList.add('effect-click');
        setTimeout(() => btn.classList.remove('effect-click'), 200);

        if (AppState.checklistActive) {
            document.execCommand('insertHTML', false, '<input type="checkbox" style="transform:scale(1.2);margin-right:6px;">');
        }
        document.getElementById('evernote-editor').focus();
    },

    toggleFormat(event, cmd, btn) {
        event.preventDefault();
        document.getElementById('evernote-editor').focus();
        document.execCommand(cmd);
        this.updateFormatButtons();
        btn.classList.add('effect-click');
        setTimeout(() => btn.classList.remove('effect-click'), 200);
    },

    updateFormatButtons() {
        const buttons = {
            'bold': document.getElementById('bold-btn'),
            'italic': document.getElementById('italic-btn'),
            'underline': document.getElementById('underline-btn'),
            'strikeThrough': document.getElementById('strike-btn'),
            'insertOrderedList': document.getElementById('ordered-btn'),
            'insertUnorderedList': document.getElementById('unordered-btn'),
            'justifyLeft': document.getElementById('left-btn'),
            'justifyCenter': document.getElementById('center-btn'),
            'justifyRight': document.getElementById('right-btn')
        };

        Object.entries(buttons).forEach(([cmd, btn]) => {
            if (btn) {
                btn.classList.toggle('active', document.queryCommandState(cmd));
            }
        });
    }
};

// ===== SEARCH FUNCTIONS =====
const Search = {
    clearHighlight() {
        const editor = document.getElementById('evernote-editor');
        const spans = editor.querySelectorAll('.search-highlight');
        spans.forEach(span => {
            const text = document.createTextNode(span.textContent);
            span.parentNode.replaceChild(text, span);
        });
    },

    highlightTerm(term) {
        this.clearHighlight();
        if (!term) return [];
        
        const editor = document.getElementById('evernote-editor');
        const regex = new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
        let results = [];

        function walk(node) {
            if (node.nodeType === 3) {
                let match;
                let parent = node.parentNode;
                let text = node.nodeValue;
                let frag = document.createDocumentFragment();
                let lastIndex = 0;
                regex.lastIndex = 0;
                
                while ((match = regex.exec(text)) !== null) {
                    if (match.index > lastIndex) {
                        frag.appendChild(document.createTextNode(text.slice(lastIndex, match.index)));
                    }
                    const span = document.createElement('span');
                    span.className = 'search-highlight';
                    span.textContent = match[0];
                    frag.appendChild(span);
                    results.push(span);
                    lastIndex = regex.lastIndex;
                }
                
                if (lastIndex < text.length) {
                    frag.appendChild(document.createTextNode(text.slice(lastIndex)));
                }
                if (results.length > 0) {
                    parent.replaceChild(frag, node);
                }
            } else if (node.nodeType === 1 && node.childNodes && node.tagName !== 'SCRIPT' && node.tagName !== 'STYLE') {
                for (let i = node.childNodes.length - 1; i >= 0; i--) {
                    walk(node.childNodes[i]);
                }
            }
        }

        walk(editor);
        return results;
    },

    gotoNext() {
        if (!AppState.searchResults.length) return;
        AppState.searchResults.forEach(span => span.style.outline = '');
        AppState.currentSearchIndex = (AppState.currentSearchIndex + 1) % AppState.searchResults.length;
        const span = AppState.searchResults[AppState.currentSearchIndex];
        span.scrollIntoView({behavior: "smooth", block: "center"});
        span.style.outline = '2px solid orange';
    }
};

// ===== SAVE FUNCTIONS =====
const SaveManager = {
    showSaveStatus() {
        const icon = document.getElementById('save-status');
        icon.style.display = 'inline';
        icon.style.opacity = '1';
        icon.animate([{opacity: 0.2}, {opacity: 1}], {duration: 300, iterations: 1});
        
        clearTimeout(this.saveTimeout);
        this.saveTimeout = setTimeout(() => {
            icon.style.display = 'none';
        }, 1500);
    },

    async saveNote() {
        let title = document.getElementById('note-title').value.trim();
        const editor = document.getElementById('evernote-editor');
        Editor.syncCheckboxStates(editor);
        
        // Lấy content nhưng loại bỏ phần images-section để không lưu trong content
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = editor.innerHTML;
        
        // XÓA TẤT CẢ images-section khỏi content trước khi lưu
        const imagesSections = tempDiv.querySelectorAll('.images-section');
        imagesSections.forEach(section => section.remove());
        
        const content = tempDiv.innerHTML;

        if (title === "") {
            title = `Note_${new Date().toLocaleString('sv-SE').replace(/[:\s]/g, '_').slice(0, -3)}`;
            document.getElementById('note-title').value = title;
        }

        if (!AppState.currentId) {
            if (title !== "" || content !== "") {
                const data = await API.createNote(title, content);
                await NoteManager.loadNotes();
                NoteManager.selectNote(data.id);
            }
        } else {
            const note = AppState.notes.find(n => n.id === AppState.currentId);
            if (note) {
                note.title = title;
                note.content = content;
                await API.updateNote(AppState.currentId, title, content);
            }
        }

        AppState.lastSavedTitle = title;
        AppState.lastSavedContent = content;
        this.showSaveStatus();
        
        // SAU KHI LÀM AUTO SAVE, ĐẢM BẢO CHỈ CÓ 1 IMAGES-SECTION
        setTimeout(() => {
            if (AppState.currentImages && AppState.currentImages.length > 0) {
                ImageManager.updateImagesInEditor(AppState.currentImages);
            }
        }, 100);
    },

    autoSave: Utils.debounce(function() {
        const title = document.getElementById('note-title').value.trim();
        const editor = document.getElementById('evernote-editor');
        
        // Lấy content mà không có images-section
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = editor.innerHTML;
        
        // XÓA TẤT CẢ images-section khỏi content
        const imagesSections = tempDiv.querySelectorAll('.images-section');
        imagesSections.forEach(section => section.remove());
        
        const content = tempDiv.innerHTML;
        
        if (title !== AppState.lastSavedTitle || content !== AppState.lastSavedContent) {
            SaveManager.saveNote();
        }
    }, 5000)
};

// ===== UI HANDLERS =====
const UIHandlers = {
    setupSidebar() {
        const sidebar = document.querySelector('.evernote-sidebar');
        const main = document.querySelector('.evernote-main');
        const toggleBtn = document.getElementById('toggle-sidebar-btn');
        const toggleIcon = document.getElementById('toggle-sidebar-icon');
        let collapsed = false;

        toggleBtn.onclick = () => {
            collapsed = !collapsed;
            sidebar.classList.toggle('collapsed', collapsed);
            main.classList.toggle('expanded', collapsed);
            toggleIcon.textContent = collapsed ? '>' : '<';
        };
    },

    setupMobileList() {
        const noteList = document.getElementById('note-list');
        const toggleBtn = document.getElementById('toggle-list-btn');
        const toggleIcon = document.getElementById('toggle-list-icon');
        let collapsed = false;

        toggleBtn.onclick = () => {
            collapsed = !collapsed;
            noteList.classList.toggle('collapsed', collapsed);
            toggleIcon.classList.toggle('bi-chevron-bar-up', !collapsed);
            toggleIcon.classList.toggle('bi-chevron-bar-down', collapsed);
        };
    },

    setupSearch() {
        const searchBtn = document.getElementById('search-btn');
        const searchModal = document.getElementById('searchModal');
        const searchTextbox = document.getElementById('search-textbox');

        searchBtn.onclick = () => {
            searchBtn.classList.add('effect-click');
            setTimeout(() => searchBtn.classList.remove('effect-click'), 200);

            if (!AppState.searchActive) {
                searchBtn.classList.add('active');
                AppState.searchActive = true;
                AppState.searchModalInstance = new bootstrap.Modal(searchModal);
                searchTextbox.value = "";
                AppState.searchModalInstance.show();
                
                searchModal.addEventListener('shown.bs.modal', function handler() {
                    searchTextbox.focus();
                    searchModal.removeEventListener('shown.bs.modal', handler);
                });
            } else {
                searchBtn.classList.remove('active');
                AppState.searchActive = false;
                Search.clearHighlight();
                AppState.searchResults = [];
                AppState.currentSearchIndex = -1;
                AppState.lastSearchTerm = "";
                if (AppState.searchModalInstance) {
                    AppState.searchModalInstance.hide();
                }
            }
        };

        searchTextbox.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                this.hideSearchModal();
                
                const term = searchTextbox.value.trim();
                AppState.lastSearchTerm = term;
                if (!term) return;
                
                if (!AppState.searchResults.length) {
                    AppState.searchResults = Search.highlightTerm(term);
                    AppState.currentSearchIndex = -1;
                }
                if (AppState.searchResults.length) {
                    Search.gotoNext();
                }
            }
        });

        searchTextbox.addEventListener('input', () => {
            Search.clearHighlight();
            AppState.searchResults = [];
            AppState.currentSearchIndex = -1;
            this.showSearchModal();
            AppState.lastSearchTerm = searchTextbox.value.trim();
        });

        searchModal.addEventListener('hidden.bs.modal', () => {
            this.showSearchModal();
            if (AppState.searchResults.length > 0 && AppState.lastSearchTerm) {
                searchBtn.classList.add('active');
                AppState.searchActive = true;
            } else {
                searchBtn.classList.remove('active');
                AppState.searchActive = false;
                Search.clearHighlight();
                AppState.searchResults = [];
                AppState.currentSearchIndex = -1;
                AppState.lastSearchTerm = "";
            }
        });
    },

    hideSearchModal() {
        const modal = document.getElementById('searchModal');
        modal.querySelector('.modal-content').style.opacity = '0.2';
        const backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) backdrop.style.display = 'none';
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        modal.removeAttribute('tabindex');
    },

    showSearchModal() {
        const modal = document.getElementById('searchModal');
        modal.querySelector('.modal-content').style.opacity = '1';
        const backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) backdrop.style.display = '';
        document.body.classList.add('modal-open');
    },

    setupVisualViewport() {
        if (window.visualViewport) {
            AppState.originalEditorHeight = document.getElementById('evernote-editor').style.height;
            
            window.visualViewport.addEventListener('resize', () => {
                const editor = document.getElementById('evernote-editor');
                const toolbar = document.querySelector('.evernote-toolbar');
                
                if (window.visualViewport.height < window.innerHeight * 0.7) {
                    toolbar.style.position = 'sticky';
                    toolbar.style.top = '0';
                    toolbar.style.zIndex = '10';
                    
                    const availableHeight = window.visualViewport.height - toolbar.offsetHeight - 20;
                    editor.style.height = `${availableHeight}px`;
                    editor.style.maxHeight = `${availableHeight}px`;
                } else {
                    editor.style.height = AppState.originalEditorHeight || '100%';
                    editor.style.maxHeight = '100%';
                }
            });
        }
    }
};

// ===== GLOBAL FUNCTIONS (for inline handlers) =====
function format(cmd, value = null) {
    document.execCommand(cmd, false, value);
    document.getElementById('evernote-editor').focus();
}

function setFontSize(size) {
    if (!size) return;
    document.execCommand('fontSize', false, 7);
    const editor = document.getElementById('evernote-editor');
    const fonts = editor.querySelectorAll('font[size="7"]');
    fonts.forEach(font => {
        const span = document.createElement('span');
        span.style.fontSize = size;
        span.innerHTML = font.innerHTML;
        font.parentNode.replaceChild(span, font);
    });
    editor.focus();
}

function toggleFormat(event, cmd, btn) {
    Editor.toggleFormat(event, cmd, btn);
}

function toggleChecklist(event, btn) {
    Editor.toggleChecklist(event, btn);
}

// ===== EVENT LISTENERS =====
document.addEventListener('DOMContentLoaded', () => {
    // Setup UI handlers
    UIHandlers.setupSidebar();
    UIHandlers.setupMobileList();
    UIHandlers.setupSearch();
    UIHandlers.setupVisualViewport();

    // Setup button events
    document.getElementById('add-note-btn').onclick = () => NoteManager.addNote();
    document.getElementById('delete-note-btn').onclick = () => {
        AppState.pendingDelete = true;
        const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        modal.show();
    };
    document.getElementById('confirm-delete-btn').onclick = async () => {
        if (AppState.pendingDelete) {
            await NoteManager.deleteNote();
            AppState.pendingDelete = false;
            bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
        }
    };
    document.getElementById('clear-title-btn').onclick = () => {
        document.getElementById('note-title').value = "";
        document.getElementById('note-title').focus();
    };

    // Setup lightbox events
    const lightbox = document.getElementById('imageLightbox');
    const lightboxClose = document.querySelector('.lightbox-close');
    
    lightboxClose.onclick = () => ImageManager.closeLightbox();
    
    lightbox.onclick = (e) => {
        if (e.target === lightbox) {
            ImageManager.closeLightbox();
        }
    };
    
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            ImageManager.closeLightbox();
        }
    });

    // Setup share link button
    document.getElementById('share-link-btn').onclick = async () => {
        const btn = document.getElementById('share-link-btn');
        btn.classList.add('effect-click');
        setTimeout(() => btn.classList.remove('effect-click'), 200);

        if (!AppState.currentId) {
            alert('Vui lòng chọn ghi chú để chia sẻ');
            return;
        }

        const modal = new bootstrap.Modal(document.getElementById('shareLinkModal'));
        const resultDiv = document.getElementById('share-link-result');
        const contentDiv = document.getElementById('share-link-content');
        
        resultDiv.style.display = 'none';
        contentDiv.style.display = 'block';
        contentDiv.innerHTML = '<p><i class="bi bi-hourglass-split"></i> Đang tạo link chia sẻ...</p>';
        
        modal.show();

        try {
            const shareUrl = await ShareLink.generateShareLink(AppState.currentId);
            ShareLink.showShareModal(shareUrl);
        } catch (error) {
            contentDiv.innerHTML = `<p class="text-danger"><i class="bi bi-exclamation-triangle"></i> Lỗi: ${error.message}</p>`;
        }
    };

    document.getElementById('copy-link-btn').onclick = () => {
        ShareLink.copyToClipboard();
    };

    // Setup editor events
    const editor = document.getElementById('evernote-editor');
    
    // Mutation observer
    const observer = new MutationObserver((mutations) => {
        let needsCleanup = false;
        
        mutations.forEach((mutation) => {
            if (mutation.type === 'childList') {
                mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === 1 && (
                        node.classList?.contains('images-section') || 
                        node.querySelector?.('.images-section')
                    )) {
                        needsCleanup = true;
                    }
                });
            }
        });
        
        if (needsCleanup) {
            setTimeout(() => {
                ImageManager.ensureSingleImagesSection();
            }, 10);
        }
    });

    observer.observe(editor, {
        childList: true,
        subtree: true
    });

    // CHỈ 1 EVENT LISTENER CHO PASTE - XỬ LÝ CẢ ẢNH VÀ TABLE
    editor.addEventListener('paste', (e) => {
        console.log('Paste event triggered', e);
        
        if (!AppState.currentId) {
            console.log('No current note selected');
            return;
        }
        
        const clipboardData = e.clipboardData || window.clipboardData;
        const items = Array.from(clipboardData.items);
        
        // Kiểm tra chi tiết hơn về loại data
        const htmlData = clipboardData.getData('text/html');
        const plainText = clipboardData.getData('text/plain');
        
        // Kiểm tra xem có phải ảnh thực sự không (binary image file)
        const hasRealImageFile = items.some(item => {
            return item.type.indexOf('image') === 0 && 
                   item.kind === 'file' && 
                   !htmlData; // Nếu có HTML data thì có thể là Excel/table
        });
        
        console.log('Clipboard analysis:', {
            hasRealImageFile,
            htmlDataLength: htmlData?.length || 0,
            plainTextLength: plainText?.length || 0,
            items: items.map(item => ({type: item.type, kind: item.kind}))
        });
        
        if (hasRealImageFile) {
            // Xử lý ảnh thực sự (screenshot, copy file ảnh)
            console.log('Processing real image file...');
            ImageManager.handlePaste(e, AppState.currentId);
        } else if (htmlData || plainText) {
            // Xử lý text/table/HTML - bao gồm Excel data
            console.log('Processing text/table data...');
            PasteManager.handlePaste(e, AppState.currentId);
        }
    });

    // Thêm event listener cho click vào links
    editor.addEventListener('click', (e) => {
        if (e.target.tagName === 'A' && e.target.href) {
            e.preventDefault();
            e.stopPropagation();
            window.open(e.target.href, '_blank', 'noopener,noreferrer');
        }
    });

    editor.onblur = () => SaveManager.saveNote();
    editor.addEventListener('keyup', Editor.updateFormatButtons);
    editor.addEventListener('mouseup', Editor.updateFormatButtons);
    editor.addEventListener('focus', Editor.updateFormatButtons);
    
    editor.addEventListener('input', (e) => {
        setTimeout(() => {
            ImageManager.ensureSingleImagesSection();
        }, 10);
        SaveManager.autoSave();
    });

    editor.addEventListener('keydown', (e) => {
        if (AppState.checklistActive && e.key === 'Enter') {
            e.preventDefault();
            document.execCommand('insertHTML', false, '<br><input type="checkbox" style="transform:scale(1.2);margin-right:6px;">');
            const sel = window.getSelection();
            if (sel.rangeCount > 0) {
                const range = sel.getRangeAt(0);
                range.collapse(false);
            }
        } else if (e.key === 'Enter') {
            // Xử lý Enter một cách đơn giản và hiệu quả hơn
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const container = range.startContainer;
                
                // Tìm node cha gần nhất
                let currentNode = container.nodeType === 3 ? container.parentNode : container;
                
                // Kiểm tra xem có đang ở trong table cell không
                const isInTableCell = currentNode.closest('td, th');
                if (isInTableCell) {
                    // Nếu đang trong table cell, để browser xử lý Enter bình thường
                    return;
                }
                
                // Kiểm tra xem có đang ở trong paragraph không
                const currentParagraph = currentNode.closest('p');
                
                if (currentParagraph) {
                    // Đang trong paragraph - để browser xử lý Enter bình thường
                    // Nhưng đảm bảo tạo paragraph mới thay vì div
                    const editor = document.getElementById('evernote-editor');
                    
                    // Sử dụng setTimeout để can thiệp sau khi browser xử lý Enter
                    setTimeout(() => {
                        // Kiểm tra xem có div nào vừa được tạo không
                        const newDivs = editor.querySelectorAll('div:not(.images-section)');
                        newDivs.forEach(div => {
                            // Nếu div không có class đặc biệt, chuyển thành paragraph
                            if (!div.className) {
                                const p = document.createElement('p');
                                p.innerHTML = div.innerHTML || '<br>';
                                div.parentNode.replaceChild(p, div);
                            }
                        });
                    }, 10);
                    
                    return; // Để browser xử lý Enter bình thường
                }
                
                // Nếu không trong paragraph nào, tạo paragraph mới
                e.preventDefault();
                
                const newParagraph = document.createElement('p');
                newParagraph.innerHTML = '<br>';
                
                // Chèn paragraph mới
                range.insertNode(newParagraph);
                
                // Đặt cursor vào paragraph mới
                range.setStart(newParagraph.firstChild, 0);
                range.collapse(true);
                selection.removeAllRanges();
                selection.addRange(range);
            }
        }
    });

    // Tạo input file cho upload ảnh
    const imageUploadInput = ImageManager.createImageUpload();
    
    // Thêm button upload ảnh vào toolbar
    const toolbar = document.querySelector('.evernote-toolbar');
    const uploadBtn = document.createElement('button');
    uploadBtn.className = 'btn btn-light btn-sm';
    uploadBtn.type = 'button';
    uploadBtn.title = 'Upload ảnh';
    uploadBtn.innerHTML = '<i class="bi bi-image"></i>';
    uploadBtn.onclick = () => {
        console.log('Upload button clicked');
        if (AppState.currentId) {
            console.log('Opening file dialog for note:', AppState.currentId);
            imageUploadInput.click();
        } else {
            console.log('No current note selected');
            alert('Vui lòng chọn hoặc tạo note trước');
        }
    };
    
    // Thêm vào toolbar sau button search
    const searchBtn = document.getElementById('search-btn');
    searchBtn.parentNode.insertBefore(uploadBtn, searchBtn.nextSibling);

    // Load initial data
    NoteManager.loadNotes();
});
// Expose ImageManager globally for onclick handlers
window.ImageManager = ImageManager;
window.PasteManager = PasteManager;
</script>
{% endblock %}