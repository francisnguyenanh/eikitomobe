{% extends "Memo/base.html" %}
{% block title %}Task List{% endblock %}
{% block content %}
    <style>
        .task-category {
            font-weight: bold;
            font-size: 1.1rem;
            margin-top: 2rem;
            margin-bottom: 0.5rem;
            color: #0d6efd;
            letter-spacing: 0.5px;
        }
        .task-table th, .task-table td {
            vertical-align: middle !important;
        }
        .task-table .task-title {
            font-weight: 500;
        }
        .task-table .task-content {
            color: #555;
            font-size: 0.97em;
        }
        .task-table .task-due {
            font-size: 0.97em;
            color: #b02a37;
        }
        .task-table .task-complete:checked + span {
            text-decoration: line-through;
            color: #888;
        }
        .task-table .delete-btn {
            color: #b02a37;
            cursor: pointer;
            font-size: 1.2em;
            transition: color 0.15s;
        }
        .task-table .delete-btn:hover {
            color: #dc3545;
        }
        .card {
            background-color: var(--card-bg);
            font-family: 'Noto Sans JP', sans-serif;
        }
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .reminder-item.clicked {
            background-color: var(--primary-color) !important;
            color: #ffffff;
        }
        .reminder-item.clicked:hover {
            background-color: #28a745 !important;
            color: #ffffff;
        }
        .reminder-item:hover {
            background-color: #ffca2c;
        }
        #viewMemoModal .modal-body {
            font-family: 'Noto Sans JP', sans-serif;
        }
        #viewMemoModal #viewMemoTitle {
            font-family: 'Kosugi Maru', sans-serif;
            font-size: 1.5rem;
        }
        #viewMemoModal #viewMemoContent {
            background-color: var(--card-bg);
            padding: 18px;
            border-radius: 5px;
            min-height: 200px;
            max-height: 400px;
            font-size: 1.1rem;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            border: 1px solid #ddd;
        }
        #imagePreview img, #editImagePreview img, #viewMemoImages img {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 5px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .position-relative {
            display: inline-block;
        }
        .position-relative .btn-danger {
            padding: 2px 6px;
            font-size: 12px;
        }
        .link-input[readonly] {
            background-color: #f3f3f3 !important;
            color: #555;
            cursor: pointer;
            transition: background 0.2s;
        }
        .link-input:not([readonly]) {
            background-color: #fffbe6 !important;
            color: #212529;
            transition: background 0.2s;
        }
        .link-input:focus {
            background-color: #fffde7 !important;
            border-color: #ffe066;
            outline: none;
        }
        .task-category .btn-link {
            color: inherit;
            text-decoration: none;
        }
        .category-table-wrapper.collapsed {
            display: none;
        }
        
    </style>

    <form class="mb-3" id="searchForm">
        <div class="input-group mb-2">
            <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#addMemoModal" title="Add New Note">
                <i class="bi bi-plus-circle"></i>
            </button>
            <input type="text" class="form-control" id="searchInput" name="search" placeholder="Search notes..." value="{{ search_query }}">
        </div>
        <div class="row">
            <div class="col-md-3">
                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="showCompleted" name="show_completed" value="1" {% if show_completed %}checked{% endif %}>
                    <label class="form-check-label" for="showCompleted"><i class="bi bi-check2"></i> Completed</label>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="showIncomplete" name="show_incomplete" value="1"
                        {% if show_incomplete is none or show_incomplete %}checked{% endif %}>
                    <label class="form-check-label" for="showIncomplete"><i class="bi bi-circle"></i> Incomplete</label>
                </div>
            </div>
            <div class="col-md-2">
                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="showReminders" name="show_reminders" value="1">
                    <label class="form-check-label" for="showReminders"><i class="bi bi-bell"></i> Reminders</label>
                </div>
            </div>
        </div>
    </form>
    <div id="reminders" class="mb-3"></div>
    <div id="notesContainer">
        {% for category in categories %}
            <div class="task-category d-flex align-items-center" style="color: {{ category.color or '#0d6efd' }}">
                <button class="btn btn-link btn-sm p-0 me-2 toggle-category" type="button" data-category-id="{{ category.id }}">
                    <i class="bi bi-chevron-down" id="toggle-icon-{{ category.id }}"></i>
                </button>
                <span>{{ category.name }}</span>
            </div>
            <div class="category-table-wrapper" id="category-table-{{ category.id }}">
                <table class="table table-hover task-table mb-4">
                    <thead>
                        <tr>
                            <th style="width:40px"></th>
                            <th style="width:40px"></th>
                            <th>Tiêu đề</th>
                            <th>Nội dung</th>
                            <th>Hạn</th>
                            <th style="width:100px">Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for note in notes if note.category_id == category.id %}
                        <tr data-task-id="{{ note.id }}">
                            <td>
                                <input type="checkbox" class="form-check-input task-complete complete-switch" data-note-id="{{ note.id }}" {% if note.is_completed %}checked{% endif %}>
                            </td>
                            <td>
                                <i class="bi bi-trash delete-btn btn-delete-memo" data-note-id="{{ note.id }}" title="Xoá"></i>
                            </td>
                            <td>
                                <span class="task-title" onclick="openViewMemoModal({{ note.id }})" style="cursor:pointer;">{{ note.title }}</span>
                            </td>
                            <td>
                                <span class="task-content">{{ note.content|truncate(100) }}</span>
                            </td>
                            <td>
                                <span class="task-due due-date" data-due-date="{{ note.due_date.isoformat() if note.due_date else '' }}">
                                    {{ note.due_date.strftime('%Y-%m-%d %H:%M') if note.due_date else '' }}
                                </span>
                            </td>
                            <td>
                                <a href="{{ url_for('export_note', id=note.id) }}" class="btn btn-sm me-1"><i class="bi bi-file-earmark-text"></i></a>
                                <a href="{{ url_for('export_pdf', id=note.id) }}" class="btn btn-sm"><i class="bi bi-file-earmark-pdf"></i></a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endfor %}
    </div>

    <div class="modal fade" id="confirmLogoutModal" tabindex="-1" aria-labelledby="confirmLogoutModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmLogoutModalLabel">Confirm Logout</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to logout?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmLogoutBtn">Logout</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="linksModal" tabindex="-1" aria-labelledby="linksModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="linksModalLabel">Saved Links</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="linksForm">
                        <div id="linksInputs"></div>
                        <button type="submit" class="btn btn-primary mt-2">Update</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% if categories %}
    <div class="modal fade" id="addMemoModal" tabindex="-1" aria-labelledby="addMemoModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="addMemoTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="add-content-tab" data-bs-toggle="tab" data-bs-target="#add-content" type="button" role="tab">Content</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="add-meta-tab" data-bs-toggle="tab" data-bs-target="#add-meta" type="button" role="tab">Meta</button>
                        </li>
                    </ul>
                    <form id="addMemoForm" method="POST" action="{{ url_for('add_note') }}" enctype="multipart/form-data">
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="add-content" role="tabpanel">
                                <div class="mb-3">
                                    <input type="text" class="form-control" id="memoTitle" name="title" required>
                                </div>
                                <div class="mb-3">
                                    <textarea class="form-control" id="memoContent" name="content" rows="14" required></textarea>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="add-meta" role="tabpanel">
                                <div class="mb-3">
                                    <input type="file" class="form-control" id="memoImages" name="images" multiple accept="image/png,image/jpeg,image/gif,image/heic">
                                    <div id="imagePreview" class="mt-2 d-flex flex-wrap gap-2"></div>
                                </div>
                                <div class="mb-3">
                                    <input type="datetime-local" class="form-control" id="memoDueDate" name="due_date" step="60">
                                </div>
                                <div class="mb-3">
                                    <select class="form-select" id="memoCategory" name="category_id" required>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" type="checkbox" id="memoShare" name="share">
                                        <label class="form-check-label" for="memoShare">Enable public sharing</label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" type="checkbox" id="memoCompleted" name="is_completed">
                                        <label class="form-check-label" for="memoCompleted">Completed</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Memo</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    <div class="modal fade" id="viewMemoModal" tabindex="-1" aria-labelledby="viewMemoModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="viewMemoTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="view-content-tab" data-bs-toggle="tab" data-bs-target="#view-content" type="button" role="tab">Content</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="view-meta-tab" data-bs-toggle="tab" data-bs-target="#view-meta" type="button" role="tab">Meta</button>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="view-content" role="tabpanel">
                            <h6 id="viewMemoTitle" class="mb-3"></h6>
                            <p id="viewMemoContent" style="white-space: pre-wrap;"></p>
                        </div>
                        <div class="tab-pane fade" id="view-meta" role="tabpanel">
                            <div id="viewMemoImages" class="mt-2 d-flex flex-wrap gap-2"></div>
                            <p id="viewMemoDueDate" class="text-muted"></p>
                            <p id="viewMemoCategory" class="text-muted"></p>
                            <p id="viewMemoShare" class="text-muted"></p>
                            <p id="viewMemoCompleted" class="text-muted"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="imageViewModal" tabindex="-1" aria-labelledby="imageViewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="enlargedImage" src="" style="max-width: 100%; max-height: 80vh; object-fit: contain;">
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmDeleteModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this memo?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>
    {% if categories %}
    <div class="modal fade" id="editMemoModal" tabindex="-1" aria-labelledby="editMemoModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="editMemoTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="edit-content-tab" data-bs-toggle="tab" data-bs-target="#edit-content" type="button" role="tab">Content</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="edit-meta-tab" data-bs-toggle="tab" data-bs-target="#edit-meta" type="button" role="tab">Meta</button>
                        </li>
                    </ul>
                    <form id="editMemoForm" method="POST" enctype="multipart/form-data">
                        <input type="hidden" id="editMemoId" name="id">
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="edit-content" role="tabpanel">
                                <div class="mb-3">
                                    <input type="text" class="form-control" id="editMemoTitle" name="title" required>
                                </div>
                                <div class="mb-3">
                                    <textarea class="form-control" id="editMemoContent" name="content" rows="14" required></textarea>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="edit-meta" role="tabpanel">
                                <div class="mb-3">
                                    <input type="file" class="form-control" id="editMemoImages" name="images" multiple accept="image/png,image/jpeg,image/gif,image/heic">
                                    <div id="editImagePreview" class="mt-2 d-flex flex-wrap gap-2"></div>
                                </div>
                                <div class="mb-3">
                                    <input type="datetime-local" class="form-control" id="editMemoDueDate" name="due_date" step="60">
                                </div>
                                <div class="mb-3">
                                    <select class="form-select" id="editMemoCategory" name="category_id" required>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" type="checkbox" id="editMemoShare" name="share">
                                        <label class="form-check-label" for="editMemoShare">Enable public sharing</label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" type="checkbox" id="editMemoCompleted" name="is_completed">
                                        <label class="form-check-label" for="editMemoCompleted">Completed</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Update Memo</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    <div class="modal fade" id="manageCategoriesModal" tabindex="-1" aria-labelledby="manageCategoriesModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body">
                    <form id="addCategoryForm" class="mb-3">
                        <div class="mb-3">
                            <label for="categoryName" class="form-label">Category Name</label>
                            <input type="text" class="form-control" id="categoryName" name="name" required>
                        </div>
                        <div class="row mb-3 align-items-end">
                            <div class="col">
                                <input type="color" class="form-control form-control-color" id="categoryColor" name="color" value="#ffffff">
                            </div>
                            <div class="col-auto">
                                <button type="submit" class="btn btn-primary mt-4">Add Category</button>
                            </div>
                        </div>
                    </form>
                    <div id="categoriesContainer" class="row">
                        {% for category in categories %}
                            <div class="col-12 col-md-6 mb-3">
                                <div class="card" style="background-color: {{ category.color or '#ffffff' }};">
                                    <div class="card-body d-flex justify-content-between align-items-center">
                                        <span>{{ category.name }}</span>
                                        <div>
                                            <button class="btn btn-sm me-1 edit-category" data-category-id="{{ category.id }}" data-category-name="{{ category.name }}" data-category-color="{{ category.color or '#ffffff' }}"><i class="bi bi-pencil"></i></button>
                                            <button class="btn btn-sm delete-category" data-category-id="{{ category.id }}"><i class="bi bi-trash"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="settingsModalLabel">Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" action="{{ url_for('change_password') }}">
                        <div class="mb-3">
                            <label for="new_password" class="form-label">Change Password</label>
                            <input type="password" class="form-control" id="new_password" name="new_password" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Password</button>
                    </form>
                    <hr>
                    <div class="mb-3">
                        <label for="themeSelect" class="form-label">Theme</label>
                        <select class="form-select" id="themeSelect">
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                            <option value="blue">Blue</option>
                            <option value="green">Green</option>
                            <option value="purple">Purple</option>
                            <option value="red">Red</option>
                            <option value="orange">Orange</option>
                            <option value="yellow">Yellow</option>
                            <option value="pink">Pink</option>
                            <option value="cyan">Cyan</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <footer class="text-end p-2" style="position:fixed;right:0;bottom:0;z-index:999;width:auto;min-width:180px;background:rgba(255,255,255,0.8);font-size:0.95em;">
        DB size: <span id="dbSize">...</span>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Khai báo modals
        const modals = {
            addMemo: new bootstrap.Modal(document.getElementById('addMemoModal')),
            editMemo: new bootstrap.Modal(document.getElementById('editMemoModal')),
            viewMemo: new bootstrap.Modal(document.getElementById('viewMemoModal')),
            imageView: new bootstrap.Modal(document.getElementById('imageViewModal')),
            confirmDelete: new bootstrap.Modal(document.getElementById('confirmDeleteModal')),
            manageCategories: new bootstrap.Modal(document.getElementById('manageCategoriesModal')),
            settings: new bootstrap.Modal(document.getElementById('settingsModal')),
            links: new bootstrap.Modal(document.getElementById('linksModal')),
            confirmLogout: new bootstrap.Modal(document.getElementById('confirmLogoutModal'))
        };

        // DOM elements
        const editMemoForm = document.getElementById('editMemoForm');
        const themeSelect = document.getElementById('themeSelect');
        const searchInput = document.getElementById('searchInput');
        const categorySelect = document.getElementById('categorySelect');
        const showCompleted = document.getElementById('showCompleted');
        const showIncomplete = document.getElementById('showIncomplete');
        const showReminders = document.getElementById('showReminders');
        const notesContainer = document.getElementById('notesContainer');
        const remindersDiv = document.getElementById('reminders');
        const addCategoryForm = document.getElementById('addCategoryForm');
        const categoriesContainer = document.getElementById('categoriesContainer');

        // State variables
        let currentlyClickedReminderId = null;
        let selectedFilesAdd = [];
        let selectedFilesEdit = [];
        let existingImagesEdit = [];
        let notes, categories;
        const currentTheme = localStorage.getItem('theme') || '{{ session.get("theme", "light") }}';

        try {
            notes = {{ notes_data | tojson }};
            categories = {{ categories | tojson }};
        } catch (e) {
            console.error('Error parsing initial data:', e);
            notes = [];
            categories = [];
        }

        function cleanBackdrops() {
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                backdrop.remove();
            });
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.removeAttribute('aria-hidden');
        }

        // Tiện ích chung

        // Xử lý lỗi và hiển thị thông báo flash
        function handleError(error, defaultMessage = 'An error occurred') {
            console.error(error);
            showFlashMessage('danger', error.message || defaultMessage);
        }

        // Hiển thị thông báo flash
        function showFlashMessage(category, message) {
            const flashContainer = document.querySelector('.container.mt-4');
            if (!flashContainer) return;
            const alert = document.createElement('div');
            alert.className = `alert alert-${category} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            flashContainer.insertBefore(alert, flashContainer.firstChild);
            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 150);
            }, 3000);
        }

        // Chuyển URL thành liên kết HTML
        function linkify(text) {
            if (!text) return '';
            const urlRegex = /(https?:\/\/[^\s<]+[^\s<.,:;"')\]\}])/g;
            return text.replace(urlRegex, url => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`);
        }

        // Định dạng ngày giờ theo JST
        function formatDateJST(isoDate) {
            if (!isoDate) return '';
            const date = new Date(isoDate);
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                weekday: 'short',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false,
                timeZone: 'Asia/Tokyo'
            };
            const formatter = new Intl.DateTimeFormat('ja-JP', options);
            const parts = formatter.formatToParts(date);
            const year = parts.find(p => p.type === 'year')?.value || '';
            const month = parts.find(p => p.type === 'month')?.value || '';
            const day = parts.find(p => p.type === 'day')?.value || '';
            const weekday = parts.find(p => p.type === 'weekday')?.value || '';
            const hour = parts.find(p => p.type === 'hour')?.value || '';
            const minute = parts.find(p => p.type === 'minute')?.value || '';
            return `${year}/${month}/${day} (${weekday}) ${hour}:${minute}`;
        }

        // Nén ảnh
        async function compressImage(file, targetSizeRatio = 0.2) {
            return new Promise((resolve, reject) => {
                if (!file || (file.type === 'image/heic' || file.name?.toLowerCase().endsWith('.heic'))) {
                    resolve(file);
                    return;
                }
                const img = new Image();
                img.src = URL.createObjectURL(file);
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const scaleFactor = Math.sqrt(targetSizeRatio);
                    canvas.width = img.width * scaleFactor;
                    canvas.height = img.height * scaleFactor;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    canvas.toBlob(
                        newBlob => {
                            const newFile = new File([newBlob], file.name, {
                                type: 'image/jpeg',
                                lastModified: Date.now()
                            });
                            URL.revokeObjectURL(img.src);
                            resolve(newFile);
                        },
                        'image/jpeg',
                        0.2
                    );
                };
                img.onerror = () => {
                    URL.revokeObjectURL(img.src);
                    reject(new Error('Failed to load image'));
                };
            });
        }

        // Debounce utility
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Xử lý giao diện dữ liệu

        // Cập nhật hiển thị ngày giờ
        function updateDueDateDisplays() {
            document.querySelectorAll('.due-date').forEach(el => {
                const isoDate = el.getAttribute('data-due-date');
                if (isoDate) {
                    el.textContent = formatDateJST(isoDate);
                }
            });
        }

        // Cập nhật preview ảnh
        function updateImagePreview(previewContainer, files, isAddModal) {
            if (!previewContainer) return;
            previewContainer.innerHTML = '';
            files.forEach((fileObj, index) => {
                const container = document.createElement('div');
                container.className = 'position-relative';
                const placeholder = document.createElement('div');
                placeholder.style.width = '100px';
                placeholder.style.height = '100px';
                placeholder.style.display = 'flex';
                placeholder.style.alignItems = 'center';
                placeholder.style.justifyContent = 'center';
                placeholder.style.border = '1px solid #ddd';
                placeholder.style.borderRadius = '5px';
                placeholder.style.backgroundColor = '#f8f9fa';
                placeholder.classList.add('img-thumbnail');
                if (fileObj?.url) {
                    const img = document.createElement('img');
                    img.src = fileObj.url;
                    img.style.maxWidth = '100px';
                    img.style.maxHeight = '100px';
                    img.style.objectFit = 'contain';
                    img.onerror = () => {
                        placeholder.textContent = 'Error loading image';
                        placeholder.style.fontSize = '12px';
                        placeholder.style.color = '#dc3545';
                        placeholder.style.textAlign = 'center';
                    };
                    placeholder.appendChild(img);
                } else if (fileObj && (fileObj.type === 'image/heic' || fileObj.name?.toLowerCase().endsWith('.heic'))) {
                    placeholder.textContent = 'HEIC';
                    placeholder.style.fontSize = '14px';
                    placeholder.style.color = '#666';
                    placeholder.style.textAlign = 'center';
                } else if (fileObj instanceof File) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(fileObj);
                    img.style.maxWidth = '100px';
                    img.style.maxHeight = '100px';
                    img.style.objectFit = 'contain';
                    img.onerror = () => {
                        placeholder.textContent = 'Error loading image';
                        placeholder.style.fontSize = '12px';
                        placeholder.style.color = '#dc3545';
                        placeholder.style.textAlign = 'center';
                    };
                    placeholder.appendChild(img);
                }
                container.appendChild(placeholder);
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger btn-sm position-absolute top-0 end-0';
                deleteBtn.innerHTML = '<i class="bi bi-x"></i>';
                deleteBtn.onclick = () => {
                    if (isAddModal) {
                        selectedFilesAdd.splice(index, 1);
                        updateImagePreview(previewContainer, selectedFilesAdd, true);
                    } else {
                        existingImagesEdit.splice(index, 1);
                        updateImagePreview(previewContainer, [...existingImagesEdit, ...selectedFilesEdit], false);
                    }
                };
                container.appendChild(deleteBtn);
                container.dataset.index = index;
                previewContainer.appendChild(container);
            });
        }

        // Quản lý danh mục

        // Cập nhật select box danh mục
        function updateCategorySelectBox(selectElement, selectedId = null) {
            if (!selectElement) return;
            selectElement.innerHTML = selectElement.id === 'categorySelect' ? '<option value="">All Categories</option>' : '';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                if (category.id == selectedId) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            });
        }

        // Cập nhật select box tìm kiếm
        function updateCategorySelect() {
            updateCategorySelectBox(categorySelect, {{ selected_category | tojson }});
        }

        // Cập nhật select box thêm ghi chú
        function updateAddMemoCategorySelect() {
            const memoCategory = document.getElementById('memoCategory');
            if (!memoCategory) return;
            updateCategorySelectBox(memoCategory);
        }

        // Cập nhật danh sách danh mục
        function updateCategoriesDisplay() {
            if (!categoriesContainer) return;
            categoriesContainer.innerHTML = '';
            categories.forEach(category => {
                const div = document.createElement('div');
                div.className = 'col-12 col-md-6 mb-3';
                div.innerHTML = `
                    <div class="card" style="background-color: ${category.color || '#ffffff'};">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <span>${category.name}</span>
                            <div>
                                <button class="btn btn-sm me-1 edit-category" data-category-id="${category.id}" data-category-name="${category.name}" data-category-color="${category.color || '#ffffff'}"><i class="bi bi-pencil"></i></button>
                                <button class="btn btn-sm delete-category" data-category-id="${category.id}"><i class="bi bi-trash"></i></button>
                            </div>
                        </div>
                    </div>
                `;
                categoriesContainer.appendChild(div);
            });
            adjustCategoryTextColors();
            attachCategoryEventListeners();
        }

        // Điều chỉnh màu chữ danh mục
        function adjustCategoryTextColors() {
            if (!categoriesContainer) return;
            categoriesContainer.querySelectorAll('.card').forEach(card => {
                const bgColor = card.style.backgroundColor;
                if (bgColor) {
                    const rgb = bgColor.match(/\d+/g)?.map(Number) || [255, 255, 255];
                    const luminance = (0.299 * rgb[0] + 0.587 * rgb[1] + 0.114 * rgb[2]) / 255;
                    const textColor = luminance > 0.5 ? '#000000' : '#ffffff';
                    card.style.color = textColor;
                    card.querySelectorAll('.card-body, .card-body button').forEach(el => {
                        el.style.color = textColor;
                    });
                }
            });
        }

        // Gắn sự kiện chỉnh sửa/xóa danh mục
        function attachCategoryEventListeners() {
            if (!categoriesContainer) return;
            categoriesContainer.querySelectorAll('.edit-category').forEach(button => {
                button.addEventListener('click', () => {
                    const categoryId = button.dataset.categoryId;
                    const categoryName = button.dataset.categoryName;
                    const categoryColor = button.dataset.categoryColor;
                    if (!addCategoryForm) return;
                    addCategoryForm.innerHTML = `
                        <div class="mb-3">
                            <label for="categoryName" class="form-label">Category Name</label>
                            <input type="text" class="form-control" id="categoryName" name="name" value="${categoryName}" required>
                        </div>
                        <div class="mb-3">
                            <label for="categoryColor" class="form-label">Color</label>
                            <input type="color" class="form-control form-control-color" id="categoryColor" name="color" value="${categoryColor}">
                        </div>
                        <button type="submit" class="btn btn-primary">Update Category</button>
                    `;
                    addCategoryForm.dataset.categoryId = categoryId;
                    addCategoryForm.onsubmit = async function(e) {
                        e.preventDefault();
                        const formData = new FormData(this);
                        try {
                            const response = await fetch(`/edit_category/${categoryId}`, {
                                method: 'POST',
                                body: formData,
                                headers: { 'X-Requested-With': 'XMLHttpRequest' }
                            });
                            const data = await response.json();
                            if (data.status === 'success') {
                                const index = categories.findIndex(c => c.id == categoryId);
                                if (index !== -1) {
                                    categories[index] = data.category;
                                }
                                updateCategoriesDisplay();
                                updateCategorySelect();
                                updateAddMemoCategorySelect();
                                addCategoryForm.reset();
                                addCategoryForm.innerHTML = `
                                    <div class="mb-3">
                                        <label for="categoryName" class="form-label">Category Name</label>
                                        <input type="text" class="form-control" id="categoryName" name="name" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="categoryColor" class="form-label">Color</label>
                                        <input type="color" class="form-control form-control-color" id="categoryColor" name="color" value="#ffffff">
                                    </div>
                                    <button type="submit" class="btn btn-primary">Add Category</button>
                                `;
                                delete addCategoryForm.dataset.categoryId;
                                showFlashMessage('success', 'Category updated successfully');
                            } else {
                                showFlashMessage('danger', data.message || 'Failed to update category.');
                            }
                        } catch (error) {
                            handleError(error, 'Error updating category.');
                        }
                    };
                });
            });
            categoriesContainer.querySelectorAll('.delete-category').forEach(button => {
                button.addEventListener('click', async () => {
                    const categoryId = button.dataset.categoryId;
                    if (confirm('Are you sure you want to delete this category?')) {
                        await deleteItem(`/delete_category/${categoryId}`, 'Category deleted successfully', () => {
                            categories = categories.filter(c => c.id != categoryId);
                            updateCategoriesDisplay();
                            updateCategorySelect();
                            updateAddMemoCategorySelect();
                            updateSearch();
                        });
                    }
                });
            });
        }

        // Quản lý ghi chú và nhắc nhở

        // Lấy dữ liệu ghi chú
        async function fetchNoteData(noteId) {
            try {
                const response = await fetch(`/edit_note/${noteId}`, {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                const data = await response.json();
                if (data.status !== 'success') {
                    throw new Error(data.message || 'Failed to load note data.');
                }
                return data;
            } catch (error) {
                handleError(error, 'Error loading note.');
                throw error;
            }
        }

        // Xử lý FormData và nén ảnh
        async function prepareFormData(form, isEdit = false, selectedFiles = [], existingImages = []) {
            if (!form) throw new Error('Form is not provided.');
            const formData = new FormData(form);
            if (isEdit) {
                const editMemoCompleted = document.getElementById('editMemoCompleted');
                const editMemoShare = document.getElementById('editMemoShare');
                if (editMemoCompleted) {
                    formData.set('is_completed', editMemoCompleted.checked ? '1' : '0');
                }
                if (editMemoShare) {
                    formData.set('share', editMemoShare.checked ? '1' : '0');
                }
                existingImages.forEach(imgObj => formData.append('keep_images', imgObj.originalIndex));
            } else {
                formData.set('is_completed', formData.get('is_completed') ? '1' : '');
                formData.set('share', formData.get('share') ? '1' : '');
            }
            const dueDate = formData.get('due_date');
            if (dueDate) {
                formData.set('due_date', dueDate.slice(0, 16));
            }
            formData.delete('images');
            for (const file of selectedFiles) {
                try {
                    if (file.type === 'image/heic' || file.name?.toLowerCase().endsWith('.heic')) {
                        formData.append('images', file);
                    } else {
                        const compressedFile = await compressImage(file, 0.2);
                        formData.append('images', compressedFile);
                    }
                } catch (err) {
                    handleError(err, 'Failed to process image.');
                    throw err;
                }
            }
            return formData;
        }

        // Mở modal chỉnh sửa ghi chú
        async function openEditMemoModal(noteId) {
            try {
                const data = await fetchNoteData(noteId);
                const note = data.note;
                const editMemoId = document.getElementById('editMemoId');
                const editMemoTitle = document.getElementById('editMemoTitle');
                const editMemoContent = document.getElementById('editMemoContent');
                const editMemoDueDate = document.getElementById('editMemoDueDate');
                const editMemoCategory = document.getElementById('editMemoCategory');
                const editMemoShare = document.getElementById('editMemoShare');
                const editMemoCompleted = document.getElementById('editMemoCompleted');
                const editImagePreview = document.getElementById('editImagePreview');
                const editMemoImages = document.getElementById('editMemoImages');
                if (!editMemoId || !editMemoTitle || !editMemoContent || !editMemoCategory || !editImagePreview || !editMemoImages) {
                    throw new Error('Missing required DOM elements.');
                }
                editMemoId.value = note.id;
                editMemoTitle.value = note.title || '';
                editMemoContent.value = note.content || '';
                editMemoDueDate.value = note.due_date || '';
                editMemoShare.checked = !!note.share_id;
                editMemoCompleted.checked = note.is_completed === true;
                editImagePreview.innerHTML = '';
                existingImagesEdit = note.images
                    ? note.images.map((img, idx) => ({
                        url: `data:image/${img.filename.split('.').pop().toLowerCase()};base64,${img.data}`,
                        originalIndex: idx
                    }))
                    : [];
                selectedFilesEdit = [];
                updateImagePreview(editImagePreview, existingImagesEdit, false);
                editMemoCategory.innerHTML = '';
                data.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    if (category.id == note.category_id) {
                        option.selected = true;
                    }
                    editMemoCategory.appendChild(option);
                });
                editMemoImages.value = '';
                modals.editMemo.show();
            } catch (error) {
                // Lỗi đã được xử lý trong fetchNoteData
            }
        }

        // Mở modal xem ghi chú
        async function openViewMemoModal(noteId) {
            try {
                const data = await fetchNoteData(noteId);
                const note = data.note;
                const viewMemoTitle = document.getElementById('viewMemoTitle');
                const viewMemoContent = document.getElementById('viewMemoContent');
                const viewMemoDueDate = document.getElementById('viewMemoDueDate');
                const viewMemoCategory = document.getElementById('viewMemoCategory');
                const viewMemoShare = document.getElementById('viewMemoShare');
                const viewMemoCompleted = document.getElementById('viewMemoCompleted');
                const viewMemoImages = document.getElementById('viewMemoImages');
                if (!viewMemoTitle || !viewMemoContent || !viewMemoDueDate || !viewMemoCategory || !viewMemoShare || !viewMemoCompleted || !viewMemoImages) {
                    throw new Error('Missing required DOM elements.');
                }
                viewMemoTitle.textContent = note.title || '';
                viewMemoContent.innerHTML = linkify(note.content || '');
                viewMemoDueDate.textContent = note.due_date ? `Due: ${formatDateJST(note.due_date)}` : '';
                viewMemoCategory.textContent = `Category: ${note.category_name || 'None'}`;
                viewMemoShare.innerHTML = note.share_id ? `Share: <a href="{{ url_for('share_note', share_id='') }}${note.share_id}" target="_blank">Link</a>` : '';
                viewMemoCompleted.textContent = `Status: ${note.is_completed ? 'Completed' : 'Incomplete'}`;
                viewMemoImages.innerHTML = '';
                if (note.images?.length) {
                    note.images.forEach(image => {
                        const container = document.createElement('div');
                        container.className = 'position-relative';
                        const img = document.createElement('img');
                        img.src = `data:image/${image.filename.split('.').pop().toLowerCase()};base64,${image.data}`;
                        img.style.maxWidth = '100px';
                        img.style.maxHeight = '100px';
                        img.style.objectFit = 'contain';
                        img.classList.add('img-thumbnail');
                        img.style.cursor = 'pointer';
                        img.onclick = () => {
                            const enlargedImage = document.getElementById('enlargedImage');
                            if (enlargedImage) {
                                enlargedImage.src = img.src;
                                modals.imageView.show();
                            }
                        };
                        img.onerror = () => {
                            showFlashMessage('danger', `Failed to load image: ${image.filename}`);
                        };
                        container.appendChild(img);
                        viewMemoImages.appendChild(container);
                    });
                } else {
                    viewMemoImages.textContent = 'No images available.';
                }
                viewMemoContent.onclick = function(e) {
                    if (e.target.tagName === 'A') return;
                    modals.viewMemo.hide();
                    const handler = function() {
                        openEditMemoModal(note.id);
                        document.getElementById('viewMemoModal').removeEventListener('hidden.bs.modal', handler);
                    };
                    document.getElementById('viewMemoModal').addEventListener('hidden.bs.modal', handler);
                };
                modals.viewMemo.show();
            } catch (error) {
                // Lỗi đã được xử lý trong fetchNoteData
            }
        }

        // Gắn sự kiện toggle hoàn thành
        function attachToggleSwitchListeners() {
            document.querySelectorAll('.complete-switch').forEach(switchEl => {
                switchEl.addEventListener('change', async () => {
                    const noteId = parseInt(switchEl.dataset.noteId);
                    const isChecked = switchEl.checked;
                    try {
                        const response = await fetch(`/toggle_complete/${noteId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        if (response.ok) {
                            const note = notes.find(n => n.id === noteId);
                            if (note) {
                                note.is_completed = isChecked;
                                updateReminders();
                                if (showIncomplete.checked || showCompleted.checked) {
                                    updateSearch();
                                }
                            }
                        } else {
                            console.error('Toggle failed:', await response.json());
                            switchEl.checked = !isChecked;
                        }
                    } catch (error) {
                        handleError(error, 'Error toggling note completion.');
                        switchEl.checked = !isChecked;
                    }
                });
            });
        }

        // Cập nhật sự kiện ghi chú
        function updateNotesEventListeners() {
            attachToggleSwitchListeners();
            document.querySelectorAll('.btn-delete-memo').forEach(button => {
                button.removeEventListener('click', openEditMemoModal);
            });
        }

        // Cập nhật nhắc nhở
        function updateReminders() {
            if (!remindersDiv) return;
            const now = new Date();
            const search = searchInput?.value.toLowerCase() || '';
            const category_id = categorySelect?.value || '';
            const show_completed = showCompleted?.checked || false;
            const show_incomplete = showIncomplete?.checked || false;
            let filteredNotes = notes.filter(note => {
                const matchesSearch = !search ||
                    (note.title?.toLowerCase().includes(search) ||
                     note.content?.toLowerCase().includes(search));
                const matchesCategory = !category_id || note.category_id === parseInt(category_id);
                const matchesCompletion =
                    (show_completed && note.is_completed) ||
                    (show_incomplete && !note.is_completed) ||
                    (!show_completed && !show_incomplete);
                return matchesSearch && matchesCategory && matchesCompletion;
            });
            const reminders = filteredNotes
                .filter(note => {
                    if (!note.due_date) return false;
                    const dueDateJST = new Date(note.due_date);
                    return dueDateJST <= now && !note.is_completed;
                })
                .sort((a, b) => new Date(a.due_date) - new Date(b.due_date));
            remindersDiv.innerHTML = '';
            reminders.forEach(note => {
                const reminder = document.createElement('div');
                reminder.className = 'alert alert-warning reminder-item';
                if (note.id == currentlyClickedReminderId) {
                    reminder.classList.add('clicked');
                }
                reminder.dataset.noteId = note.id;
                const dueDateFormatted = formatDateJST(note.due_date);
                reminder.textContent = `Reminder: "${note.title || ''}" is due at ${dueDateFormatted}`;
                remindersDiv.appendChild(reminder);
            });
            attachReminderListeners();
        }

        // Gắn sự kiện nhắc nhở
        function attachReminderListeners() {
            document.querySelectorAll('.reminder-item').forEach(reminder => {
                reminder.addEventListener('click', () => {
                    const noteId = reminder.dataset.noteId;
                    document.querySelectorAll('.reminder-item').forEach(r => {
                        r.classList.remove('clicked');
                    });
                    reminder.classList.add('clicked');
                    currentlyClickedReminderId = noteId;
                    const row = document.querySelector(`tr[data-task-id="${noteId}"]`);
                    if (row) {
                        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        row.style.backgroundColor = '#fff3cd';
                        setTimeout(() => row.style.backgroundColor = '', 1000);
                    }
                });
            });
        }

        // Cập nhật tìm kiếm
        async function updateSearch() {
            currentlyClickedReminderId = null;
            if (!notesContainer) return;
            const loading = document.createElement('div');
            loading.textContent = 'Loading...';
            notesContainer.innerHTML = '';
            notesContainer.appendChild(loading);
            try {
                const search = searchInput?.value.toLowerCase() || '';
                const category_id = categorySelect?.value || '';
                const show_completed = showCompleted?.checked ? 1 : 0;
                const show_incomplete = showIncomplete?.checked ? 1 : 0;
                const params = new URLSearchParams({
                    search,
                    category_id,
                    show_completed,
                    show_incomplete
                });
                const response = await fetch(`/task?${params.toString()}`);
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newNotesContainer = doc.getElementById('notesContainer');
                if (newNotesContainer) {
                    notesContainer.innerHTML = newNotesContainer.innerHTML;
                }
                const newNotesData = doc.querySelector('script')?.textContent.match(/let notes = (\[.*?\]);/s);
                if (newNotesData) {
                    notes = JSON.parse(newNotesData[1]);
                }
                const newCategoriesData = doc.querySelector('script')?.textContent.match(/let categories = (\[.*?\]);/s);
                if (newCategoriesData) {
                    categories = JSON.parse(newCategoriesData[1]);
                    updateCategorySelect();
                    updateAddMemoCategorySelect();
                }
                updateNotesEventListeners();
                updateReminders();
                updateDueDateDisplays();
                toggleRemindersVisibility();
                attachCategoryToggleListeners();
            } catch (error) {
                handleError(error, 'Error searching notes.');
            } finally {
                loading.remove();
            }
        }

        // Gợi ý triển khai API JSON cho updateSearch (tương lai)
        /*
        async function updateSearchWithJSON() {
            try {
                const search = searchInput?.value.toLowerCase() || '';
                const category_id = categorySelect?.value || '';
                const show_completed = showCompleted?.checked ? 1 : 0;
                const show_incomplete = showIncomplete?.checked ? 1 : 0;
                const params = new URLSearchParams({ search, category_id, show_completed, show_incomplete });
                const response = await fetch(`/api/notes?${params.toString()}`);
                const data = await response.json();
                if (data.status === 'success') {
                    notes = data.notes;
                    categories = data.categories;
                    // Cập nhật DOM dựa trên notes và categories
                    updateCategorySelect();
                    updateAddMemoCategorySelect();
                    updateNotesEventListeners();
                    updateReminders();
                    updateDueDateDisplays();
                    toggleRemindersVisibility();
                    attachCategoryToggleListeners();
                } else {
                    throw new Error(data.message || 'Failed to fetch notes.');
                }
            } catch (error) {
                handleError(error, 'Error searching notes.');
            }
        }
        */

        // Quản lý giao diện và hệ thống

        // Ẩn/hiện nhắc nhở
        function toggleRemindersVisibility() {
            if (remindersDiv) {
                remindersDiv.style.display = showReminders?.checked ? 'block' : 'none';
            }
        }

        // Cập nhật kích thước DB
        async function updateDbSize() {
            try {
                const res = await fetch('/db_size');
                const data = await res.json();
                const dbSize = document.getElementById('dbSize');
                if (dbSize) {
                    dbSize.textContent = data.size_mb > 0 ? `${data.size_mb} MB` : `${data.size_kb} KB`;
                }
            } catch (error) {
                handleError(error, 'Error fetching database size.');
            }
        }

        // Xóa mục
        async function deleteItem(endpoint, successMessage, updateCallback) {
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                const data = await response.json();
                if (data.status === 'success') {
                    updateCallback();
                    showFlashMessage('success', successMessage);
                } else {
                    showFlashMessage('danger', data.message || `Failed to delete item.`);
                }
            } catch (error) {
                handleError(error, `Error deleting item.`);
            }
        }

        // Cập nhật theme
        function updateTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        }

        // Gắn sự kiện toggle danh mục
        function attachCategoryToggleListeners() {
            document.querySelectorAll('.toggle-category').forEach(button => {
                button.addEventListener('click', () => {
                    const categoryId = button.dataset.categoryId;
                    const tableWrapper = document.getElementById(`category-table-${categoryId}`);
                    const icon = document.getElementById(`toggle-icon-${categoryId}`);
                    if (tableWrapper && icon) {
                        tableWrapper.classList.toggle('collapsed');
                        icon.classList.toggle('bi-chevron-down');
                        icon.classList.toggle('bi-chevron-right');
                    }
                });
            });
        }

        // Khởi tạo sự kiện
        document.addEventListener('DOMContentLoaded', () => {
    // Xử lý backdrop cho addMemoModal
    const addMemoModalEl = document.getElementById('addMemoModal');
    if (addMemoModalEl) {
        addMemoModalEl.addEventListener('show.bs.modal', () => {
            cleanBackdrops();
        });
        addMemoModalEl.addEventListener('hidden.bs.modal', () => {
            cleanBackdrops();
            // Reset form và state khi đóng modal
            const addMemoForm = document.getElementById('addMemoForm');
            if (addMemoForm) {
                addMemoForm.reset();
                selectedFilesAdd = [];
                const imagePreview = document.getElementById('imagePreview');
                if (imagePreview) {
                    imagePreview.innerHTML = '';
                }
            }
        });
    }

    // Khởi tạo theme
    if (themeSelect) {
        themeSelect.value = currentTheme;
        updateTheme(currentTheme);
        themeSelect.addEventListener('change', () => {
            updateTheme(themeSelect.value);
        });
    }

    // Xử lý submit form thêm ghi chú
    const addMemoForm = document.getElementById('addMemoForm');
    if (addMemoForm) {
        addMemoForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            try {
                const formData = await prepareFormData(this, false, selectedFilesAdd);
                const response = await fetch('{{ url_for("add_note") }}', {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                if (response.redirected) {
                    window.location.href = response.url;
                } else {
                    const data = await response.json();
                    if (data.status === 'success') {
                        modals.addMemo.hide();
                        updateSearch();
                    } else {
                        showFlashMessage('danger', data.message || 'Failed to add memo.');
                    }
                }
            } catch (error) {
                handleError(error, 'Error adding memo.');
            }
        });
    }

    // Xử lý submit form chỉnh sửa ghi chú
    if (editMemoForm) {
        editMemoForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const noteId = this.querySelector('#editMemoId')?.value;
            if (!noteId) return;
            try {
                const formData = await prepareFormData(this, true, selectedFilesEdit, existingImagesEdit);
                const response = await fetch(`/edit_note/${noteId}`, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                const data = await response.json();
                if (data.status === 'success') {
                    modals.editMemo.hide();
                    updateSearch();
                    showFlashMessage('success', data.message || 'Memo updated successfully.');
                } else {
                    showFlashMessage('danger', data.message || 'Failed to update note.');
                }
            } catch (error) {
                handleError(error, 'Error updating memo.');
            }
        });
    }

    // Xử lý xóa ghi chú
    document.addEventListener('click', function(e) {
        if (e.target.closest('.btn-delete-memo')) {
            const noteId = e.target.closest('.btn-delete-memo').dataset.noteId;
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            if (confirmDeleteBtn) {
                confirmDeleteBtn.onclick = async function() {
                    await deleteItem(`/delete_note/${noteId}`, 'Memo deleted successfully', () => {
                        modals.confirmDelete.hide();
                        updateSearch();
                    });
                };
                modals.confirmDelete.show();
            }
        }
    });

    // Xử lý submit form liên kết
    const linksForm = document.getElementById('linksForm');
    if (linksForm) {
        linksForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            try {
                const inputs = document.querySelectorAll('.link-input');
                const links = Array.from(inputs).map(input => input.value.trim()).filter(val => val);
                const res = await fetch('/links', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                    body: JSON.stringify({ links })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    showFlashMessage('success', 'Links updated!');
                    modals.links.hide();
                } else {
                    showFlashMessage('danger', data.message || 'Failed to update links.');
                }
            } catch (error) {
                handleError(error, 'Error updating links.');
            }
        });
    }

    // Xử lý logout
    const confirmLogoutBtn = document.getElementById('confirmLogoutBtn');
    if (confirmLogoutBtn) {
        confirmLogoutBtn.addEventListener('click', async () => {
            try {
                const response = await fetch('/logout', {
                    method: 'POST',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                if (response.ok) {
                    window.location.href = '/login';
                } else {
                    throw new Error('Logout failed.');
                }
            } catch (error) {
                handleError(error, 'Error logging out.');
            }
        });
    }

    // Xử lý tìm kiếm
    if (searchInput) {
        searchInput.addEventListener('input', debounce(updateSearch, 300));
    }

    // Xử lý chọn danh mục và trạng thái
    if (categorySelect) {
        categorySelect.addEventListener('change', updateSearch);
    }
    if (showCompleted) {
        showCompleted.addEventListener('change', updateSearch);
    }
    if (showIncomplete) {
        showIncomplete.addEventListener('change', updateSearch);
    }
    if (showReminders) {
        showReminders.addEventListener('change', toggleRemindersVisibility);
    }

    // Xử lý chọn ảnh
    const memoImages = document.getElementById('memoImages');
    if (memoImages) {
        memoImages.addEventListener('change', function() {
            selectedFilesAdd = Array.from(this.files);
            updateImagePreview(document.getElementById('imagePreview'), selectedFilesAdd, true);
        });
    }
    const editMemoImages = document.getElementById('editMemoImages');
    if (editMemoImages) {
        editMemoImages.addEventListener('change', function() {
            selectedFilesEdit = Array.from(this.files);
            updateImagePreview(document.getElementById('editImagePreview'), [...existingImagesEdit, ...selectedFilesEdit], false);
        });
    }

    // Xử lý thêm danh mục
    if (addCategoryForm) {
        addCategoryForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            if (this.dataset.categoryId) return; // Đang ở chế độ chỉnh sửa
            const formData = new FormData(this);
            try {
                const response = await fetch('/add_category', {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                const data = await response.json();
                if (data.status === 'success') {
                    categories.push(data.category);
                    updateCategoriesDisplay();
                    updateCategorySelect();
                    updateAddMemoCategorySelect();
                    this.reset();
                    showFlashMessage('success', 'Category added successfully.');
                } else {
                    showFlashMessage('danger', data.message || 'Failed to add category.');
                }
            } catch (error) {
                handleError(error, 'Error adding category.');
            }
        });
    }

    // Khởi tạo giao diện
    updateCategorySelect();
    updateAddMemoCategorySelect();
    updateNotesEventListeners();
    updateDbSize();
    toggleRemindersVisibility();
    attachCategoryToggleListeners();
});
document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const showIncomplete = document.getElementById('showIncomplete');
    if (showIncomplete && !urlParams.has('show_incomplete')) {
        showIncomplete.checked = true;
    }
});
    </script>
{% endblock %}