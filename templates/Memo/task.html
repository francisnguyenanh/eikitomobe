{% extends "Memo/base.html" %}
{% block title %}Task List{% endblock %}
{% block content %}
    <style>
        .task-category {
            font-weight: bold;
            font-size: 1.1rem;
            margin-top: 2rem;
            margin-bottom: 0.5rem;
            color: #0d6efd;
            letter-spacing: 0.5px;
        }
        .task-table th, .task-table td {
            vertical-align: middle !important;
        }
        .task-table .task-title {
            font-weight: 500;
        }
        .task-table .task-content {
            color: #555;
            font-size: 0.97em;
        }
        .task-table .task-due {
            font-size: 0.97em;
            color: #b02a37;
        }
        .task-table .task-complete:checked + span {
            text-decoration: line-through;
            color: #888;
        }
        .task-table .delete-btn {
            color: #b02a37;
            cursor: pointer;
            font-size: 1.2em;
            transition: color 0.15s;
        }
        .task-table .delete-btn:hover {
            color: #dc3545;
        }
        .card {
            background-color: var(--card-bg);
            font-family: 'Noto Sans JP', sans-serif;
        }
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .reminder-item.clicked {
            background-color: var(--primary-color) !important;
            color: #ffffff;
        }
        .reminder-item.clicked:hover {
            background-color: #28a745 !important;
            color: #ffffff;
        }
        .reminder-item:hover {
            background-color: #ffca2c;
        }
        #viewMemoModal .modal-body {
            font-family: 'Noto Sans JP', sans-serif;
        }
        #viewMemoModal #viewMemoTitle {
            font-family: 'Kosugi Maru', sans-serif;
            font-size: 1.5rem;
        }
        #viewMemoModal #viewMemoContent {
            background-color: var(--card-bg);
            padding: 18px;
            border-radius: 5px;
            min-height: 200px;
            max-height: 400px;
            font-size: 1.1rem;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            border: 1px solid #ddd;
        }
        #imagePreview img, #editImagePreview img, #viewMemoImages img {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 5px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .position-relative {
            display: inline-block;
        }
        .position-relative .btn-danger {
            padding: 2px 6px;
            font-size: 12px;
        }
        .link-input[readonly] {
            background-color: #f3f3f3 !important;
            color: #555;
            cursor: pointer;
            transition: background 0.2s;
        }
        .link-input:not([readonly]) {
            background-color: #fffbe6 !important;
            color: #212529;
            transition: background 0.2s;
        }
        .link-input:focus {
            background-color: #fffde7 !important;
            border-color: #ffe066;
            outline: none;
        }
    </style>


        <form class="mb-3" id="searchForm">
            <div class="input-group mb-2">
                <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#addMemoModal" title="Add New Note">
                    <i class="bi bi-plus-circle"></i>
                </button>
                <input type="text" class="form-control" id="searchInput" name="search" placeholder="Search notes..." value="{{ search_query }}">
            </div>
            <div class="row">
                <div class="col-md-4">
                    <select class="form-select mb-2" name="category_id" id="categorySelect">
                        <option value="">All Categories</option>
                        {% for category in categories %}
                            <option value="{{ category.id }}" {% if selected_category == category.id %}selected{% endif %}>{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="showCompleted" name="show_completed" value="1" {% if show_completed %}checked{% endif %}>
                        <label class="form-check-label" for="showCompleted"><i class="bi bi-check2"></i> Completed</label>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="showIncomplete" name="show_incomplete" value="1" {% if show_incomplete is none or show_incomplete %}checked{% endif %}>
                        <label class="form-check-label" for="showIncomplete"><i class="bi bi-circle"></i> Incomplete</label>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="showReminders" name="show_reminders" value="1">
                        <label class="form-check-label" for="showReminders"><i class="bi bi-bell"></i> Reminders</label>
                    </div>
                </div>
            </div>
        </form>
        <div id="reminders" class="mb-3"></div>
        <div id="notesContainer">
            {% for category in categories %}
            <div class="task-category" style="color: {{ category.color or '#0d6efd' }}">
                <i class="bi bi-folder2-open"></i> {{ category.name }}
            </div>
            <table class="table table-hover task-table mb-4">
                <thead>
                    <tr>
                        <th style="width:40px"></th>
                        <th style="width:40px"></th>
                        <th>Tiêu đề</th>
                        <th>Nội dung</th>
                        <th>Hạn</th>
                        <th style="width:100px">Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    {% for note in notes if note.category_id == category.id %}
                    <tr data-task-id="{{ note.id }}">
                        <td>
                            <input type="checkbox" class="form-check-input task-complete complete-switch" data-note-id="{{ note.id }}" {% if note.is_completed %}checked{% endif %}>
                        </td>
                        <td>
                            <i class="bi bi-trash delete-btn btn-delete-memo" data-note-id="{{ note.id }}" title="Xoá"></i>
                        </td>
                        <td>
                            <span class="task-title" onclick="openViewMemoModal({{ note.id }})" style="cursor:pointer;">{{ note.title }}</span>
                        </td>
                        <td>
                            <span class="task-content">{{ note.content|truncate(100) }}</span>
                        </td>
                        <td>
                            <span class="task-due due-date" data-due-date="{{ note.due_date.isoformat() if note.due_date else '' }}">
                                {{ note.due_date.strftime('%Y-%m-%d %H:%M') if note.due_date else '' }}
                            </span>
                        </td>
                        <td>
                            <a href="{{ url_for('export_note', id=note.id) }}" class="btn btn-sm me-1"><i class="bi bi-file-earmark-text"></i></a>
                            <a href="{{ url_for('export_pdf', id=note.id) }}" class="btn btn-sm"><i class="bi bi-file-earmark-pdf"></i></a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endfor %}
        </div>

    <div class="modal fade" id="confirmLogoutModal" tabindex="-1" aria-labelledby="confirmLogoutModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmLogoutModalLabel">Confirm Logout</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to logout?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmLogoutBtn">Logout</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="linksModal" tabindex="-1" aria-labelledby="linksModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="linksModalLabel">Saved Links</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="linksForm">
                        <div id="linksInputs"></div>
                        <button type="submit" class="btn btn-primary mt-2">Update</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% if categories %}
    <div class="modal fade" id="addMemoModal" tabindex="-1" aria-labelledby="addMemoModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="addMemoTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="add-content-tab" data-bs-toggle="tab" data-bs-target="#add-content" type="button" role="tab">Content</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="add-meta-tab" data-bs-toggle="tab" data-bs-target="#add-meta" type="button" role="tab">Meta</button>
                        </li>
                    </ul>
                    <form id="addMemoForm" method="POST" action="{{ url_for('add_note') }}" enctype="multipart/form-data">
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="add-content" role="tabpanel">
                                <div class="mb-3">
                                    <input type="text" class="form-control" id="memoTitle" name="title" required>
                                </div>
                                <div class="mb-3">
                                    <textarea class="form-control" id="memoContent" name="content" rows="14" required></textarea>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="add-meta" role="tabpanel">
                                <div class="mb-3">
                                    <input type="file" class="form-control" id="memoImages" name="images" multiple accept="image/png,image/jpeg,image/gif,image/heic">
                                    <div id="imagePreview" class="mt-2 d-flex flex-wrap gap-2"></div>
                                </div>
                                <div class="mb-3">
                                    <input type="datetime-local" class="form-control" id="memoDueDate" name="due_date" step="60">
                                </div>
                                <div class="mb-3">
                                    <select class="form-select" id="memoCategory" name="category_id" required>
                                        {% for category in categories %}
                                            <option value="{{ category.id }}">{{ category.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" type="checkbox" id="memoShare" name="share">
                                        <label class="form-check-label" for="memoShare">Enable public sharing</label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" type="checkbox" id="memoCompleted" name="is_completed">
                                        <label class="form-check-label" for="memoCompleted">Completed</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Memo</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    <div class="modal fade" id="viewMemoModal" tabindex="-1" aria-labelledby="viewMemoModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="viewMemoTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="view-content-tab" data-bs-toggle="tab" data-bs-target="#view-content" type="button" role="tab">Content</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="view-meta-tab" data-bs-toggle="tab" data-bs-target="#view-meta" type="button" role="tab">Meta</button>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="view-content" role="tabpanel">
                            <h6 id="viewMemoTitle" class="mb-3"></h6>
                            <p id="viewMemoContent" style="white-space: pre-wrap;"></p>
                        </div>
                        <div class="tab-pane fade" id="view-meta" role="tabpanel">
                            <div id="viewMemoImages" class="mt-2 d-flex flex-wrap gap-2"></div>
                            <p id="viewMemoDueDate" class="text-muted"></p>
                            <p id="viewMemoCategory" class="text-muted"></p>
                            <p id="viewMemoShare" class="text-muted"></p>
                            <p id="viewMemoCompleted" class="text-muted"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="imageViewModal" tabindex="-1" aria-labelledby="imageViewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="enlargedImage" src="" style="max-width: 100%; max-height: 80vh; object-fit: contain;">
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmDeleteModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this memo?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>
    {% if categories %}
    <div class="modal fade" id="editMemoModal" tabindex="-1" aria-labelledby="editMemoModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="editMemoTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="edit-content-tab" data-bs-toggle="tab" data-bs-target="#edit-content" type="button" role="tab">Content</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="edit-meta-tab" data-bs-toggle="tab" data-bs-target="#edit-meta" type="button" role="tab">Meta</button>
                        </li>
                    </ul>
                    <form id="editMemoForm" method="POST" enctype="multipart/form-data">
                        <input type="hidden" id="editMemoId" name="id">
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="edit-content" role="tabpanel">
                                <div class="mb-3">
                                    <input type="text" class="form-control" id="editMemoTitle" name="title" required>
                                </div>
                                <div class="mb-3">
                                    <textarea class="form-control" id="editMemoContent" name="content" rows="14" required></textarea>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="edit-meta" role="tabpanel">
                                <div class="mb-3">
                                    <input type="file" class="form-control" id="editMemoImages" name="images" multiple accept="image/png,image/jpeg,image/gif,image/heic">
                                    <div id="editImagePreview" class="mt-2 d-flex flex-wrap gap-2"></div>
                                </div>
                                <div class="mb-3">
                                    <input type="datetime-local" class="form-control" id="editMemoDueDate" name="due_date" step="60">
                                </div>
                                <div class="mb-3">
                                    <select class="form-select" id="editMemoCategory" name="category_id" required>
                                        {% for category in categories %}
                                            <option value="{{ category.id }}">{{ category.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" type="checkbox" id="editMemoShare" name="share">
                                        <label class="form-check-label" for="editMemoShare">Enable public sharing</label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" type="checkbox" id="editMemoCompleted" name="is_completed">
                                        <label class="form-check-label" for="editMemoCompleted">Completed</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Update Memo</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    <div class="modal fade" id="manageCategoriesModal" tabindex="-1" aria-labelledby="manageCategoriesModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body">
                    <form id="addCategoryForm" class="mb-3">
                        <div class="mb-3">
                            <label for="categoryName" class="form-label">Category Name</label>
                            <input type="text" class="form-control" id="categoryName" name="name" required>
                        </div>
                        <div class="row mb-3 align-items-end">
                            <div class="col">
                                <input type="color" class="form-control form-control-color" id="categoryColor" name="color" value="#ffffff">
                            </div>
                            <div class="col-auto">
                                <button type="submit" class="btn btn-primary mt-4">Add Category</button>
                            </div>
                        </div>
                    </form>
                    <div id="categoriesContainer" class="row">
                        {% for category in categories %}
                            <div class="col-12 col-md-6 mb-3">
                                <div class="card" style="background-color: {{ category.color or '#ffffff' }};">
                                    <div class="card-body d-flex justify-content-between align-items-center">
                                        <span>{{ category.name }}</span>
                                        <div>
                                            <button class="btn btn-sm me-1 edit-category" data-category-id="{{ category.id }}" data-category-name="{{ category.name }}" data-category-color="{{ category.color or '#ffffff' }}"><i class="bi bi-pencil"></i></button>
                                            <button class="btn btn-sm delete-category" data-category-id="{{ category.id }}"><i class="bi bi-trash"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="settingsModalLabel">Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" action="{{ url_for('change_password') }}">
                        <div class="mb-3">
                            <label for="new_password" class="form-label">Change Password</label>
                            <input type="password" class="form-control" id="new_password" name="new_password" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Password</button>
                    </form>
                    <hr>
                    <div class="mb-3">
                        <label for="themeSelect" class="form-label">Theme</label>
                        <select class="form-select" id="themeSelect">
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                            <option value="blue">Blue</option>
                            <option value="green">Green</option>
                            <option value="purple">Purple</option>
                            <option value="red">Red</option>
                            <option value="orange">Orange</option>
                            <option value="yellow">Yellow</option>
                            <option value="pink">Pink</option>
                            <option value="cyan">Cyan</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <footer class="text-end p-2" style="position:fixed;right:0;bottom:0;z-index:999;width:auto;min-width:180px;background:rgba(255,255,255,0.8);font-size:0.95em;">
        DB size: <span id="dbSize">...</span>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentlyClickedReminderId = null;
        let selectedFilesAdd = [];
        let selectedFilesEdit = [];
        let existingImagesEdit = [];
        const editMemoModal = new bootstrap.Modal(document.getElementById('editMemoModal'));
        const editMemoForm = document.getElementById('editMemoForm');
        const themeSelect = document.getElementById('themeSelect');
        const currentTheme = localStorage.getItem('theme') || '{{ session.get("theme", "light") }}';
        document.documentElement.setAttribute('data-theme', currentTheme);
        themeSelect.value = currentTheme;
        themeSelect.addEventListener('change', () => {
            const theme = themeSelect.value;
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            fetch('/set_theme', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({theme: theme})
            });
        });
        const searchInput = document.getElementById('searchInput');
        const categorySelect = document.getElementById('categorySelect');
        const showCompleted = document.getElementById('showCompleted');
        const showIncomplete = document.getElementById('showIncomplete');
        const showReminders = document.getElementById('showReminders');
        const notesContainer = document.getElementById('notesContainer');
        const remindersDiv = document.getElementById('reminders');
        const addMemoModal = new bootstrap.Modal(document.getElementById('addMemoModal'));
        const manageCategoriesModal = new bootstrap.Modal(document.getElementById('manageCategoriesModal'));
        const addCategoryForm = document.getElementById('addCategoryForm');
        const categoriesContainer = document.getElementById('categoriesContainer');
        const viewMemoModal = new bootstrap.Modal(document.getElementById('viewMemoModal'));
        let notes = {{ notes_data | tojson }};
        let categories = {{ categories | tojson }};
        let searchTimeout;
        async function compressImage(file, targetSizeRatio = 0.2) {
            return new Promise((resolve, reject) => {
                if (file.type === 'image/heic' || file.name.toLowerCase().endsWith('.heic')) {
                    resolve(file);
                } else {
                    const img = new Image();
                    img.src = URL.createObjectURL(file);
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const scaleFactor = Math.sqrt(targetSizeRatio);
                        canvas.width = img.width * scaleFactor;
                        canvas.height = img.height * scaleFactor;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        canvas.toBlob(
                            newBlob => {
                                const newFile = new File([newBlob], file.name, {
                                    type: 'image/jpeg',
                                    lastModified: Date.now()
                                });
                                URL.revokeObjectURL(img.src);
                                resolve(newFile);
                            },
                            'image/jpeg',
                            0.2
                        );
                    };
                    img.onerror = () => {
                        URL.revokeObjectURL(img.src);
                        reject(new Error('Failed to load image'));
                    };
                }
            });
        }
        function formatDateJST(isoDate) {
            if (!isoDate) return '';
            const date = new Date(isoDate);
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                weekday: 'short',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false,
                timeZone: 'Asia/Tokyo'
            };
            const formatter = new Intl.DateTimeFormat('ja-JP', options);
            const parts = formatter.formatToParts(date);
            const year = parts.find(p => p.type === 'year').value;
            const month = parts.find(p => p.type === 'month').value;
            const day = parts.find(p => p.type === 'day').value;
            const weekday = parts.find(p => p.type === 'weekday').value;
            const hour = parts.find(p => p.type === 'hour').value;
            const minute = parts.find(p => p.type === 'minute').value;
            return `${year}/${month}/${day} (${weekday}) ${hour}:${minute}`;
        }
        function linkify(text) {
            const urlRegex = /(https?:\/\/[^\s<]+[^\s<.,:;"')\]\}])/g;
            return text.replace(urlRegex, url => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`);
        }
        function updateDueDateDisplays() {
            document.querySelectorAll('.due-date').forEach(el => {
                const isoDate = el.getAttribute('data-due-date');
                if (isoDate) {
                    el.textContent = formatDateJST(isoDate);
                }
            });
        }
        function updateImagePreview(previewContainer, files, isAddModal) {
            previewContainer.innerHTML = '';
            files.forEach((fileObj, index) => {
                const container = document.createElement('div');
                container.className = 'position-relative';
                const placeholder = document.createElement('div');
                placeholder.style.width = '100px';
                placeholder.style.height = '100px';
                placeholder.style.display = 'flex';
                placeholder.style.alignItems = 'center';
                placeholder.style.justifyContent = 'center';
                placeholder.style.border = '1px solid #ddd';
                placeholder.style.borderRadius = '5px';
                placeholder.style.backgroundColor = '#f8f9fa';
                placeholder.classList.add('img-thumbnail');
                if (fileObj && typeof fileObj === 'object' && fileObj.url) {
                    const img = document.createElement('img');
                    img.src = fileObj.url;
                    img.style.maxWidth = '100px';
                    img.style.maxHeight = '100px';
                    img.style.objectFit = 'contain';
                    img.onerror = () => {
                        placeholder.textContent = 'Error loading image';
                        placeholder.style.fontSize = '12px';
                        placeholder.style.color = '#dc3545';
                        placeholder.style.textAlign = 'center';
                    };
                    placeholder.appendChild(img);
                } else if (fileObj && typeof fileObj === 'object' && (fileObj.type === 'image/heic' || (fileObj.name && fileObj.name.toLowerCase().endsWith('.heic')))) {
                    placeholder.textContent = 'HEIC';
                    placeholder.style.fontSize = '14px';
                    placeholder.style.color = '#666';
                    placeholder.style.textAlign = 'center';
                } else if (fileObj && typeof fileObj === 'object' && fileObj instanceof File) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(fileObj);
                    img.style.maxWidth = '100px';
                    img.style.maxHeight = '100px';
                    img.style.objectFit = 'contain';
                    img.onerror = () => {
                        placeholder.textContent = 'Error loading image';
                        placeholder.style.fontSize = '12px';
                        placeholder.style.color = '#dc3545';
                        placeholder.style.textAlign = 'center';
                    };
                    placeholder.appendChild(img);
                }
                container.appendChild(placeholder);
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger btn-sm position-absolute top-0 end-0';
                deleteBtn.innerHTML = '<i class="bi bi-x"></i>';
                deleteBtn.onclick = () => {
                    if (isAddModal) {
                        selectedFilesAdd.splice(index, 1);
                        updateImagePreview(previewContainer, selectedFilesAdd, true);
                    } else {
                        existingImagesEdit.splice(index, 1);
                        updateImagePreview(previewContainer, [...existingImagesEdit, ...selectedFilesEdit], false);
                    }
                };
                container.appendChild(deleteBtn);
                container.dataset.index = index;
                previewContainer.appendChild(container);
            });
        }
        function updateCategorySelect() {
            categorySelect.innerHTML = '<option value="">All Categories</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                if (category.id == {{ selected_category | tojson }}) {
                    option.selected = true;
                }
                categorySelect.appendChild(option);
            });
        }
        function updateCategoriesDisplay() {
            categoriesContainer.innerHTML = '';
            categories.forEach(category => {
                const div = document.createElement('div');
                div.className = 'col-12 col-md-6 mb-3';
                div.innerHTML = `
                    <div class="card" style="background-color: ${category.color || '#ffffff'};">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <span>${category.name}</span>
                            <div>
                                <button class="btn btn-sm me-1 edit-category" data-category-id="${category.id}" data-category-name="${category.name}" data-category-color="${category.color || '#ffffff'}"><i class="bi bi-pencil"></i></button>
                                <button class="btn btn-sm delete-category" data-category-id="${category.id}"><i class="bi bi-trash"></i></button>
                            </div>
                        </div>
                    </div>
                `;
                categoriesContainer.appendChild(div);
            });
            adjustCategoryTextColors();
            attachCategoryEventListeners();
        }
        function adjustCategoryTextColors() {
            categoriesContainer.querySelectorAll('.card').forEach(card => {
                const bgColor = card.style.backgroundColor;
                if (bgColor) {
                    const rgb = bgColor.match(/\d+/g)?.map(Number) || [255, 255, 255];
                    const luminance = (0.299 * rgb[0] + 0.587 * rgb[1] + 0.114 * rgb[2]) / 255;
                    const textColor = luminance > 0.5 ? '#000000' : '#ffffff';
                    card.style.color = textColor;
                    card.querySelectorAll('.card-body, .card-body button').forEach(el => {
                        el.style.color = textColor;
                    });
                }
            });
        }
        function showFlashMessage(category, message) {
            const flashContainer = document.querySelector('.container.mt-4');
            const alert = document.createElement('div');
            alert.className = `alert alert-${category} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            flashContainer.insertBefore(alert, flashContainer.firstChild);
            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 150);
            }, 3000);
        }
        function attachCategoryEventListeners() {
            categoriesContainer.querySelectorAll('.edit-category').forEach(button => {
                button.addEventListener('click', () => {
                    const categoryId = button.dataset.categoryId;
                    const categoryName = button.dataset.categoryName;
                    const categoryColor = button.dataset.categoryColor;
                    addCategoryForm.innerHTML = `
                        <div class="mb-3">
                            <label for="categoryName" class="form-label">Category Name</label>
                            <input type="text" class="form-control" id="categoryName" name="name" value="${categoryName}" required>
                        </div>
                        <div class="mb-3">
                            <label for="categoryColor" class="form-label">Color</label>
                            <input type="color" class="form-control form-control-color" id="categoryColor" name="color" value="${categoryColor}">
                        </div>
                        <button type="submit" class="btn btn-primary">Update Category</button>
                    `;
                    addCategoryForm.dataset.categoryId = categoryId;
                    addCategoryForm.onsubmit = async function(e) {
                        e.preventDefault();
                        const formData = new FormData(this);
                        try {
                            const response = await fetch(`/edit_category/${categoryId}`, {
                                method: 'POST',
                                body: formData,
                                headers: { 'X-Requested-With': 'XMLHttpRequest' }
                            });
                            const data = await response.json();
                            if (data.status === 'success') {
                                const index = categories.findIndex(c => c.id == categoryId);
                                categories[index] = data.category;
                                updateCategoriesDisplay();
                                updateCategorySelect();
                                addCategoryForm.reset();
                                addCategoryForm.innerHTML = `
                                    <div class="mb-3">
                                        <label for="categoryName" class="form-label">Category Name</label>
                                        <input type="text" class="form-control" id="categoryName" name="name" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="categoryColor" class="form-label">Color</label>
                                        <input type="color" class="form-control form-control-color" id="categoryColor" name="color" value="#ffffff">
                                    </div>
                                    <button type="submit" class="btn btn-primary">Add Category</button>
                                `;
                                delete addCategoryForm.dataset.categoryId;
                                showFlashMessage('success', 'Category updated successfully');
                            } else {
                                alert('Failed to update category: ' + (data.message || 'Unknown error'));
                            }
                        } catch (error) {
                            console.error('Update category error:', error);
                            alert('Error updating category: ' + error.message);
                        }
                    };
                });
            });
            categoriesContainer.querySelectorAll('.delete-category').forEach(button => {
                button.addEventListener('click', async () => {
                    const categoryId = button.dataset.categoryId;
                    if (confirm('Are you sure you want to delete this category?')) {
                        try {
                            const response = await fetch(`/delete_category/${categoryId}`, {
                                method: 'POST',
                                headers: { 'X-Requested-With': 'XMLHttpRequest' }
                            });
                            const data = await response.json();
                            if (data.status === 'success') {
                                categories = categories.filter(c => c.id != categoryId);
                                updateCategoriesDisplay();
                                updateCategorySelect();
                                updateSearch();
                                showFlashMessage('success', 'Category deleted successfully');
                            } else {
                                alert('Failed to delete category: ' + (data.message || 'Unknown error'));
                            }
                        } catch (error) {
                            console.error('Delete category error:', error);
                            alert('Error deleting category: ' + error.message);
                        }
                    }
                });
            });
        }
        function attachReminderListeners() {
            document.querySelectorAll('.reminder-item').forEach(reminder => {
                reminder.addEventListener('click', () => {
                    const noteId = reminder.dataset.noteId;
                    document.querySelectorAll('.reminder-item').forEach(r => {
                        r.classList.remove('clicked');
                    });
                    reminder.classList.add('clicked');
                    currentlyClickedReminderId = noteId;
                    const row = document.querySelector(`tr[data-task-id="${noteId}"]`);
                    if (row) {
                        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        row.style.backgroundColor = '#fff3cd';
                        setTimeout(() => row.style.backgroundColor = '', 1000);
                    }
                });
            });
        }
        function attachToggleSwitchListeners() {
            document.querySelectorAll('.complete-switch').forEach(switchEl => {
                switchEl.addEventListener('change', async () => {
                    const noteId = parseInt(switchEl.dataset.noteId);
                    const isChecked = switchEl.checked;
                    try {
                        const response = await fetch(`/toggle_complete/${noteId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        if (response.ok) {
                            const note = notes.find(n => n.id === noteId);
                            if (note) {
                                note.is_completed = isChecked;
                                updateReminders();
                                if (showIncomplete.checked || showCompleted.checked) {
                                    updateSearch();
                                }
                            }
                        } else {
                            console.error('Toggle failed:', await response.json());
                            switchEl.checked = !isChecked;
                        }
                    } catch (error) {
                        console.error('Toggle error:', error);
                        switchEl.checked = !isChecked;
                    }
                });
            });
        }
        function updateNotesEventListeners() {
            attachToggleSwitchListeners();
            document.querySelectorAll('.btn-delete-memo').forEach(button => {
                button.removeEventListener('click', openEditMemoModal);
            });
        }
        function updateReminders() {
            const now = new Date();
            const search = searchInput.value.toLowerCase();
            const category_id = categorySelect.value;
            const show_completed = showCompleted.checked;
            const show_incomplete = showIncomplete.checked;
            let filteredNotes = notes.filter(note => {
                const matchesSearch = !search ||
                    (note.title.toLowerCase().includes(search) ||
                     note.content.toLowerCase().includes(search));
                const matchesCategory = !category_id || note.category_id === parseInt(category_id);
                const matchesCompletion =
                    (show_completed && note.is_completed) ||
                    (show_incomplete && !note.is_completed) ||
                    (!show_completed && !show_incomplete);
                return matchesSearch && matchesCategory && matchesCompletion;
            });
            const reminders = filteredNotes
                .filter(note => {
                    if (!note.due_date) return false;
                    const dueDateJST = new Date(note.due_date);
                    return dueDateJST <= now && !note.is_completed;
                })
                .sort((a, b) => new Date(a.due_date) - new Date(b.due_date));
            remindersDiv.innerHTML = '';
            reminders.forEach(note => {
                const reminder = document.createElement('div');
                reminder.className = 'alert alert-warning reminder-item';
                if (note.id == currentlyClickedReminderId) {
                    reminder.classList.add('clicked');
                }
                reminder.dataset.noteId = note.id;
                const dueDateFormatted = formatDateJST(note.due_date);
                reminder.textContent = `Reminder: "${note.title}" is due at ${dueDateFormatted}`;
                remindersDiv.appendChild(reminder);
            });
            attachReminderListeners();
        }
        async function updateSearch() {
            currentlyClickedReminderId = null;
            const search = searchInput.value.toLowerCase();
            const category_id = categorySelect.value;
            const show_completed = showCompleted.checked ? 1 : 0;
            const show_incomplete = showIncomplete.checked ? 1 : 0;
            const params = new URLSearchParams({
                search,
                category_id,
                show_completed,
                show_incomplete
            });
            try {
                const response = await fetch(`/task?${params.toString()}`);
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newNotesContainer = doc.getElementById('notesContainer');
                notesContainer.innerHTML = newNotesContainer.innerHTML;
                const newNotesData = doc.querySelector('script').textContent.match(/let notes = (\[.*?\]);/s);
                if (newNotesData) {
                    notes = JSON.parse(newNotesData[1]);
                }
                const newCategoriesData = doc.querySelector('script').textContent.match(/let categories = (\[.*?\]);/s);
                if (newCategoriesData) {
                    categories = JSON.parse(newCategoriesData[1]);
                    updateCategorySelect();
                }
                updateNotesEventListeners();
                updateReminders();
                updateDueDateDisplays();
                toggleRemindersVisibility();
            } catch (error) {
                console.error('Search error:', error);
            }
        }
        async function openEditMemoModal(noteId){
            try {
                const response = await fetch(`/edit_note/${noteId}`, {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                const data = await response.json();
                if (data.status === 'success') {
                    const note = data.note;
                    document.getElementById('editMemoId').value = note.id;
                    document.getElementById('editMemoTitle').value = note.title;
                    document.getElementById('editMemoContent').value = note.content;
                    document.getElementById('editMemoDueDate').value = note.due_date || '';
                    document.getElementById('editMemoCategory').value = note.category_id;
                    document.getElementById('editMemoShare').checked = !!note.share_id;
                    document.getElementById('editMemoCompleted').checked = note.is_completed === true;
                    const editImagePreview = document.getElementById('editImagePreview');
                    editImagePreview.innerHTML = '';
                    existingImagesEdit = note.images
                        ? note.images.map((img, idx) => ({
                            url: `data:image/${img.filename.split('.').pop()};base64,${img.data}`,
                            originalIndex: idx
                        }))
                        : [];
                    selectedFilesEdit = [];
                    updateImagePreview(editImagePreview, existingImagesEdit, false);
                    const categorySelect = document.getElementById('editMemoCategory');
                    categorySelect.innerHTML = '';
                    data.categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;
                        if (category.id == note.category_id) {
                            option.selected = true;
                        }
                        categorySelect.appendChild(option);
                    });
                    document.getElementById('editMemoImages').value = "";
                    editMemoModal.show();
                } else {
                    showFlashMessage('danger', data.message || 'Failed to load note data.');
                }
            } catch (error) {
                console.error('Error loading note:', error);
                showFlashMessage('danger', 'Error loading note.');
            }
        }
        async function openViewMemoModal(noteId) {
            try {
                const response = await fetch(`/edit_note/${noteId}`, {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                const data = await response.json();
                if (data.status === 'success') {
                    const note = data.note;
                    document.getElementById('viewMemoTitle').textContent = note.title;
                    document.getElementById('viewMemoContent').innerHTML = linkify(note.content);
                    document.getElementById('viewMemoDueDate').textContent = note.due_date ? `Due: ${formatDateJST(note.due_date)}` : '';
                    document.getElementById('viewMemoCategory').textContent = `Category: ${note.category_name ? note.category_name : 'None'}`;
                    document.getElementById('viewMemoShare').innerHTML = note.share_id ? `Share: <a href="{{ url_for('share_note', share_id='') }}${note.share_id}" target="_blank">Link</a>` : '';
                    document.getElementById('viewMemoCompleted').textContent = `Status: ${note.is_completed ? 'Completed' : 'Incomplete'}`;
                    const viewMemoImages = document.getElementById('viewMemoImages');
                    viewMemoImages.innerHTML = '';
                    if (note.images && note.images.length) {
                        note.images.forEach(image => {
                            const container = document.createElement('div');
                            container.className = 'position-relative';
                            const img = document.createElement('img');
                            img.src = `data:image/${image.filename.split('.').pop().toLowerCase()};base64,${image.data}`;
                            img.style.maxWidth = '100px';
                            img.style.maxHeight = '100px';
                            img.style.objectFit = 'contain';
                            img.classList.add('img-thumbnail');
                            img.style.cursor = 'pointer';
                            img.onclick = () => {
                                const imageViewModal = new bootstrap.Modal(document.getElementById('imageViewModal'));
                                document.getElementById('enlargedImage').src = img.src;
                                imageViewModal.show();
                            };
                            img.onerror = () => {
                                showFlashMessage('danger', `Failed to load image: ${image.filename}`);
                            };
                            container.appendChild(img);
                            viewMemoImages.appendChild(container);
                        });
                    } else {
                        viewMemoImages.textContent = 'No images available.';
                    }
                    const viewMemoContent = document.getElementById('viewMemoContent');
                    viewMemoContent.onclick = function(e) {
                        if (e.target.tagName === 'A') return;
                        viewMemoModal.hide();
                        const handler = function() {
                            openEditMemoModal(note.id);
                            document.getElementById('viewMemoModal').removeEventListener('hidden.bs.modal', handler);
                        };
                        document.getElementById('viewMemoModal').addEventListener('hidden.bs.modal', handler);
                    };
                    viewMemoModal.show();
                } else {
                    showFlashMessage('danger', data.message || 'Failed to load note data.');
                }
            } catch (error) {
                showFlashMessage('danger', 'Error loading note.');
            }
        }
        function toggleRemindersVisibility() {
            remindersDiv.style.display = showReminders.checked ? 'block' : 'none';
        }

        updateDueDateDisplays();
        toggleRemindersVisibility();

        // Xử lý preview ảnh trong modal thêm ghi chú
        document.getElementById('memoImages').addEventListener('change', function(e) {
            const imagePreview = document.getElementById('imagePreview');
            const files = Array.from(e.target.files);
            selectedFilesAdd = [...selectedFilesAdd, ...files];
            updateImagePreview(imagePreview, selectedFilesAdd, true);
        });

        // Xử lý preview ảnh trong modal chỉnh sửa ghi chú
        document.getElementById('editMemoImages').addEventListener('change', function(e) {
            const editImagePreview = document.getElementById('editImagePreview');
            const files = Array.from(e.target.files);
            selectedFilesEdit = [...selectedFilesEdit, ...files];
            updateImagePreview(editImagePreview, [...existingImagesEdit, ...selectedFilesEdit], false);
        });

        // Xóa preview ảnh khi mở addMemoModal
        document.getElementById('addMemoModal').addEventListener('show.bs.modal', function() {
            const nowJST = new Date(new Date().getTime() + 9 * 60 * 60 * 1000);
            const dateStr = nowJST.toISOString().slice(0, 16);
            document.getElementById('memoDueDate').value = dateStr;
            document.getElementById('addMemoForm').reset();
            document.getElementById('memoDueDate').value = dateStr;
            document.getElementById('imagePreview').innerHTML = '';
            selectedFilesAdd = [];
        });

        // Initialize showIncomplete to ON if no query parameter
        if (!{{ show_incomplete | tojson }}) {
            showIncomplete.checked = true;
            showCompleted.checked = false;
            updateSearch();
        }

        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(updateSearch, 300);
        });
        categorySelect.addEventListener('change', updateSearch);
        showCompleted.addEventListener('change', () => {
            updateSearch();
        });
        showIncomplete.addEventListener('change', () => {
            updateSearch();
        });
        showReminders.addEventListener('change', () => {
            toggleRemindersVisibility();
        });

        // Xử lý submit form Add Memo
        document.getElementById('addMemoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const form = this;
            const formData = new FormData(form);
            const dueDate = formData.get('due_date');
            if (dueDate) {
                formData.set('due_date', dueDate.slice(0, 16));
            }
            formData.set('is_completed', formData.get('is_completed') ? '1' : '');
            formData.set('share', formData.get('share') ? '1' : '');
            formData.delete('images');
            for (const file of selectedFilesAdd) {
                try {
                    if (file.type === 'image/heic' || file.name.toLowerCase().endsWith('.heic')) {
                        // Gửi file HEIC gốc lên server
                        formData.append('images', file);
                    } else {
                        const compressedFile = await compressImage(file, 0.2);
                        formData.append('images', compressedFile);
                    }
                } catch (err) {
                    console.error('Image compression error:', err);
                    showFlashMessage('danger', 'Failed to process image: ' + err.message);
                    return;
                }
            }
            try {
                const response = await fetch('{{ url_for("add_note") }}', {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                if (response.redirected) {
                    window.location.href = response.url;
                } else {
                    const data = await response.json();
                    if (data.status === 'success') {
                        addMemoModal.hide();
                        updateSearch();
                    } else {
                        showFlashMessage('danger', 'Failed to add memo: ' + (data.message || 'Unknown error'));
                    }
                }
            } catch (error) {
                console.error('Fetch error:', error);
                showFlashMessage('danger', 'Error adding memo: ' + error.message);
            }
        });

        // Set default due_date to current time in JST
        document.getElementById('addMemoModal').addEventListener('show.bs.modal', function() {
            const nowJST = new Date(new Date().getTime() + 9 * 60 * 60 * 1000);
            const dateStr = nowJST.toISOString().slice(0, 16);
            document.getElementById('memoDueDate').value = dateStr;
            document.getElementById('addMemoForm').reset();
            document.getElementById('memoDueDate').value = dateStr;
        });        

        // Add Category
        addCategoryForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            try {
                const response = await fetch('{{ url_for("add_category") }}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                const data = await response.json();
                if (data.status === 'success') {
                    categories.push(data.category);
                    updateCategoriesDisplay();
                    updateCategorySelect();
                    addCategoryForm.reset();
                    showFlashMessage('success', 'Category added successfully');
                } else {
                    alert('Failed to add category: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Add category error:', error);
                alert('Error adding category: ' + error.message);
            }
        });

        updateReminders();

        // Xử lý submit form Edit Memo
        document.getElementById('editMemoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            formData.set('is_completed', document.getElementById('editMemoCompleted').checked ? '1' : '0');
            formData.set('share', document.getElementById('editMemoShare').checked ? '1' : '0');
            const noteId = formData.get('id');
            formData.delete('images');
            for (const file of selectedFilesEdit) {
                try {
                    if (file.type === 'image/heic' || file.name.toLowerCase().endsWith('.heic')) {
                        // Gửi file HEIC gốc lên server
                        formData.append('images', file);
                    } else {
                        const compressedFile = await compressImage(file, 0.2);
                        formData.append('images', compressedFile);
                    }
                } catch (err) {
                    console.error('Image compression error:', err);
                    showFlashMessage('danger', 'Failed to process image: ' + err.message);
                    return;
                }
            }
            existingImagesEdit.forEach(imgObj => formData.append('keep_images', imgObj.originalIndex));
            console.log('Index ảnh giữ lại gửi về server:', existingImagesEdit.map(img => img.originalIndex));
            try {
                const response = await fetch(`/edit_note/${noteId}`, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                const data = await response.json();
                if (data.status === 'success') {
                    editMemoModal.hide();
                    updateSearch();
                    showFlashMessage('success', data.message);
                } else {
                    showFlashMessage('danger', data.message || 'Failed to update note.');
                }
            } catch (error) {
                console.error('Fetch error:', error);
                showFlashMessage('danger', 'Error updating memo: ' + error.message);
            }
        });

        document.querySelectorAll('.alert-dismissible').forEach(alert => {
            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 150);
            }, 3000);
        });

        function updateAddMemoCategorySelect() {
            const memoCategory = document.getElementById('memoCategory');
            if (!memoCategory) return;
            memoCategory.innerHTML = '';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                memoCategory.appendChild(option);
            });
        }

        function updateDbSize() {
            fetch('/db_size')
                .then(res => res.json())
                .then(data => {                    
                    let text = '';
                    if (data.size_mb > 0) {
                        text = `${data.size_mb} MB`;
                    } else {
                        text = `${data.size_kb} KB`;
                    }
                    document.getElementById('dbSize').textContent = text;
                });
        }

        updateDbSize();

    

        document.getElementById('linksForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const inputs = document.querySelectorAll('.link-input');
            const links = [];
            inputs.forEach(input => {
                const val = input.value.trim();
                if (val) links.push(val);
            });
            fetch('/links', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest'},
                body: JSON.stringify({links: links})
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    // Đóng modal hoặc thông báo thành công
                    showFlashMessage && showFlashMessage('success', 'Links updated!');
                    bootstrap.Modal.getInstance(document.getElementById('linksModal')).hide();
                } else {
                    alert('Failed to update links');
                }
            });
        });

        document.addEventListener('click', function(e) {
            if (e.target.closest('.btn-delete-memo')) {
                const noteId = e.target.closest('.btn-delete-memo').dataset.noteId;
                const confirmModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
                document.getElementById('confirmDeleteBtn').onclick = async function() {
                    try {
                        const response = await fetch(`/delete_note/${noteId}`, {
                            method: 'POST',
                            headers: {'X-Requested-With': 'XMLHttpRequest'}
                        });
                        const data = await response.json();
                        if (data.status === 'success') {
                            confirmModal.hide();
                            updateSearch();
                            showFlashMessage('success', 'Memo deleted successfully');
                        } else {
                            showFlashMessage('danger', data.message || 'Failed to delete memo.');
                        }
                    } catch (error) {
                        showFlashMessage('danger', 'Error deleting memo: ' + error.message);
                    }
                };
                confirmModal.show();
            }
        });

        updateNotesEventListeners();
    </script>
{% endblock %}