{% extends "Password/base.html" %}
{% block title %}Password Manager{% endblock %}

{% block content %}
<div class="password-manager-container">
    <!-- Header -->
    <div class="password-header">
       <div class="header-content">
            <h1><i class="bi bi-shield-lock me-2"></i>Password Manager</h1>
            <div class="header-info">
                <span class="text-muted" id="password-count">0 passwords</span>
            </div>
            <div class="header-actions">
                <button class="btn btn-outline-primary" id="import-btn">
                    <i class="bi bi-upload me-1"></i>Import
                </button>
                <button class="btn btn-primary" id="add-password-btn">
                    <i class="bi bi-plus-lg me-1"></i>Add Password
                </button>
            </div>
        </div>
        
        <!-- Search and Filter -->
        <div class="search-filter-bar">
            <div class="search-box">
                <i class="bi bi-search"></i>
                <input type="text" id="search-input" placeholder="Search passwords..." class="form-control">
            </div>
            <select id="category-filter" class="form-select">
                <option value="all">All Categories</option>
            </select>
        </div>
    </div>

    <!-- Password Grid -->
    <div class="password-container">
    <!-- View Toggle -->

    <div class="bulk-actions" id="bulk-actions">
    <!-- Bulk actions will be populated by JavaScript -->
</div>

    <!-- Table View -->
    <div class="table-responsive" id="password-table-view">
        <table class="table table-hover password-table">
            <thead>
                <tr>
                    <th width="25px">
                        <input type="checkbox" id="select-all" class="form-check-input">
                    </th>
                    <th width="40px"></th> <!-- Favicon -->
                    <th>Title</th>
                    <th>Website</th>
                    <th>Username</th>
                    <th width="100px">Password</th>
                    <th>Category</th>
                    <th width="80px">Updated</th>
                    <th width="120px">Actions</th>
                </tr>
            </thead>
            <tbody id="password-table-body">
                <!-- Passwords will be rendered here -->
            </tbody>
        </table>
    </div>


    <!-- Empty State (same as before) -->
    <div class="empty-state" id="empty-state" style="display: none;">
        <i class="bi bi-shield-plus"></i>
        <h3>No Passwords Yet</h3>
        <p>Start by adding your first password or importing from iCloud</p>
        <button class="btn btn-primary" onclick="openPasswordModal()">
            <i class="bi bi-plus-lg me-1"></i>Add First Password
        </button>
    </div>
</div>

    <!-- Empty State -->
    <div class="empty-state" id="empty-state" style="display: none;">
        <i class="bi bi-shield-plus"></i>
        <h3>No Passwords Yet</h3>
        <p>Start by adding your first password or importing from iCloud</p>
        <button class="btn btn-primary" onclick="openPasswordModal()">
            <i class="bi bi-plus-lg me-1"></i>Add First Password
        </button>
    </div>
</div>

<!-- Password Modal -->
<div class="modal fade" id="passwordModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-shield-plus me-2"></i>
                    <span id="modal-title">Add Password</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="password-form">
                    <input type="hidden" id="password-id">
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="title" class="form-label">Title *</label>
                                <input type="text" class="form-control" id="title" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="category" class="form-label">Category</label>
                                <select class="form-select" id="category">
                                    <option value="General">General</option>
                                    <option value="Social Media">Social Media</option>
                                    <option value="Banking">Banking</option>
                                    <option value="Work">Work</option>
                                    <option value="Shopping">Shopping</option>
                                    <option value="Email">Email</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="website-url" class="form-label">Website URL *</label>
                        <input type="url" class="form-control" id="website-url" required>
                    </div>

                    <div class="mb-3">
                        <label for="username" class="form-label">Username/Email *</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>

                    <div class="mb-3">
                        <label for="password" class="form-label">Password *</label>
                        <div class="password-input-group">
                            <input type="password" class="form-control" id="password" required>
                            <button type="button" class="btn btn-outline-secondary" id="toggle-password">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button type="button" class="btn btn-outline-primary" id="generate-password">
                                <i class="bi bi-gear"></i>
                            </button>
                        </div>
                        <div class="password-strength" id="password-strength"></div>
                    </div>

                    <div class="mb-3">
                        <label for="note" class="form-label">Notes</label>
                        <textarea class="form-control" id="note" rows="3"></textarea>
                    </div>

                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="favorite">
                        <label class="form-check-label" for="favorite">
                            <i class="bi bi-star me-1"></i>Mark as Favorite
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-password">Save Password</button>
            </div>
        </div>
    </div>
</div>

<!-- Password Generator Modal -->
<div class="modal fade" id="generatorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-gear me-2"></i>Password Generator
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="password-length" class="form-label">Length: <span id="length-value">12</span></label>
                    <input type="range" class="form-range" id="password-length" min="4" max="50" value="12">
                </div>

                <div class="mb-3">
                    <label class="form-label">Include:</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="include-upper" checked>
                        <label class="form-check-label" for="include-upper">Uppercase Letters (A-Z)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="include-lower" checked>
                        <label class="form-check-label" for="include-lower">Lowercase Letters (a-z)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="include-numbers" checked>
                        <label class="form-check-label" for="include-numbers">Numbers (0-9)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="include-symbols" checked>
                        <label class="form-check-label" for="include-symbols">Symbols (!@#$%^&*)</label>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Generated Password:</label>
                    <div class="generated-password-container">
                        <input type="text" class="form-control" id="generated-password" readonly>
                        <button type="button" class="btn btn-outline-primary" id="copy-generated">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="generate-new-password">Generate</button>
                <button type="button" class="btn btn-success" id="use-generated-password">Use Password</button>
            </div>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-upload me-2"></i>Import Passwords
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="import-instructions">
                    <h6>How to export from iCloud Keychain:</h6>
                    <ol>
                        <li>Open Safari → Preferences → Passwords</li>
                        <li>Select all passwords or specific ones</li>
                        <li>Click "Export Passwords" → Save as CSV</li>
                        <li>Upload the CSV file here</li>
                    </ol>
                </div>

                <div class="mb-3">
                    <label for="import-file" class="form-label">Select CSV File</label>
                    <input type="file" class="form-control" id="import-file" accept=".csv">
                </div>

                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    Supported formats: CSV files from Safari, Chrome, Firefox, 1Password, LastPass
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="import-passwords">Import</button>
            </div>
        </div>
    </div>
</div>

<style>
.password-manager-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1rem;
}

.password-header {
    background: var(--card-bg);
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.header-content h1 {
    color: var(--primary-color);
    margin: 0;
    font-weight: 700;
}

.header-actions {
    display: flex;
    gap: 1rem;
}

.search-filter-bar {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.search-box {
    position: relative;
    flex: 1;
}

.search-box i {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--secondary-color);
}

.search-box input {
    padding-left: 3rem;
}

.password-card {
    background: var(--card-bg);
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    position: relative;
}

.password-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 30px rgba(0,0,0,0.15);
}

.password-card.favorite::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(135deg, #ffd700, #ffed4e);
    border-radius: 15px 15px 0 0;
}

.password-card-header {
    display: flex;
    justify-content: between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.password-card-title {
    display: flex;
    align-items: center;
    flex: 1;
    min-width: 0;
}

.password-card-title img {
    width: 24px;
    height: 24px;
    border-radius: 4px;
    margin-right: 0.75rem;
}

.password-card-title h5 {
    margin: 0;
    font-weight: 600;
    color: var(--text-color);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.password-card-actions {
    display: flex;
    gap: 0.5rem;
}

.password-card-actions .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.password-card-body {
    margin-bottom: 1rem;
}

.password-field {
    margin-bottom: 0.75rem;
}

.password-field label {
    font-size: 0.75rem;
    color: var(--secondary-color);
    text-transform: uppercase;
    font-weight: 600;
    letter-spacing: 0.5px;
    margin-bottom: 0.25rem;
    display: block;
}

.password-field-value {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.password-field-text {
    flex: 1;
    color: var(--text-color);
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.password-field-text.password {
    font-family: monospace;
    filter: blur(4px);
    transition: filter 0.3s ease;
}

.password-field-text.password.revealed {
    filter: none;
}

.copy-btn {
    background: none;
    border: none;
    color: var(--secondary-color);
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 4px;
    transition: all 0.3s ease;
}

.copy-btn:hover {
    background: var(--primary-color);
    color: white;
}

.password-card-footer {
    display: flex;
    justify-content: between;
    align-items: center;
    padding-top: 1rem;
    border-top: 1px solid var(--navbar-border);
}

.password-category {
    background: rgba(var(--primary-color-rgb), 0.1);
    color: var(--primary-color);
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
}

.password-date {
    font-size: 0.75rem;
    color: var(--secondary-color);
}

.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--secondary-color);
}

.empty-state i {
    font-size: 4rem;
    margin-bottom: 1rem;
    color: var(--primary-color);
}

.password-input-group {
    display: flex;
    gap: 0.5rem;
}

.password-input-group input {
    flex: 1;
}

.password-strength {
    margin-top: 0.5rem;
    font-size: 0.875rem;
}

.strength-weak { color: #dc3545; }
.strength-medium { color: #ffc107; }
.strength-strong { color: #28a745; }

.generated-password-container {
    display: flex;
    gap: 0.5rem;
}

.generated-password-container input {
    flex: 1;
    font-family: monospace;
}

.import-instructions {
    background: var(--alert-info-bg);
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 1rem;
}

.import-instructions ol {
    margin: 0;
    padding-left: 1.25rem;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .password-manager-container {
        padding: 1rem 0.5rem;
    }
    
    .header-content {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .header-actions {
        width: 100%;
        justify-content: center;
    }
    
    .search-filter-bar {
        flex-direction: column;
        gap: 1rem;
    }
    
    
    .password-card {
        padding: 1rem;
    }
    
    .password-card-header {
        flex-direction: column;
        gap: 1rem;
    }
    
    .password-card-actions {
        justify-content: center;
        width: 100%;
    }
}

@media (max-width: 576px) {
    .password-field-value {
        flex-direction: column;
        align-items: stretch;
        gap: 0.25rem;
    }
    
    .modal-lg {
        max-width: 95%;
    }
}
/* ===== PASSWORD TABLE STYLES ===== */
.password-container {
    background: var(--card-bg);
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}


.password-table {
    margin-bottom: 0;
    font-size: 0.9rem;
}

.password-table th {
    border-top: none;
    background: var(--card-bg);
    color: var(--secondary-color);
    font-weight: 600;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 1rem 0.75rem;
    border-bottom: 2px solid var(--navbar-border);
    position: sticky;
    top: 0;
    z-index: 10;
}

.password-table td {
    padding: 0.75rem;
    vertical-align: middle;
    border-bottom: 1px solid rgba(0,0,0,0.05);
}

.password-table tbody tr {
    transition: all 0.2s ease;
}

.password-table tbody tr:hover {
    background: rgba(var(--primary-color-rgb), 0.05);
    transform: scale(1.01);
}

.password-table tbody tr.selected {
    background: rgba(var(--primary-color-rgb), 0.1);
}

.password-table tbody tr.favorite {
    border-left: 4px solid #ffd700;
}

/* Favicon trong table */
.table-favicon {
    width: 20px;
    height: 20px;
    border-radius: 4px;
}

/* Title column */
.password-title {
    font-weight: 600;
    color: var(--text-color);
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.password-title.favorite::after {
    content: " ⭐";
    color: #ffd700;
}

/* Website column */
.password-website {
    color: var(--primary-color);
    text-decoration: none;
    max-width: 180px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    display: block;
}

.password-website:hover {
    text-decoration: underline;
}

/* Username column */
.password-username {
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-family: monospace;
    font-size: 0.85rem;
}

/* Password column */
.password-field-compact {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.password-dots {
    font-family: monospace;
    color: var(--secondary-color);
    font-size: 0.9rem;
    cursor: pointer;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    background: rgba(var(--secondary-color-rgb), 0.1);
    transition: all 0.2s ease;
}

.password-dots:hover {
    background: rgba(var(--primary-color-rgb), 0.1);
}

.password-dots.revealed {
    font-family: monospace;
    color: var(--text-color);
    background: rgba(var(--success-color-rgb), 0.1);
}

/* Category badge */
.category-badge {
    background: rgba(var(--primary-color-rgb), 0.1);
    color: var(--primary-color);
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    white-space: nowrap;
}

/* Date column */
.password-date {
    font-size: 0.75rem;
    color: var(--secondary-color);
    white-space: nowrap;
}

/* Action buttons */
.action-buttons {
    display: flex;
    gap: 0.25rem;
}

.action-btn {
    padding: 0.25rem 0.5rem;
    border: none;
    background: none;
    color: var(--secondary-color);
    border-radius: 4px;
    transition: all 0.2s ease;
    font-size: 0.875rem;
}

.action-btn:hover {
    background: var(--primary-color);
    color: white;
}

.action-btn.copy-btn:hover {
    background: #28a745;
}

.action-btn.edit-btn:hover {
    background: #ffc107;
}

.action-btn.delete-btn:hover {
    background: #dc3545;
}

/* Bulk actions */
.bulk-actions {
    display: none;
    padding: 1rem;
    background: rgba(var(--primary-color-rgb), 0.05);
    border-radius: 8px;
    margin-bottom: 1rem;
}

.bulk-actions.show {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* Mobile responsive */
@media (max-width: 768px) {
    .password-table th,
    .password-table td {
        padding: 0.5rem 0.25rem;
        font-size: 0.8rem;
    }
    
    .password-table th:nth-child(4), /* Website */
    .password-table td:nth-child(4),
    .password-table th:nth-child(7), /* Category */
    .password-table td:nth-child(7) {
        display: none;
    }
    
}

@media (max-width: 576px) {
    .password-table th:nth-child(5), /* Username */
    .password-table td:nth-child(5),
    .password-table th:nth-child(8), /* Date */
    .password-table td:nth-child(8) {
        display: none;
    }
    
    .password-title {
        max-width: 120px;
    }
}

/* Grid view styles (existing cards) - hidden by default */
.password-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
    margin-top: 1rem;
}

/* Existing card styles remain the same */
</style>

<script>
let passwords = [];
let categories = [];
let currentPasswordId = null;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadPasswords();
    loadCategories();
    setupEventListeners();
});

function setupEventListeners() {
    // Add password button
    document.getElementById('add-password-btn').onclick = () => openPasswordModal();
    
    // Import button
    document.getElementById('import-btn').onclick = () => openImportModal();
    
    // Search input
    document.getElementById('search-input').oninput = debounce(filterPasswords, 300);
    
    // Category filter
    document.getElementById('category-filter').onchange = filterPasswords;
    
    // Save password
    document.getElementById('save-password').onclick = savePassword;
    
    // Toggle password visibility
    document.getElementById('toggle-password').onclick = togglePasswordVisibility;
    
    // Generate password
    document.getElementById('generate-password').onclick = () => openGeneratorModal();
    
    // Password generator events
    document.getElementById('password-length').oninput = updateLengthValue;
    document.getElementById('generate-new-password').onclick = generatePassword;
    document.getElementById('use-generated-password').onclick = useGeneratedPassword;
    document.getElementById('copy-generated').onclick = copyGeneratedPassword;
    
    // Import passwords
    document.getElementById('import-passwords').onclick = importPasswords;
    
    // Password strength checker
    document.getElementById('password').oninput = checkPasswordStrength;

    // ✅ Bỏ setupViewToggle() - chỉ giữ bulk actions
    setupBulkActions();
}

function setupBulkActions() {
    document.getElementById('select-all').onchange = function() {
        const checkboxes = document.querySelectorAll('.password-checkbox');
        checkboxes.forEach(cb => cb.checked = this.checked);
        updateBulkActions();
    };
    
    // Delegate event for individual checkboxes
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('password-checkbox')) {
            updateBulkActions();
        }
    });
}

function updateBulkActions() {
    const selected = document.querySelectorAll('.password-checkbox:checked');
    const bulkActions = document.querySelector('.bulk-actions');
    
    if (selected.length > 0) {
        bulkActions.classList.add('show');
        bulkActions.innerHTML = `
            <span><strong>${selected.length}</strong> passwords selected</span>
            <div>
                <button class="btn btn-outline-primary btn-sm me-2" onclick="bulkExport()">
                    <i class="bi bi-download me-1"></i>Export Selected
                </button>
                <button class="btn btn-outline-danger btn-sm" onclick="bulkDelete()">
                    <i class="bi bi-trash me-1"></i>Delete Selected
                </button>
            </div>
        `;
    } else {
        bulkActions.classList.remove('show');
    }
}

async function loadPasswords() {
    try {
        console.log('🔄 Loading passwords...');
        const response = await fetch('/api/passwords');
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('📦 Response data:', data);
        
        if (data.status === 'success') {
            // ✅ SỬA: Đảm bảo passwords là array
            passwords = Array.isArray(data.passwords) ? data.passwords : [];
            console.log('✅ Loaded', passwords.length, 'passwords');
            renderPasswords();
        } else {
            console.error('❌ API Error:', data.message);
            showToast('Error: ' + (data.message || 'Unknown error'), 'error');
            // ✅ Set empty array nếu có lỗi
            passwords = [];
            renderPasswords();
        }
    } catch (error) {
        console.error('💥 Load passwords error:', error);
        showToast('Error loading passwords: ' + error.message, 'error');
        // ✅ Set empty array nếu có lỗi
        passwords = [];
        renderPasswords();
    }
}

async function loadCategories() {
    try {
        const response = await fetch('/api/passwords/categories');
        const data = await response.json();
        
        if (data.status === 'success') {
            categories = data.categories;
            updateCategoryFilter();
        }
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

function renderPasswords() {
    const tableView = document.getElementById('password-table-view');
    const emptyState = document.getElementById('empty-state');
    
    if (!passwords || passwords.length === 0) {
        tableView.style.display = 'none';
        emptyState.style.display = 'block';
        updatePasswordCount(0);
        return;
    }
    
    emptyState.style.display = 'none';
    tableView.style.display = 'block';
    
    renderTableView();
    updatePasswordCount(passwords.length);
}

function updatePasswordCount(count) {
    const countElement = document.getElementById('password-count');
    if (countElement) {
        countElement.textContent = `${count} password${count !== 1 ? 's' : ''}`;
    }
}

function renderTableView() {
    const tableBody = document.getElementById('password-table-body');
    
    tableBody.innerHTML = passwords.map(password => {
        const faviconUrl = getFaviconUrl(password.website_url);
        const isSecure = password.website_url && password.website_url.startsWith('https://');
        
        return `
            <tr class="${password.favorite ? 'favorite' : ''}" data-password-id="${password.id}">
                <td>
                    <input type="checkbox" class="form-check-input password-checkbox" 
                           value="${password.id}">
                </td>
                <td>
                    <img src="${faviconUrl}" alt="favicon" class="table-favicon" 
                         onerror="this.style.display='none'">
                </td>
                <td>
                    <div class="password-title ${password.favorite ? 'favorite' : ''}"
                         title="${escapeHtml(password.title)}">
                        ${escapeHtml(password.title || 'Untitled')}
                    </div>
                </td>
                <td>
                    <a href="${password.website_url}" target="_blank" 
                       class="password-website" 
                       title="${escapeHtml(password.website_url)}">
                        ${escapeHtml(password.website_url || '')}
                        ${isSecure ? '<i class="bi bi-shield-lock-fill text-success ms-1" title="Secure (HTTPS)"></i>' : ''}
                    </a>
                </td>
                <td>
                    <div class="password-username" title="${escapeHtml(password.username)}">
                        ${escapeHtml(password.username || '')}
                    </div>
                </td>
                <td>
                    <div class="password-field-compact">
                        <span class="password-dots" id="pwd-${password.id}" 
                              onclick="togglePasswordReveal(${password.id}, \`${escapeHtml(password.password || '')}\`)">
                            ••••••
                        </span>
                    </div>
                </td>
                <td>
                    <span class="category-badge">${escapeHtml(password.category || 'General')}</span>
                </td>
                <td>
                    <span class="password-date" title="${password.created_at ? new Date(password.created_at).toLocaleString() : 'Unknown'}">
                        ${password.created_at ? new Date(password.created_at).toLocaleDateString() : 'Unknown'}
                    </span>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn copy-btn" 
                                onclick="copyToClipboard(\`${escapeHtml(password.username || '')}\`)"
                                title="Copy Username">
                            <i class="bi bi-person"></i>
                        </button>
                        <button class="action-btn copy-btn" 
                                onclick="copyToClipboard(\`${escapeHtml(password.password || '')}\`)"
                                title="Copy Password">
                            <i class="bi bi-key"></i>
                        </button>
                        <button class="action-btn edit-btn" 
                                onclick="editPassword(${password.id})"
                                title="Edit">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="action-btn delete-btn" 
                                onclick="deletePassword(${password.id})"
                                title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}


// ✅ THÊM: Helper functions để tránh lỗi
function getFaviconUrl(websiteUrl) {
    try {
        if (!websiteUrl) {
            return getDefaultFaviconSvg();
        }
        
        // Nếu URL không có protocol, thêm https://
        let url = websiteUrl;
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
            url = 'https://' + url;
        }
        
        const urlObj = new URL(url);
        return `https://www.google.com/s2/favicons?domain=${urlObj.hostname}`;
    } catch (error) {
        console.warn('Invalid URL for favicon:', websiteUrl, error);
        return getDefaultFaviconSvg();
    }
}

function getDefaultFaviconSvg() {
    return 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/></svg>';
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function openPasswordModal(passwordId = null) {
    currentPasswordId = passwordId;
    const modal = new bootstrap.Modal(document.getElementById('passwordModal'));
    
    if (passwordId) {
        // Edit mode
        const password = passwords.find(p => p.id === passwordId);
        document.getElementById('modal-title').textContent = 'Edit Password';
        document.getElementById('title').value = password.title;
        document.getElementById('website-url').value = password.website_url;
        document.getElementById('username').value = password.username;
        document.getElementById('password').value = password.password;
        document.getElementById('note').value = password.note || '';
        document.getElementById('category').value = password.category;
        document.getElementById('favorite').checked = password.favorite;
    } else {
        // Add mode
        document.getElementById('modal-title').textContent = 'Add Password';
        document.getElementById('password-form').reset();
    }
    
    modal.show();
}

function openImportModal() {
    const modal = new bootstrap.Modal(document.getElementById('importModal'));
    modal.show();
}

function openGeneratorModal() {
    const modal = new bootstrap.Modal(document.getElementById('generatorModal'));
    generatePassword();
    modal.show();
}

async function savePassword() {
    const formData = {
        title: document.getElementById('title').value,
        website_url: document.getElementById('website-url').value,
        username: document.getElementById('username').value,
        password: document.getElementById('password').value,
        note: document.getElementById('note').value,
        category: document.getElementById('category').value,
        favorite: document.getElementById('favorite').checked
    };
    
    try {
        const url = currentPasswordId ? `/api/passwords/${currentPasswordId}` : '/api/passwords';
        const method = currentPasswordId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showToast(currentPasswordId ? 'Password updated successfully' : 'Password added successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('passwordModal')).hide();
            loadPasswords();
            loadCategories();
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        console.error('Error saving password:', error);
        showToast('Error saving password', 'error');
    }
}

function editPassword(id) {
    openPasswordModal(id);
}

async function deletePassword(id) {
    if (!confirm('Are you sure you want to delete this password?')) return;
    
    try {
        const response = await fetch(`/api/passwords/${id}`, { method: 'DELETE' });
        const data = await response.json();
        
        if (data.status === 'success') {
            showToast('Password deleted successfully', 'success');
            loadPasswords();
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        console.error('Error deleting password:', error);
        showToast('Error deleting password', 'error');
    }
}

function filterPasswords() {
    const search = document.getElementById('search-input').value.toLowerCase();
    const category = document.getElementById('category-filter').value;
    
    const filtered = passwords.filter(password => {
        const matchesSearch = !search || 
            password.title.toLowerCase().includes(search) ||
            password.website_url.toLowerCase().includes(search) ||
            password.username.toLowerCase().includes(search) ||
            (password.note && password.note.toLowerCase().includes(search));
        
        const matchesCategory = category === 'all' || password.category === category;
        
        return matchesSearch && matchesCategory;
    });
    
    // Temporarily store original and render filtered
    const originalPasswords = passwords;
    passwords = filtered;
    renderPasswords();
    passwords = originalPasswords;
}

function updateCategoryFilter() {
    const select = document.getElementById('category-filter');
    const currentValue = select.value;
    
    select.innerHTML = '<option value="all">All Categories</option>' +
        categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
    
    select.value = currentValue;
}

function togglePasswordVisibility() {
    const input = document.getElementById('password');
    const button = document.getElementById('toggle-password');
    
    if (input.type === 'password') {
        input.type = 'text';
        button.innerHTML = '<i class="bi bi-eye-slash"></i>';
    } else {
        input.type = 'password';
        button.innerHTML = '<i class="bi bi-eye"></i>';
    }
}

function togglePasswordReveal(id, password) {
    const element = document.getElementById(`pwd-${id}`);
    if (!element) return;
    
    const actualPassword = unescapeHtml(password || '');
    
    if (element.textContent === '••••••') {
        element.textContent = actualPassword;
        element.classList.add('revealed');
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            element.textContent = '••••••';
            element.classList.remove('revealed');
        }, 5000);
    } else {
        element.textContent = '••••••';
        element.classList.remove('revealed');
    }
}

function unescapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.innerHTML = text;
    return div.textContent || div.innerText || '';
}

function updateLengthValue() {
    const length = document.getElementById('password-length').value;
    document.getElementById('length-value').textContent = length;
}

async function generatePassword() {
    const settings = {
        length: parseInt(document.getElementById('password-length').value),
        include_upper: document.getElementById('include-upper').checked,
        include_lower: document.getElementById('include-lower').checked,
        include_numbers: document.getElementById('include-numbers').checked,
        include_symbols: document.getElementById('include-symbols').checked
    };
    
    try {
        const response = await fetch('/api/passwords/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(settings)
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            document.getElementById('generated-password').value = data.password;
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        console.error('Error generating password:', error);
        showToast('Error generating password', 'error');
    }
}

function useGeneratedPassword() {
    const generatedPassword = document.getElementById('generated-password').value;
    document.getElementById('password').value = generatedPassword;
    bootstrap.Modal.getInstance(document.getElementById('generatorModal')).hide();
    checkPasswordStrength();
}

function copyGeneratedPassword() {
    copyToClipboard(document.getElementById('generated-password').value);
}

async function importPasswords() {
    const fileInput = document.getElementById('import-file');
    const file = fileInput.files[0];
    
    if (!file) {
        showToast('Please select a file', 'error');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        const response = await fetch('/api/passwords/import', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showToast(data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();
            loadPasswords();
            loadCategories();
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        console.error('Error importing passwords:', error);
        showToast('Error importing passwords', 'error');
    }
}

function checkPasswordStrength() {
    const password = document.getElementById('password').value;
    const strengthDiv = document.getElementById('password-strength');
    
    if (!password) {
        strengthDiv.innerHTML = '';
        return;
    }
    
    let score = 0;
    let feedback = [];
    
    // Length check
    if (password.length >= 8) score++;
    else feedback.push('At least 8 characters');
    
    // Character variety checks
    if (/[a-z]/.test(password)) score++;
    else feedback.push('lowercase letters');
    
    if (/[A-Z]/.test(password)) score++;
    else feedback.push('uppercase letters');
    
    if (/[0-9]/.test(password)) score++;
    else feedback.push('numbers');
    
    if (/[^a-zA-Z0-9]/.test(password)) score++;
    else feedback.push('symbols');
    
    let strength = '';
    let className = '';
    
    if (score < 3) {
        strength = 'Weak';
        className = 'strength-weak';
    } else if (score < 5) {
        strength = 'Medium';
        className = 'strength-medium';
    } else {
        strength = 'Strong';
        className = 'strength-strong';
    }
    
    strengthDiv.innerHTML = `<span class="${className}">Strength: ${strength}</span>`;
    if (feedback.length > 0 && score < 5) {
        strengthDiv.innerHTML += `<br><small>Add: ${feedback.join(', ')}</small>`;
    }
}

async function copyToClipboard(text) {
    try {
        await navigator.clipboard.writeText(text);
        showToast('Copied to clipboard', 'success');
    } catch (error) {
        console.error('Error copying to clipboard:', error);
        showToast('Error copying to clipboard', 'error');
    }
}

function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 3000);
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
</script>
{% endblock %}