{% extends "Password/base.html" %}
{% block title %}Password Manager{% endblock %}

{% block content %}
<div class="password-manager-container">
    <!-- Header -->
    <div class="password-header">
        <div class="header-content">
            <div class="header-info">
                <span id="password-count">0 passwords</span>
            </div>
            
            <!-- ✅ THÊM: Category filter vào header -->
            <select id="category-filter" class="form-select category-filter-header">
                <option value="all">All Categories</option>
            </select>
            
            <div class="header-actions">
                <button class="btn btn-outline-secondary" id="manage-categories-btn">
                    <i class="bi bi-gear me-1"></i>Manage Categories
                </button>
                <button class="btn btn-outline-primary" id="import-btn">
                    <i class="bi bi-upload me-1"></i>Import
                </button>
                <button class="btn btn-primary" id="add-password-btn">
                    <i class="bi bi-plus-lg me-1"></i>Add Password
                </button>
            </div>
        </div>
    </div>

    <!-- Password Grid -->
    <div class="password-container">
    <!-- View Toggle -->

    <div class="bulk-actions" id="bulk-actions">
    <!-- Bulk actions will be populated by JavaScript -->
</div>

    <!-- Table View -->
    <div class="table-responsive" id="password-table-view">
        <table class="table table-hover password-table">
            <thead>
                <tr>
                    <th width="25px">
                        <input type="checkbox" id="select-all" class="form-check-input">
                    </th>
                    <!-- ✅ BỎ: <th width="40px"></th> Favicon column -->
                    <th>Title</th>
                    <th>Website</th>
                    <th>Username</th>
                    <th width="100px">Password</th>
                    <th>Category</th>
                    <th width="80px">Updated</th>
                    <th width="120px">Actions</th>
                </tr>
            </thead>
            <tbody id="password-table-body">
                <!-- Passwords will be rendered here -->
            </tbody>
        </table>
    </div>


    <!-- Empty State (same as before) -->
    <div class="empty-state" id="empty-state" style="display: none;">
        <i class="bi bi-shield-plus"></i>
        <h3>No Passwords Yet</h3>
        <p>Start by adding your first password or importing from iCloud</p>
        <button class="btn btn-primary" onclick="openPasswordModal()">
            <i class="bi bi-plus-lg me-1"></i>Add First Password
        </button>
    </div>
</div>

    <!-- Empty State -->
    <div class="empty-state" id="empty-state" style="display: none;">
        <i class="bi bi-shield-plus"></i>
        <h3>No Passwords Yet</h3>
        <p>Start by adding your first password or importing from iCloud</p>
        <button class="btn btn-primary" onclick="openPasswordModal()">
            <i class="bi bi-plus-lg me-1"></i>Add First Password
        </button>
    </div>
</div>

<!-- ✅ THÊM: Category Management Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-folder-plus me-2"></i>Manage Categories
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Add New Category -->
                <div class="add-category-section mb-4">
                    <h6>Add New Category</h6>
                    <div class="input-group">
                        <input type="text" class="form-control" id="new-category-name" placeholder="Category name..." maxlength="50">
                        <input type="color" class="form-control form-control-color" id="new-category-color" value="#007bff" title="Choose category color">
                        <button class="btn btn-primary" type="button" id="add-category-btn">
                            <i class="bi bi-plus"></i> Add
                        </button>
                    </div>
                </div>
                
                <!-- Existing Categories -->
                <div class="existing-categories">
                    <h6>Existing Categories</h6>
                    <div id="categories-list" class="categories-list">
                        <!-- Categories will be loaded here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Password Modal -->
<div class="modal fade" id="passwordModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-shield-plus me-2"></i>
                    <span id="modal-title">Add Password</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="password-form">
                    <div class="mb-3">
                        <label for="password-title" class="form-label">Title <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="password-title" required>
                    </div>
                    
                    <!-- ✅ SỬA: Bỏ required cho website URL -->
                    <div class="mb-3">
                        <label for="password-website" class="form-label">Website URL</label>
                        <input type="url" class="form-control" id="password-website" placeholder="https://example.com">
                        <div class="form-text">Optional - Leave empty for non-web accounts</div>
                    </div>
                    
                    <!-- ✅ SỬA: Bỏ required cho username/email -->
                    <div class="mb-3">
                        <label for="password-username" class="form-label">Username/Email</label>
                        <input type="text" class="form-control" id="password-username" placeholder="username or email@example.com">
                        <div class="form-text">Optional - Can be username, email, or any identifier</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="password" class="form-label">Password <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="password" required>
                            <button class="btn btn-outline-secondary" type="button" id="toggle-password">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-outline-primary" type="button" id="generate-password">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                        <div id="password-strength" class="password-strength mt-2"></div>
                    </div>
                    
                    <!-- ✅ SỬA: Category với chức năng quản lý -->
                    <div class="mb-3">
                        <label for="password-category" class="form-label">Category</label>
                        <select class="form-select" id="password-category">
                            <option value="">General</option>
                            <!-- Categories will be loaded dynamically -->
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="password-note" class="form-label">Notes</label>
                        <textarea class="form-control" id="password-note" rows="3" placeholder="Additional notes..."></textarea>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="password-favorite">
                        <label class="form-check-label" for="password-favorite">
                            <i class="bi bi-star me-1"></i>Mark as favorite
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-password">Save Password</button>
            </div>
        </div>
    </div>
</div>

<!-- Password Generator Modal -->
<div class="modal fade" id="generatorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-gear me-2"></i>Password Generator
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="password-length" class="form-label">Length: <span id="length-value">12</span></label>
                    <input type="range" class="form-range" id="password-length" min="4" max="50" value="12">
                </div>

                <div class="mb-3">
                    <label class="form-label">Include:</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="include-upper" checked>
                        <label class="form-check-label" for="include-upper">Uppercase Letters (A-Z)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="include-lower" checked>
                        <label class="form-check-label" for="include-lower">Lowercase Letters (a-z)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="include-numbers" checked>
                        <label class="form-check-label" for="include-numbers">Numbers (0-9)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="include-symbols" checked>
                        <label class="form-check-label" for="include-symbols">Symbols (!@#$%^&*)</label>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Generated Password:</label>
                    <div class="generated-password-container">
                        <input type="text" class="form-control" id="generated-password" readonly>
                        <button type="button" class="btn btn-outline-primary" id="copy-generated">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="generate-new-password">Generate</button>
                <button type="button" class="btn btn-success" id="use-generated-password">Use Password</button>
            </div>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-upload me-2"></i>Import Passwords
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="import-instructions">
                    <h6>How to export from iCloud Keychain:</h6>
                    <ol>
                        <li>Open Safari → Preferences → Passwords</li>
                        <li>Select all passwords or specific ones</li>
                        <li>Click "Export Passwords" → Save as CSV</li>
                        <li>Upload the CSV file here</li>
                    </ol>
                </div>

                <div class="mb-3">
                    <label for="import-file" class="form-label">Select CSV File</label>
                    <input type="file" class="form-control" id="import-file" accept=".csv">
                </div>

                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    Supported formats: CSV files from Safari, Chrome, Firefox, 1Password, LastPass
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="import-passwords">Import</button>
            </div>
        </div>
    </div>
</div>

<!-- Master Password Modal -->
<div class="modal fade" id="masterPasswordModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-shield-lock me-2"></i>Master Password Required
                </h5>
            </div>
            <div class="modal-body">
                <p>Enter your master password to access encrypted passwords:</p>
                <div class="mb-3">
                    <input type="password" class="form-control" id="master-password-input" 
                           placeholder="Master Password" autofocus>
                </div>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    This password is used to encrypt/decrypt your stored passwords and is not saved anywhere.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="verify-master-password">
                    <i class="bi bi-unlock me-1"></i>Unlock
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* ===== CONTAINER & LAYOUT ===== */
.password-manager-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1rem;
}

/* ===== HEADER STYLES ===== */
.password-header {
    background: var(--card-bg);
    border-radius: 15px;
    padding: 1rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.header-content {
    display: grid;
    grid-template-columns: auto 1fr auto auto;
    gap: 2rem;
    align-items: center;
}

.header-content h1 {
    color: var(--primary-color);
    margin: 0;
    font-weight: 700;
    white-space: nowrap;
}

.header-info {
    justify-self: start;
}

.header-info #password-count {
    font-size: 1.1rem;
    font-weight: 500;
    color: var(--text-color);
}

.category-filter-header {
    min-width: 200px;
}

.header-actions {
    display: flex;
    gap: 0.75rem;
    align-items: center;

}

.header-actions .btn {
    white-space: nowrap;
    font-weight: 500;
}

/* ===== PASSWORD CONTAINER & TABLE ===== */
.password-container {
    background: var(--card-bg);
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.password-table {
    margin-bottom: 0;
    font-size: 0.9rem;
}

.password-table th {
    border-top: none;
    background: var(--card-bg);
    color: var(--secondary-color);
    font-weight: 600;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 1rem 0.75rem;
    border-bottom: 2px solid var(--navbar-border);
    position: sticky;
    top: 0;
    z-index: 10;
}

.password-table td {
    padding: 0.75rem;
    vertical-align: middle;
    border-bottom: 1px solid rgba(0,0,0,0.05);
}

.password-table tbody tr {
    transition: all 0.2s ease;
}

.password-table tbody tr:hover {
    background: rgba(var(--primary-color-rgb), 0.05);
    transform: scale(1.01);
}

.password-table tbody tr.selected {
    background: rgba(var(--primary-color-rgb), 0.1);
}

.password-table tbody tr.favorite {
    border-left: 4px solid #ffd700;
}

/* ===== TABLE CELL CONTENT ===== */
.password-title {
    font-weight: 600;
    color: var(--text-color);
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.password-title.favorite::after {
    content: " ⭐";
    color: #ffd700;
}

.password-website {
    color: var(--primary-color);
    text-decoration: none;
    max-width: 180px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    display: block;
}

.password-website:hover {
    text-decoration: underline;
}

.password-username {
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-family: monospace;
    font-size: 0.85rem;
}

.password-field-compact {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.password-dots {
    font-family: monospace;
    color: var(--secondary-color);
    font-size: 0.9rem;
    cursor: pointer;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    background: rgba(var(--secondary-color-rgb), 0.1);
    transition: all 0.2s ease;
}

.password-dots:hover {
    background: rgba(var(--primary-color-rgb), 0.1);
}

.password-dots.revealed {
    font-family: monospace;
    color: var(--text-color);
    background: rgba(var(--success-color-rgb), 0.1);
}

.category-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    white-space: nowrap;
    border: 1px solid currentColor;
}

.category-badge:not([style*="background-color"]) {
    background: rgba(var(--primary-color-rgb), 0.1);
    color: var(--primary-color);
}

.password-date {
    font-size: 0.75rem;
    color: var(--secondary-color);
    white-space: nowrap;
}

/* ===== ACTION BUTTONS ===== */
.action-buttons {
    display: flex;
    gap: 0.25rem;
}

.action-btn {
    padding: 0.25rem 0.5rem;
    border: none;
    background: none;
    color: var(--secondary-color);
    border-radius: 4px;
    transition: all 0.2s ease;
    font-size: 0.875rem;
}

.action-btn:hover {
    background: var(--primary-color);
    color: white;
}

.action-btn.copy-btn:hover {
    background: #28a745;
}

.action-btn.edit-btn:hover {
    background: #ffc107;
}

.action-btn.delete-btn:hover {
    background: #dc3545;
}

/* ===== BULK ACTIONS ===== */
.bulk-actions {
    display: none;
    padding: 1rem;
    background: rgba(var(--primary-color-rgb), 0.05);
    border-radius: 8px;
    margin-bottom: 1rem;
}

.bulk-actions.show {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* ===== EMPTY STATE ===== */
.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--secondary-color);
}

.empty-state i {
    font-size: 4rem;
    margin-bottom: 1rem;
    color: var(--primary-color);
}

/* ===== CATEGORY MANAGEMENT ===== */
.add-category-section {
    padding: 1rem;
    background: rgba(var(--primary-color-rgb), 0.05);
    border-radius: 8px;
    border: 1px solid rgba(var(--primary-color-rgb), 0.1);
}

.categories-list {
    max-height: 300px;
    overflow-y: auto;
}

.category-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    background: var(--card-bg);
    border: 1px solid var(--navbar-border);
    border-radius: 8px;
    transition: all 0.2s ease;
}

.category-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.category-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex: 1;
}

.category-color {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.category-details {
    flex: 1;
}

.category-name {
    font-weight: 600;
    color: var(--text-color);
    margin: 0;
}

.category-count {
    font-size: 0.875rem;
    color: var(--secondary-color);
    margin: 0;
}

.category-actions {
    display: flex;
    gap: 0.25rem;
}

.category-item.editing .category-name {
    display: none;
}

.category-item.editing .category-edit-input {
    display: block;
}

.category-edit-input {
    display: none;
    border: none;
    background: transparent;
    font-weight: 600;
    color: var(--text-color);
    width: 100%;
}

.category-edit-input:focus {
    outline: 1px solid var(--primary-color);
    background: rgba(var(--primary-color-rgb), 0.05);
    border-radius: 4px;
    padding: 0 0.25rem;
}

.category-item.default .category-actions .btn-danger {
    display: none;
}

/* ===== MODAL STYLES ===== */
.password-input-group {
    display: flex;
    gap: 0.5rem;
}

.password-input-group input {
    flex: 1;
}

.password-strength {
    margin-top: 0.5rem;
    font-size: 0.875rem;
}

.strength-weak { color: #dc3545; }
.strength-medium { color: #ffc107; }
.strength-strong { color: #28a745; }

.generated-password-container {
    display: flex;
    gap: 0.5rem;
}

.generated-password-container input {
    flex: 1;
    font-family: monospace;
}

.import-instructions {
    background: var(--alert-info-bg);
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 1rem;
}

.import-instructions ol {
    margin: 0;
    padding-left: 1.25rem;
}

/* ===== FORM VALIDATION ===== */
.is-invalid {
    border-color: #dc3545;
}

.invalid-feedback {
    color: #dc3545;
    font-size: 0.875rem;
    margin-top: 0.25rem;
}

/* ===== RESPONSIVE DESIGN ===== */
@media (max-width: 992px) {
    .header-content {
        grid-template-columns: 1fr;
        gap: 1.5rem;
        text-align: center;
    }
    
    .header-info {
        order: -1;
        justify-self: center;
    }
    
    .category-filter-header {
        order: 1;
        justify-self: center;
        min-width: 250px;
    }
    
    .header-actions {
        order: 2;
        justify-self: center;
        flex-wrap: wrap;
        justify-content: center;
    }
}

@media (max-width: 768px) {
    .password-manager-container {
        padding: 1rem 0.5rem;
    }
    
    .password-header {
        padding: 1.5rem;
    }
    
    .header-content {
        gap: 1rem;
    }
    
    .header-content h1 {
        font-size: 1.5rem;
    }
    
    .header-actions {
        gap: 0.5rem;
    }
    
    .header-actions .btn {
        flex: 1;
        min-width: 120px;
        font-size: 0.875rem;
    }
    
    .category-filter-header {
        min-width: 200px;
        max-width: none;
        width: 100%;
    }
    
    .password-table th,
    .password-table td {
        padding: 0.5rem 0.25rem;
        font-size: 0.8rem;
    }
    
    .password-table th:nth-child(3), /* Website */
    .password-table td:nth-child(3),
    .password-table th:nth-child(6), /* Category */
    .password-table td:nth-child(6) {
        display: none;
    }
}

@media (max-width: 576px) {
    .password-header {
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .header-actions {
        flex-direction: column;
        width: 100%;
        gap: 0.75rem;
    }
    
    .header-actions .btn {
        width: 100%;
        padding: 0.75rem 1rem;
    }
    
    .category-filter-header {
        width: 100%;
    }
    
    .password-table th:nth-child(4), /* Username */
    .password-table td:nth-child(4),
    .password-table th:nth-child(7), /* Date */
    .password-table td:nth-child(7) {
        display: none;
    }
    
    .password-title {
        max-width: 120px;
    }
    
    .modal-lg {
        max-width: 95%;
    }
}
</style>

<script>

let passwords = [];
let categories = [];
let currentPasswordId = null;
let masterPasswordVerified = false; // ✅ SỬA: Thêm từ khóa 'let'

// Check master password on page load
document.addEventListener('DOMContentLoaded', function() {
    checkMasterPasswordStatus();
});

async function checkMasterPasswordStatus() {
    // Kiểm tra xem master password đã được verify chưa
    try {
        const response = await fetch('/api/passwords?test=1');
        if (response.status === 401) {
            showMasterPasswordModal();
        } else {
            masterPasswordVerified = true;
            loadPasswords();
            loadCategories();
            setupEventListeners();
        }
    } catch (error) {
        showMasterPasswordModal();
    }
}

function showMasterPasswordModal() {
    const modal = new bootstrap.Modal(document.getElementById('masterPasswordModal'));
    modal.show();
    
    document.getElementById('verify-master-password').onclick = verifyMasterPassword;
    document.getElementById('master-password-input').onkeypress = function(e) {
        if (e.key === 'Enter') {
            verifyMasterPassword();
        }
    };
}

async function verifyMasterPassword() {
    const masterPassword = document.getElementById('master-password-input').value;
    
    if (!masterPassword) {
        showToast('Please enter master password', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/auth/master_password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                master_password: masterPassword
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            masterPasswordVerified = true;
            bootstrap.Modal.getInstance(document.getElementById('masterPasswordModal')).hide();
            
            // Clear input
            document.getElementById('master-password-input').value = '';
            
            // Initialize app
            loadPasswords();
            loadCategories();
            setupEventListeners();
            
            showToast('Access granted', 'success');
        } else {
            showToast('Invalid master password', 'error');
            document.getElementById('master-password-input').select();
        }
    } catch (error) {
        console.error('Error verifying master password:', error);
        showToast('Error verifying master password', 'error');
    }
}


function setupEventListeners() {
    // Add password button
    document.getElementById('add-password-btn').onclick = () => openPasswordModal();
    
    // Manage categories button (moved from modal to header)
    document.getElementById('manage-categories-btn').onclick = openCategoryModal;
    
    // Import button
    document.getElementById('import-btn').onclick = () => openImportModal();
    
    // Category filter
    document.getElementById('category-filter').onchange = filterPasswords;
    
    // Save password
    document.getElementById('save-password').onclick = savePassword;
    
    // Toggle password visibility
    document.getElementById('toggle-password').onclick = togglePasswordVisibility;
    
    // Generate password
    document.getElementById('generate-password').onclick = () => openGeneratorModal();
    
    // Password generator events
    document.getElementById('password-length').oninput = updateLengthValue;
    document.getElementById('generate-new-password').onclick = generatePassword;
    document.getElementById('use-generated-password').onclick = useGeneratedPassword;
    document.getElementById('copy-generated').onclick = copyGeneratedPassword;
    
    // Import passwords
    document.getElementById('import-passwords').onclick = importPasswords;
    
    // Password strength checker
    document.getElementById('password').oninput = checkPasswordStrength;

    // Category management events (moved here)
    document.getElementById('add-category-btn').onclick = addNewCategory;
    
    // Enter key for adding category
    document.getElementById('new-category-name').onkeypress = function(e) {
        if (e.key === 'Enter') {
            addNewCategory();
        }
    };

    // Bulk actions
    setupBulkActions();
}
function openCategoryModal() {
    loadCategoriesForManagement();
    new bootstrap.Modal(document.getElementById('categoryModal')).show();
}

async function loadCategoriesForManagement() {
    try {
        const response = await fetch('/api/categories');
        const data = await response.json();
        
        if (data.status === 'success') {
            categories = data.categories;
            renderCategoriesForManagement();
        }
    } catch (error) {
        console.error('Error loading categories:', error);
        showToast('Error loading categories', 'error');
    }
}

function renderCategoriesForManagement() {
    const categoriesList = document.getElementById('categories-list');
    
    if (categories.length === 0) {
        categoriesList.innerHTML = '<p class="text-muted text-center">No custom categories yet</p>';
        return;
    }
    
    categoriesList.innerHTML = categories.map(category => {
        const isDefault = ['General', 'Social Media', 'Banking', 'Work', 'Shopping', 'Email'].includes(category.name);
        
        return `
            <div class="category-item ${isDefault ? 'default' : ''}" data-category-id="${category.id}">
                <div class="category-info">
                    <div class="category-color" style="background-color: ${category.color || '#007bff'}"></div>
                    <div class="category-details">
                        <div class="category-name">${escapeHtml(category.name)}</div>
                        <input type="text" class="category-edit-input" value="${escapeHtml(category.name)}" maxlength="50">
                        <div class="category-count">${category.password_count || 0} passwords</div>
                    </div>
                </div>
                <div class="category-actions">
                    <button class="btn btn-outline-primary btn-sm" onclick="editCategory(${category.id})" title="Edit">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-outline-success btn-sm d-none" onclick="saveCategory(${category.id})" title="Save">
                        <i class="bi bi-check"></i>
                    </button>
                    <button class="btn btn-outline-secondary btn-sm d-none" onclick="cancelEditCategory(${category.id})" title="Cancel">
                        <i class="bi bi-x"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="deleteCategory(${category.id})" title="Delete">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

async function addNewCategory() {
    const nameInput = document.getElementById('new-category-name');
    const colorInput = document.getElementById('new-category-color');
    const name = nameInput.value.trim();
    const color = colorInput.value;
    
    // Validation
    if (!name) {
        showToast('Please enter a category name', 'warning');
        nameInput.focus();
        return;
    }
    
    if (name.length > 50) {
        showToast('Category name must be 50 characters or less', 'warning');
        return;
    }
    
    // Check if category already exists
    if (categories.some(cat => cat.name.toLowerCase() === name.toLowerCase())) {
        showToast('Category already exists', 'warning');
        nameInput.focus();
        return;
    }
    
    try {
        const response = await fetch('/api/categories', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: name,
                color: color
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showToast('Category added successfully', 'success');
            nameInput.value = '';
            colorInput.value = '#007bff';
            loadCategoriesForManagement();
            loadCategories(); // Refresh category dropdown
        } else {
            showToast('Error: ' + data.message, 'error');
        }
    } catch (error) {
        console.error('Error adding category:', error);
        showToast('Error adding category', 'error');
    }
}

function editCategory(categoryId) {
    const categoryItem = document.querySelector(`[data-category-id="${categoryId}"]`);
    categoryItem.classList.add('editing');
    
    // Hide edit button, show save/cancel
    categoryItem.querySelector('.btn-outline-primary').classList.add('d-none');
    categoryItem.querySelector('.btn-outline-success').classList.remove('d-none');
    categoryItem.querySelector('.btn-outline-secondary').classList.remove('d-none');
    
    // Focus input
    const input = categoryItem.querySelector('.category-edit-input');
    input.focus();
    input.select();
}

async function saveCategory(categoryId) {
    const categoryItem = document.querySelector(`[data-category-id="${categoryId}"]`);
    const input = categoryItem.querySelector('.category-edit-input');
    const newName = input.value.trim();
    
    if (!newName) {
        showToast('Please enter a category name', 'warning');
        input.focus();
        return;
    }
    
    if (newName.length > 50) {
        showToast('Category name must be 50 characters or less', 'warning');
        return;
    }
    
    // Check if new name conflicts with existing categories
    const existingCategory = categories.find(cat => 
        cat.name.toLowerCase() === newName.toLowerCase() && cat.id !== categoryId
    );
    
    if (existingCategory) {
        showToast('Category name already exists', 'warning');
        input.focus();
        return;
    }
    
    try {
        const response = await fetch(`/api/categories/${categoryId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: newName
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showToast('Category updated successfully', 'success');
            cancelEditCategory(categoryId);
            loadCategoriesForManagement();
            loadCategories(); // Refresh category dropdown
        } else {
            showToast('Error: ' + data.message, 'error');
        }
    } catch (error) {
        console.error('Error updating category:', error);
        showToast('Error updating category', 'error');
    }
}

function cancelEditCategory(categoryId) {
    const categoryItem = document.querySelector(`[data-category-id="${categoryId}"]`);
    categoryItem.classList.remove('editing');
    
    // Show edit button, hide save/cancel
    categoryItem.querySelector('.btn-outline-primary').classList.remove('d-none');
    categoryItem.querySelector('.btn-outline-success').classList.add('d-none');
    categoryItem.querySelector('.btn-outline-secondary').classList.add('d-none');
    
    // Reset input value
    const category = categories.find(cat => cat.id == categoryId);
    if (category) {
        categoryItem.querySelector('.category-edit-input').value = category.name;
    }
}

async function deleteCategory(categoryId) {
    const category = categories.find(cat => cat.id == categoryId);
    if (!category) return;
    
    // Check if category has passwords
    if (category.password_count > 0) {
        const confirmed = confirm(
            `Category "${category.name}" contains ${category.password_count} passwords.\n\n` +
            'Deleting this category will move all passwords to "General" category.\n\n' +
            'Are you sure you want to continue?'
        );
        
        if (!confirmed) return;
    } else {
        const confirmed = confirm(`Are you sure you want to delete the "${category.name}" category?`);
        if (!confirmed) return;
    }
    
    try {
        const response = await fetch(`/api/categories/${categoryId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showToast('Category deleted successfully', 'success');
            loadCategoriesForManagement();
            loadCategories(); // Refresh category dropdown
            loadPasswords(); // Refresh passwords if needed
        } else {
            showToast('Error: ' + data.message, 'error');
        }
    } catch (error) {
        console.error('Error deleting category:', error);
        showToast('Error deleting category', 'error');
    }
}


function setupBulkActions() {
    document.getElementById('select-all').onchange = function() {
        const checkboxes = document.querySelectorAll('.password-checkbox');
        checkboxes.forEach(cb => cb.checked = this.checked);
        updateBulkActions();
    };
    
    // Delegate event for individual checkboxes
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('password-checkbox')) {
            updateBulkActions();
        }
    });
}

function updateBulkActions() {
    const selected = document.querySelectorAll('.password-checkbox:checked');
    const bulkActions = document.querySelector('.bulk-actions');
    
    if (selected.length > 0) {
        bulkActions.classList.add('show');
        bulkActions.innerHTML = `
            <span><strong>${selected.length}</strong> passwords selected</span>
            <div>
                <button class="btn btn-outline-primary btn-sm me-2" onclick="bulkExport()">
                    <i class="bi bi-download me-1"></i>Export Selected
                </button>
                <button class="btn btn-outline-danger btn-sm" onclick="bulkDelete()">
                    <i class="bi bi-trash me-1"></i>Delete Selected
                </button>
            </div>
        `;
    } else {
        bulkActions.classList.remove('show');
    }
}

async function loadPasswords() {
    if (!masterPasswordVerified) {
        showMasterPasswordModal();
        return;
    }
    try {
        console.log('🔄 Loading passwords...');
        const response = await fetch('/api/passwords');
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('📦 Response data:', data);
        
        if (data.status === 'success') {
            // ✅ SỬA: Đảm bảo passwords là array
            passwords = Array.isArray(data.passwords) ? data.passwords : [];
            console.log('✅ Loaded', passwords.length, 'passwords');
            renderPasswords();
        } else {
            console.error('❌ API Error:', data.message);
            showToast('Error: ' + (data.message || 'Unknown error'), 'error');
            // ✅ Set empty array nếu có lỗi
            passwords = [];
            renderPasswords();
        }
    } catch (error) {
        console.error('💥 Load passwords error:', error);
        showToast('Error loading passwords: ' + error.message, 'error');
        // ✅ Set empty array nếu có lỗi
        passwords = [];
        renderPasswords();
    }
}

async function loadCategories() {
    try {
        // ✅ SỬA: Sử dụng API endpoint riêng cho password categories
        const response = await fetch('/api/passwords/categories');
        const data = await response.json();
        
        if (data.status === 'success') {
            categories = data.categories;
            updateCategoryFilter();
            updateCategoryDropdown();
        }
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

function renderPasswords() {
    const tableView = document.getElementById('password-table-view');
    const emptyState = document.getElementById('empty-state');
    
    if (!passwords || passwords.length === 0) {
        tableView.style.display = 'none';
        emptyState.style.display = 'block';
        updatePasswordCount(0);
        return;
    }
    
    emptyState.style.display = 'none';
    tableView.style.display = 'block';
    
    renderTableView();
    updatePasswordCount(passwords.length);
}

function updatePasswordCount(count) {
    const countElement = document.getElementById('password-count');
    if (countElement) {
        countElement.textContent = `${count} password${count !== 1 ? 's' : ''}`;
    }
}

function renderTableView() {
    const tableBody = document.getElementById('password-table-body');
    
    tableBody.innerHTML = passwords.map(password => {
        // ✅ BỎ: const faviconUrl = getFaviconUrl(password.website_url);
        const isSecure = password.website_url && password.website_url.startsWith('https://');
        
        return `
            <tr class="${password.favorite ? 'favorite' : ''}" data-password-id="${password.id}">
                <td>
                    <input type="checkbox" class="form-check-input password-checkbox" 
                           value="${password.id}">
                </td>
                <!-- ✅ BỎ: Favicon column -->
                <!-- 
                -->
                <td>
                    <div class="password-title ${password.favorite ? 'favorite' : ''}"
                         title="${escapeHtml(password.title)}">
                        ${escapeHtml(password.title || 'Untitled')}
                    </div>
                </td>
                <td>
                    <a href="${password.website_url}" target="_blank" 
                       class="password-website" 
                       title="${escapeHtml(password.website_url)}">
                        ${escapeHtml(password.website_url || '')}
                        ${isSecure ? '<i class="bi bi-shield-lock-fill text-success ms-1" title="Secure (HTTPS)"></i>' : ''}
                    </a>
                </td>
                <td>
                    <div class="password-username" title="${escapeHtml(password.username)}">
                        ${escapeHtml(password.username || '')}
                    </div>
                </td>
                <td>
                    <div class="password-field-compact">
                        <span class="password-dots" id="pwd-${password.id}" 
                              onclick="togglePasswordReveal(${password.id}, \`${escapeHtml(password.password || '')}\`)">
                            ••••••
                        </span>
                    </div>
                </td>
                <td>
                    <span class="category-badge" style="background-color: ${password.category_color || '#6c757d'}20; color: ${password.category_color || '#6c757d'}">
                        ${escapeHtml(password.category_name || 'General')}
                    </span>
                </td>
                <td>
                    <span class="password-date" title="${password.created_at ? new Date(password.created_at).toLocaleString() : 'Unknown'}">
                        ${password.created_at ? new Date(password.created_at).toLocaleDateString() : 'Unknown'}
                    </span>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn copy-btn" 
                                onclick="copyToClipboard(\`${escapeHtml(password.username || '')}\`)"
                                title="Copy Username">
                            <i class="bi bi-person"></i>
                        </button>
                        <button class="action-btn copy-btn" 
                                onclick="copyToClipboard(\`${escapeHtml(password.password || '')}\`)"
                                title="Copy Password">
                            <i class="bi bi-key"></i>
                        </button>
                        <button class="action-btn edit-btn" 
                                onclick="editPassword(${password.id})"
                                title="Edit">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="action-btn delete-btn" 
                                onclick="deletePassword(${password.id})"
                                title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function openPasswordModal(passwordId = null) {
    currentPasswordId = passwordId;
    const modal = new bootstrap.Modal(document.getElementById('passwordModal'));
    
    if (passwordId) {
        // Edit mode
        const password = passwords.find(p => p.id === passwordId);
        document.getElementById('modal-title').textContent = 'Edit Password';
        document.getElementById('password-title').value = password.title;
        document.getElementById('password-website').value = password.website_url;
        document.getElementById('password-username').value = password.username;
        document.getElementById('password').value = password.password;
        document.getElementById('password-note').value = password.note || '';
        // ✅ SỬA: Sử dụng category_id
        document.getElementById('password-category').value = password.category_id || '';
        document.getElementById('password-favorite').checked = password.favorite;
    } else {
        // Add mode
        document.getElementById('modal-title').textContent = 'Add Password';
        document.getElementById('password-form').reset();
    }
    
    modal.show();
}

function openImportModal() {
    const modal = new bootstrap.Modal(document.getElementById('importModal'));
    modal.show();
}

function openGeneratorModal() {
    const modal = new bootstrap.Modal(document.getElementById('generatorModal'));
    generatePassword();
    modal.show();
}

async function savePassword() {
    const title = document.getElementById('password-title').value.trim();
    const website = document.getElementById('password-website').value.trim();
    const username = document.getElementById('password-username').value.trim();
    const password = document.getElementById('password').value;
    const categoryId = document.getElementById('password-category').value || null;
    const note = document.getElementById('password-note').value.trim();
    const favorite = document.getElementById('password-favorite').checked;
    
    if (!title) {
        showToast('Please enter a title', 'warning');
        document.getElementById('password-title').focus();
        return;
    }
    
    if (!password) {
        showToast('Please enter a password', 'warning');
        document.getElementById('password').focus();
        return;
    }
    
    const passwordData = {
        title,
        website_url: website,
        username: username,
        password,
        category_id: categoryId ? parseInt(categoryId) : null,
        note: note,
        favorite
    };
    
    try {
        let response;
        if (currentPasswordId) {
            response = await fetch(`/api/passwords/${currentPasswordId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(passwordData)
            });
        } else {
            response = await fetch('/api/passwords', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(passwordData)
            });
        }
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showToast(currentPasswordId ? 'Password updated successfully' : 'Password added successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('passwordModal')).hide();
            loadPasswords();
        } else {
            showToast('Error: ' + data.message, 'error');
        }
    } catch (error) {
        console.error('Error saving password:', error);
        showToast('Error saving password', 'error');
    }
}

// ✅ THÊM: Helper function để validate URL
function isValidUrl(string) {
    if (!string) return true; // Empty is valid
    try {
        new URL(string);
        return true;
    } catch (_) {
        // Try with https:// prefix
        try {
            new URL('https://' + string);
            return true;
        } catch (_) {
            return false;
        }
    }
}

function editPassword(id) {
    openPasswordModal(id);
}

async function deletePassword(id) {
    if (!confirm('Are you sure you want to delete this password?')) return;
    
    try {
        const response = await fetch(`/api/passwords/${id}`, { method: 'DELETE' });
        const data = await response.json();
        
        if (data.status === 'success') {
            showToast('Password deleted successfully', 'success');
            loadPasswords();
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        console.error('Error deleting password:', error);
        showToast('Error deleting password', 'error');
    }
}

function filterPasswords() {
    const search = document.getElementById('search-input').value.toLowerCase();
    const categoryId = document.getElementById('category-filter').value;
    
    let url = '/api/passwords?';
    if (search) url += `search=${encodeURIComponent(search)}&`;
    if (categoryId && categoryId !== 'all') url += `category_id=${categoryId}&`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                passwords = data.passwords;
                renderPasswords();
            }
        })
        .catch(error => {
            console.error('Error filtering passwords:', error);
        });
}

function updateCategoryFilter() {
    const select = document.getElementById('category-filter');
    const currentValue = select.value;
    
    select.innerHTML = '<option value="all">All Categories</option>' +
        categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
    
    select.value = currentValue;
}

function updateCategoryDropdown() {
    const select = document.getElementById('password-category');
    const currentValue = select.value;
    
    select.innerHTML = '<option value="">General</option>' +
        categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
    
    select.value = currentValue;
}

function togglePasswordVisibility() {
    const input = document.getElementById('password');
    const button = document.getElementById('toggle-password');
    
    if (input.type === 'password') {
        input.type = 'text';
        button.innerHTML = '<i class="bi bi-eye-slash"></i>';
    } else {
        input.type = 'password';
        button.innerHTML = '<i class="bi bi-eye"></i>';
    }
}

function togglePasswordReveal(id, password) {
    const element = document.getElementById(`pwd-${id}`);
    if (!element) return;
    
    const actualPassword = unescapeHtml(password || '');
    
    if (element.textContent === '••••••') {
        element.textContent = actualPassword;
        element.classList.add('revealed');
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            element.textContent = '••••••';
            element.classList.remove('revealed');
        }, 5000);
    } else {
        element.textContent = '••••••';
        element.classList.remove('revealed');
    }
}

function unescapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.innerHTML = text;
    return div.textContent || div.innerText || '';
}

function updateLengthValue() {
    const length = document.getElementById('password-length').value;
    document.getElementById('length-value').textContent = length;
}

async function generatePassword() {
    const settings = {
        length: parseInt(document.getElementById('password-length').value),
        include_upper: document.getElementById('include-upper').checked,
        include_lower: document.getElementById('include-lower').checked,
        include_numbers: document.getElementById('include-numbers').checked,
        include_symbols: document.getElementById('include-symbols').checked
    };
    
    try {
        const response = await fetch('/api/passwords/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(settings)
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            document.getElementById('generated-password').value = data.password;
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        console.error('Error generating password:', error);
        showToast('Error generating password', 'error');
    }
}

function useGeneratedPassword() {
    const generatedPassword = document.getElementById('generated-password').value;
    document.getElementById('password').value = generatedPassword;
    bootstrap.Modal.getInstance(document.getElementById('generatorModal')).hide();
    checkPasswordStrength();
}

function copyGeneratedPassword() {
    copyToClipboard(document.getElementById('generated-password').value);
}

async function importPasswords() {
    const fileInput = document.getElementById('import-file');
    const file = fileInput.files[0];
    
    if (!file) {
        showToast('Please select a file', 'error');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        const response = await fetch('/api/passwords/import', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showToast(data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();
            loadPasswords();
            loadCategories();
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        console.error('Error importing passwords:', error);
        showToast('Error importing passwords', 'error');
    }
}

function checkPasswordStrength() {
    const password = document.getElementById('password').value;
    const strengthDiv = document.getElementById('password-strength');
    
    if (!password) {
        strengthDiv.innerHTML = '';
        return;
    }
    
    let score = 0;
    let feedback = [];
    
    // Length check
    if (password.length >= 8) score++;
    else feedback.push('At least 8 characters');
    
    // Character variety checks
    if (/[a-z]/.test(password)) score++;
    else feedback.push('lowercase letters');
    
    if (/[A-Z]/.test(password)) score++;
    else feedback.push('uppercase letters');
    
    if (/[0-9]/.test(password)) score++;
    else feedback.push('numbers');
    
    if (/[^a-zA-Z0-9]/.test(password)) score++;
    else feedback.push('symbols');
    
    let strength = '';
    let className = '';
    
    if (score < 3) {
        strength = 'Weak';
        className = 'strength-weak';
    } else if (score < 5) {
        strength = 'Medium';
        className = 'strength-medium';
    } else {
        strength = 'Strong';
        className = 'strength-strong';
    }
    
    strengthDiv.innerHTML = `<span class="${className}">Strength: ${strength}</span>`;
    if (feedback.length > 0 && score < 5) {
        strengthDiv.innerHTML += `<br><small>Add: ${feedback.join(', ')}</small>`;
    }
}

async function copyToClipboard(text) {
    try {
        await navigator.clipboard.writeText(text);
        showToast('Copied to clipboard', 'success');
    } catch (error) {
        console.error('Error copying to clipboard:', error);
        showToast('Error copying to clipboard', 'error');
    }
}

function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 3000);
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
</script>
{% endblock %}