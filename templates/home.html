<!DOCTYPE html>
<html lang="en" data-theme="{{ theme|default('light') }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>友部 瑛希</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=Noto+Sans+JP:wght@400;700&family=Shippori+Mincho+B1:wght@700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <style>
        :root {
            --bg-color: #f8f9fa; /* Light */
            --card-bg: #f8f9fa;
            --quote-text-color: #ff8c00;
        }
        [data-theme="dark"] {
            --bg-color: #23272b;
            --card-bg: #495057;
            --quote-text-color: #ff8c00;
        }
        [data-theme="blue"] {
            --bg-color: #e3f0fc;
            --card-bg: #d6e4f0;
            --quote-text-color: #ff8c00;
        }
        [data-theme="green"] {
            --bg-color: #eafaf1;
            --card-bg: #d4edda;
            --quote-text-color: #ff8c00;
        }
        [data-theme="purple"] {
            --bg-color: #f3e6fa;
            --card-bg: #e1bee7;
            --quote-text-color: #ff8c00;
        }
        [data-theme="red"] {
            --bg-color: #fff0f0;
            --card-bg: #f5c6cb;
            --quote-text-color: #ff8c00;
        }
        [data-theme="orange"] {
            --bg-color: #fff7e6;
            --card-bg: #ffe5b4;
            --quote-text-color: #ff8c00;
        }
        [data-theme="yellow"] {
            --bg-color: #fffbe6;
            --card-bg: #fff3cd;
            --quote-text-color: #ff8c00;
        }
        [data-theme="pink"] {
            --bg-color: #fff0f6;
            --card-bg: #f8c1d0;
            --quote-text-color: #ff8c00;
        }
        [data-theme="cyan"] {
            --bg-color: #e0fcff;
            --card-bg: #b2ebf2;
            --quote-text-color: #ff8c00;
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Noto Sans JP', sans-serif;
        }
        .card {
            background-color: var(--card-bg);
            font-family: 'Noto Sans JP', sans-serif;
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 2px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        .card-title {
            color: var(--primary-color);
        }
        @media (max-width: 576px) {
            .card-title { font-size: 1.1rem; }
            .card-text { font-size: 1rem; }
            .navbar-brand { font-size: 1.1rem; }
            .container, .container-fluid { padding-left: 8px !important; padding-right: 8px !important; }
            .modal-content { font-size: 1rem; }
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Noto Sans JP', sans-serif;
            {% if bg_image_url %}
            background-image: url('{{ bg_image_url }}');
            background-size: contain;
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            {% endif %}
        }
        @media (max-width: 576px) {
            body {
                background-attachment: scroll;
                background-size: contain;
            }
        }
        .card {
            background-color: transparent !important;
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 2px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        .card-body {
            position: relative;
            overflow: hidden;
            background-color: transparent !important;
        }
        .card-body::before {
            content: "";
            position: absolute;
            inset: 0;
            background-color: var(--card-bg);
            opacity: 0.5;
            pointer-events: none;
            z-index: 0;
        }
        .card-body > * {
            position: relative;
            z-index: 1;
        }
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .container.py-4 {
            margin-bottom: 0;
        }
        .quote-content {
            font-size: 1.7rem;
            font-family: 'Noto Sans', 'Noto Sans JP', 'Roboto', Arial, sans-serif;
            font-weight: bold;
            margin-bottom: 1rem;
            color: var(--quote-text-color);
        }
        .quote-author {
            font-family: 'Kosugi Maru', 'Noto Sans JP', sans-serif;
            font-style: italic;
            color: var(--primary-color);
            text-align: right;
            font-size: 1.1rem;
        }
        @media (max-width: 576px) {
            .quote-content {
                font-size: 1.15rem;
            }
            .quote-author {
                font-size: 0.95rem;
            }
        }
        body.no-bg-image {
            background-image: none !important;
            background-color: var(--bg-color) !important;
        }
        body.no-bg-image .container.py-4 {
            min-height: 90vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        body.no-bg-image .row.g-3,
        body.no-bg-image .col-12 {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        body.no-bg-image .card {
            width: 100%;
            max-width: 600px;
        }
        .brand-shodo {
            font-family: 'Shippori Mincho B1', 'Kosugi Maru', 'Noto Sans JP', serif;
            font-weight: 700;
            font-size: 1.5rem;
            letter-spacing: 0.08em;
            color: #222;
            text-shadow: 0 2px 8px rgba(0,0,0,0.07);
            line-height: 0.2;
        }
        @media (max-width: 576px) {
            .brand-shodo { font-size: 1.3rem; }
        }
        input.link-input[readonly] {
            cursor: default !important;
        }
        .circle-visual:hover #mindCircleHover {
            opacity: 0.15;
            filter: blur(2px);
            transition: opacity 0.2s, filter 0.2s;
        }
        .circle-visual:active #mindCircleHover {
            opacity: 0.25;
            filter: blur(0.5px);
        }
        .center-quote {
            min-height: 70vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        #linksTreeContainer .list-group-item {
            cursor: grab;
        }
        #linksTreeContainer .list-group-item:active {
            cursor: grabbing;
        }
        #linksModal .modal-dialog {
            max-height: 70vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        #linksModal .modal-content {
            max-height: 70vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        #linksModal .modal-body {
            overflow-y: auto;
            max-height: 60vh;
        }
        .folder-header {
            background: #e3f2fd !important;
            border-radius: 6px;
            padding: 4px 8px;
            font-weight: bold;
        }
    </style>
</head>
<body>
 
    <nav class="navbar navbar-expand-lg navbar-light" style="background-color: var(--card-bg);">
        <div class="container-fluid">
            <nav class="navbar navbar-expand-lg navbar-light" style="background-color: var(--card-bg);">
                <div class="container-fluid">
                    <a class="navbar-brand brand-shodo" href="#" id="showCardListModal">友部 瑛希</a>
                </div>
            </nav>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('list_note') }}">
                            <i class="bi bi-journal-text"></i> Memo
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('diary_list') }}">
                            <i class="bi bi-calendar-heart"></i> Diary
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('manage_quotes') }}">
                            <i class="bi bi-chat-quote"></i> Quote
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('breath') }}">
                            <i class="bi bi-wind"></i> Breath
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('eye_exercise') }}">
                            <i class="bi bi-eye"></i> Eyes 
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#settingsModal">
                            <i class="bi bi-gear"></i> Settings
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="showLinksBtn">
                            <i class="bi bi-link-45deg"></i> Links
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logoutBtn">
                            <i class="bi bi-box-arrow-right"></i> Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Thêm sau nav -->
    <div class="modal fade" id="cardListModal" tabindex="-1" aria-labelledby="cardListModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="cardListModalLabel">Name Card</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <ul id="cardList" class="list-group"></ul>
        </div>
        </div>
    </div>
    </div>


    <div class="container py-4 center-quote">
        <div class="row g-3">
            <div class="col-12">
                {% if show_quote %}
                <div class="card shadow-sm">
                    <div class="card-body text-center">
                        <div class="quote-content">
                            {{ quote_content | nl2br | safe }}
                        </div>
                        <div class="quote-author mt-3">
                            — {{ quote_author }}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Links Modal -->
    <div class="modal fade" id="linksModal" tabindex="-1" aria-labelledby="linksModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
            <div class="modal-body">
                <div id="linksTreeContainer"></div>
            </div>
            </div>
        </div>
        </div>

    <!-- Confirm Logout Modal -->
    <div class="modal fade" id="confirmLogoutModal" tabindex="-1" aria-labelledby="confirmLogoutModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="confirmLogoutModalLabel">Confirm Logout</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to logout?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmLogoutBtn">Logout</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->

    <!-- filepath: /Users/eikitomobe/Documents/3.Học tập/Lập trình/VS code/EikiTomobe/eikitomobe/templates/home.html -->
<div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body">
                <!-- Nav tabs -->
                <ul class="nav nav-tabs" id="settingsTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#generalTab" type="button" role="tab" aria-controls="generalTab" aria-selected="true">
                            Theme
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="password-tab" data-bs-toggle="tab" data-bs-target="#passwordTab" type="button" role="tab" aria-controls="passwordTab" aria-selected="false">
                            Password
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#uploadTab" type="button" role="tab" aria-controls="uploadTab" aria-selected="false">
                            Background
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="avatar-tab" data-bs-toggle="tab" data-bs-target="#avatarTab" type="button" role="tab" aria-controls="avatarTab" aria-selected="false">
                            Avatar
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profileTab" type="button" role="tab" aria-controls="profileTab" aria-selected="false">
                            Card
                        </button>
                    </li>
                </ul>
                <!-- Tab panes -->
                <div class="tab-content mt-3">
                    <!-- General Tab -->
                    <div class="tab-pane fade show active" id="generalTab" role="tabpanel" aria-labelledby="general-tab">
                        <div class="mb-3">
                            <label for="themeSelect" class="form-label">Theme</label>
                            <select class="form-select" id="themeSelect">
                                <option value="light">Light</option>
                                <option value="dark">Dark</option>
                                <option value="blue">Blue</option>
                                <option value="green">Green</option>
                                <option value="purple">Purple</option>
                                <option value="red">Red</option>
                                <option value="orange">Orange</option>
                                <option value="yellow">Yellow</option>
                                <option value="pink">Pink</option>
                                <option value="cyan">Cyan</option>
                            </select>
                        </div>
                    </div>
                    <!-- Password Tab -->
                    <div class="tab-pane fade" id="passwordTab" role="tabpanel" aria-labelledby="password-tab">
                        <form method="POST" action="{{ url_for('change_password') }}">
                            <div class="mb-3">
                                <label for="new_password" class="form-label">Change Password</label>
                                <input type="password" class="form-control" id="new_password" name="new_password" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Save Password</button>
                        </form>
                    </div>
                    <!-- Upload Tab -->
                    <div class="tab-pane fade" id="uploadTab" role="tabpanel" aria-labelledby="upload-tab">
                        <form action="{{ url_for('upload_bg') }}" method="post" enctype="multipart/form-data" class="mb-3 text-center">
                            <input type="file" name="bg_image" accept="image/*" class="form-control d-inline-block mb-2" style="max-width:500px;display:inline-block;">
                            <button type="submit" class="btn btn-primary mt-2">Upload</button>
                        </form>
                        <div class="form-check form-switch mt-3">
                            <input class="form-check-input" type="checkbox" id="toggleBgImage">
                            <label class="form-check-label" for="toggleBgImage">Hiển thị hình nền</label>
                        </div>
                        <div class="form-check form-switch mt-3">
                            <input class="form-check-input" type="checkbox" id="toggleQuote" checked>
                            <label class="form-check-label" for="toggleQuote">Hiển thị quote</label>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="avatarTab" role="tabpanel" aria-labelledby="avatar-tab">
                        <form action="{{ url_for('upload_avatar') }}" method="post" enctype="multipart/form-data" class="mb-3 text-center">
                            <input type="file" name="avatar_image" accept="image/*,.heic" class="form-control d-inline-block mb-2" style="max-width:5.3.3/dist/js/bootstrap.bundle.min.js00px;display:inline-block;" required>
                            <button type="submit" class="btn btn-primary mt-2">Upload</button>
                        </form>
                    </div>
                    <div class="tab-pane fade" id="profileTab" role="tabpanel" aria-labelledby="profile-tab">
                        <form id="profileForm" class="mb-3">
                            <div class="mb-2">
                                <label class="form-label">Name</label>
                                <input type="text" class="form-control" name="name" id="profileName" required>
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Job</label>
                                <input type="text" class="form-control" name="job" id="profileJob">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" name="email" id="profileEmail">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Phone</label>
                                <input type="text" class="form-control" name="phone" id="profilePhone">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">SNS</label>
                                <input type="text" class="form-control" name="sns" id="profileSNS">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Slogan</label>
                                <input type="text" class="form-control" name="slogan" id="profileSlogan">
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Update</button>
                        </form>
                        <div id="profileMsg" class="text-success text-center"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Mindfulness Modal -->
    <div class="modal fade" id="mindfulnessModal" tabindex="-1" aria-labelledby="mindfulnessModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered" style="max-width:420px;">
        <div class="modal-content" style="background: var(--card-bg);">
        <div class="modal-body">
            <!-- Tabs -->
            <ul class="nav nav-tabs" id="mindTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="mind-main-tab" data-bs-toggle="tab" data-bs-target="#mindMainTab" type="button" role="tab">Practice</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="mind-setting-tab" data-bs-toggle="tab" data-bs-target="#mindSettingTab" type="button" role="tab">Setting</button>
            </li>
            </ul>
            <div class="tab-content mt-3">
            <!-- Practice Tab -->
            <div class="tab-pane fade show active text-center" id="mindMainTab" role="tabpanel">
                
                <div class="mb-2">
                <span id="mindTimer" style="font-size:2.2rem;font-weight:bold;">00:00:00</span>
                </div>
                <div class="mb-2">
                <span id="mindBreakInfo" style="font-size:1.1rem;color:var(--primary-color);"></span>
                </div>
                <div class="mb-2 d-flex justify-content-center">
                    <svg id="mindCircleSvg" class="circle-visual" width="120" height="120" viewBox="0 0 120 120" style="cursor:pointer;">
                        <circle cx="60" cy="60" r="50" stroke="#0d6efd" stroke-width="6" fill="none" opacity="0.15"/>
                        <circle id="mindCircleProgress" cx="60" cy="60" r="50" stroke="#0d6efd" stroke-width="6" fill="none"
                            stroke-dasharray="314" stroke-dashoffset="314" stroke-linecap="round"
                            transform="rotate(-90 60 60)" />
                        <circle id="mindCircleDot" r="8" fill="#0d6efd" cx="60" cy="10"/>
                        <circle id="mindCircleHover" cx="60" cy="60" r="40" fill="#0d6efd" opacity="0" />
                    </svg>
                </div>
            </div>
            <!-- Setting Tab -->
            <div class="tab-pane fade" id="mindSettingTab" role="tabpanel">
                <form id="mindSettingForm">
                <div class="mb-2">
                    <label class="form-label">Thời gian (phút)</label>
                    <select id="mindDuration" class="form-select">
                    {% for i in range(5, 301, 5) %}
                    <option value="{{ i }}">{{ i // 60 }}h {{ i % 60 }}m</option>
                    {% endfor %}
                    </select>
                </div>
                <div class="mb-2">
                    <label class="form-label">Số lần nghỉ (break)</label>
                    <select id="mindBreaks" class="form-select">
                    {% for i in range(1, 11) %}
                    <option value="{{ i }}">{{ i }}</option>
                    {% endfor %}
                    </select>
                </div>
                <div class="mb-2">
                    <label class="form-label">Mỗi lần nghỉ: <span id="mindBreakLength">0</span> phút</label>
                </div>
                </form>
            </div>
            </div>
        </div>
        </div>
    </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
    // --- Mindfulness Timer Logic ---
    const circleSvg = document.getElementById('mindCircleSvg');
    const circleProgress = document.getElementById('mindCircleProgress');
    const circleDot = document.getElementById('mindCircleDot');
    const circleLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
    circleLabel.setAttribute('id', 'mindCircleLabel');
    circleLabel.setAttribute('x', '60');
    circleLabel.setAttribute('y', '68');
    circleLabel.setAttribute('text-anchor', 'middle');
    circleLabel.setAttribute('font-size', '1.2rem');
    circleLabel.setAttribute('font-family', 'inherit');
    circleLabel.setAttribute('fill', '#0d6efd');
    circleLabel.style.cursor = 'pointer';
    circleSvg.appendChild(circleLabel);

    const RADIUS = 50;
    const CIRCUM = 2 * Math.PI * RADIUS;

    const BG_IMAGE_URL = "{{ bg_image_url|default('') }}";

    let isRunning = false;
    let timer = null, totalSec = 0, remainSec = 0, isPaused = false, breakCount = 1, breakLength = 0, currentBreak = 0;
    let startTimestamp = null;
    let pausedAt = null;

    const timerDisplay = document.getElementById('mindTimer');
    const breakInfo = document.getElementById('mindBreakInfo');
    const durationSel = document.getElementById('mindDuration');
    const breaksSel = document.getElementById('mindBreaks');
    const breakLenSpan = document.getElementById('mindBreakLength');

    function updateCircle(progress) {
        const offset = CIRCUM - progress * CIRCUM;
        circleProgress.setAttribute('stroke-dashoffset', offset);
        const angle = -Math.PI / 2 + 2 * Math.PI * progress;
        const cx = 60 + RADIUS * Math.cos(angle);
        const cy = 60 + RADIUS * Math.sin(angle);
        circleDot.setAttribute('cx', cx);
        circleDot.setAttribute('cy', cy);
    }

    function playBell() {
        const audio = new Audio('/static/bell.mp3');
        audio.play();
    }

    function updateBreakLength() {
        const duration = parseInt(durationSel.value) || 5;
        const breaks = parseInt(breaksSel.value) || 1;
        breakLength = Math.floor(duration / breaks);
        breakLenSpan.textContent = breakLength;
    }
    durationSel.addEventListener('change', updateBreakLength);
    breaksSel.addEventListener('change', updateBreakLength);
    updateBreakLength();

    function formatTime(sec) {
        const h = Math.floor(sec / 3600);
        const m = Math.floor((sec % 3600) / 60);
        const s = sec % 60;
        return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }

    function showCircleLabel(text) {
        circleLabel.textContent = text;
    }

    function startTimer() {
        totalSec = parseInt(durationSel.value) * 60;
        remainSec = totalSec;
        breakCount = parseInt(breaksSel.value);
        breakLength = Math.floor((parseInt(durationSel.value)) / breakCount);
        currentBreak = 1;
        isPaused = false;
        isRunning = true;
        startTimestamp = performance.now();
        pausedAt = null;
        showCircleLabel('stop');
        requestAnimationFrame(tick);
        playBell();
    }
    function tick(now) {
        if (isPaused) {
            pausedAt = now;
            return;
        }
        if (!startTimestamp) startTimestamp = now;
        let elapsed = Math.floor((now - startTimestamp) / 1000);
        if (pausedAt) {
            startTimestamp += (now - pausedAt);
            pausedAt = null;
        }
        remainSec = Math.max(0, totalSec - elapsed);
        timerDisplay.textContent = formatTime(remainSec);

        let progress = Math.min(1, (totalSec - remainSec) / totalSec);
        updateCircle(progress);

        const breakInterval = Math.floor(totalSec / breakCount);
        const nextBreak = totalSec - (currentBreak * breakInterval);
        if (remainSec === nextBreak && currentBreak <= breakCount) {
            breakInfo.textContent = `Break ${currentBreak} - ${breakLength} phút`;
            currentBreak++;
        } else if (remainSec > 0) {
            breakInfo.textContent = '';
        }

        if (remainSec <= 0) {
            timerDisplay.textContent = "00:00:00";
            breakInfo.textContent = "Hoàn thành!";
            updateCircle(1);
            isRunning = false;
            showCircleLabel('start');
            playBell();
            return;
        }
        timer = requestAnimationFrame(tick);
    }
        function stopTimer(playSound = true) {
            cancelAnimationFrame(timer);
            timerDisplay.textContent = "00:00:00";
            breakInfo.textContent = '';
            updateCircle(0);
            isRunning = false;
            showCircleLabel('start');
            if (playSound) playBell();
        }


    // Vòng tròn: hover hiệu ứng nổi
    circleSvg.addEventListener('mouseenter', function() {
        circleSvg.classList.add('circle-hover');
    });
    circleSvg.addEventListener('mouseleave', function() {
        circleSvg.classList.remove('circle-hover');
    });

    // Click vào vòng tròn: start/stop
    circleSvg.addEventListener('click', function() {
        if (isRunning) {
            stopTimer();
        } else {
            stopTimer();
            startTimer();
        }
    });

    // Khi mở modal, reset về trạng thái ban đầu (KHÔNG phát âm thanh)
    document.getElementById('mindfulnessModal').addEventListener('shown.bs.modal', function () {
        stopTimer(false);
        showCircleLabel('start');
    });

    // Khi đóng modal, reset timer (KHÔNG phát âm thanh)
    document.getElementById('mindfulnessModal').addEventListener('hidden.bs.modal', function () {
        stopTimer(false);
        showCircleLabel('start');
    });

    // Click vào quote mở modal mindfulness
    document.querySelectorAll('.quote-content').forEach(function(el) {
        el.style.cursor = 'pointer';
        el.addEventListener('click', function() {
            var modal = new bootstrap.Modal(document.getElementById('mindfulnessModal'));
            modal.show();
        });
    });
});

        // --- UI Settings (Background & Quote toggle) ---
        document.getElementById('upload-tab').addEventListener('shown.bs.tab', function () {
            fetch('/ui_settings')
                .then(res => res.json())
                .then(data => {
                    document.getElementById('toggleBgImage').checked = !!data.show_bg_image;
                    document.getElementById('toggleQuote').checked = !!data.show_quote;
                    // Áp dụng ngay trạng thái background
                    applyBgImage(!!data.show_bg_image);
                    applyQuote(!!data.show_quote);
                });
        });
        document.getElementById('toggleBgImage').addEventListener('change', function() {
            saveUiSettings();
            applyBgImage(this.checked);
        });
        document.getElementById('toggleQuote').addEventListener('change', function() {
            saveUiSettings();
            applyQuote(this.checked);
        });
        function saveUiSettings() {
            fetch('/ui_settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    show_bg_image: document.getElementById('toggleBgImage').checked,
                    show_quote: document.getElementById('toggleQuote').checked
                })
            });
        }
        function applyBgImage(show) {
            if (show) {
                document.body.classList.remove('no-bg-image');
                if (BG_IMAGE_URL) {
                    document.body.style.backgroundImage = "url('" + BG_IMAGE_URL + "')";
                }
            } else {
                document.body.classList.add('no-bg-image');
                document.body.style.backgroundImage = "none";
            }
        }
        function applyQuote(show) {
            document.querySelectorAll('.card.shadow-sm').forEach(function(card) {
                card.style.display = show ? '' : 'none';
            });
        }

        

        document.getElementById('showLinksBtn').addEventListener('click', function(e) {
            e.preventDefault();
            fetch('/links')
                .then(res => res.json())
                .then(data => {
                    let linksTree = data.links_tree || [];
                    renderLinksTree(linksTree);
                    const modal = new bootstrap.Modal(document.getElementById('linksModal'));
                    modal.show();
                });
        });

        function renderLinksTree(treeData) {
            const container = document.getElementById('linksTreeContainer');
            container.innerHTML = '';

            // Đảm bảo luôn có 1 thư mục trống cuối cùng
            let last = treeData[treeData.length - 1];
            if (!last || (last.name.trim() !== '' || (last.children && last.children.length > 0 && last.children.some(l => l.url && l.url.trim() !== '')))) {
                treeData.push({name: '', children: []});
            }

            treeData.forEach((folder, folderIdx) => {
                const folderDiv = document.createElement('div');
                folderDiv.className = 'mb-2 border rounded p-2 bg-light';

                // Folder header
                const header = document.createElement('div');
                header.className = 'd-flex align-items-center mb-1 folder-header';
                header.style.background = '#e3f2fd'; // Màu xanh nhạt
                header.style.borderRadius = '6px';
                header.style.padding = '4px 8px';
                header.style.fontWeight = 'bold';

                // Collapse/expand button
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'btn btn-sm btn-link px-1 py-0';
                // Mặc định là mở
                let collapsed = false;
                toggleBtn.innerHTML = '<i class="bi bi-caret-down-fill"></i>';
                toggleBtn.onclick = function() {
                    collapsed = !collapsed;
                    linksUl.style.display = collapsed ? 'none' : '';
                    toggleBtn.innerHTML = collapsed
                        ? '<i class="bi bi-caret-right-fill"></i>'
                        : '<i class="bi bi-caret-down-fill"></i>';
                };
                header.appendChild(toggleBtn);

                // Folder name (editable)
                const folderName = document.createElement('input');
                folderName.type = 'text';
                folderName.value = folder.name;
                folderName.className = 'form-control form-control-sm d-inline-block mx-1';
                folderName.style.width = '120px';
                folderName.placeholder = 'Tên thư mục...';
                folderName.onblur = function() {
                    folder.name = folderName.value.trim();
                    // Nếu là thư mục không phải cuối cùng và tên rỗng thì xoá luôn cả thư mục (bất kể có link con hay không)
                    if (folderIdx !== treeData.length - 1 && folder.name === '') {
                        treeData.splice(folderIdx, 1);
                    }
                    saveLinksTree();
                    renderLinksTree(treeData);
                };
                header.appendChild(folderName);

                folderDiv.appendChild(header);

                // Links list
                const linksUl = document.createElement('ul');
                linksUl.className = 'list-group';
                linksUl.style.minHeight = '10px';
                // Mặc định HIỆN (mở)
                linksUl.style.display = '';

                folder.children = folder.children || [];
                // Render các link đã có
                folder.children.forEach((link, linkIdx) => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex align-items-center';
                    li.draggable = true;

                    // Drag events
                    li.ondragstart = function(e) {
                        e.dataTransfer.setData('text/plain', JSON.stringify({fromFolder: folderIdx, fromLink: linkIdx}));
                    };
                    li.ondragover = function(e) { e.preventDefault(); };
                    li.ondrop = function(e) {
                        e.preventDefault();
                        const {fromFolder, fromLink} = JSON.parse(e.dataTransfer.getData('text/plain'));
                        if (fromFolder == folderIdx && fromLink == linkIdx) return;
                        const moved = treeData[fromFolder].children.splice(fromLink, 1)[0];
                        folder.children.splice(linkIdx, 0, moved);
                        renderLinksTree(treeData);
                        saveLinksTree();
                    };

                    // Link input
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'form-control form-control-sm me-2';
                    input.value = link.url;
                    input.placeholder = 'Link...';
                    input.onblur = function() {
                        link.url = input.value.trim();
                        // Nếu link con bị xoá hết nội dung thì xoá luôn nút con đó
                        if (!link.url) {
                            folder.children.splice(linkIdx, 1);
                        }
                        saveLinksTree();
                        renderLinksTree(treeData);
                    };
                    li.appendChild(input);

                    // Open link button
                    if (link.url) {
                        const openBtn = document.createElement('button');
                        openBtn.className = 'btn btn-sm btn-primary me-2';
                        openBtn.innerHTML = '<i class="bi bi-box-arrow-up-right"></i>';
                        openBtn.onclick = function() {
                            let url = link.url.trim();
                            if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
                            window.open(url, '_blank');
                        };
                        li.appendChild(openBtn);
                    }

                    linksUl.appendChild(li);
                });

                // Luôn render thêm 1 dòng link trống cuối cùng
                const emptyLi = document.createElement('li');
                emptyLi.className = 'list-group-item d-flex align-items-center';
                const emptyInput = document.createElement('input');
                emptyInput.type = 'text';
                emptyInput.className = 'form-control form-control-sm me-2';
                emptyInput.placeholder = 'Link...';
                emptyInput.onblur = function() {
                    const val = emptyInput.value.trim();
                    if (val) {
                        folder.children.push({url: val});
                        saveLinksTree();
                        renderLinksTree(treeData);
                    }
                };
                emptyLi.appendChild(emptyInput);
                linksUl.appendChild(emptyLi);

                // Drag over folder to move link here
                linksUl.ondragover = function(e) { e.preventDefault(); };
                linksUl.ondrop = function(e) {
                    e.preventDefault();
                    const {fromFolder, fromLink} = JSON.parse(e.dataTransfer.getData('text/plain'));
                    if (fromFolder == folderIdx) return;
                    const moved = treeData[fromFolder].children.splice(fromLink, 1)[0];
                    folder.children.push(moved);
                    renderLinksTree(treeData);
                    saveLinksTree();
                };

                folderDiv.appendChild(linksUl);
                container.appendChild(folderDiv);
            });

            // Không còn nút Thêm thư mục

            // Lưu lại tree sau mỗi thao tác
            function saveLinksTree() {
                fetch('/links', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({links_tree: treeData})
                });
            }
        }

        

        // --- Logout Modal logic ---
        document.getElementById('logoutBtn').addEventListener('click', function(e) {
            e.preventDefault();
            const modal = new bootstrap.Modal(document.getElementById('confirmLogoutModal'));
            modal.show();
        });
        document.getElementById('confirmLogoutBtn').onclick = function() {
            fetch('{{ url_for("logout") }}', {
                method: 'POST',
                headers: {'X-Requested-With': 'XMLHttpRequest'}
            }).then(() => {
                window.location.href = '{{ url_for("login") }}';
            });
        };

        // --- Theme select logic for Settings Modal ---
        const themeSelect = document.getElementById('themeSelect');
        const currentTheme = localStorage.getItem('theme') || '{{ theme|default("light") }}';
        document.documentElement.setAttribute('data-theme', currentTheme);
        themeSelect.value = currentTheme;
        themeSelect.addEventListener('change', () => {
            const theme = themeSelect.value;
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            fetch('/set_theme', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({theme: theme})
            }).then(res => res.json())
            .then(() => {
                location.reload(); // Reload to apply new theme from session
            });
        });

        // --- Card List Modal logic ---
        document.getElementById('showCardListModal').addEventListener('click', function(e) {
            e.preventDefault();
            fetch('/card_list')
                .then(res => res.json())
                .then(data => {
                    const cardList = document.getElementById('cardList');
                    cardList.innerHTML = '';
                    data.files.forEach(file => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item';
                        const a = document.createElement('a');
                        a.href = '#';
                        a.textContent = file;
                        a.onclick = function(e) {
                            e.preventDefault();
                            fetch(`/get_card_hash/${file}`)
                            .then(res => res.json())
                            .then(data => {
                                if (data.hash) {
                                    const publicUrl = `${window.location.origin}/public_card/${data.hash}`;
                                    // Thử copy clipboard
                                    if (navigator.clipboard) {
                                        navigator.clipboard.writeText(publicUrl)
                                            .then(() => {
                                                window.open(publicUrl, '_blank');
                                            })
                                            .catch(() => {
                                                // Fallback: tạo input ẩn để copy
                                                const tempInput = document.createElement('input');
                                                tempInput.value = publicUrl;
                                                document.body.appendChild(tempInput);
                                                tempInput.select();
                                                try {
                                                    document.execCommand('copy');
                                                    window.open(publicUrl, '_blank');
                                                } catch (err) {
                                                    window.open(publicUrl, '_blank');
                                                    alert('Không thể copy link vào clipboard, hãy copy thủ công:\n' + publicUrl);
                                                }
                                                document.body.removeChild(tempInput);
                                            });
                                    } else {
                                        // Fallback luôn
                                        const tempInput = document.createElement('input');
                                        tempInput.value = publicUrl;
                                        document.body.appendChild(tempInput);
                                        tempInput.select();
                                        try {
                                            document.execCommand('copy');
                                            window.open(publicUrl, '_blank');
                                        } catch (err) {
                                            window.open(publicUrl, '_blank');
                                            alert('Không thể copy link vào clipboard, hãy copy thủ công:\n' + publicUrl);
                                        }
                                        document.body.removeChild(tempInput);
                                    }
                                } else {
                                    alert('Không thể tạo link public cho card này!');
                                }
                            });
                        };
                        li.appendChild(a);
                        cardList.appendChild(li);
                    });
                    new bootstrap.Modal(document.getElementById('cardListModal')).show();
                });
        });

        // --- Card Info (Profile Tab) ---
        document.getElementById('profile-tab').addEventListener('shown.bs.tab', function () {
            fetch('/get_card_info')
                .then(res => res.json())
                .then(data => {
                    document.getElementById('profileName').value = data.Name || '';
                    document.getElementById('profileJob').value = data.Job || '';
                    document.getElementById('profileEmail').value = data.Email || '';
                    document.getElementById('profilePhone').value = data.Phone || '';
                    document.getElementById('profileSNS').value = data.SNS || '';
                    document.getElementById('profileSlogan').value = data.SubSlogan || '';
                });
        });
        document.getElementById('profileForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const data = {
                Name: document.getElementById('profileName').value,
                Job: document.getElementById('profileJob').value,
                Email: document.getElementById('profileEmail').value,
                Phone: document.getElementById('profilePhone').value,
                SNS: document.getElementById('profileSNS').value,
                SubSlogan: document.getElementById('profileSlogan').value
            };
            fetch('/update_card_info', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(res => res.json())
            .then(resp => {
                if(resp.status === 'success') {
                    document.getElementById('profileMsg').textContent = 'Cập nhật thành công!';
                    setTimeout(() => { document.getElementById('profileMsg').textContent = ''; }, 2000);
                }
            });
        });

        // --- Navbar auto close on outside click (mobile UX) ---
        document.addEventListener('click', function(event) {
            const navbarCollapse = document.getElementById('navbarNav');
            const navbarToggler = document.querySelector('.navbar-toggler');
            // Nếu menu đang mở và click ngoài menu + ngoài nút toggler thì đóng menu
            if (navbarCollapse.classList.contains('show')) {
                if (
                    !navbarCollapse.contains(event.target) &&
                    !navbarToggler.contains(event.target)
                ) {
                    new bootstrap.Collapse(navbarCollapse).hide();
                }
            }
        });
    </script>
</body>
</html>