<!DOCTYPE html>
<html lang="en" data-theme="{{ theme|default('light') }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ username or '友部 瑛稀' }}</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Merriweather:ital,wght@0,400;0,700;1,400&family=Kosugi+Maru&family=Noto+Sans+JP:wght@400;700&family=Shippori+Mincho+B1:wght@700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon-16x16.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='android-chrome-192x192.png') }}">
    <link rel="icon" type="image/png" sizes="512x512" href="{{ url_for('static', filename='android-chrome-512x512.png') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='apple-touch-icon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
    
    <style>
        /* ===== HOME-SPECIFIC STYLES ===== */
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            {% if bg_image_url %}
            background-image: url('{{ bg_image_url }}');
            background-size: contain;
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            {% endif %}
        }

        /* Modern Navbar */
        .navbar {
            background: var(--navbar-bg) !important;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--navbar-border);
            box-shadow: 0 4px 20px var(--navbar-shadow);
            padding: 1rem 0;
        }

        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-color) !important;
            font-family: 'Shippori Mincho B1', 'Kosugi Maru', 'Noto Sans JP', serif;
            letter-spacing: 0.08em;
            text-shadow: 0 2px 8px rgba(0,0,0,0.07);
            line-height: 1.2;
            transition: all 0.3s ease;
        }

        .navbar-brand:hover {
            color: var(--primary-color) !important;
            transform: translateY(-1px);
        }

        .navbar .navbar-toggler {
            border: 1px solid var(--navbar-border);
            color: var(--text-color);
        }

        .navbar .navbar-toggler:focus {
            box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb, 52, 152, 219), 0.1);
        }

        .nav-link {
            color: var(--secondary-color) !important;
            font-weight: 500;
            transition: all 0.3s ease;
            border-radius: 10px;
            margin: 0 0.25rem;
            padding: 0.5rem 1rem !important;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-link:hover,
        .nav-link:focus,
        .nav-link.active {
            color: var(--primary-color) !important;
            background: rgba(var(--primary-color-rgb, 52, 152, 219), 0.1);
            transform: translateY(-1px);
        }

        .nav-link i {
            font-size: 1.1rem;
        }

        /* Dropdown Menu */
        .dropdown-menu {
            background: var(--card-bg);
            border: 1px solid var(--navbar-border);
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
            z-index: 9999 !important;
            position: absolute !important;
        }
        
        /* Ensure navbar dropdown always on top */
        .navbar .dropdown-menu {
            z-index: 9999 !important;
        }
        
        /* Lower z-index for alert box */
        #alertsBox {
            position: relative;
            z-index: 100 !important;
        }

        .dropdown-item {
            color: var(--text-color);
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
            border-radius: 8px;
            margin: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .dropdown-item:hover {
            background: var(--primary-color);
            color: white;
            transform: translateX(2px);
        }

        .dropdown-item i {
            width: 1.2rem;
            font-size: 1rem;
        }

        /* Container and Layout Overrides */
        .container.py-4 {
            margin-bottom: 0;
            max-width: 1200px;
            padding: 2rem 1.5rem;
        }

        .center-quote {
            min-height: 70vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* Card Enhancement */
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            opacity: 0.8;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .card-body {
            position: relative;
            padding: 2rem;
            background: transparent !important;
        }

        /* Quote Specific Styles */
        .quote-content {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quote-content:hover {
            color: var(--primary-color);
            transform: scale(1.02);
        }

        /* Modal Enhancements */
        .modal-content {
            border: none;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
            background: var(--modal-bg) !important;
        }

        .modal-header {
            border-bottom: 1px solid var(--navbar-border);
            padding: 1.5rem;
            background: transparent;
        }

        .modal-title {
            font-weight: 600;
            color: var(--text-color) !important;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-body {
            padding: 1.5rem;
            background: transparent;
            color: var(--text-color) !important;
        }

        .modal-footer {
            border-top: 1px solid var(--navbar-border);
            padding: 1rem 1.5rem;
            background: transparent;
        }

        /* Form Controls */
        .form-control {
            border-radius: 10px;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            background: var(--card-bg);
            color: var(--text-color);
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb, 52, 152, 219), 0.1);
            transform: translateY(-1px);
            background: var(--card-bg);
            color: var(--text-color);
        }

        .form-label {
            color: var(--text-color);
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .form-text {
            color: var(--secondary-color);
        }

        .form-select {
            border-radius: 10px;
            padding: 0.75rem 1rem;
            background: var(--card-bg);
            color: var(--text-color);
        }

        .form-check-input {
            border: 2px solid var(--navbar-border);
            border-radius: 6px;
        }

        .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .form-check-label {
            color: var(--text-color);
            font-weight: 500;
        }

        /* Buttons */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border: none;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(var(--primary-color-rgb, 52, 152, 219), 0.3);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(var(--primary-color-rgb, 52, 152, 219), 0.4);
            background: linear-gradient(135deg, var(--accent-color), var(--primary-color));
            color: white;
        }

        .btn-secondary {
            background: var(--secondary-color);
            border: none;
            border-radius: 10px;
            color: white;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: var(--primary-color);
            transform: translateY(-1px);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--alert-danger-color), #c0392b);
            border: none;
            border-radius: 10px;
            color: white;
            transition: all 0.3s ease;
        }

        .btn-danger:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.3);
        }

        .btn-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            opacity: 0.6;
            transition: opacity 0.3s ease;
        }

        .btn-close:hover {
            opacity: 1;
        }

        /* Nav Tabs */
        .nav-tabs {
            border-bottom: 2px solid var(--navbar-border);
        }

        .nav-tabs .nav-link {
            border: none;
            border-radius: 10px 10px 0 0;
            color: var(--text-color) !important;
            font-weight: 500;
            padding: 0.75rem 1rem;
            margin-right: 0.25rem;
            transition: all 0.3s ease;
        }

        .nav-tabs .nav-link:hover {
            color: var(--primary-color) !important;
            background: rgba(var(--primary-color-rgb, 52, 152, 219), 0.1);
        }

        .nav-tabs .nav-link.active {
            background: var(--primary-color) !important;
            color: white !important;
            border-bottom: 2px solid var(--primary-color);
        }

        /* Modal sizing for desktop */
        @media (min-width: 992px) {
            #settingsModal .modal-dialog {
                max-width: 800px;
            }
            
            #settingsModal .nav-tabs {
                display: flex;
                flex-wrap: nowrap;
                justify-content: space-between;
            }
            
            #settingsModal .nav-tabs .nav-item {
                flex: 1;
                text-align: center;
            }
            
            #settingsModal .nav-tabs .nav-link {
                white-space: nowrap;
                padding: 0.75rem 0.5rem;
                margin-right: 0.1rem;
                font-size: 0.95rem;
            }
        }

        @media (max-width: 991.98px) {
            #settingsModal .nav-tabs {
                flex-wrap: wrap;
            }
            
            #settingsModal .nav-tabs .nav-item {
                min-width: calc(50% - 0.25rem);
            }
        }

        /* QR Container */
        .qr-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
            margin: 0.5rem 0;
            border: 1px solid var(--navbar-border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--card-bg);
        }

        .qr-container:hover {
            background: rgba(var(--primary-color-rgb, 52, 152, 219), 0.1);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .qr-canvas {
            margin-bottom: 0.5rem;
            border-radius: 8px;
        }

        .qr-filename {
            font-size: 0.9rem;
            color: var(--secondary-color);
            text-align: center;
            font-weight: 500;
        }

        /* Links Tree */
        .folder-header {
            background: rgba(var(--primary-color-rgb, 52, 152, 219), 0.1) !important;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .list-group-item {
            background: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--navbar-border);
            border-radius: 8px;
            margin-bottom: 0.25rem;
            transition: all 0.3s ease;
        }

        .list-group-item:hover {
            background: rgba(var(--primary-color-rgb, 52, 152, 219), 0.05);
            transform: translateX(2px);
        }

        .list-group-item.dragging {
            opacity: 0.5;
            background: rgba(var(--primary-color-rgb, 52, 152, 219), 0.1) !important;
        }

        .list-group-item.drag-over {
            border-top: 2px solid var(--primary-color);
            background: rgba(var(--primary-color-rgb, 52, 152, 219), 0.1) !important;
        }

        /* Categories Grid */
        .categories-grid {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--card-bg);
            border-radius: 10px;
            border: 1px solid var(--navbar-border);
            transition: all 0.3s ease;
        }

        .category-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .category-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .category-color {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 2px solid rgba(255,255,255,0.8);
        }

        .category-name {
            font-weight: 500;
            color: var(--text-color);
        }

        /* Responsive Design */
        @media (max-width: 991.98px) {
            .navbar-collapse {
                background: var(--navbar-bg);
                border-radius: 15px;
                margin-top: 1rem;
                padding: 1rem;
                box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            }
        }

        @media (max-width: 768px) {
            .container.py-4 {
                padding: 1rem;
            }

            .card-body {
                padding: 1.5rem;
            }

            .modal-content {
                margin: 1rem;
                border-radius: 15px;
            }

            .modal-header,
            .modal-body {
                padding: 1rem;
            }

            body {
                background-attachment: scroll;
                background-size: contain;
            }

        }

        @media (max-width: 576px) {
            .navbar {
                padding: 0.75rem 0;
            }

            .navbar-brand {
                font-size: 1.3rem;
            }

            .nav-link {
                font-size: 0.9rem;
            }

            .container,
            .container-fluid {
                padding-left: 8px !important;
                padding-right: 8px !important;
            }

            /* Thêm margin-top cho nội dung thông báo trên mobile */
            #alertsList {
                margin-top: 3rem !important;
                padding-left: 1rem;
            }
        }

        /* Responsive cho iPad */
        @media (max-width: 768px) and (min-width: 577px) {
            #alertsList {
                margin-top: 3rem !important;
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover);
        }

        /* Utility classes */
        .text-primary {
            color: var(--primary-color) !important;
        }

        .text-secondary {
            color: var(--secondary-color) !important;
        }

        .text-muted {
            color: var(--secondary-color) !important;
        }

        /* Smooth transitions */
        * {
            transition: color 0.3s ease, background-color 0.3s ease;
        }

        /* ===== MASTER PASSWORD TAB STYLES ===== */
        .password-strength {
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }

        .strength-weak { 
            color: #dc3545; 
        }

        .strength-medium { 
            color: #ffc107; 
        }

        .strength-strong { 
            color: #28a745; 
        }

        #change-master-pass-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #masterPassMsg.text-success {
            color: #28a745 !important;
        }

        #masterPassMsg.text-danger {
            color: #dc3545 !important;
        }

        #masterPassMsg.text-info {
            color: #17a2b8 !important;
        }

        /* Master Password tab responsive */
        @media (max-width: 991.98px) {
            #settingsModal .nav-tabs .nav-item {
                min-width: calc(33.33% - 0.25rem);
            }
        }

        @media (max-width: 767.98px) {
            #settingsModal .nav-tabs .nav-item {
                min-width: calc(50% - 0.25rem);
                margin-bottom: 0.25rem;
            }
            
            #settingsModal .nav-tabs .nav-link {
                font-size: 0.85rem;
                padding: 0.5rem 0.25rem;
            }
        }
        #settingsModal .nav-tabs {
    overflow-x: auto;
    overflow-y: hidden;
    flex-wrap: nowrap !important;
    white-space: nowrap;
    scrollbar-width: thin;
    scrollbar-color: var(--primary-color) #e0e0e0;
    -webkit-overflow-scrolling: touch;
    border-bottom: 2px solid var(--navbar-border);
    margin-bottom: 0;
}
#settingsModal .nav-tabs .nav-item {
    flex: 0 0 auto;
}
#settingsModal .nav-tabs .nav-link {
    min-width: 110px;
    text-align: center;
}
@media (max-width: 600px) {
    #settingsModal .modal-dialog {
        max-width: 98vw;
        margin: 0.5rem auto;
    }
    #settingsModal .nav-tabs .nav-link {
        padding: 0.5rem 0.5rem;
        font-size: 0.95rem;
    }
}
/* ✅ THÊM: Master Password Modal styles */
    #diaryMasterPasswordModal .modal-content {
        background: var(--card-bg);
        border: none;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    #diaryMasterPasswordModal .modal-header {
        border-bottom: 1px solid var(--navbar-border);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px 15px 0 0;
    }

    #diaryMasterPasswordModal .modal-body {
        padding: 2rem;
    }

    #diary-password-hint-section .alert {
        margin-bottom: 0;
        border-radius: 8px;
    }

    #diary-show-hint-btn {
        color: var(--primary-color);
        text-decoration: none;
        font-size: 0.875rem;
    }

    #diary-show-hint-btn:hover {
        color: var(--primary-color);
        text-decoration: underline;
    }
    #lock-settings-btn {
    border-color: #dc3545;
    color: #dc3545;
    font-size: 0.875rem;
    padding: 0.375rem 0.75rem;
    transition: all 0.2s;
}
#lock-settings-btn:hover {
    background-color: #dc3545;
    border-color: #dc3545;
    color: #fff;
}
#toggleAlertsBtn:hover #toggleAlertsIcon {
    color: #dc3545; /* Đổi thành màu đỏ */
    transform: scale(1.3) rotate(-15deg); /* Phóng to hơn và xoay nhiều hơn */
    transition: color 0.2s, transform 0.2s;
}
#toggleAlertsBtn #toggleAlertsIcon {
    transition: color 0.2s, transform 0.2s;
}

#alertsList {
    padding-left: 3rem !important;
    padding-top: 2rem !important;
}

.offcanvas.show ~ .btn-hamburger {
    display: none !important;
}

.offcanvas{
    max-width: 50%;
}

.btn-hamburger {
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

#sidebarMenuLabel {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--bg-color) !important;
    font-family: 'Shippori Mincho B1', 'Kosugi Maru', 'Noto Sans JP', serif;
    letter-spacing: 0.08em;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
    line-height: 1.2;
    transition: all 0.3s ease;

    </style>
</head>
<body>
    <!-- Hamburger button (top left) -->
    <button class="btn btn-hamburger" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" style="position: fixed; top: 10px; left: 10px; z-index: 1051;">
      <i class="bi bi-list"></i>
    </button>
    <!-- Mindfulness button moved next to bell icon -->
    
    <!-- Offcanvas vertical sidebar menu (menu chính) -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarMenu" aria-labelledby="sidebarMenuLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title mx-auto" id="sidebarMenuLabel">{{ username or '友部 瑛稀' }}</h5>
      </div>
      <div class="offcanvas-body">
        <ul class="nav flex-column sidebar-menu">
          <!-- Evernote Group -->
          <li class="nav-item">
            <a class="nav-link d-flex align-items-center" data-bs-toggle="collapse" href="#evernoteCollapse" role="button" aria-expanded="false" aria-controls="evernoteCollapse">
              <i class="bi bi-journal-richtext me-2"></i> Evernote
              <i class="bi bi-chevron-down ms-auto"></i>
            </a>
            <div class="collapse collapse-item" id="evernoteCollapse">
              <ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link" href="{{ url_for('ever_note') }}"><i class="bi bi-journal-text"></i> Ever Note</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('task') }}"><i class="bi bi-check2-square"></i> Task</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('todo') }}"><i class="bi bi-list-check"></i> Todo</a></li>
              </ul>
            </div>
          </li>

          <!-- Diary Group -->
          <li class="nav-item">
            <a class="nav-link d-flex align-items-center" data-bs-toggle="collapse" href="#diaryCollapse" role="button" aria-expanded="false" aria-controls="diaryCollapse">
              <i class="bi bi-calendar-heart me-2"></i> Diary
              <i class="bi bi-chevron-down ms-auto"></i>
            </a>
            <div class="collapse collapse-item" id="diaryCollapse">
              <ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link" href="{{ url_for('diary_grid') }}?action=new"><i class="bi bi-plus-circle"></i> New Diary</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('diary_list') }}"><i class="bi bi-list-ul"></i> Diary List</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('diary_grid') }}"><i class="bi bi-grid-3x3"></i> Diary Grid</a></li>
              </ul>
            </div>
          </li>

          <!-- Learning Group -->
          <li class="nav-item">
            <a class="nav-link d-flex align-items-center" data-bs-toggle="collapse" href="#learningCollapse" role="button" aria-expanded="false" aria-controls="learningCollapse">
              <i class="bi bi-book me-2"></i> Learning
              <i class="bi bi-chevron-down ms-auto"></i>
            </a>
            <div class="collapse collapse-item" id="learningCollapse">
              <ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link" href="{{ url_for('knowledge') }}"><i class="bi bi-lightbulb"></i> Knowledge</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('vocabulary') }}"><i class="bi bi-chat-quote"></i> Vocabulary</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('english_cloze') }}"><i class="bi bi-chat-quote"></i> English Cloze</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('flashcard') }}"><i class="bi bi-collection"></i> Flashcard</a></li>
              </ul>
            </div>
          </li>

          <!-- Password Group -->
          <li class="nav-item">
            <a class="nav-link d-flex align-items-center" data-bs-toggle="collapse" href="#passwordCollapse" role="button" aria-expanded="false" aria-controls="passwordCollapse">
              <i class="bi bi-shield-lock me-2"></i> Password
              <i class="bi bi-chevron-down ms-auto"></i>
            </a>
            <div class="collapse collapse-item" id="passwordCollapse">
              <ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link" href="{{ url_for('password_manager') }}"><i class="bi bi-key"></i> Password Manager</a></li>
              </ul>
            </div>
          </li>

          <!-- Wellness Group -->
          <li class="nav-item">
            <a class="nav-link d-flex align-items-center" data-bs-toggle="collapse" href="#wellnessCollapse" role="button" aria-expanded="false" aria-controls="wellnessCollapse">
              <i class="bi bi-heart-pulse me-2"></i> Wellness
              <i class="bi bi-chevron-down ms-auto"></i>
            </a>
            <div class="collapse collapse-item" id="wellnessCollapse">
              <ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link" href="{{ url_for('mindmap') }}"><i class="bi bi-diagram-3"></i> Mindmap</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('contacts') }}"><i class="bi bi-person-lines-fill"></i> Contact</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('manage_quotes') }}"><i class="bi bi-chat-quote"></i> Quotes</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('breath') }}"><i class="bi bi-wind"></i> Breath</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('eye_exercise') }}"><i class="bi bi-eye"></i> Eye Exercise</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('game_flip') }}"><i class="bi bi-controller"></i> Memory Game</a></li>
              </ul>
            </div>
          </li>

          <!-- Single Items -->
          <li class="nav-item"><a class="nav-link" href="#" id="openSettingsBtn"><i class="bi bi-gear"></i> Settings</a></li>
          <li class="nav-item"><a class="nav-link" href="#" id="showCardListModal"><i class="bi bi-card-list"></i> Card List</a></li>
          <li class="nav-item"><a class="nav-link" href="#" id="logoutBtn"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
        </ul>
      </div>
    </div>


    <!-- Always show bell icon (toggleAlertsBtn), alertsList only if alerts exist -->
    <div class="container mt-3 position-relative">
        <div class="alert alert-info p-0 border-0 bg-transparent position-absolute end-0 top-0 d-flex align-items-center gap-1" id="alertsBox" style="min-width:90px; max-width:140px; z-index:1052;">
            <button class="btn p-0 border-0 bg-transparent" id="toggleAlertsBtn" type="button" style="font-size:1.6rem;">
                <span id="toggleAlertsIcon" class="bi bi-bell"></span>
            </button>
            <button class="btn p-0 border-0 bg-transparent" id="mindfulnessBtn" type="button" style="font-size:1.6rem; margin-left: 0.8rem;">
                <i class="bi bi-alexa"></i>
            </button>
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const mindfulnessBtn = document.getElementById('mindfulnessBtn');
                    if (mindfulnessBtn) {
                        mindfulnessBtn.addEventListener('click', function() {
                            var mindfulnessModal = new bootstrap.Modal(document.getElementById('mindfulnessModal'));
                            mindfulnessModal.show();
                        });
                        // Add hover effect for mindfulnessBtn like toggleAlertsBtn
                        mindfulnessBtn.addEventListener('mouseenter', () => {
                            mindfulnessBtn.style.color = '#dc3545';
                            mindfulnessBtn.style.transition = 'color 0.2s';
                        });
                        mindfulnessBtn.addEventListener('mouseleave', () => {
                            mindfulnessBtn.style.color = '';
                        });
                    }
                });
            </script>
            <button class="btn p-0 border-0 bg-transparent" id="linksBtn" type="button" style="font-size:1.6rem; margin-left: 0.8rem;">
                <i class="bi bi-link-45deg"></i>
            </button>
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const linksBtn = document.getElementById('linksBtn');
                    if (linksBtn) {
                        // Add hover effect for mindfulnessBtn like toggleAlertsBtn
                        linksBtn.addEventListener('mouseenter', () => {
                            linksBtn.style.color = '#dc3545';
                            linksBtn.style.transition = 'color 0.2s';
                        });
                        linksBtn.addEventListener('mouseleave', () => {
                            linksBtn.style.color = '';
                        });
                    }
                });
            </script>

        </div>
        {% if alerts_today or alerts_tomorrow %}
        <div id="alertsList" class="mt-2 d-none">
            <!-- Contact alerts today -->
            {% for alert in alerts_today %}
                {% if 'sinh nhật' in alert %}
                    <div style="color:#28a745;font-weight:bold"><i class="bi bi-cake2 me-2"></i>{{ alert }}</div>
                {% elif 'kỷ niệm' in alert %}
                    <div style="color:#28a745;font-weight:bold"><i class="bi bi-heart-fill me-2"></i>{{ alert }}</div>
                {% endif %}
            {% endfor %}

            <!-- Contact alerts tomorrow -->
            {% for alert in alerts_tomorrow %}
                {% if 'sinh nhật' in alert %}
                    <div><i class="bi bi-cake2 me-2"></i>{{ alert }}</div>
                {% elif 'kỷ niệm' in alert %}
                    <div><i class="bi bi-heart me-2"></i>{{ alert }}</div>
                {% endif %}
            {% endfor %}

            <!-- Task alerts today -->
            {% for alert in alerts_today %}
                {% if 'Task' in alert and 'quá hạn' in alert %}
                    <div style="color:#dc3545;font-weight:bold"><i class="bi bi-exclamation-triangle-fill me-2"></i>{{ alert }}</div>
                {% elif 'Task' in alert %}
                    <div style="color:#fd7e14;font-weight:bold"><i class="bi bi-clock-fill me-2"></i>{{ alert }}</div>
                {% endif %}
            {% endfor %}

            <!-- Task alerts tomorrow -->
            {% for alert in alerts_tomorrow %}
                {% if 'Task' in alert %}
                    <div><i class="bi bi-clock me-2"></i>{{ alert }}</div>
                {% endif %}
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <div class="container py-4 center-quote">
        <div class="row g-3">
            <div class="col-12">
                {% if show_quote %}
                <div class="card shadow-sm">
                    <div class="card-body text-center">
                        <div class="quote-content" id="quoteContent" style="cursor:pointer;">
                            {{ quote_content | nl2br | safe }}
                        </div>
                        <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            const quoteContent = document.getElementById('quoteContent');
                            if (quoteContent) {
                                quoteContent.addEventListener('click', function() {
                                    // Remove HTML tags and decode entities for copying plain text
                                    const tempDiv = document.createElement('div');
                                    tempDiv.innerHTML = quoteContent.innerHTML;
                                    const text = tempDiv.innerText;
                                    navigator.clipboard.writeText(text).then(function() {
                                        // Visual feedback
                                        quoteContent.style.background = '#e0ffe0';
                                        quoteContent.style.transition = 'background 0.3s';
                                        setTimeout(() => {
                                            quoteContent.style.background = '';
                                        }, 600);
                                    });
                                });
                                // Optional: show pointer and tooltip
                                quoteContent.title = 'Click to copy quote';
                            }
                        });
                        </script>
                        <div class="quote-author mt-3">
                            — {{ quote_author }}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Modals (keeping existing structure but with modern styling) -->
    <div class="modal fade" id="cardListModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-qr-code me-2"></i>
                        Name Cards
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small mb-3">
                        <i class="bi bi-info-circle me-1"></i>
                        Click vào mã QR để copy link card vào clipboard
                    </p>
                    <div id="cardList" class="row g-3"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="linksModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-link-45deg me-2"></i>
                        Links Manager
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="linksTreeContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmLogoutModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Confirm Logout
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to logout?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmLogoutBtn">Logout</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-gear me-2"></i>
                        Settings
                    </h5>
                    <button class="btn btn-outline-danger btn-sm ms-auto" id="lock-settings-btn" type="button" title="Lock">
                        <i class="bi bi-lock"></i> Lock Settings
                    </button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="settingsTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="personalize-tab" data-bs-toggle="tab" data-bs-target="#personalizeTab" type="button">Personalize</button>
                        </li>
                        
                        <!-- ✅ THÊM: Master Password tab -->
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="master-password-tab" data-bs-toggle="tab" data-bs-target="#masterPasswordTab" type="button">Master Pass</button>
                        </li>
                        
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profileTab" type="button">Card</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="ai-search-tab" data-bs-toggle="tab" data-bs-target="#aiSearchTab" type="button">AI Search</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="db-tab" data-bs-toggle="tab" data-bs-target="#dbTab" type="button">Database</button>
                        </li>
                    </ul>
                    <div class="tab-content mt-3">
                        <div class="tab-pane fade show active" id="personalizeTab">
                            <!-- User Name -->
                            <div class="mb-4">
                                <label for="userNameInput" class="form-label">
                                    <i class="bi bi-person-badge me-1"></i>
                                    User Name
                                </label>
                                <input type="text" class="form-control" id="userNameInput" value="{{ username or '' }}" maxlength="100" autocomplete="off" placeholder="Enter your name">
                                <button type="button" class="btn btn-outline-primary mt-2 w-100" id="saveUserNameBtn">
                                    <i class="bi bi-save me-1"></i> Save User Name
                                </button>
                                <div id="userNameMsg" class="form-text text-success d-none">Saved!</div>
                            </div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const saveUserNameBtn = document.getElementById('saveUserNameBtn');
    const userNameInput = document.getElementById('userNameInput');
    const userNameMsg = document.getElementById('userNameMsg');
    const toggleBgImage = document.getElementById('toggleBgImage');
    if (saveUserNameBtn && userNameInput) {
        saveUserNameBtn.addEventListener('click', function() {
            const name = userNameInput.value.trim();
            const showBg = toggleBgImage ? toggleBgImage.checked : undefined;
            const payload = { user_name: name };
            if (typeof showBg !== 'undefined') payload.show_bg_image = showBg;
            fetch('/api/ui_settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    userNameMsg.classList.remove('d-none');
                    setTimeout(() => userNameMsg.classList.add('d-none'), 1200);
                }
            });
        });
    }
});
</script>
                            <!-- Theme -->
                            <div class="mb-4">
                                <label for="themeSelect" class="form-label">
                                    <i class="bi bi-palette me-1"></i>
                                    Theme
                                </label>
                                <select class="form-select" id="themeSelect">
                                    <option value="light">Light</option>
                                    <option value="dark">Dark</option>
                                    <option value="blue">Blue</option>
                                    <option value="green">Green</option>
                                    <option value="purple">Purple</option>
                                    <option value="red">Red</option>
                                    <option value="orange">Orange</option>
                                    <option value="yellow">Yellow</option>
                                    <option value="pink">Pink</option>
                                    <option value="cyan">Cyan</option>
                                </select>
                            </div>
                            <!-- Background -->
                            <div class="mb-4">
                                <form action="{{ url_for('upload_bg') }}" method="post" enctype="multipart/form-data" class="mb-3">
                                    <label class="form-label">
                                        <i class="bi bi-image me-1"></i>
                                        Background Image
                                    </label>
                                    <input type="file" name="bg_image" accept="image/*" class="form-control">
                                    <button type="submit" class="btn btn-primary w-100 mt-2">
                                        <i class="bi bi-upload me-1"></i>
                                        Upload
                                    </button>
                                </form>
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" id="toggleBgImage">
                                    <label class="form-check-label" for="toggleBgImage">Hiển thị hình nền</label>
                                </div>                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="toggleQuote" checked>
                                <label class="form-check-label" for="toggleQuote">Hiển thị quote nội bộ</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="toggleZenQuote">
                                <label class="form-check-label" for="toggleZenQuote">Hiển thị ZenQuote</label>
                            </div>
                            </div>
                            <!-- Avatar -->
                            <div class="mb-4">
                                <form action="{{ url_for('upload_avatar') }}" method="post" enctype="multipart/form-data" class="mb-3">
                                    <label class="form-label">
                                        <i class="bi bi-person-circle me-1"></i>
                                        Avatar Image
                                    </label>
                                    <input type="file" name="avatar_image" accept="image/*,.heic" class="form-control" required>
                                    <button type="submit" class="btn btn-primary w-100 mt-2">
                                        <i class="bi bi-upload me-1"></i>
                                        Upload
                                    </button>
                                </form>
                            </div>
                            <!-- Password -->
                            <div>
                                <form method="POST" action="{{ url_for('change_password') }}">
                                    <label for="new_password" class="form-label">
                                        <i class="bi bi-key me-1"></i>
                                        Change Password
                                    </label>
                                    <input type="password" class="form-control mb-2" id="new_password" name="new_password" required>
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="bi bi-check-circle me-1"></i>
                                        Save Password
                                    </button>
                                </form>
                            </div>
                        </div>
                        
                        
                        <div class="tab-pane fade" id="masterPasswordTab">
                            <form id="masterPasswordForm">
                                <div class="mb-3">
                                    <label for="current-master-pass" class="form-label">
                                        <i class="bi bi-shield-lock me-1"></i>
                                        Current Master Password
                                    </label>
                                    <input type="password" class="form-control" id="current-master-pass" 
                                        placeholder="Enter current master password" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="new-master-pass" class="form-label">
                                        <i class="bi bi-key me-1"></i>
                                        New Master Password
                                    </label>
                                    <input type="password" class="form-control" id="new-master-pass" 
                                        placeholder="Enter new master password" required>
                                    <div id="master-pass-strength" class="password-strength mt-2"></div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="confirm-master-pass" class="form-label">
                                        <i class="bi bi-check-circle me-1"></i>
                                        Confirm New Master Password
                                    </label>
                                    <input type="password" class="form-control" id="confirm-master-pass" 
                                        placeholder="Confirm new master password" required>
                                    <div id="master-pass-match-feedback" class="mt-1"></div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="master-pass-hint" class="form-label">
                                        <i class="bi bi-lightbulb me-1"></i>
                                        Password Hint (Optional)
                                    </label>
                                    <input type="text" class="form-control" id="master-pass-hint" 
                                        placeholder="Create a hint for your master password" maxlength="200">
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <button type="button" class="btn btn-primary" id="change-master-pass-btn" disabled>
                                        <i class="bi bi-shield-check me-1"></i>
                                        Change Master Password
                                    </button>
                                </div>
                            </form>
                            
                            <div class="mt-3">
                                <div id="masterPassMsg" class="text-center"></div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="uploadTab">
                            <form action="{{ url_for('upload_bg') }}" method="post" enctype="multipart/form-data" class="mb-3">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="bi bi-image me-1"></i>
                                        Background Image
                                    </label>
                                    <input type="file" name="bg_image" accept="image/*" class="form-control">
                                </div>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="bi bi-upload me-1"></i>
                                    Upload
                                </button>
                            </form>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="toggleBgImage">
                                <label class="form-check-label" for="toggleBgImage">Hiển thị hình nền</label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="toggleQuote" checked>
                                <label class="form-check-label" for="toggleQuote">Hiển thị quote nội bộ</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="toggleZenQuote">
                                <label class="form-check-label" for="toggleZenQuote">Hiển thị ZenQuote</label>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="avatarTab">
                            <form action="{{ url_for('upload_avatar') }}" method="post" enctype="multipart/form-data" class="mb-3">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="bi bi-person-circle me-1"></i>
                                        Avatar Image
                                    </label>
                                    <input type="file" name="avatar_image" accept="image/*,.heic" class="form-control" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="bi bi-upload me-1"></i>
                                    Upload
                                </button>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="profileTab">
                            <form id="profileForm">
                                <div class="mb-3">
                                    <label for="profileName" class="form-label">
                                        <i class="bi bi-person me-1"></i>
                                        Name
                                    </label>
                                    <input type="text" class="form-control" id="profileName" placeholder="Enter your name">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="profileJob" class="form-label">
                                        <i class="bi bi-briefcase me-1"></i>
                                        Job Title
                                    </label>
                                    <input type="text" class="form-control" id="profileJob" placeholder="Enter your job title">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="profileEmail" class="form-label">
                                        <i class="bi bi-envelope me-1"></i>
                                        Email
                                    </label>
                                    <input type="email" class="form-control" id="profileEmail" placeholder="Enter your email">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="profilePhone" class="form-label">
                                        <i class="bi bi-phone me-1"></i>
                                        Phone
                                    </label>
                                    <input type="tel" class="form-control" id="profilePhone" placeholder="Enter your phone">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="profileSNS" class="form-label">
                                        <i class="bi bi-share me-1"></i>
                                        Social Media
                                    </label>
                                    <input type="text" class="form-control" id="profileSNS" placeholder="Enter your social media">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="profileSlogan" class="form-label">
                                        <i class="bi bi-chat-quote me-1"></i>
                                        Slogan
                                    </label>
                                    <input type="text" class="form-control" id="profileSlogan" placeholder="Enter your slogan">
                                </div>
                                
                                <button type="button" class="btn btn-primary w-100" onclick="ProfileManager.saveProfile()">
                                    <i class="bi bi-check-circle me-1"></i>
                                    Save Profile
                                </button>
                                
                                <div class="mt-3">
                                    <div id="profileMsg" class="text-center text-success"></div>
                                </div>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="aiSearchTab">
                                <form id="aiSearchForm" onsubmit="return false;"> <!-- Thêm onsubmit="return false;" -->
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <i class="bi bi-chat-text me-1"></i>
                                            AI Question Template (Knowledge)
                                        </label>
                                        <textarea class="form-control" id="aiQuestionTemplate" name="ai_question_template" rows="4" placeholder="Enter your question template. Use {keyword} as placeholder for the keyword."></textarea>
                                        <div class="form-text">
                                            <strong>Example:</strong> "abc {keyword} xyz."
                                            <br><strong>Note:</strong> Must contain {keyword} placeholder
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <i class="bi bi-book me-1"></i>
                                            Vocabulary Query Template
                                        </label>
                                        <textarea class="form-control" id="vocabularyQueryTemplate" name="vocabulary_query_template" rows="3" placeholder="Enter your vocabulary query template. Use {word} as placeholder for the word."></textarea>
                                        <div class="form-text">
                                            <strong>Example:</strong> "Explain the meaning of {word} with examples and usage"
                                            <br><strong>Note:</strong> Must contain {word} placeholder
                                        </div>
                                    </div>
                                    
                                    <hr class="my-4">
                                    
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="form-label">
                                                <i class="bi bi-robot me-1"></i>
                                                ChatGPT
                                            </label>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="chatgptEnabled" name="chatgpt_enabled" checked>
                                                <label class="form-check-label" for="chatgptEnabled">Enabled</label>
                                            </div>
                                        </div>
                                        <input type="text" class="form-control" id="chatgptUrl" name="chatgpt_url" value="https://chat.openai.com/?q={query}" placeholder="URL must contain {query}">
                                        <div class="form-text">AI assistant for comprehensive answers</div>
                                    </div>
                                        
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <label class="form-label">
                                                    <i class="bi bi-lightning me-1"></i>
                                                    Grok AI
                                                </label>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="grokEnabled" name="grok_enabled" checked>
                                                    <label class="form-check-label" for="grokEnabled">Enabled</label>
                                                </div>
                                            </div>
                                            <input type="text" class="form-control" id="grokUrl" name="grok_url" value="https://x.com/i/grok?q={query}" placeholder="URL must contain {query}">
                                            <div class="form-text">X (Twitter)'s AI with real-time data</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <label class="form-label">
                                                    <i class="bi bi-search me-1"></i>
                                                    Perplexity AI
                                                </label>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="perplexityEnabled" name="perplexity_enabled">
                                                    <label class="form-check-label" for="perplexityEnabled">Enabled</label>
                                                </div>
                                            </div>
                                            <input type="text" class="form-control" id="perplexityUrl" name="perplexity_url" value="https://www.perplexity.ai/?q={query}" placeholder="URL must contain {query}">
                                            <div class="form-text">AI-powered search with sources</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <label class="form-label">
                                                    <i class="bi bi-globe me-1"></i>
                                                    You.com Search
                                                </label>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="youEnabled" name="you_enabled">
                                                    <label class="form-check-label" for="youEnabled">Enabled</label>
                                                </div>
                                            </div>
                                            <input type="text" class="form-control" id="youUrl" name="you_url" value="https://you.com/search?q={query}" placeholder="URL must contain {query}">
                                            <div class="form-text">AI-powered search engine</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <label class="form-label">
                                                    <i class="bi bi-microsoft me-1"></i>
                                                    Copilot AI
                                                </label>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="copilotEnabled" name="copilot_enabled">
                                                    <label class="form-check-label" for="copilotEnabled">Enabled</label>
                                                </div>
                                            </div>
                                            <input type="text" class="form-control" id="copilotUrl" name="copilot_url" value="https://copilot.microsoft.com/?q={query}" placeholder="URL must contain {query}">
                                            <div class="form-text">Microsoft's AI assistant</div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-6">
                                                <button type="button" class="btn btn-primary w-100" onclick="AISettingsManager.saveAISettings(event)"> <!-- Thay đổi type từ "submit" thành "button" và thêm onclick -->
                                                    <i class="bi bi-check-circle me-1"></i>
                                                    Save Settings
                                                </button>
                                            </div>
                                            <div class="col-6">
                                                <button type="button" class="btn btn-secondary w-100" id="resetAiSettings">
                                                    <i class="bi bi-arrow-clockwise me-1"></i>
                                                    Reset to Default
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-3">
                                            <div id="aiSettingsMsg" class="text-center"></div>
                                        </div>
                                    </form>
                                </div>
                        <div class="tab-pane fade" id="dbTab">
                            <div class="mb-3">
                                <label class="form-label"><i class="bi bi-hdd-network me-1"></i>Database Size</label>
                                <div>
                                    <span id="dbSizeText" class="fw-bold">Loading...</span>
                                    <button class="btn btn-outline-secondary btn-sm ms-2" id="downloadDbBtn">
                                        <i class="bi bi-download"></i> Download DB (zip)
                                    </button>
                                </div>
                            </div>
                            <hr>
                            <div class="mb-3">
                                <label class="form-label"><i class="bi bi-table me-1"></i>Tables &amp; Data</label>
                                <div id="dbTablesList" class="mb-2"></div>
                                <button class="btn btn-danger btn-sm" id="deleteTableDataBtn" disabled>
                                    <i class="bi bi-trash"></i> Delete Selected Table Data
                                </button>
                            </div>
                            <hr>
                            <div class="mb-3">
                                <label class="form-label"><i class="bi bi-images me-1"></i>Uploaded Images</label>
                                <div id="uploadsFileList" style="max-height:200px;overflow:auto;"></div>
                                <button class="btn btn-danger btn-sm" id="deleteFilesBtn" disabled>
                                    <i class="bi bi-trash"></i> Delete Selected Files
                                </button>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
<div class="modal fade" id="masterPasswordModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-shield-lock me-2"></i>Master Password Required
                </h5>
            </div>
            <div class="modal-body">
                <p>Enter your master password to access your setting:</p>
                
                <!-- Hint Display -->
                <div id="password-hint-section" class="mb-3">
                    <div class="alert alert-info">
                        <i class="bi bi-lightbulb me-2"></i>
                        <strong>Hint:</strong> <span id="password-hint-text"></span>
                    </div>
                </div>
                
                <div class="mb-3">
                    <input type="password" class="form-control" id="master-password-input" 
                           placeholder="Enter master password" required>
                </div>
                
                <!-- Show/Hide Hint Button -->
                <div class="mb-3 text-center">
                    <button type="button" class="btn btn-link btn-sm" id="show-hint-btn">
                        <i class="bi bi-question-circle me-1"></i>Show Hint
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='/home'">
                    <i class="bi bi-house me-1"></i>Go Home
                </button>
                <button type="button" class="btn btn-primary" id="verify-master-password">
                    <i class="bi bi-unlock me-1"></i>Unlock Diary
                </button>
            </div>
        </div>
    </div>
</div>
    <div class="modal fade" id="mindfulnessModal" tabindex="-1">
        <div class="modal-dialog modal-md modal-dialog-centered" style="max-width:420px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-alexa"></i>
                        Mindfulness
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="mindTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="mind-main-tab" data-bs-toggle="tab" data-bs-target="#mindMainTab" type="button">Practice</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="mind-setting-tab" data-bs-toggle="tab" data-bs-target="#mindSettingTab" type="button">Setting</button>
                        </li>
                    </ul>
                    <div class="tab-content mt-3">
                        <div class="tab-pane fade show active text-center" id="mindMainTab">
                            <div class="mb-2">
                                <span id="mindTimer" style="font-size:2.2rem;font-weight:bold;color:var(--text-color);">00:00:00</span>
                            </div>
                            <div class="mb-2">
                                <span id="mindBreakInfo" style="font-size:1.1rem;color:var(--primary-color);"></span>
                            </div>
                            <div class="mb-2 d-flex justify-content-center">
                                <svg id="mindCircleSvg" class="circle-visual" width="120" height="120" viewBox="0 0 120 120" style="cursor:pointer;">
                                    <circle cx="60" cy="60" r="50" stroke="var(--primary-color)" stroke-width="6" fill="none" opacity="0.15"/>
                                    <circle id="mindCircleProgress" cx="60" cy="60" r="50" stroke="var(--primary-color)" stroke-width="6" fill="none"
                                        stroke-dasharray="314" stroke-dashoffset="314" stroke-linecap="round"
                                        transform="rotate(-90 60 60)" />
                                    <circle id="mindCircleDot" r="8" fill="var(--primary-color)" cx="60" cy="10"/>
                                    <circle id="mindCircleHover" cx="60" cy="60" r="40" fill="var(--primary-color)" opacity="0" />
                                </svg>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="mindSettingTab">
                            <form id="mindSettingForm">
                                <div class="mb-3">
                                    <label class="form-label">Thời gian (phút)</label>
                                    <select id="mindDuration" class="form-select">
                                        {% for i in range(5, 301, 5) %}
                                        <option value="{{ i }}">{{ i // 60 }}h {{ i % 60 }}m</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Số lần nghỉ (break)</label>
                                    <select id="mindBreaks" class="form-select">
                                        {% for i in range(1, 11) %}
                                        <option value="{{ i }}">{{ i }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Mỗi lần nghỉ: <span id="mindBreakLength">0</span> phút</label>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="{{ url_for('static', filename='js/master_password_auth.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ===== APPLICATION STATE =====
        const AppState = {
            BG_IMAGE_URL: "{{ bg_image_url|default('') }}",
            isRunning: false,
            timer: null,
            totalSec: 0,
            remainSec: 0,
            isPaused: false,
            breakCount: 1,
            breakLength: 0,
            currentBreak: 0,
            startTimestamp: null,
            pausedAt: null
        };

        // ===== CONSTANTS =====
        const RADIUS = 50;
        const CIRCUM = 2 * Math.PI * RADIUS;

        // ===== UTILITY FUNCTIONS =====
        const Utils = {
            formatTime(sec) {
                const h = Math.floor(sec / 3600);
                const m = Math.floor((sec % 3600) / 60);
                const s = sec % 60;
                return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            },

            playBell() {
                try {
                    const audio = new Audio('/static/bell.mp3');
                    audio.play().catch(() => {}); // Ignore audio errors
                } catch (e) {}
            },

            showFlashMessage(message, type = 'success') {
                const alert = document.createElement('div');
                alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
                alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
                alert.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
                document.body.appendChild(alert);
                setTimeout(() => alert.remove(), 3000);
            },

            copyToClipboard(text, container) {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(text)
                        .then(() => this.showCopySuccess(container))
                        .catch(() => this.copyFallback(text));
                } else {
                    this.copyFallback(text);
                }
            },

            showCopySuccess(container) {
                const originalBg = container.style.backgroundColor;
                container.style.backgroundColor = '#d4edda';
                container.style.borderColor = '#c3e6cb';
                
                const tooltip = document.createElement('div');
                tooltip.textContent = 'Copied!';
                tooltip.style.cssText = `
                    position: absolute; background: #28a745; color: white; padding: 4px 8px;
                    border-radius: 4px; font-size: 0.8rem; z-index: 1000; pointer-events: none;
                    top: -30px; left: 50%; transform: translateX(-50%);
                `;
                container.style.position = 'relative';
                container.appendChild(tooltip);
                
                setTimeout(() => {
                    container.style.backgroundColor = originalBg;
                    container.style.borderColor = '#e0e0e0';
                    if (tooltip.parentNode) tooltip.remove();
                }, 1500);
            },

            copyFallback(text) {
                const tempInput = document.createElement('input');
                tempInput.value = text;
                document.body.appendChild(tempInput);
                tempInput.select();
                try {
                    document.execCommand('copy');
                    this.showFlashMessage('Link đã được copy vào clipboard!');
                } catch (err) {
                    alert('Không thể copy link. Link: ' + text);
                }
                document.body.removeChild(tempInput);
            }
        };

        // ===== API FUNCTIONS =====
        const API = {
            async fetchWithErrorHandling(url, options = {}) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return await response.json();
                } catch (error) {
                    console.error(`API Error (${url}):`, error);
                    throw error;
                }
            },

            async getConfig() {
                return this.fetchWithErrorHandling('/api/config');
            },

            async updateConfig(settings) {
                return this.fetchWithErrorHandling('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
            },

            async getAISettings() {
                return this.fetchWithErrorHandling('/ai_settings');
            },

            async updateAISettings(settings) {
                return this.fetchWithErrorHandling('/ai_settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
            },

            async getUISettings() {
                return this.fetchWithErrorHandling('/api/ui_settings');
            },

            async updateUISettings(settings) {
                return this.fetchWithErrorHandling('/api/ui_settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
            },

            async getLinksTree() {
                return this.fetchWithErrorHandling('/api/links_tree');
            },

            async updateLinksTree(treeData) {
                return this.fetchWithErrorHandling('/api/links_tree', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ links_tree: treeData })
                });
            },

            async getCardList() {
                return this.fetchWithErrorHandling('/api/card_list');
            },

            async getCardHash(filename) {
                return this.fetchWithErrorHandling(`/get_card_hash/${encodeURIComponent(filename)}`);
            },

            async getCardInfo() {
                return this.fetchWithErrorHandling('/api/card_info');
            },

            async updateCardInfo(data) {
                return this.fetchWithErrorHandling('/api/card_info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            }
        };

        // ===== MASTER PASSWORD MANAGER =====
        const MasterPasswordManager = {
            init() {
                document.getElementById('master-password-tab').addEventListener('shown.bs.tab', () => this.loadMasterPasswordTab());
                
                // Setup event listeners
                document.getElementById('new-master-pass').addEventListener('input', () => this.checkMasterPasswordStrength());
                document.getElementById('confirm-master-pass').addEventListener('input', () => this.checkMasterPasswordMatch());
                document.getElementById('current-master-pass').addEventListener('input', () => this.checkMasterPasswordMatch());
                
                document.getElementById('change-master-pass-btn').addEventListener('click', () => this.changeMasterPassword());
                
            },

            async loadMasterPasswordTab() {
                // Load current hint if exists
                try {
                    const response = await fetch('/api/auth/master_password_hint');
                    const data = await response.json();
                    
                    if (data.status === 'success' && data.hint) {
                        document.getElementById('master-pass-hint').value = data.hint;
                    } else {
                        document.getElementById('master-pass-hint').value = '';
                    }
                } catch (error) {
                    console.error('Error loading master password hint:', error);
                }
                
                // Reset form
                document.getElementById('current-master-pass').value = '';
                document.getElementById('new-master-pass').value = '';
                document.getElementById('confirm-master-pass').value = '';
                document.getElementById('change-master-pass-btn').disabled = true;
                this.showMessage('', '');
            },

            checkMasterPasswordStrength() {
                const password = document.getElementById('new-master-pass').value;
                const strengthDiv = document.getElementById('master-pass-strength');
                
                if (!password) {
                    strengthDiv.innerHTML = '';
                    this.checkMasterPasswordMatch();
                    return;
                }
                
                let score = 0;
                let feedback = [];
                
                // Length check
                if (password.length >= 12) score += 2;
                else if (password.length >= 8) score++;
                else feedback.push('at least 8 characters (12+ recommended)');
                
                // Character variety checks
                if (/[a-z]/.test(password)) score++;
                else feedback.push('lowercase letters');
                
                if (/[A-Z]/.test(password)) score++;
                else feedback.push('uppercase letters');
                
                if (/[0-9]/.test(password)) score++;
                else feedback.push('numbers');
                
                if (/[^a-zA-Z0-9]/.test(password)) score++;
                else feedback.push('symbols');
                
                let strength = '';
                let className = '';
                
                if (score < 3) {
                    strength = 'Weak';
                    className = 'strength-weak';
                } else if (score < 5) {
                    strength = 'Medium';
                    className = 'strength-medium';
                } else {
                    strength = 'Strong';
                    className = 'strength-strong';
                }
                
                strengthDiv.innerHTML = `<span class="${className}">Strength: ${strength}</span>`;
                if (feedback.length > 0 && score < 5) {
                    strengthDiv.innerHTML += `<br><small>Add: ${feedback.join(', ')}</small>`;
                }
                
                this.checkMasterPasswordMatch();
            },
                
            checkMasterPasswordMatch() {
                const newPassword = document.getElementById('new-master-pass').value;
                const confirmPassword = document.getElementById('confirm-master-pass').value;
                const currentPassword = document.getElementById('current-master-pass').value;
                const feedbackDiv = document.getElementById('master-pass-match-feedback');
                const changeBtn = document.getElementById('change-master-pass-btn');
                
                if (!confirmPassword) {
                    feedbackDiv.innerHTML = '';
                    changeBtn.disabled = true;
                    return;
                }
                
                if (newPassword === confirmPassword) {
                    feedbackDiv.innerHTML = '<small class="text-success"><i class="bi bi-check-circle me-1"></i>Passwords match</small>';
                    
                    // Enable button only if all fields are filled and passwords match
                    changeBtn.disabled = !(currentPassword && newPassword && confirmPassword && newPassword === confirmPassword);
                } else {
                    feedbackDiv.innerHTML = '<small class="text-danger"><i class="bi bi-x-circle me-1"></i>Passwords do not match</small>';
                    changeBtn.disabled = true;
                }
            },

            async changeMasterPassword() {
                const currentPassword = document.getElementById('current-master-pass').value;
                const newPassword = document.getElementById('new-master-pass').value;
                const confirmPassword = document.getElementById('confirm-master-pass').value;
                const newHint = document.getElementById('master-pass-hint').value.trim();
                
                // Validation
                if (!currentPassword) {
                    this.showMessage('Please enter your current master password', 'danger');
                    document.getElementById('current-master-pass').focus();
                    return;
                }
                
                if (!newPassword) {
                    this.showMessage('Please enter a new master password', 'danger');
                    document.getElementById('new-master-pass').focus();
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    this.showMessage('New passwords do not match', 'danger');
                    document.getElementById('confirm-master-pass').focus();
                    return;
                }
                
                if (newPassword === currentPassword) {
                    this.showMessage('New password must be different from current password', 'danger');
                    document.getElementById('new-master-pass').focus();
                    return;
                }
                
                if (newPassword.length < 8) {
                    this.showMessage('New password must be at least 8 characters long', 'danger');
                    document.getElementById('new-master-pass').focus();
                    return;
                }
                
                // Confirm action
                const confirmed = confirm(
                    'Are you sure you want to change your master password?\n\n' +
                    'This will re-encrypt all your passwords with the new master password.\n' +
                    'Make sure you remember the new password as it cannot be recovered!'
                );
                
                if (!confirmed) return;
                
                // Disable button and show loading
                const changeBtn = document.getElementById('change-master-pass-btn');
                const originalText = changeBtn.innerHTML;
                changeBtn.disabled = true;
                changeBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Changing...';
                
                try {
                    const response = await fetch('/api/auth/change_master_password', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            current_password: currentPassword,
                            new_password: newPassword,
                            new_hint: newHint
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        this.showMessage(data.message, 'success');
                        
                        // Reset form
                        document.getElementById('current-master-pass').value = '';
                        document.getElementById('new-master-pass').value = '';
                        document.getElementById('confirm-master-pass').value = '';
                        document.getElementById('master-pass-strength').innerHTML = '';
                        document.getElementById('master-pass-match-feedback').innerHTML = '';
                    } else {
                        this.showMessage('Error: ' + data.message, 'danger');
                    }
                } catch (error) {
                    console.error('Error changing master password:', error);
                    this.showMessage('Error changing master password', 'danger');
                } finally {
                    // Restore button
                    changeBtn.disabled = false;
                    changeBtn.innerHTML = originalText;
                }
            },

            openHintSetupModal() {
                // Load current hint
                this.loadCurrentMasterHint();
                
                const modal = new bootstrap.Modal(document.getElementById('masterHintSetupModal'));
                modal.show();
            },

            async loadCurrentMasterHint() {
                try {
                    const response = await fetch('/api/auth/master_password_hint');
                    const data = await response.json();
                    
                    if (data.status === 'success' && data.hint) {
                        document.getElementById('master-hint-input').value = data.hint;
                        document.getElementById('clear-master-hint-btn').style.display = 'inline-block';
                    } else {
                        document.getElementById('master-hint-input').value = '';
                        document.getElementById('clear-master-hint-btn').style.display = 'none';
                    }
                } catch (error) {
                    console.error('Error loading current master hint:', error);
                    document.getElementById('master-hint-input').value = '';
                    document.getElementById('clear-master-hint-btn').style.display = 'none';
                }
            },

            async saveMasterHint() {
                const hint = document.getElementById('master-hint-input').value.trim();
                
                if (hint.length > 200) {
                    Utils.showFlashMessage('Hint must be 200 characters or less', 'warning');
                    return;
                }
                
                try {
                    const response = await fetch('/api/auth/master_password_hint', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            hint: hint
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        Utils.showFlashMessage(hint ? 'Hint saved successfully' : 'Hint cleared successfully', 'success');
                        bootstrap.Modal.getInstance(document.getElementById('masterHintSetupModal')).hide();
                        
                        // Update hint in main form
                        document.getElementById('master-pass-hint').value = hint;
                    } else {
                        Utils.showFlashMessage('Error: ' + data.message, 'danger');
                    }
                } catch (error) {
                    console.error('Error saving master hint:', error);
                    Utils.showFlashMessage('Error saving hint', 'danger');
                }
            },

            async clearMasterHint() {
                if (!confirm('Are you sure you want to clear your master password hint?')) {
                    return;
                }
                
                try {
                    const response = await fetch('/api/auth/master_password_hint', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            hint: ''
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        Utils.showFlashMessage('Hint cleared successfully', 'success');
                        bootstrap.Modal.getInstance(document.getElementById('masterHintSetupModal')).hide();
                        
                        // Update hint in main form
                        document.getElementById('master-pass-hint').value = '';
                    } else {
                        Utils.showFlashMessage('Error: ' + data.message, 'danger');
                    }
                } catch (error) {
                    console.error('Error clearing master hint:', error);
                    Utils.showFlashMessage('Error clearing hint', 'danger');
                }
            },

            showMessage(message, type) {
                const msgElement = document.getElementById('masterPassMsg');
                if (message) {
                    msgElement.className = `text-${type}`;
                    msgElement.textContent = message;
                    setTimeout(() => { msgElement.textContent = ''; }, 5000);
                } else {
                    msgElement.textContent = '';
                }
            }
        };

        // ===== MINDFULNESS TIMER =====
        const MindfulnessTimer = {
            init() {
                this.setupElements();
                this.setupEventListeners();
                this.updateBreakLength();
            },

            setupElements() {
                this.circleSvg = document.getElementById('mindCircleSvg');
                this.circleProgress = document.getElementById('mindCircleProgress');
                this.circleDot = document.getElementById('mindCircleDot');
                this.timerDisplay = document.getElementById('mindTimer');
                this.breakInfo = document.getElementById('mindBreakInfo');
                this.durationSel = document.getElementById('mindDuration');
                this.breaksSel = document.getElementById('mindBreaks');
                this.breakLenSpan = document.getElementById('mindBreakLength');

                // Add SVG label
                const circleLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
                circleLabel.setAttribute('id', 'mindCircleLabel');
                circleLabel.setAttribute('x', '60');
                circleLabel.setAttribute('y', '68');
                circleLabel.setAttribute('text-anchor', 'middle');
                circleLabel.setAttribute('font-size', '1.2rem');
                circleLabel.setAttribute('font-family', 'inherit');
                circleLabel.setAttribute('fill', '#0d6efd');
                circleLabel.style.cursor = 'pointer';
                circleLabel.textContent = 'start';
                this.circleSvg.appendChild(circleLabel);
                this.circleLabel = circleLabel;
            },

            setupEventListeners() {
                this.durationSel.addEventListener('change', () => this.updateBreakLength());
                this.breaksSel.addEventListener('change', () => this.updateBreakLength());
                
                this.circleSvg.addEventListener('click', () => {
                    if (AppState.isRunning) {
                        this.stopTimer();
                    } else {
                        this.stopTimer();
                        this.startTimer();
                    }
                });

                // Modal events
                document.getElementById('mindfulnessModal').addEventListener('shown.bs.modal', () => {
                    this.stopTimer(false);
                });
                
                document.getElementById('mindfulnessModal').addEventListener('hidden.bs.modal', () => {
                    this.stopTimer(false);
                });
            },

            updateBreakLength() {
                const duration = parseInt(this.durationSel.value) || 5;
                const breaks = parseInt(this.breaksSel.value) || 1;
                AppState.breakLength = Math.floor(duration / breaks);
                this.breakLenSpan.textContent = AppState.breakLength;
            },

            updateCircle(progress) {
                const offset = CIRCUM - progress * CIRCUM;
                this.circleProgress.setAttribute('stroke-dashoffset', offset);
                const angle = -Math.PI / 2 + 2 * Math.PI * progress;
                const cx = 60 + RADIUS * Math.cos(angle);
                const cy = 60 + RADIUS * Math.sin(angle);
                this.circleDot.setAttribute('cx', cx);
                this.circleDot.setAttribute('cy', cy);
            },

            startTimer() {
                AppState.totalSec = parseInt(this.durationSel.value) * 60;
                AppState.remainSec = AppState.totalSec;
                AppState.breakCount = parseInt(this.breaksSel.value);
                AppState.breakLength = Math.floor((parseInt(this.durationSel.value)) / AppState.breakCount);
                AppState.currentBreak = 1;
                AppState.isPaused = false;
                AppState.isRunning = true;
                AppState.startTimestamp = performance.now();
                AppState.pausedAt = null;
                this.circleLabel.textContent = 'stop';
                requestAnimationFrame(() => this.tick());
                Utils.playBell();
            },

            tick() {
                if (AppState.isPaused) {
                    AppState.pausedAt = performance.now();
                    return;
                }
                
                const now = performance.now();
                if (!AppState.startTimestamp) AppState.startTimestamp = now;
                
                let elapsed = Math.floor((now - AppState.startTimestamp) / 1000);
                if (AppState.pausedAt) {
                    AppState.startTimestamp += (now - AppState.pausedAt);
                    AppState.pausedAt = null;
                }
                
                AppState.remainSec = Math.max(0, AppState.totalSec - elapsed);
                this.timerDisplay.textContent = Utils.formatTime(AppState.remainSec);

                let progress = Math.min(1, (AppState.totalSec - AppState.remainSec) / AppState.totalSec);
                this.updateCircle(progress);

                const breakInterval = Math.floor(AppState.totalSec / AppState.breakCount);
                const nextBreak = AppState.totalSec - (AppState.currentBreak * breakInterval);
                if (AppState.remainSec === nextBreak && AppState.currentBreak <= AppState.breakCount) {
                    this.breakInfo.textContent = `Break ${AppState.currentBreak} - ${AppState.breakLength} phút`;
                    AppState.currentBreak++;
                } else if (AppState.remainSec > 0) {
                    this.breakInfo.textContent = '';
                }

                if (AppState.remainSec <= 0) {
                    this.timerDisplay.textContent = "00:00:00";
                    this.breakInfo.textContent = "Hoàn thành!";
                    this.updateCircle(1);
                    AppState.isRunning = false;
                    this.circleLabel.textContent = 'start';
                    Utils.playBell();
                    return;
                }
                
                AppState.timer = requestAnimationFrame(() => this.tick());
            },

            stopTimer(playSound = true) {
                cancelAnimationFrame(AppState.timer);
                this.timerDisplay.textContent = "00:00:00";
                this.breakInfo.textContent = '';
                this.updateCircle(0);
                AppState.isRunning = false;
                this.circleLabel.textContent = 'start';
                if (playSound) Utils.playBell();
            }
        };

        // ===== UI SETTINGS MANAGER =====
        const UISettingsManager = {
            init() {
                this.setupEventListeners();
            },

            setupEventListeners() {
                document.getElementById('personalize-tab').addEventListener('shown.bs.tab', async () => {
                    try {
                        const data = await API.getUISettings();
                        document.getElementById('toggleBgImage').checked = !!data.show_bg_image;
                        document.getElementById('toggleQuote').checked = !!data.show_quote;
                        document.getElementById('toggleZenQuote').checked = !!data.show_zen_quote;
                        this.applyBgImage(!!data.show_bg_image);
                        this.applyQuote(!!data.show_quote, !!data.show_zen_quote);
                    } catch (error) {
                        console.error('Failed to load UI settings:', error);
                    }
                });

                document.getElementById('toggleBgImage').addEventListener('change', (e) => {
                    this.saveSettings();
                    this.applyBgImage(e.target.checked);
                });

                document.getElementById('toggleQuote').addEventListener('change', (e) => {
                    if (e.target.checked) {
                        document.getElementById('toggleZenQuote').checked = false;
                    }
                    this.saveSettings();
                    this.applyQuote(e.target.checked, false);
                });

                document.getElementById('toggleZenQuote').addEventListener('change', (e) => {
                    if (e.target.checked) {
                        document.getElementById('toggleQuote').checked = false;
                    }
                    this.saveSettings();
                    this.applyQuote(false, e.target.checked);
                });
            },

            async saveSettings() {
                try {
                    await API.updateUISettings({
                        show_bg_image: document.getElementById('toggleBgImage').checked,
                        show_quote: document.getElementById('toggleQuote').checked,
                        show_zen_quote: document.getElementById('toggleZenQuote').checked
                    });
                } catch (error) {
                    console.error('Failed to save UI settings:', error);
                }
            },

            applyBgImage(show) {
                if (show) {
                    document.body.classList.remove('no-bg-image');
                    if (AppState.BG_IMAGE_URL) {
                        document.body.style.backgroundImage = `url('${AppState.BG_IMAGE_URL}')`;
                    }
                } else {
                    document.body.classList.add('no-bg-image');
                    document.body.style.backgroundImage = "none";
                }
            },

            applyQuote(showLocal, showZen) {
                const showAnyQuote = showLocal || showZen;
                document.querySelectorAll('.card.shadow-sm').forEach(card => {
                    card.style.display = showAnyQuote ? '' : 'none';
                });
                // Không reload trang để tránh đóng modal settings
            }
        };

        // ===== THEME MANAGER =====
        const ThemeManager = {
            init() {
                this.themeSelect = document.getElementById('themeSelect');
                this.currentTheme = localStorage.getItem('theme') || '{{ theme|default("light") }}';
                document.documentElement.setAttribute('data-theme', this.currentTheme);
                this.themeSelect.value = this.currentTheme;
                
                this.themeSelect.addEventListener('change', () => this.changeTheme());
            },

            async changeTheme() {
                const theme = this.themeSelect.value;
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                
                try {
                    await fetch('/set_theme', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({theme: theme})
                    });
                    location.reload();
                } catch (error) {
                    console.error('Failed to save theme:', error);
                    Utils.showFlashMessage('Failed to save theme', 'danger');
                }
            }
        };

        // ===== AI SETTINGS MANAGER =====
        const AISettingsManager = {
            // Default URLs và question templates
            defaultUrls: {
                chatgpt: "https://chat.openai.com/?q={query}",
                grok: "https://x.com/i/grok?q={query}",
                perplexity: "https://www.perplexity.ai/?q={query}",
                you: "https://you.com/search?q={query}",
                copilot: "https://copilot.microsoft.com/?q={query}"
            },

            defaultQuestionTemplate: "1.hãy nêu tổng quan và các khía cạnh chi tiết về {keyword} bằng các bản dịch tiếng anh, tiếng việt và tiếng nhật (những từ vựng jlpt N1 thì thêm furigana). 2.sao cho sau khi đọc xong thì có đủ kiến thức để trình bày lại cho người khác. 3.hãy cho bảng từ vựn (đầy đủ phiên âm, âm hán việt) liên quan đến chủ đề này. 4.nêu 1 số link nguồn để tìm hiểu sâu hơn về chủ đề này.",

            defaultVocabularyTemplate: "Please explain the word '{word}' in detail including: 1. Definition and meaning, 2. Pronunciation guide, 3. Example sentences with context, 4. Common collocations and phrases, 5. Etymology if interesting, 6. Similar or related words",

            init() {
                document.getElementById('ai-search-tab').addEventListener('shown.bs.tab', () => this.loadAISettings());
                // Xóa event listener cho form submit vì ta đã thay đổi cách xử lý
                // document.getElementById('aiSearchForm').addEventListener('submit', (e) => this.saveAISettings(e));
                document.getElementById('resetAiSettings').addEventListener('click', () => this.resetAISettings());
                
                // Add visual feedback for disabled checkboxes
                ['chatgpt', 'grok', 'perplexity', 'you', 'copilot'].forEach(service => {
                    const checkbox = document.getElementById(`${service}Enabled`);
                    const container = checkbox.closest('.mb-3');
                    
                    checkbox.addEventListener('change', () => {
                        if (!checkbox.checked) {
                            container.style.opacity = '0.6';
                            container.classList.add('text-muted');
                        } else {
                            container.style.opacity = '1';
                            container.classList.remove('text-muted');
                        }
                    });
                });
            },

            async loadAISettings() {
                try {
                    // Load AI settings
                    const aiResponse = await API.getAISettings();
                    
                    // Load templates from config
                    const configResponse = await API.getConfig();
                    
                    // Load question templates
                    const questionTemplate = configResponse.ai_question_template || this.defaultQuestionTemplate;
                    const vocabularyTemplate = configResponse.vocabulary_query_template || this.defaultVocabularyTemplate;
                    
                    document.getElementById('aiQuestionTemplate').value = questionTemplate;
                    document.getElementById('vocabularyQueryTemplate').value = vocabularyTemplate;
                    
                    // Load URLs
                    document.getElementById('chatgptUrl').value = aiResponse.chatgpt_url || this.defaultUrls.chatgpt;
                    document.getElementById('grokUrl').value = aiResponse.grok_url || this.defaultUrls.grok;
                    document.getElementById('perplexityUrl').value = aiResponse.perplexity_url || this.defaultUrls.perplexity;
                    document.getElementById('youUrl').value = aiResponse.you_url || this.defaultUrls.you;
                    document.getElementById('copilotUrl').value = aiResponse.copilot_url || this.defaultUrls.copilot;
                    
                    // Load enabled states
                    document.getElementById('chatgptEnabled').checked = aiResponse.chatgpt_enabled !== false;
                    document.getElementById('grokEnabled').checked = aiResponse.grok_enabled !== false;
                    document.getElementById('perplexityEnabled').checked = aiResponse.perplexity_enabled === true;
                    document.getElementById('youEnabled').checked = aiResponse.you_enabled === true;
                    document.getElementById('copilotEnabled').checked = aiResponse.copilot_enabled === true;
                    
                    // Update visual feedback
                    ['chatgpt', 'grok', 'perplexity', 'you', 'copilot'].forEach(service => {
                        const checkbox = document.getElementById(`${service}Enabled`);
                        const container = checkbox.closest('.mb-3');
                        
                        if (!checkbox.checked) {
                            container.style.opacity = '0.6';
                            container.classList.add('text-muted');
                        } else {
                            container.style.opacity = '1';
                            container.classList.remove('text-muted');
                        }
                    });
                    
                } catch (error) {
                    console.error('Failed to load AI settings:', error);
                    this.showMessage('Failed to load AI settings', 'danger');
                }
            },

            async saveAISettings(e) {
                e.preventDefault(); // Thêm dòng này để ngăn form submit mặc định
                
                // Validate question template
                const questionTemplate = document.getElementById('aiQuestionTemplate').value.trim();
                if (!questionTemplate) {
                    this.showMessage('Question template is required', 'danger');
                    return;
                }
                
                if (!questionTemplate.includes('{keyword}')) {
                    this.showMessage('Question template must contain {keyword} placeholder', 'danger');
                    return;
                }
                
                // Validate vocabulary template
                const vocabularyTemplate = document.getElementById('vocabularyQueryTemplate').value.trim();
                if (!vocabularyTemplate) {
                    this.showMessage('Vocabulary query template is required', 'danger');
                    return;
                }
                
                if (!vocabularyTemplate.includes('{word}')) {
                    this.showMessage('Vocabulary template must contain {word} placeholder', 'danger');
                    return;
                }
                
                // Validate URLs contain {query}
                const urls = {
                    chatgpt_url: document.getElementById('chatgptUrl').value.trim(),
                    grok_url: document.getElementById('grokUrl').value.trim(),
                    perplexity_url: document.getElementById('perplexityUrl').value.trim(),
                    you_url: document.getElementById('youUrl').value.trim(),
                    copilot_url: document.getElementById('copilotUrl').value.trim()
                };
                
                // Validate that all URLs contain {query}
                for (const [key, url] of Object.entries(urls)) {
                    if (url && !url.includes('{query}')) {
                        this.showMessage(`${key.replace('_url', '')} URL must contain {query} placeholder`, 'danger');
                        return;
                    }
                }
                
                // Prepare AI settings
                const aiSettings = {
                    // Save custom URLs
                    ...urls,
                    
                    // Get enabled states from checkboxes
                    chatgpt_enabled: document.getElementById('chatgptEnabled').checked,
                    grok_enabled: document.getElementById('grokEnabled').checked,
                    perplexity_enabled: document.getElementById('perplexityEnabled').checked,
                    you_enabled: document.getElementById('youEnabled').checked,
                    copilot_enabled: document.getElementById('copilotEnabled').checked
                };
                
                try {
                    // Save AI settings
                    const aiResponse = await API.updateAISettings(aiSettings);
                    
                    // Save templates to config
                    const configResponse = await API.updateConfig({
                        ai_question_template: questionTemplate,
                        vocabulary_query_template: vocabularyTemplate
                    });
                    
                    if (aiResponse.status === 'success' && configResponse.status === 'success') {
                        this.showMessage('AI settings saved successfully!', 'success');
                    }
                } catch (error) {
                    console.error('Failed to save AI settings:', error);
                    this.showMessage('Failed to save AI settings', 'danger');
                }
            },

            resetAISettings() {
                if (confirm('Are you sure you want to reset AI settings to default?')) {
                    // Reset templates
                    document.getElementById('aiQuestionTemplate').value = this.defaultQuestionTemplate;
                    document.getElementById('vocabularyQueryTemplate').value = this.defaultVocabularyTemplate;
                    
                    // Reset URLs to default
                    document.getElementById('chatgptUrl').value = this.defaultUrls.chatgpt;
                    document.getElementById('grokUrl').value = this.defaultUrls.grok;
                    document.getElementById('perplexityUrl').value = this.defaultUrls.perplexity;
                    document.getElementById('youUrl').value = this.defaultUrls.you;
                    document.getElementById('copilotUrl').value = this.defaultUrls.copilot;
                    
                    // Reset enabled states to default
                    document.getElementById('chatgptEnabled').checked = true;
                    document.getElementById('grokEnabled').checked = true;
                    document.getElementById('perplexityEnabled').checked = false;
                    document.getElementById('youEnabled').checked = false;
                    document.getElementById('copilotEnabled').checked = false;
                    
                    // Update visual feedback
                    ['chatgpt', 'grok', 'perplexity', 'you', 'copilot'].forEach(service => {
                        const checkbox = document.getElementById(`${service}Enabled`);
                        const container = checkbox.closest('.mb-3');
                        
                        if (!checkbox.checked) {
                            container.style.opacity = '0.6';
                            container.classList.add('text-muted');
                        } else {
                            container.style.opacity = '1';
                            container.classList.remove('text-muted');
                        }
                    });
                    
                    this.showMessage('AI settings reset to default', 'info');
                }
            },

            showMessage(message, type) {
                const msgElement = document.getElementById('aiSettingsMsg');
                msgElement.className = `text-${type === 'success' ? 'success' : type === 'danger' ? 'danger' : 'info'}`;
                msgElement.textContent = message;
                setTimeout(() => { msgElement.textContent = ''; }, 3000);
            }
        };

        // ===== LINKS MANAGER =====
        const LinksManager = {
            init() {
                document.getElementById('linksBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showLinksModal();
                });
            },

            async showLinksModal() {
                try {
                    const data = await API.getLinksTree();
                    console.log('Links API response:', data); // Debug log
                    
                    // Handle the new API response format
                    let links_tree = [];
                    if (data && data.status === 'success' && data.links_tree) {
                        links_tree = data.links_tree;
                    } else if (data && data.links_tree) {
                        // Fallback for old format
                        links_tree = data.links_tree;
                    } else if (data && Array.isArray(data)) {
                        // Fallback if data is directly an array
                        links_tree = data;
                    }
                    
                    this.renderLinksTree(links_tree);
                    new bootstrap.Modal(document.getElementById('linksModal')).show();
                } catch (error) {
                    console.error('Failed to load links:', error);
                    // Show modal with empty content on error
                    this.renderLinksTree([]);
                    new bootstrap.Modal(document.getElementById('linksModal')).show();
                }
            },

            renderLinksTree(treeData) {
                const container = document.getElementById('linksTreeContainer');
                container.innerHTML = '';

                // Ensure there's always an empty folder at the end
                let last = treeData[treeData.length - 1];
                if (!last || (last.name.trim() !== '' || (last.children && last.children.length > 0 && last.children.some(l => l.url && l.url.trim() !== '')))) {
                    treeData.push({name: '', children: []});
                }

                treeData.forEach((folder, folderIdx) => this.renderFolder(folder, folderIdx, treeData, container));
            },

            renderFolder(folder, folderIdx, treeData, container) {
                const folderDiv = document.createElement('div');
                folderDiv.className = 'mb-2 border rounded p-2 bg-light';

                // Links list
                const linksUl = this.createLinksList(folder, folderIdx, treeData);
                
                // Folder header - truyền tham chiếu linksUl
                const header = this.createFolderHeader(folder, folderIdx, treeData, linksUl);
                folderDiv.appendChild(header);
                folderDiv.appendChild(linksUl);

                container.appendChild(folderDiv);
            },

            createFolderHeader(folder, folderIdx, treeData, linksUl) {
                const header = document.createElement('div');
                header.className = 'd-flex align-items-center mb-1 folder-header';

                // Toggle button
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'btn btn-sm btn-link px-1 py-0';
                toggleBtn.innerHTML = '<i class="bi bi-caret-down-fill"></i>';
                toggleBtn.type = 'button'; // Thêm type để đảm bảo không submit form
                header.appendChild(toggleBtn);

                // Folder name input
                const folderName = document.createElement('input');
                folderName.type = 'text';
                folderName.value = folder.name;
                folderName.className = 'form-control form-control-sm d-inline-block mx-1';
                folderName.style.width = '120px';
                folderName.placeholder = 'Tên thư mục...';
                header.appendChild(folderName);

                // Setup toggle functionality với tham chiếu linksUl
                let collapsed = false;
                toggleBtn.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    collapsed = !collapsed;
                    if (linksUl) {
                        linksUl.style.display = collapsed ? 'none' : '';
                        toggleBtn.innerHTML = collapsed ? 
                            '<i class="bi bi-caret-right-fill"></i>' : 
                            '<i class="bi bi-caret-down-fill"></i>';
                    }
                };

                folderName.onblur = () => {
                    folder.name = folderName.value.trim();
                    if (folderIdx !== treeData.length - 1 && folder.name === '') {
                        treeData.splice(folderIdx, 1);
                    }
                    this.saveLinksTree(treeData);
                    this.renderLinksTree(treeData);
                };

                return header;
            },

            createLinksList(folder, folderIdx, treeData) {
                const linksUl = document.createElement('ul');
                linksUl.className = 'list-group';
                linksUl.style.minHeight = '10px';

                folder.children = folder.children || [];
                
                // Render existing links
                folder.children.forEach((link, linkIdx) => {
                    const li = this.createLinkItem(link, linkIdx, folder, folderIdx, treeData);
                    linksUl.appendChild(li);
                });

                // Add empty link input
                const emptyLi = this.createEmptyLinkItem(folder, treeData);
                linksUl.appendChild(emptyLi);

                // Setup drag and drop for folder
                linksUl.ondragover = (e) => e.preventDefault();
                linksUl.ondrop = (e) => {
                    e.preventDefault();
                    const {fromFolder, fromLink} = JSON.parse(e.dataTransfer.getData('text/plain'));
                    if (fromFolder == folderIdx) return;
                    const moved = treeData[fromFolder].children.splice(fromLink, 1)[0];
                    folder.children.push(moved);
                    this.renderLinksTree(treeData);
                    this.saveLinksTree(treeData);
                };

                return linksUl;
            },

            createLinkItem(link, linkIdx, folder, folderIdx, treeData) {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex align-items-center';
                li.draggable = true;

                // Setup drag events
                this.setupLinkDragEvents(li, folderIdx, linkIdx, folder, treeData);

                // Link input
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'form-control form-control-sm me-2';
                input.value = link.url;
                input.placeholder = 'Link...';
                input.onblur = () => {
                    link.url = input.value.trim();
                    if (!link.url) {
                        folder.children.splice(linkIdx, 1);
                    }
                    this.saveLinksTree(treeData);
                    this.renderLinksTree(treeData);
                };
                li.appendChild(input);

                // Open button
                if (link.url) {
                    const openBtn = document.createElement('button');
                    openBtn.className = 'btn btn-sm btn-primary me-2';
                    openBtn.innerHTML = '<i class="bi bi-box-arrow-up-right"></i>';
                    openBtn.onclick = () => {
                        let url = link.url.trim();
                        if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
                        window.open(url, '_blank');
                    };
                    li.appendChild(openBtn);
                }

                return li;
            },

            createEmptyLinkItem(folder, treeData) {
                const emptyLi = document.createElement('li');
                emptyLi.className = 'list-group-item d-flex align-items-center';
                
                const emptyInput = document.createElement('input');
                emptyInput.type = 'text';
                emptyInput.className = 'form-control form-control-sm me-2';
                emptyInput.placeholder = 'Link...';
                emptyInput.onblur = () => {
                    const val = emptyInput.value.trim();
                    if (val) {
                        folder.children.push({url: val});
                        this.saveLinksTree(treeData);
                        this.renderLinksTree(treeData);
                    }
                };
                emptyLi.appendChild(emptyInput);
                
                return emptyLi;
            },

            setupLinkDragEvents(li, folderIdx, linkIdx, folder, treeData) {
                li.ondragstart = (e) => {
                    e.dataTransfer.setData('text/plain', JSON.stringify({fromFolder: folderIdx, fromLink: linkIdx}));
                    li.classList.add('dragging');
                };

                li.ondragend = () => {
                    li.classList.remove('dragging');
                    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                };

                li.ondragover = (e) => {
                    e.preventDefault();
                    li.classList.add('drag-over');
                };

                li.ondragleave = () => {
                    li.classList.remove('drag-over');
                };

                li.ondrop = (e) => {
                    e.preventDefault();
                    li.classList.remove('drag-over');
                    const {fromFolder, fromLink} = JSON.parse(e.dataTransfer.getData('text/plain'));
                    if (fromFolder == folderIdx && fromLink == linkIdx) return;
                    const moved = treeData[fromFolder].children.splice(fromLink, 1)[0];
                    folder.children.splice(linkIdx, 0, moved);
                    this.renderLinksTree(treeData);
                    this.saveLinksTree(treeData);
                };
            },

            async saveLinksTree(treeData) {
                try {
                    await API.updateLinksTree(treeData);
                } catch (error) {
                    console.error('Failed to save links tree:', error);
                }
            }
        };

        // ===== CARD LIST MANAGER =====
        const CardListManager = {
            init() {
                document.getElementById('showCardListModal').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showCardListModal();
                });
            },

            async showCardListModal() {
                try {
                    const data = await API.getCardList();
                    this.renderCardList(data.files);
                    new bootstrap.Modal(document.getElementById('cardListModal')).show();
                } catch (error) {
                    console.error('Error loading card list:', error);
                    Utils.showFlashMessage('Không thể tải danh sách card!', 'danger');
                }
            },

            renderCardList(files) {
                const cardList = document.getElementById('cardList');
                cardList.innerHTML = '';
                cardList.className = 'row g-3';
                
                files.forEach(file => this.renderCardItem(file, cardList));
            },

            async renderCardItem(file, container) {
                const colDiv = document.createElement('div');
                colDiv.className = 'col-6 col-md-4';
                
                const qrContainer = document.createElement('div');
                qrContainer.className = 'qr-container';
                
                const qrImg = document.createElement('img');
                qrImg.className = 'qr-canvas';
                qrImg.style.width = '120px';
                qrImg.style.height = '120px';
                
                const filename = document.createElement('div');
                filename.className = 'qr-filename';
                filename.textContent = file.replace('.html', '');
                
                qrContainer.appendChild(qrImg);
                qrContainer.appendChild(filename);
                colDiv.appendChild(qrContainer);
                container.appendChild(colDiv);
                
                try {
                    const data = await API.getCardHash(file);
                    if (data.hash) {
                        const publicUrl = `${window.location.origin}/public_card/${data.hash}`;
                        const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${encodeURIComponent(publicUrl)}`;
                        qrImg.src = qrApiUrl;
                        
                        qrImg.onerror = () => this.showErrorFallback(qrImg, qrContainer, filename, 'QR Error');
                        qrContainer.onclick = () => Utils.copyToClipboard(publicUrl, qrContainer);
                    } else {
                        this.showErrorFallback(qrImg, qrContainer, filename, 'Link Error');
                    }
                } catch (error) {
                    console.error('Error getting card hash:', error);
                    this.showErrorFallback(qrImg, qrContainer, filename, 'Hash Error');
                }
            },

            showErrorFallback(element, qrContainer, filename, errorMsg) {
                element.style.display = 'none';
                const errorText = document.createElement('div');
                errorText.textContent = errorMsg;
                errorText.style.color = 'red';
                errorText.style.fontSize = '0.8rem';
                errorText.style.textAlign = 'center';
                qrContainer.insertBefore(errorText, filename);
            }
        };

        // ===== PROFILE MANAGER =====
        const ProfileManager = {
            init() {
                document.getElementById('personalize-tab').addEventListener('shown.bs.tab', () => this.loadProfileData());
                
                // Thêm event listener sau khi DOM đã loaded
                const profileForm = document.getElementById('profileForm');
                if (profileForm) {
                    profileForm.addEventListener('submit', (e) => this.saveProfile(e));
                }
            },

            async loadProfileData() {
                try {
                    const data = await API.getCardInfo();
                    // Kiểm tra element tồn tại trước khi set value
                    const profileName = document.getElementById('profileName');
                    const profileJob = document.getElementById('profileJob');
                    const profileEmail = document.getElementById('profileEmail');
                    const profilePhone = document.getElementById('profilePhone');
                    const profileSNS = document.getElementById('profileSNS');
                    const profileSlogan = document.getElementById('profileSlogan');
                    
                    if (profileName) profileName.value = data.Name || '';
                    if (profileJob) profileJob.value = data.Job || '';
                    if (profileEmail) profileEmail.value = data.Email || '';
                    if (profilePhone) profilePhone.value = data.Phone || '';
                    if (profileSNS) profileSNS.value = data.SNS || '';
                    if (profileSlogan) profileSlogan.value = data.SubSlogan || '';
                } catch (error) {
                    console.error('Failed to load profile data:', error);
                }
            },

            async saveProfile(e) {
                if (e) e.preventDefault();
                
                // Kiểm tra element tồn tại trước khi lấy value
                const profileName = document.getElementById('profileName');
                const profileJob = document.getElementById('profileJob');
                const profileEmail = document.getElementById('profileEmail');
                const profilePhone = document.getElementById('profilePhone');
                const profileSNS = document.getElementById('profileSNS');
                const profileSlogan = document.getElementById('profileSlogan');
                
                const data = {
                    Name: profileName ? profileName.value : '',
                    Job: profileJob ? profileJob.value : '',
                    Email: profileEmail ? profileEmail.value : '',
                    Phone: profilePhone ? profilePhone.value : '',
                    SNS: profileSNS ? profileSNS.value : '',
                    SubSlogan: profileSlogan ? profileSlogan.value : ''
                };
                
                try {
                    const response = await API.updateCardInfo(data);
                    if (response.status === 'success') {
                        const msgElement = document.getElementById('profileMsg');
                        if (msgElement) {
                            msgElement.textContent = 'Cập nhật thành công!';
                            setTimeout(() => { msgElement.textContent = ''; }, 2000);
                        }
                    }
                } catch (error) {
                    console.error('Failed to save profile:', error);
                    Utils.showFlashMessage('Failed to save profile', 'danger');
                }
            }
        };

        // ===== AUTH MANAGER =====
        const AuthManager = {
            init() {
                document.getElementById('logoutBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    new bootstrap.Modal(document.getElementById('confirmLogoutModal')).show();
                });

                document.getElementById('confirmLogoutBtn').onclick = async () => {
                    try {
                        await fetch('{{ url_for("logout") }}', {
                            method: 'POST',
                            headers: {'X-Requested-With': 'XMLHttpRequest'}
                        });
                        window.location.href = '{{ url_for("login") }}';
                    } catch (error) {
                        console.error('Logout failed:', error);
                        window.location.href = '{{ url_for("login") }}'; // Fallback
                    }
                };
            }
        };

        // ===== MAIN APPLICATION =====
        document.addEventListener('DOMContentLoaded', function() {
            // Optionally, close sidebar when a menu item is clicked (mobile UX)
            document.querySelectorAll('#sidebarMenu .nav-link').forEach(function(link) {
                link.addEventListener('click', function(e) {
                    // Chỉ đóng sidebar nếu KHÔNG phải là menu cha (không có data-bs-toggle="collapse")
                    if (!link.hasAttribute('data-bs-toggle')) {
                        var sidebar = bootstrap.Offcanvas.getInstance(document.getElementById('sidebarMenu'));
                        if (sidebar) sidebar.hide();
                    }
                });
            });
            // Initialize all managers
            MindfulnessTimer.init();
            UISettingsManager.init();
            ThemeManager.init();
            LinksManager.init();
            CardListManager.init();
            ProfileManager.init();
            AuthManager.init();
            AISettingsManager.init(); // Add this line
            MasterPasswordManager.init();

            const openSettingsBtn = document.getElementById('openSettingsBtn');
            const alertsBox = document.getElementById('alertsBox');
            const alertsList = document.getElementById('alertsList');
            const toggleAlertsBtn = document.getElementById('toggleAlertsBtn');
            const toggleAlertsIcon = document.getElementById('toggleAlertsIcon');

            if (alertsBox && alertsList && toggleAlertsBtn && toggleAlertsIcon) {
            let expanded = false;
            toggleAlertsBtn.onclick = function() {
                expanded = !expanded;
                if (expanded) {
                alertsList.classList.remove('d-none');
                toggleAlertsIcon.className = 'bi bi-bell-fill';
                } else {
                alertsList.classList.add('d-none');
                toggleAlertsIcon.className = 'bi bi-bell';
                }
            };
            // Mặc định ẩn
            alertsList.classList.add('d-none');
            toggleAlertsIcon.className = 'bi bi-bell';
            }

            if (openSettingsBtn) {
                openSettingsBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    // Kiểm tra master password
                    await window.masterPasswordAuth?.checkMasterPasswordStatus?.();
                    // Nếu đã xác thực thì mới show modal
                    if (window.masterPasswordAuth?.isAuthenticated) {
                        new bootstrap.Modal(document.getElementById('settingsModal')).show();
                    }
                });
            }
            
            const lockBtn = document.getElementById('lock-settings-btn');
            if (lockBtn) {
                lockBtn.onclick = () => {
                    window.masterPasswordAuth?.lockMasterPassword();
                    // Đóng modal settings nếu muốn:
                    const modal = bootstrap.Modal.getInstance(document.getElementById('settingsModal'));
                    if (modal) modal.hide();
                };
            }


            // Navbar auto-close on outside click (mobile UX)
            document.addEventListener('click', (event) => {
                const navbarToggler = document.querySelector('.navbar-toggler');
                
            });

            document.getElementById('db-tab').addEventListener('shown.bs.tab', async function() {
                // Hiển thị dung lượng DB
                fetch('/db_size').then(r=>r.json()).then(data=>{
                    document.getElementById('dbSizeText').textContent = data.size_mb ? `${data.size_mb} MB` : `${data.size_kb} KB`;
                });

                // Hiển thị danh sách table
                fetch('/api/db_tables').then(r=>r.json()).then(data=>{
                    const list = document.getElementById('dbTablesList');
                    list.innerHTML = '';
                    if (data.tables && data.tables.length > 0) {
                        // Hiển thị bảng dưới dạng table HTML hiện đại
                        let tableHtml = `
                            <div class="table-responsive">
                            <table class="table table-bordered table-sm align-middle mb-2">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width:36px"></th>
                                        <th>Table Name</th>
                                        <th style="width:100px">Rows</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        data.tables.forEach(t=>{
                            tableHtml += `
                                <tr>
                                    <td>
                                        <input class="form-check-input db-table-checkbox" type="checkbox" value="${t.name}" id="table_${t.name}">
                                    </td>
                                    <td>
                                        <label class="form-check-label" for="table_${t.name}">${t.name}</label>
                                    </td>
                                    <td>
                                        <span class="text-muted">${t.rows} rows</span>
                                    </td>
                                </tr>
                            `;
                        });
                        tableHtml += `</tbody></table></div>`;
                        list.innerHTML = tableHtml;
                    } else {
                        list.innerHTML = '<div class="text-muted">No tables found in database.</div>';
                    }
                    document.getElementById('deleteTableDataBtn').disabled = true;
                    list.querySelectorAll('.db-table-checkbox').forEach(cb=>{
                        cb.onchange = ()=>{
                            document.getElementById('deleteTableDataBtn').disabled = !list.querySelectorAll('.db-table-checkbox:checked').length;
                        };
                    });
                });

                // Hiển thị danh sách file uploads
                fetch('/api/uploads_files').then(r=>r.json()).then(data=>{
                    const list = document.getElementById('uploadsFileList');
                    list.innerHTML = '';
                    data.files.forEach(f=>{
                        const row = document.createElement('div');
                        row.className = 'form-check';
                        row.innerHTML = `<input class="form-check-input upload-file-checkbox" type="checkbox" value="${f.name}" id="file_${btoa(f.name)}">
                            <label class="form-check-label" for="file_${btoa(f.name)}">${f.name} <span class="text-muted">(${(f.size/1024).toFixed(1)} KB)</span></label>`;
                        list.appendChild(row);
                    });
                    document.getElementById('deleteFilesBtn').disabled = true;
                    list.querySelectorAll('.upload-file-checkbox').forEach(cb=>{
                        cb.onchange = ()=>{
                            document.getElementById('deleteFilesBtn').disabled = !list.querySelectorAll('.upload-file-checkbox:checked').length;
                        };
                    });
                });
            });

        // Download DB
        document.getElementById('downloadDbBtn').onclick = function() {
            window.open('/download_db', '_blank');
        };

        // Xoá data table
        document.getElementById('deleteTableDataBtn').onclick = async function() {
            const checked = Array.from(document.querySelectorAll('.db-table-checkbox:checked')).map(cb=>cb.value);
            if (!checked.length) return;
            if (!confirm('Delete all data in selected tables?')) return;
            for (const t of checked) {
                await fetch('/api/db_delete_table', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({table: t})
                });
            }
            // Reload tab
            document.getElementById('db-tab').dispatchEvent(new Event('shown.bs.tab'));
        };

        // Xoá file uploads
        document.getElementById('deleteFilesBtn').onclick = async function() {
            const checked = Array.from(document.querySelectorAll('.upload-file-checkbox:checked')).map(cb=>cb.value);
            if (!checked.length) return;
            if (!confirm('Delete selected files?')) return;
            for (const f of checked) {
                await fetch('/api/delete_upload_file', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({filename: f})
                });
            }
            // Reload tab
            document.getElementById('db-tab').dispatchEvent(new Event('shown.bs.tab'));
        };

        });

        document.addEventListener('DOMContentLoaded', function() {
            var sidebar = document.getElementById('sidebarMenu');
            var hamburger = document.querySelector('.btn-hamburger');
            if (sidebar && hamburger) {
                sidebar.addEventListener('shown.bs.offcanvas', function () {
                    hamburger.style.display = 'none';
                });
                sidebar.addEventListener('hidden.bs.offcanvas', function () {
                    hamburger.style.display = '';
                });
            }
        });
    </script>
</body>
</html>